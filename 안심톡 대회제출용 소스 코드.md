# ğŸ† ì•ˆì‹¬í†¡(AnsimTalk) ëŒ€íšŒ ì œì¶œìš© ì „ì²´ ì½”ë“œ ë° ë¦¬ì†ŒìŠ¤

ë³¸ ë¬¸ì„œëŠ” ansimtalk í”„ë¡œì íŠ¸ì˜ ëŒ€íšŒ ì œì¶œìš© ì „ì²´ ì½”ë“œ, í…œí”Œë¦¿, ë¦¬ì†ŒìŠ¤, í™˜ê²½ì„¤ì •, ì‹¤í–‰ë²•ì„ í•œ ê¸€ìë„ ë¹ ì§ì—†ì´ í¬í•¨í•©ë‹ˆë‹¤.

---

## ğŸ“– í”„ë¡œì íŠ¸ ê°œìš” (ìš”ì•½)
- **ì•ˆì‹¬í†¡(AnsimTalk)**: AI ê¸°ë°˜ ë”¥í˜ì´í¬ íƒì§€ ë° ì‚¬ì´ë²„í­ë ¥ ë¶„ì„, ë””ì§€í„¸ ì¦ê±° PDF ìë™ìƒì„±, ë²•ì  íš¨ë ¥ ê°•í™”, ëª¨ë°”ì¼/ì›¹ ìµœì í™”, ê°œì¸ì •ë³´ ë³´í˜¸, ì‹¤ì‹œê°„ ë¶„ì„ ì„œë¹„ìŠ¤
- **ì£¼ìš” ê¸°ìˆ **: Python 3.12, Flask, Sightengine API, Google Gemini/Vision, WeasyPrint, Docker, Railway, HTML/CSS/JS
- **ì‹¤í–‰ë²•**: ì•„ë˜ "ì‹¤í–‰/ë°°í¬ ì•ˆë‚´" ì°¸ê³ 

---

## 1. run.py (Flask ì•± ì‹¤í–‰ ì§„ì…ì )
```python
import os
from app import create_app

app = create_app()

if __name__ == '__main__':
    port = int(os.environ.get('PORT', 8000))
    print(f"Starting AnsimTalk on port {port}")
    app.run(host='0.0.0.0', port=port, debug=False)
```

---

## 2. config.py (í™˜ê²½ ë³€ìˆ˜ ë° ê¸°ë³¸ ì„¤ì •)
```python
import os

# Flask ê¸°ë³¸ ì„¤ì •
SECRET_KEY = os.environ.get('SECRET_KEY', 'your-secret-key')

# Sightengine API (í™˜ê²½ ë³€ìˆ˜ì—ì„œ ê°€ì ¸ì˜´)
SIGHTENGINE_API_USER = os.environ.get('SIGHTENGINE_API_USER', '')
SIGHTENGINE_API_SECRET = os.environ.get('SIGHTENGINE_API_SECRET', '')

# Google Cloud Vision/Gemini
GOOGLE_APPLICATION_CREDENTIALS = os.environ.get('GOOGLE_APPLICATION_CREDENTIALS', 'dazzling-howl-465316-m7-6605bfd84de1.json')
GOOGLE_GEMINI_API_KEY = os.environ.get('GOOGLE_GEMINI_API_KEY', '')

# ì‹¤ì œ ë°°í¬ ì‹œì—ëŠ” í™˜ê²½ë³€ìˆ˜ë¡œ ë¯¼ê°ì •ë³´ë¥¼ ê´€ë¦¬í•˜ì„¸ìš”.

BASE_DIR = os.path.abspath(os.path.dirname(__file__))
UPLOAD_FOLDER = os.path.join(BASE_DIR, 'tmp')
ALLOWED_EXTENSIONS = {'txt', 'png', 'jpg', 'jpeg'} 
```

---

## 3. app/__init__.py (Flask ì•± íŒ©í† ë¦¬ ë° ë¸”ë£¨í”„ë¦°íŠ¸ ë“±ë¡)
```python
import os
from flask import Flask
from .routes import bp

def create_app():
    app = Flask(__name__)
    
    # ë¡œê·¸ ë ˆë²¨ì„ DEBUGë¡œ ì„¤ì •
    app.logger.setLevel('DEBUG')
    
    # ì‹œí¬ë¦¿ í‚¤ ì„¤ì •
    app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY', 'ansimtalk-secret-key-2024')
    
    # í™˜ê²½ ë³€ìˆ˜ì—ì„œ API í‚¤ë“¤ ê°€ì ¸ì˜¤ê¸°
    app.config['SIGHTENGINE_API_USER'] = os.environ.get('SIGHTENGINE_API_USER', '1052068557')
    app.config['SIGHTENGINE_API_SECRET'] = os.environ.get('SIGHTENGINE_API_SECRET', 'JbRcN79c6iunXBHG29WRzyQyFHRoYnQa')
    app.config['GOOGLE_GEMINI_API_KEY'] = os.environ.get('GOOGLE_GEMINI_API_KEY', 'AIzaSyAZ__v5f-3pYxDfMi--rdCyphpcqsxxrLo')
    app.config['GOOGLE_CLOUD_VISION_API_KEY'] = os.environ.get('GOOGLE_CLOUD_VISION_API_KEY', 'your-vision-api-key-here')
    
    # Google Cloud ìê²© ì¦ëª… íŒŒì¼ ê²½ë¡œ ì„¤ì •
    app.config['GOOGLE_APPLICATION_CREDENTIALS'] = os.environ.get('GOOGLE_APPLICATION_CREDENTIALS', 'dazzling-howl-465316-m7-1940c1e7d0a2.json')
    
    # ë¸”ë£¨í”„ë¦°íŠ¸ ë“±ë¡
    app.register_blueprint(bp)
    
    return app
```

---

## 4. app/routes.py
```python
import os
import uuid
from datetime import datetime
from flask import Blueprint, render_template, request, redirect, url_for, current_app, session, flash, send_file
from werkzeug.utils import secure_filename
from .services import analyze_file, generate_pdf_report
import shutil
from PIL import Image, ExifTags
import hashlib

bp = Blueprint('main', __name__)

ALLOWED_EXTENSIONS = {'txt', 'png', 'jpg', 'jpeg'}
MAX_FILE_SIZE = 5 * 1024 * 1024

# íŒŒì¼ í™•ì¥ì ì²´í¬
def allowed_file(filename):
    return '.' in filename and filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS

# íŒŒì¼ ë©”íƒ€ë°ì´í„° ì¶”ì¶œ
def extract_metadata(image_path):
    try:
        img = Image.open(image_path)
        exif = img._getexif()
        meta = {}
        if exif:
            for tag, value in exif.items():
                decoded = ExifTags.TAGS.get(tag, tag)
                meta[decoded] = value
        meta['í•´ìƒë„'] = f"{img.width}x{img.height}"
        return meta
    except Exception:
        return {"í•´ìƒë„": "ì•Œìˆ˜ì—†ìŒ"}

# SHA-256 í•´ì‹œê°’ ìƒì„±
def get_file_sha256(filepath):
    h = hashlib.sha256()
    with open(filepath, 'rb') as f:
        while True:
            chunk = f.read(8192)
            if not chunk:
                break
            h.update(chunk)
    return h.hexdigest()

def _handle_file_upload_and_analysis(analysis_type):
    try:
        current_app.logger.info(f"=== {analysis_type} ë¶„ì„ ì‹œì‘ ===")
        print(f"=== {analysis_type} ë¶„ì„ ì‹œì‘ ===")
        
        if 'file' not in request.files:
            current_app.logger.error("ì˜¤ë¥˜: íŒŒì¼ì´ ìš”ì²­ì— ì—†ìŠµë‹ˆë‹¤.")
            print("ì˜¤ë¥˜: íŒŒì¼ì´ ìš”ì²­ì— ì—†ìŠµë‹ˆë‹¤.")
            flash('íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.')
            return redirect(url_for('main.index'))
        
        file = request.files['file']
        current_app.logger.info(f"ì—…ë¡œë“œëœ íŒŒì¼ëª…: {file.filename}")
        print(f"ì—…ë¡œë“œëœ íŒŒì¼ëª…: {file.filename}")
        
        if file.filename == '':
            current_app.logger.error("ì˜¤ë¥˜: íŒŒì¼ëª…ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.")
            print("ì˜¤ë¥˜: íŒŒì¼ëª…ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.")
            flash('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.')
            return redirect(url_for('main.index'))
        
        if not allowed_file(file.filename):
            current_app.logger.error(f"ì˜¤ë¥˜: í—ˆìš©ë˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹: {file.filename}")
            print(f"ì˜¤ë¥˜: í—ˆìš©ë˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹: {file.filename}")
            flash('í—ˆìš©ë˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤.')
            return redirect(url_for('main.index'))
        
        # íŒŒì¼ í¬ê¸° í™•ì¸
        file.seek(0, os.SEEK_END)
        file_size = file.tell()
        file.seek(0)
        current_app.logger.info(f"íŒŒì¼ í¬ê¸°: {file_size} bytes")
        print(f"íŒŒì¼ í¬ê¸°: {file_size} bytes")
        
        if file_size > MAX_FILE_SIZE:
            current_app.logger.error(f"ì˜¤ë¥˜: íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í¼: {file_size} bytes")
            print(f"ì˜¤ë¥˜: íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í¼: {file_size} bytes")
            flash('íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤.')
            return redirect(url_for('main.index'))

        original_filename = secure_filename(file.filename)
        file_extension = original_filename.rsplit('.', 1)[1].lower()
        unique_filename = f"{uuid.uuid4().hex}_{datetime.now().strftime('%Y%m%d%H%M%S')}.{file_extension}"
        
        current_app.logger.info(f"ì›ë³¸ íŒŒì¼ëª…: {original_filename}")
        current_app.logger.info(f"ê³ ìœ  íŒŒì¼ëª…: {unique_filename}")
        current_app.logger.info(f"íŒŒì¼ í™•ì¥ì: {file_extension}")
        print(f"ì›ë³¸ íŒŒì¼ëª…: {original_filename}")
        print(f"ê³ ìœ  íŒŒì¼ëª…: {unique_filename}")
        print(f"íŒŒì¼ í™•ì¥ì: {file_extension}")
        
        # í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬ í™•ì¸
        current_dir = os.getcwd()
        current_app.logger.info(f"í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬: {current_dir}")
        print(f"í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬: {current_dir}")
        
        # ì—…ë¡œë“œ í´ë”ë¥¼ í˜„ì¬ ë””ë ‰í† ë¦¬ ë‚´ì— ìƒì„±
        upload_folder = os.path.join(current_dir, 'tmp')
        if not os.path.exists(upload_folder):
            os.makedirs(upload_folder)
            current_app.logger.info(f"ì—…ë¡œë“œ í´ë” ìƒì„±: {upload_folder}")
            print(f"ì—…ë¡œë“œ í´ë” ìƒì„±: {upload_folder}")
        
        file_path = os.path.join(upload_folder, unique_filename)
        current_app.logger.info(f"íŒŒì¼ ì €ì¥ ê²½ë¡œ: {file_path}")
        print(f"íŒŒì¼ ì €ì¥ ê²½ë¡œ: {file_path}")
        
        # íŒŒì¼ ì €ì¥
        file.save(file_path)
        current_app.logger.info(f"íŒŒì¼ ì €ì¥ ì™„ë£Œ: {file_path}")
        print(f"íŒŒì¼ ì €ì¥ ì™„ë£Œ: {file_path}")
        
        # íŒŒì¼ ì¡´ì¬ í™•ì¸
        if not os.path.exists(file_path):
            current_app.logger.error(f"ì˜¤ë¥˜: íŒŒì¼ ì €ì¥ í›„ì—ë„ ì¡´ì¬í•˜ì§€ ì•ŠìŒ: {file_path}")
            print(f"ì˜¤ë¥˜: íŒŒì¼ ì €ì¥ í›„ì—ë„ ì¡´ì¬í•˜ì§€ ì•ŠìŒ: {file_path}")
            flash('íŒŒì¼ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.')
            return redirect(url_for('main.index'))
        
        # íŒŒì¼ í¬ê¸° ì¬í™•ì¸
        saved_file_size = os.path.getsize(file_path)
        current_app.logger.info(f"ì €ì¥ëœ íŒŒì¼ í¬ê¸°: {saved_file_size} bytes")
        print(f"ì €ì¥ëœ íŒŒì¼ í¬ê¸°: {saved_file_size} bytes")

        # static/uploadsë¡œ ë³µì‚¬
        static_uploads = os.path.join(current_app.root_path, 'static', 'uploads')
        if not os.path.exists(static_uploads):
            os.makedirs(static_uploads)
            current_app.logger.info(f"static ì—…ë¡œë“œ í´ë” ìƒì„±: {static_uploads}")
            print(f"static ì—…ë¡œë“œ í´ë” ìƒì„±: {static_uploads}")
        
        static_file_path = os.path.join(static_uploads, unique_filename)
        shutil.copy(file_path, static_file_path)
        current_app.logger.info(f"static í´ë”ë¡œ ë³µì‚¬ ì™„ë£Œ: {static_file_path}")
        print(f"static í´ë”ë¡œ ë³µì‚¬ ì™„ë£Œ: {static_file_path}")

        # íŒŒì¼ ì •ë³´ ì¶”ì¶œ
        file_stat = os.stat(file_path)
        metadata = extract_metadata(file_path)
        sha256 = get_file_sha256(file_path)
        
        current_app.logger.info(f"íŒŒì¼ ë©”íƒ€ë°ì´í„°: {metadata}")
        current_app.logger.info(f"SHA-256: {sha256}")
        print(f"íŒŒì¼ ë©”íƒ€ë°ì´í„°: {metadata}")
        print(f"SHA-256: {sha256}")

        # ì„¸ì…˜ì— ì €ì¥
        session['uploaded_file_path'] = file_path
        session['static_file_path'] = static_file_path
        session['original_filename'] = original_filename
        session['file_extension'] = file_extension
        session['file_stat'] = {'st_size': file_stat.st_size}
        session['metadata'] = metadata
        session['sha256'] = sha256
        session['static_image_url'] = f"uploads/{unique_filename}"
        session['original_image_path'] = static_file_path
        session['analysis_type'] = analysis_type
        
        current_app.logger.info("ì„¸ì…˜ ì •ë³´ ì €ì¥ ì™„ë£Œ")
        print("ì„¸ì…˜ ì •ë³´ ì €ì¥ ì™„ë£Œ")

        # ë¶„ì„ ê²°ê³¼ ìƒì„±
        try:
            current_app.logger.info(f"ë¶„ì„ ì‹œì‘: {analysis_type}")
            current_app.logger.info(f"ë¶„ì„í•  íŒŒì¼ ê²½ë¡œ: {file_path}")
            print(f"ë¶„ì„ ì‹œì‘: {analysis_type}")
            print(f"ë¶„ì„í•  íŒŒì¼ ê²½ë¡œ: {file_path}")
            
            # íŒŒì¼ì´ ì‹¤ì œë¡œ ì¡´ì¬í•˜ëŠ”ì§€ ë‹¤ì‹œ í•œë²ˆ í™•ì¸
            if not os.path.exists(file_path):
                current_app.logger.error(f"ë¶„ì„ ì „ íŒŒì¼ ì¡´ì¬ í™•ì¸ ì‹¤íŒ¨: {file_path}")
                print(f"ë¶„ì„ ì „ íŒŒì¼ ì¡´ì¬ í™•ì¸ ì‹¤íŒ¨: {file_path}")
                flash('ë¶„ì„í•  íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')
                return redirect(url_for('main.index'))
            
            analysis_result = analyze_file(file_path, analysis_type, file_extension)
            current_app.logger.info(f"ë¶„ì„ ì™„ë£Œ: {analysis_result}")
            print(f"ë¶„ì„ ì™„ë£Œ: {analysis_result}")
            
            # ì—…ë¡œë” ì •ë³´ ì¶”ê°€
            upload_timestamp = datetime.now()
            analysis_result['uploader_id'] = f"ANSIMTALK_USER_{upload_timestamp.strftime('%Y%m%d')}_{uuid.uuid4().hex[:8].upper()}"
            analysis_result['uploader_ip'] = request.remote_addr
            analysis_result['upload_timestamp'] = upload_timestamp.isoformat()
            analysis_result['file_size_bytes'] = file_stat.st_size
            analysis_result['file_size_mb'] = round(file_stat.st_size / (1024 * 1024), 2)
            
            # ì´ë¯¸ì§€ í¬ê¸° ì •ë³´ ì¶”ê°€
            if file_extension in {'jpg', 'jpeg', 'png'}:
                try:
                    with Image.open(file_path) as img:
                        analysis_result['image_width'] = img.width
                        analysis_result['image_height'] = img.height
                        analysis_result['image_resolution'] = f"{img.width}x{img.height}"
                        current_app.logger.info(f"ì´ë¯¸ì§€ í¬ê¸°: {img.width}x{img.height}")
                        print(f"ì´ë¯¸ì§€ í¬ê¸°: {img.width}x{img.height}")
                except Exception as e:
                    current_app.logger.error(f"ì´ë¯¸ì§€ í¬ê¸° ì¶”ì¶œ ì˜¤ë¥˜: {e}")
                    print(f"ì´ë¯¸ì§€ í¬ê¸° ì¶”ì¶œ ì˜¤ë¥˜: {e}")
                    analysis_result['image_width'] = 'N/A'
                    analysis_result['image_height'] = 'N/A'
                    analysis_result['image_resolution'] = 'N/A'
            else:
                analysis_result['image_width'] = 'N/A'
                analysis_result['image_height'] = 'N/A'
                analysis_result['image_resolution'] = 'N/A'
            
            session['analysis_result'] = analysis_result
            current_app.logger.info("ë¶„ì„ ê²°ê³¼ ì„¸ì…˜ ì €ì¥ ì™„ë£Œ")
            print("ë¶„ì„ ê²°ê³¼ ì„¸ì…˜ ì €ì¥ ì™„ë£Œ")
            
        except Exception as e:
            current_app.logger.error(f"ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
            print(f"ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
            import traceback
            current_app.logger.error(f"ìƒì„¸ ì˜¤ë¥˜ ì •ë³´: {traceback.format_exc()}")
            print(f"ìƒì„¸ ì˜¤ë¥˜ ì •ë³´: {traceback.format_exc()}")
            flash(f'{analysis_type} ë¶„ì„ ì¤‘ ì˜¤ë¥˜: {e}')
            if os.path.exists(file_path):
                os.remove(file_path)
                current_app.logger.info(f"ì„ì‹œ íŒŒì¼ ì‚­ì œ: {file_path}")
                print(f"ì„ì‹œ íŒŒì¼ ì‚­ì œ: {file_path}")
            return redirect(url_for('main.index'))
        
        current_app.logger.info(f"=== {analysis_type} ë¶„ì„ ì™„ë£Œ ===")
        print(f"=== {analysis_type} ë¶„ì„ ì™„ë£Œ ===")
        return redirect(url_for('main.results'))
        
    except Exception as e:
        current_app.logger.error(f"íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜: {e}")
        print(f"íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜: {e}")
        import traceback
        current_app.logger.error(f"ìƒì„¸ ì˜¤ë¥˜ ì •ë³´: {traceback.format_exc()}")
        print(f"ìƒì„¸ ì˜¤ë¥˜ ì •ë³´: {traceback.format_exc()}")
        flash(f'íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: {e}')
        return redirect(url_for('main.index'))

@bp.route('/health')
def health():
    try:
        # ê¸°ë³¸ ìƒíƒœ í™•ì¸
        status = {
            "status": "healthy",
            "timestamp": datetime.now().isoformat(),
            "service": "AnsimTalk AI Forensic Analysis",
            "version": "1.0.0",
            "environment": "production"
        }
        return status, 200
    except Exception as e:
        return {"status": "unhealthy", "error": str(e)}, 500

@bp.route('/')
def index():
    try:
        return render_template('index.html')
    except Exception as e:
        return f"AnsimTalk is running! Error: {str(e)}", 200

@bp.route('/analyze_deepfake', methods=['POST'])
def analyze_deepfake():
    return _handle_file_upload_and_analysis('deepfake')

@bp.route('/analyze_cyberbullying', methods=['POST'])
def analyze_cyberbullying():
    return _handle_file_upload_and_analysis('cyberbullying')

@bp.route('/results')
def results():
    analysis_result = session.get('analysis_result')
    analysis_type = session.get('analysis_type') # ë¶„ì„ íƒ€ì… ê°€ì ¸ì˜¤ê¸°
    if not analysis_result:
        flash('ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.')
        return redirect(url_for('main.index'))
    return render_template('results.html', result=analysis_result, analysis_type=analysis_type)

@bp.route('/evidence')
def evidence():
    return render_template('evidence.html')

@bp.route('/deepfake_help')
def deepfake_help():
    return render_template('deepfake_help.html')

@bp.route('/cyberbullying_help')
def cyberbullying_help():
    return render_template('cyberbullying_help.html')

@bp.route('/download_pdf')
def download_pdf():
    try:
        analysis_result = session.get('analysis_result')
        analysis_type = session.get('analysis_type') # ë¶„ì„ íƒ€ì… ê°€ì ¸ì˜¤ê¸°
        if not analysis_result:
            flash('ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.')
            return redirect(url_for('main.index'))
        
        # ì›ë³¸ ì´ë¯¸ì§€ ê²½ë¡œ ì¶”ê°€
        analysis_result['original_image_path'] = session.get('original_image_path', '')
        
        # PDF íŒŒì¼ ê²½ë¡œ ìƒì„±
        pdf_filename = f"evidence_{uuid.uuid4().hex}_{datetime.now().strftime('%Y%m%d%H%M%S')}.pdf"
        pdf_path = os.path.join(current_app.root_path, '..', 'tmp', pdf_filename)
        # PDF ìƒì„±
        generate_pdf_report(analysis_result, pdf_path, analysis_type) # analysis_type ì „ë‹¬
        print(f"Attempting to send file from: {pdf_path}")
        if not os.path.exists(pdf_path):
            print(f"Error: PDF file does not exist at {pdf_path} right before sending.")
            flash('PDF íŒŒì¼ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.')
            return redirect(url_for('main.index'))
        return send_file(pdf_path, as_attachment=True, download_name=pdf_filename)
    except Exception as e:
        flash(f'PDF ìƒì„±/ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜: {e}')
        return redirect(url_for('main.index'))

@bp.route('/reset')
def reset():
    # ì„ì‹œíŒŒì¼ ì‚­ì œ
    file_path = session.get('uploaded_file_path')
    if file_path and os.path.exists(file_path):
        os.remove(file_path)
    static_file_path = session.get('static_file_path')
    if static_file_path and os.path.exists(static_file_path):
        os.remove(static_file_path)
    
    # ì„¸ì…˜ í´ë¦¬ì–´
    session.clear()
    return redirect(url_for('main.index'))

# ============================================
# API ì—”ë“œí¬ì¸íŠ¸ (ëª¨ë°”ì¼ ì•±ìš© - JSON ì‘ë‹µ)
# ============================================

@bp.route('/api/health', methods=['GET'])
def api_health():
    """API ìƒíƒœ í™•ì¸ (JSON ì‘ë‹µ)"""
    try:
        return jsonify({
            "status": "healthy",
            "timestamp": datetime.now().isoformat(),
            "service": "AnsimTalk AI Forensic Analysis",
            "version": "1.0.0",
            "environment": "production"
        }), 200
    except Exception as e:
        return jsonify({"status": "unhealthy", "error": str(e)}), 500

@bp.route('/api/analyze_deepfake', methods=['POST'])
def api_analyze_deepfake():
    """ë”¥í˜ì´í¬ ë¶„ì„ API (JSON ì‘ë‹µ)"""
    try:
        current_app.logger.info("=== API ë”¥í˜ì´í¬ ë¶„ì„ ì‹œì‘ ===")
        
        if 'file' not in request.files:
            return jsonify({'error': 'íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.'}), 400
        
        file = request.files['file']
        
        if file.filename == '':
            return jsonify({'error': 'íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'}), 400
        
        if not allowed_file(file.filename):
            return jsonify({'error': 'í—ˆìš©ë˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤.'}), 400
        
        # íŒŒì¼ í¬ê¸° í™•ì¸
        file.seek(0, os.SEEK_END)
        file_size = file.tell()
        file.seek(0)
        
        if file_size > MAX_FILE_SIZE:
            return jsonify({'error': 'íŒŒì¼ í¬ê¸°ê°€ 5MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.'}), 400

        # íŒŒì¼ ì €ì¥
        original_filename = secure_korean_filename(file.filename)
        file_extension = original_filename.rsplit('.', 1)[1].lower()
        unique_filename = f"{uuid.uuid4().hex}_{datetime.now().strftime('%Y%m%d%H%M%S')}.{file_extension}"
        
        upload_folder = os.path.join(os.getcwd(), 'tmp')
        if not os.path.exists(upload_folder):
            os.makedirs(upload_folder)
        
        file_path = os.path.join(upload_folder, unique_filename)
        file.save(file_path)
        
        current_app.logger.info(f"íŒŒì¼ ì €ì¥ ì™„ë£Œ: {file_path}")

        # ë¶„ì„ ìˆ˜í–‰
        analysis_result = analyze_file(file_path, 'deepfake', file_extension)
        
        # íŒŒì¼ ì •ë³´ ì¶”ê°€
        file_stat = os.stat(file_path)
        analysis_result['file_info'] = {
            'filename': original_filename,
            'type': file_extension,
            'size_bytes': file_stat.st_size
        }
        analysis_result['analysis_timestamp'] = datetime.now().isoformat()
        
        # SHA-256 í•´ì‹œ
        with open(file_path, 'rb') as f:
            sha256 = hashlib.sha256(f.read()).hexdigest()
        analysis_result['sha256'] = sha256
        analysis_result['analysis_type'] = 'deepfake'
        
        current_app.logger.info("=== API ë”¥í˜ì´í¬ ë¶„ì„ ì™„ë£Œ ===")
        
        # ì„ì‹œ íŒŒì¼ ì‚­ì œ (ì„ íƒì )
        try:
            os.remove(file_path)
        except:
            pass
        
        return jsonify(analysis_result), 200
        
    except Exception as e:
        current_app.logger.error(f"API ë”¥í˜ì´í¬ ë¶„ì„ ì˜¤ë¥˜: {e}")
        import traceback
        current_app.logger.error(traceback.format_exc())
        return jsonify({'error': f'ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}'}), 500

@bp.route('/api/analyze_cyberbullying', methods=['POST'])
def api_analyze_cyberbullying():
    """ì‚¬ì´ë²„í­ë ¥ ë¶„ì„ API (JSON ì‘ë‹µ)"""
    try:
        current_app.logger.info("=== API ì‚¬ì´ë²„í­ë ¥ ë¶„ì„ ì‹œì‘ ===")
        
        if 'file' not in request.files:
            return jsonify({'error': 'íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.'}), 400
        
        file = request.files['file']
        
        if file.filename == '':
            return jsonify({'error': 'íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'}), 400
        
        if not allowed_file(file.filename):
            return jsonify({'error': 'í—ˆìš©ë˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤.'}), 400
        
        # íŒŒì¼ í¬ê¸° í™•ì¸
        file.seek(0, os.SEEK_END)
        file_size = file.tell()
        file.seek(0)
        
        if file_size > MAX_FILE_SIZE:
            return jsonify({'error': 'íŒŒì¼ í¬ê¸°ê°€ 5MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.'}), 400

        # íŒŒì¼ ì €ì¥
        original_filename = secure_korean_filename(file.filename)
        file_extension = original_filename.rsplit('.', 1)[1].lower()
        unique_filename = f"{uuid.uuid4().hex}_{datetime.now().strftime('%Y%m%d%H%M%S')}.{file_extension}"
        
        upload_folder = os.path.join(os.getcwd(), 'tmp')
        if not os.path.exists(upload_folder):
            os.makedirs(upload_folder)
        
        file_path = os.path.join(upload_folder, unique_filename)
        file.save(file_path)
        
        current_app.logger.info(f"íŒŒì¼ ì €ì¥ ì™„ë£Œ: {file_path}")

        # ë¶„ì„ ìˆ˜í–‰
        analysis_result = analyze_file(file_path, 'cyberbullying', file_extension)
        
        # íŒŒì¼ ì •ë³´ ì¶”ê°€
        file_stat = os.stat(file_path)
        analysis_result['file_info'] = {
            'filename': original_filename,
            'type': file_extension,
            'size_bytes': file_stat.st_size
        }
        analysis_result['analysis_timestamp'] = datetime.now().isoformat()
        
        # SHA-256 í•´ì‹œ
        with open(file_path, 'rb') as f:
            sha256 = hashlib.sha256(f.read()).hexdigest()
        analysis_result['sha256'] = sha256
        analysis_result['analysis_type'] = 'cyberbullying'
        
        current_app.logger.info("=== API ì‚¬ì´ë²„í­ë ¥ ë¶„ì„ ì™„ë£Œ ===")
        
        # ì„ì‹œ íŒŒì¼ ì‚­ì œ (ì„ íƒì )
        try:
            os.remove(file_path)
        except:
            pass
        
        return jsonify(analysis_result), 200
        
    except Exception as e:
        current_app.logger.error(f"API ì‚¬ì´ë²„í­ë ¥ ë¶„ì„ ì˜¤ë¥˜: {e}")
        import traceback
        current_app.logger.error(traceback.format_exc())
        return jsonify({'error': f'ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}'}), 500

@bp.route('/api/download_pdf', methods=['POST'])
def api_download_pdf():
    """PDF ìƒì„± ë° ë‹¤ìš´ë¡œë“œ API"""
    try:
        current_app.logger.info("=== API PDF ë‹¤ìš´ë¡œë“œ ì‹œì‘ ===")
        
        # JSON ë°ì´í„° ë°›ê¸°
        data = request.get_json()
        if not data or 'analysis_result' not in data:
            return jsonify({'error': 'ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.'}), 400
        
        analysis_result = data['analysis_result']
        analysis_type = data.get('analysis_type', 'deepfake')
        
        # tmp ë””ë ‰í† ë¦¬ ìƒì„±
        tmp_dir = os.path.join(os.getcwd(), 'tmp')
        if not os.path.exists(tmp_dir):
            os.makedirs(tmp_dir)
        
        # PDF íŒŒì¼ ê²½ë¡œ ìƒì„±
        pdf_filename = f"evidence_{uuid.uuid4().hex}_{datetime.now().strftime('%Y%m%d%H%M%S')}.pdf"
        pdf_path = os.path.join(tmp_dir, pdf_filename)
        
        # PDF ìƒì„±
        generate_pdf_report(analysis_result, pdf_path, analysis_type)
        
        if not os.path.exists(pdf_path):
            return jsonify({'error': 'PDF íŒŒì¼ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'}), 500
        
        current_app.logger.info(f"PDF ìƒì„± ì™„ë£Œ: {pdf_path}")
        
        # PDF íŒŒì¼ ì „ì†¡
        return send_file(
            pdf_path,
            mimetype='application/pdf',
            as_attachment=True,
            download_name=pdf_filename
        )
        
    except Exception as e:
        current_app.logger.error(f"API PDF ìƒì„± ì˜¤ë¥˜: {e}")
        import traceback
        current_app.logger.error(traceback.format_exc())
        return jsonify({'error': f'PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}'}), 500
```

---

## 5. app/services.py
ì´ íŒŒì¼ì€ ì„œë²„ì˜ í•µì‹¬ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ë‹´ë‹¹í•˜ë©°, ë”¥í˜ì´í¬ ë¶„ì„, ì‚¬ì´ë²„í­ë ¥ ë¶„ì„, PDF ìƒì„± ë“±ì˜ ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.

**ìœ„ì¹˜**: `ansimtalk (2)/app/services.py`

**ì£¼ìš” ê¸°ëŠ¥**:
- `analyze_file()`: íŒŒì¼ ë¶„ì„ ë©”ì¸ í•¨ìˆ˜ (ë”¥í˜ì´í¬/ì‚¬ì´ë²„í­ë ¥)
- `analyze_image_with_sightengine()`: Sightengine APIë¡œ ë”¥í˜ì´í¬ íƒì§€
- `extract_text_from_image()`: Google Cloud Vision APIë¡œ OCR ìˆ˜í–‰
- `analyze_text_with_gemini()`: Google Gemini APIë¡œ ì‚¬ì´ë²„í­ë ¥ ë¶„ì„
- `generate_pdf_report()`: WeasyPrintë¡œ PDF ë³´ê³ ì„œ ìƒì„±
- `_preprocess_kakao_chat_text()`: ì¹´ì¹´ì˜¤í†¡ ëŒ€í™” í…ìŠ¤íŠ¸ ì „ì²˜ë¦¬

```python
import requests
import json
from flask import current_app
import os
from PIL import Image
import hashlib
from datetime import datetime
from weasyprint import HTML
from google.cloud import vision
from google import genai
import re

def convert_markdown_table_to_html(markdown_table):
    """ë§ˆí¬ë‹¤ìš´ í‘œë¥¼ HTML í‘œë¡œ ë³€í™˜"""
    if not markdown_table.strip():
        return "<p>ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>"
    
    lines = markdown_table.strip().split('\n')
    if len(lines) < 2:
        return f"<p>í‘œ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤: {markdown_table}</p>"
    
    html_lines = ['<table class="analysis-table">']
    
    for i, line in enumerate(lines):
        line = line.strip()
        if not line.startswith('|'):
            continue
            
        # íŒŒì´í”„ ì œê±°í•˜ê³  ì…€ ë¶„ë¦¬
        cells = [cell.strip() for cell in line.split('|')[1:-1]]
        
        if i == 0:
            # í—¤ë” í–‰
            html_lines.append('  <thead>')
            html_lines.append('    <tr>')
            for cell in cells:
                html_lines.append(f'      <th>{cell}</th>')
            html_lines.append('    </tr>')
            html_lines.append('  </thead>')
            html_lines.append('  <tbody>')
        elif i == 1 and '---' in line:
            # êµ¬ë¶„ì„  í–‰ì€ ê±´ë„ˆë›°ê¸°
            continue
        else:
            # ë°ì´í„° í–‰
            html_lines.append('    <tr>')
            for j, cell in enumerate(cells):
                # ìœ„í—˜ë„ì— ë”°ë¥¸ CSS í´ë˜ìŠ¤ ì¶”ê°€
                if j == 4:  # ìœ„í—˜ë„ ì»¬ëŸ¼ (5ë²ˆì§¸)
                    risk_class = get_risk_class(cell)
                    html_lines.append(f'      <td class="{risk_class}">{cell}</td>')
                else:
                    html_lines.append(f'      <td>{cell}</td>')
            html_lines.append('    </tr>')
    
    html_lines.append('  </tbody>')
    html_lines.append('</table>')
    
    result = '\n'.join(html_lines)
    print(f"ë³€í™˜ëœ HTML í…Œì´ë¸”: {result[:300]}...")
    return result

def get_risk_class(risk_text):
    """ìœ„í—˜ë„ í…ìŠ¤íŠ¸ì— ë”°ë¥¸ CSS í´ë˜ìŠ¤ ë°˜í™˜"""
    risk_text = risk_text.strip().lower()
    if 'ì‹¬ê°' in risk_text:
        return 'risk-severe'
    elif 'ìˆìŒ' in risk_text:
        return 'risk-present'
    elif 'ì•½ê°„' in risk_text:
        return 'risk-slight'
    elif 'ì˜ì‹¬' in risk_text:
        return 'risk-suspicion'
    elif 'ì—†ìŒ' in risk_text:
        return 'risk-none'
    else:
        return ''

def get_image_metadata(filepath):
    try:
        img = Image.open(filepath)
        metadata = {
            "format": img.format,
            "mode": img.mode,
            "size": img.size, # (width, height)
            "info": img.info # Exif data, etc.
        }
        return metadata
    except Exception as e:
        return {"error": f"ë©”íƒ€ë°ì´í„° ì¶”ì¶œ ì‹¤íŒ¨: {e}"}

def analyze_file(file_path, analysis_type, file_extension):
    with open(file_path, 'rb') as f:
        sha256 = hashlib.sha256(f.read()).hexdigest()
    
    # íŒŒì¼ëª… ì²˜ë¦¬ (í•œê¸€ ì§€ì›)
    try:
        filename = os.path.basename(file_path)
    except UnicodeDecodeError:
        # í•œê¸€ íŒŒì¼ëª… ì²˜ë¦¬ ì˜¤ë¥˜ ì‹œ ëŒ€ì²´ ë°©ë²•
        filename = os.path.basename(file_path).encode('utf-8', errors='replace').decode('utf-8')
    
    result = {
        'file_info': {
            'filename': filename,
            'type': file_extension,
            'size_bytes': os.path.getsize(file_path),
            'sha256': sha256
        },
        'analysis_timestamp': datetime.now().isoformat(),
        'sha256': sha256,
        'analysis_type': analysis_type # Add analysis_type to result
    }

    if analysis_type == 'deepfake':
        if file_extension in {'png', 'jpg', 'jpeg'}:
            result['deepfake_analysis'] = analyze_image_with_sightengine(file_path)
            # For deepfake analysis, we might still want to extract text if present
            extracted_text = extract_text_from_image(file_path)
            if extracted_text.strip():
                result['extracted_text'] = extracted_text
        else:
            result['error'] = 'ë”¥í˜ì´í¬ ë¶„ì„ì€ ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì§€ì›í•©ë‹ˆë‹¤.'

    elif analysis_type == 'cyberbullying':
        if file_extension in {'png', 'jpg', 'jpeg'}:
            extracted_text = extract_text_from_image(file_path)
            # ì¹´í†¡ OCR ì „ì²˜ë¦¬ë¡œ 'ë°œí™”ì: ë‚´ìš©' ì¬êµ¬ì„±
            if extracted_text and not extracted_text.startswith('['):
                extracted_text = _preprocess_kakao_chat_text(extracted_text)
        if file_extension in {'png', 'jpg', 'jpeg'}:
            extracted_text = extract_text_from_image(file_path)
            if extracted_text and not extracted_text.startswith('['):
                extracted_text = _preprocess_kakao_chat_text(extracted_text)
            if extracted_text.strip():
                gemini_result = analyze_text_with_gemini(extracted_text)
                result['extracted_text'] = extracted_text
                result['cyberbullying_analysis'] = gemini_result.get('table', '')
                result['cyberbullying_analysis_summary'] = gemini_result.get('summary', '')
                result['cyberbullying_risk_line'] = extract_risk_line(gemini_result.get('summary', ''))
            else:
                result['error'] = 'ì´ë¯¸ì§€ì—ì„œ í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
        elif file_extension == 'txt':
            # í•œê¸€ í…ìŠ¤íŠ¸ íŒŒì¼ ì½ê¸° (ë‹¤ì–‘í•œ ì¸ì½”ë”© ì§€ì›)
            try:
                with open(file_path, 'r', encoding='utf-8') as f:
                    text = f.read()
            except UnicodeDecodeError:
                # UTF-8 ì‹¤íŒ¨ ì‹œ ë‹¤ë¥¸ ì¸ì½”ë”© ì‹œë„
                try:
                    with open(file_path, 'r', encoding='cp949') as f:
                        text = f.read()
                except UnicodeDecodeError:
                    with open(file_path, 'r', encoding='utf-8', errors='replace') as f:
                        text = f.read()
            # TXTë„ ì¹´í†¡ í¬ë§·ì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë™ì¼ ì „ì²˜ë¦¬ ì ìš©
            normalized = _preprocess_kakao_chat_text(text)
            gemini_result = analyze_text_with_gemini(normalized)
            result['extracted_text'] = normalized
            result['cyberbullying_analysis'] = gemini_result.get('table', '')
            result['cyberbullying_analysis_summary'] = gemini_result.get('summary', '')
            result['cyberbullying_risk_line'] = extract_risk_line(gemini_result.get('summary', ''))
        else:
            result['error'] = 'ì‚¬ì´ë²„í­ë ¥ ë¶„ì„ì€ í…ìŠ¤íŠ¸ ë˜ëŠ” ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì§€ì›í•©ë‹ˆë‹¤.'
    else:
        result['error'] = 'ì•Œ ìˆ˜ ì—†ëŠ” ë¶„ì„ íƒ€ì…ì…ë‹ˆë‹¤.'

    return result

def analyze_image_with_sightengine(file_path):
    api_user = current_app.config['SIGHTENGINE_API_USER']
    api_secret = current_app.config['SIGHTENGINE_API_SECRET']
    url = 'https://api.sightengine.com/1.0/check.json'
    files = {'media': open(file_path, 'rb')}
    params = {
        'models': 'deepfake,offensive,nudity,wad',
        'api_user': api_user,
        'api_secret': api_secret
    }
    try:
        response = requests.post(url, files=files, data=params)
        response.raise_for_status()
        result = response.json()
        
        # ë””ë²„ê¹…ì„ ìœ„í•œ ë¡œê·¸ ì¶œë ¥
        print(f"Sightengine API ì‘ë‹µ: {result}")
        
        return result
    except Exception as e:
        print(f"Sightengine API ì˜¤ë¥˜: {e}")
        return {'error': str(e)}
    finally:
        files['media'].close()

def extract_text_from_image(image_path):
    # Railway í™˜ê²½ì—ì„œ í™˜ê²½ ë³€ìˆ˜ë¡œ ì„¤ì •ëœ ì„œë¹„ìŠ¤ ê³„ì • í‚¤ ì‚¬ìš©
    import json
    from google.oauth2 import service_account
    
    try:
        # í™˜ê²½ ë³€ìˆ˜ì—ì„œ ì„œë¹„ìŠ¤ ê³„ì • í‚¤ JSON ê°€ì ¸ì˜¤ê¸°
        service_account_info = os.environ.get('GOOGLE_SERVICE_ACCOUNT_JSON')
        if service_account_info:
            # JSON ë¬¸ìì—´ì„ íŒŒì‹±í•˜ì—¬ ì„œë¹„ìŠ¤ ê³„ì • ì •ë³´ ìƒì„±
            service_account_dict = json.loads(service_account_info)
            credentials = service_account.Credentials.from_service_account_info(service_account_dict)
            client = vision.ImageAnnotatorClient(credentials=credentials)
        else:
            # ê¸°ì¡´ ë°©ì‹ (ë¡œì»¬ íŒŒì¼)
            credentials_path = current_app.config['GOOGLE_APPLICATION_CREDENTIALS']
            if os.path.exists(credentials_path):
                os.environ["GOOGLE_APPLICATION_CREDENTIALS"] = credentials_path
                client = vision.ImageAnnotatorClient()
            else:
                print("Google Cloud ì¸ì¦ ì •ë³´ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤")
                return "[Google Cloud ì¸ì¦ ì •ë³´ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.]"
        
        with open(image_path, "rb") as image_file:
            content = image_file.read()
        image = vision.Image(content=content)
        response = client.text_detection(image=image)
        texts = response.text_annotations
        if not texts:
            return ""
        return texts[0].description.strip()
    except Exception as e:
        print(f"Google Cloud Vision API ì˜¤ë¥˜: {e}")
        return f"[Google Cloud Vision API ì˜¤ë¥˜: {e}]"

def _preprocess_kakao_chat_text(raw_text: str) -> str:
    """ì¹´ì¹´ì˜¤í†¡ OCR í…ìŠ¤íŠ¸ë¥¼ ë¶„ì„ ì¹œí™”ì ìœ¼ë¡œ ì •ê·œí™”í•˜ì—¬
    ê° ë°œí™”ë¥¼ 'ì´ë¦„: ë‚´ìš©' ë‹¨ì¼ í–‰ìœ¼ë¡œ ì¬êµ¬ì„±í•œë‹¤.

    ê·œì¹™:
    - ì‹œê°„/ë‚ ì§œ/ì‹œìŠ¤í…œ ë¼ì¸ ì œê±°
    - ë‹¨ë… ì´ë¦„ ë¼ì¸ + ë‹¤ìŒ ë‚´ìš© ë¼ì¸ì„ ë³‘í•©í•˜ì—¬ 'ì´ë¦„: ë‚´ìš©'
    - ì´ë¦„ì„ ì•Œ ìˆ˜ ì—†ìœ¼ë©´ '-: ë‚´ìš©'
    - ì…€ ë‚´ë¶€ ê°œí–‰ì„ ìµœì†Œí™”í•˜ê¸° ìœ„í•´ ì—°ì† ê³µë°±ì„ 1ì¹¸ìœ¼ë¡œ ì •ê·œí™”
    """
    if not raw_text:
        return ""

    # íŒ¨í„´ ì •ì˜
    time_pattern = re.compile(r'^(?:ì˜¤ì „|ì˜¤í›„)\s?\d{1,2}:\d{2}$')
    date_time_pattern = re.compile(r'^\d{4}[./-]\s?\d{1,2}[./-]\s?\d{1,2}(?:\s+(?:ì˜¤ì „|ì˜¤í›„)\s?\d{1,2}:\d{2})?$')
    # ëª…ì‹œì  ì¡ìŒë§Œ ì œê±° (ì—­í• ëª…ì€ ì œê±°í•˜ì§€ ì•ŠìŒ)
    noise_exact = {"ì‚¬ì§„", "ì´ëª¨í‹°ì½˜"}
    possible_name_pattern = re.compile(r'^[ê°€-í£A-Za-z0-9_]{1,16}$')

    lines = [ln.strip() for ln in raw_text.splitlines()]
    processed: list[str] = []
    pending_speaker: str | None = None

    for ln in lines:
        if not ln:
            continue
        # ì‹œê°„/ë‚ ì§œ ë¼ì¸ ì œê±°
        if time_pattern.match(ln) or date_time_pattern.match(ln):
            continue
        # ëª…í™•í•œ ì¡ìŒ ë¼ì¸ ì œê±°
        if ln in noise_exact:
            continue
        # ë„ˆë¬´ ì§§ì€ í•œ ê¸€ì ì¡ìŒ ì œê±°
        if len(ln) == 1 and ln in {"-", ".", ","}:
            continue
        # ì´ë¯¸ 'ì´ë¦„: ë‚´ìš©' í˜•íƒœë©´ ê·¸ëŒ€ë¡œ ë°˜ì˜
        if ':' in ln and not ln.endswith(':'):
            # ì „ê° ì½œë¡  ë“±ì€ ASCII ì½œë¡ ìœ¼ë¡œ í†µì¼
            ln = ln.replace('ï¼š', ':')
            # ë‹¤ì¤‘ ì½œë¡ ì€ ì²« ì½œë¡ ë§Œ ë¶„ë¦¬í•˜ì—¬ ì´ë¦„: ë‚´ìš© ë³´ì¥
            parts = ln.split(':', 1)
            speaker = parts[0].strip()
            content = parts[1].strip()
            if not speaker:
                speaker = '-'
            if not content:
                continue
            processed.append(f"{speaker}: {re.sub(r'\s+', ' ', content)}")
            pending_speaker = None
            continue

        # ì´ë¦„ í›„ë³´ë§Œ ìˆëŠ” ë¼ì¸ ê°ì§€
        if possible_name_pattern.match(ln):
            pending_speaker = ln
            continue

        # ì¼ë°˜ ë‚´ìš© ë¼ì¸
        content = re.sub(r'\s+', ' ', ln)
        if pending_speaker:
            processed.append(f"{pending_speaker}: {content}")
            pending_speaker = None
        else:
            processed.append(f"-: {content}")

    # ì”ì—¬ ëŒ€ê¸° ì´ë¦„ ì œê±°
    return "\n".join(processed)

def analyze_text_with_gemini(text_content):
    # Railway í™˜ê²½ì—ì„œ í™˜ê²½ ë³€ìˆ˜ë¡œ ì„¤ì •ëœ ì„œë¹„ìŠ¤ ê³„ì • í‚¤ ì‚¬ìš©
    import json
    from google.oauth2 import service_account
    
    try:
        # 1) API Key ìš°ì„  ì‚¬ìš© (Vertex ì„¤ì •/ê²°ì œ ì—†ì´ ë™ì‘ ê°€ëŠ¥)
        raw_key = os.environ.get('GOOGLE_GEMINI_API_KEY') or current_app.config.get('GOOGLE_GEMINI_API_KEY')
        api_key = raw_key.strip() if isinstance(raw_key, str) else None
        # í”í•œ placeholder/ë¬´íš¨ í‚¤ íŒ¨í„´ ì°¨ë‹¨
        if api_key and (api_key.lower().startswith('your-') or api_key.lower().startswith('aizasy') or api_key.endswith('-lo') or len(api_key) < 25):
            print(f"ë¬´íš¨í•œ Gemini API Key íŒ¨í„´ ê°ì§€ (ê¸¸ì´: {len(api_key)}, ì‹œì‘: {api_key[:10]}...) â†’ Vertex ê²½ë¡œ ì‹œë„")
            api_key = None
        
        # API Key ëª¨ë“œ ì‹œë„ (ìœ íš¨ì„± ë¯¸ë¦¬ ê²€ì¦ ë¶ˆê°€í•˜ë¯€ë¡œ Vertex ê²½ë¡œë„ ì¤€ë¹„)
        client_initialized = False
        if api_key:
            try:
                client = genai.Client(api_key=api_key)
                print(f"Gemini Client ì´ˆê¸°í™”: API Key ëª¨ë“œ (í‚¤ ê¸¸ì´: {len(api_key)})")
                client_initialized = True
            except Exception as key_err:
                print(f"API Key ëª¨ë“œ ì´ˆê¸°í™” ì‹¤íŒ¨: {key_err} â†’ Vertex ê²½ë¡œë¡œ ì „í™˜")
                api_key = None
        
        if not client_initialized:
            # í™˜ê²½ ë³€ìˆ˜ì—ì„œ ì„œë¹„ìŠ¤ ê³„ì • í‚¤ JSON ê°€ì ¸ì˜¤ê¸°
            service_account_info = os.environ.get('GOOGLE_SERVICE_ACCOUNT_JSON')
            if service_account_info:
                # JSON ë¬¸ìì—´ì„ íŒŒì‹±í•˜ì—¬ ì„œë¹„ìŠ¤ ê³„ì • ì •ë³´ ìƒì„±
                service_account_dict = json.loads(service_account_info)
                
                # ëª…ì‹œì  ë²”ìœ„ ì§€ì • - ì´ê²ƒì´ í•µì‹¬ í•´ê²°ì±…!
                scopes = ["https://www.googleapis.com/auth/cloud-platform"]
                credentials = service_account.Credentials.from_service_account_info(
                    service_account_dict,
                    scopes=scopes
                )
                
                project_id = service_account_dict.get('project_id') or current_app.config.get('GCP_PROJECT') or 'us-central1'
                location = os.environ.get('GEMINI_LOCATION', 'us-central1')
                client = genai.Client(
                    vertexai=True,
                    project=project_id,
                    location=location,
                    credentials=credentials
                )
                print(f"Vertex ëª¨ë“œ: project={project_id}, location={location} (ì„œë¹„ìŠ¤ ê³„ì •/ëª…ì‹œì  ë²”ìœ„)")
            else:
                # ê¸°ì¡´ ë°©ì‹ (ë¡œì»¬ íŒŒì¼)
                credentials_path = current_app.config['GOOGLE_APPLICATION_CREDENTIALS']
                if os.path.exists(credentials_path):
                    # ë¡œì»¬ íŒŒì¼ì—ì„œë„ ëª…ì‹œì  ë²”ìœ„ ì§€ì •
                    scopes = ["https://www.googleapis.com/auth/cloud-platform"]
                    credentials = service_account.Credentials.from_service_account_file(
                        credentials_path,
                        scopes=scopes
                    )
                    # íŒŒì¼ì—ì„œ project_id ìœ ë„
                    try:
                        with open(credentials_path, 'r', encoding='utf-8') as _f:
                            _cred_json = json.load(_f)
                            project_id = _cred_json.get('project_id')
                    except Exception:
                        project_id = current_app.config.get('GCP_PROJECT')
                    if not project_id:
                        project_id = 'dazzling-howl-465316-m7'
                    location = os.environ.get('GEMINI_LOCATION', 'us-central1')
                    client = genai.Client(
                        vertexai=True,
                        project=project_id,
                        location=location,
                        credentials=credentials
                    )
                    print(f"Vertex ëª¨ë“œ(ë¡œì»¬ í‚¤): project={project_id}, location={location}, key={os.path.basename(credentials_path)}")
                else:
                    print("Google Cloud ì¸ì¦ ì •ë³´ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤")
                    print(f"í™˜ê²½ ë³€ìˆ˜ GOOGLE_SERVICE_ACCOUNT_JSON: {'ì„¤ì •ë¨' if os.environ.get('GOOGLE_SERVICE_ACCOUNT_JSON') else 'ì„¤ì •ë˜ì§€ ì•ŠìŒ'}")
                    print(f"ë¡œì»¬ íŒŒì¼ ê²½ë¡œ: {credentials_path}")
                    return {"table": '', "summary": 'Google Cloud ì¸ì¦ ì •ë³´ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.'}
    except Exception as e:
        print(f"Google Cloud ì¸ì¦ ì„¤ì • ì˜¤ë¥˜: {e}")
        return {"table": '', "summary": f'Google Cloud ì¸ì¦ ì„¤ì • ì˜¤ë¥˜: {e}'}
    
    # ëª¨ë¸: Gemini 2.5 Flash (ê³µì‹ ë¬¸ì„œ ê¸°ì¤€ ìµœì‹  í”Œë˜ì‹œ ê³„ì—´)
    # ì°¸ê³ : https://ai.google.dev/gemini-api/docs/models?hl=ko
    model = "gemini-2.5-flash"
    # ë°œí™”ì ì´ë¦„ì—ì„œ ì—­í•  íŒíŠ¸ ì¶”ì¶œ
    speakers = set([ln.split(':',1)[0].strip() for ln in _preprocess_kakao_chat_text(text_content).split('\n') if ':' in ln])
    role_hints = []
    for sp in speakers:
        if re.search(r'ê°€í•´ì|ì£¼ë™ì', sp):
            role_hints.append(f"{sp} ëŠ” ê°€í•´ì/ì£¼ë™ìì¼ ê°€ëŠ¥ì„±ì´ í¼")
        if re.search(r'í”¼í•´ì', sp):
            role_hints.append(f"{sp} ëŠ” í”¼í•´ìì¼ ê°€ëŠ¥ì„±ì´ í¼")
    hints_text = "\n".join(role_hints) if role_hints else "(ì—­í•  íŒíŠ¸ ì—†ìŒ)"

    prompt = f"""
# í˜ë¥´ì†Œë‚˜ (Persona)
ë‹¹ì‹ ì€ ì‚¬ì´ë²„í­ë ¥ ë¶„ì„ì„ ì „ë¬¸ìœ¼ë¡œ í•˜ëŠ” AI ì• ë„ë¦¬ìŠ¤íŠ¸ì…ë‹ˆë‹¤. ì£¼ì–´ì§„ ëŒ€í™” ë‚´ìš©ì„ ë¬¸ì¥ ë‹¨ìœ„ë¡œ ì •ë°€í•˜ê²Œ ë¶„ì„í•˜ì—¬ í­ë ¥ì„±, ìœ í˜•, ê°€í•´ì, í”¼í•´ì, ìœ„í—˜ë„ë¥¼ íŒë³„í•˜ëŠ” ì„ë¬´ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤. ëª¨ë“  ë‹µë³€ì€ ìš”ì²­ëœ í˜•ì‹ì— ë”°ë¼ ë§¤ìš° ì—„ê²©í•˜ê²Œ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.

# ë¶„ì„ ëŒ€ìƒ ëŒ€í™”
[ {text_content} ]

# ì—­í•  íŒíŠ¸ (ì°¸ê³ ìš©, í…ìŠ¤íŠ¸ì™€ ë¶ˆì¼ì¹˜ì‹œ í…ìŠ¤íŠ¸ ìš°ì„ ):
{hints_text}

# ì¶œë ¥ í˜•ì‹ (Output Format)
ì•„ë˜ ê·œì¹™ì„ ë°˜ë“œì‹œ, 100% ì¤€ìˆ˜í•˜ì—¬ ê²°ê³¼ë¥¼ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤.

1.  **ê²°ê³¼ëŠ” ë°˜ë“œì‹œ ë§ˆí¬ë‹¤ìš´ í‘œ(Markdown Table)ë¡œ ì‹œì‘**í•´ì•¼ í•©ë‹ˆë‹¤.
2.  í‘œì˜ ìœ„ë‚˜ ì•„ë˜ì— ì œëª©, ì½”ë“œ ë¸”ë¡, ì„¤ëª… ë“± **ì–´ë– í•œ ë‹¤ë¥¸ í…ìŠ¤íŠ¸ë„ ì¶”ê°€í•˜ì§€ ë§ˆì„¸ìš”.**
3.  í‘œì˜ ì—´(Column)ì€ `ë¬¸ì¥`, `ìœ í˜•`, `í”¼í•´ì`, `ê°€í•´ì`, `ìœ„í—˜ë„`, `í•´ì„¤` ìˆœì„œì—¬ì•¼ í•˜ë©°, **ì ˆëŒ€ ìˆœì„œë¥¼ ë°”ê¾¸ê±°ë‚˜ í•©ì¹˜ì§€ ë§ˆì„¸ìš”.**
4.  `ë¬¸ì¥`ì€ ë°˜ë“œì‹œ `ë°œí™”ì: ë‚´ìš©` í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”. ë°œí™”ì ì •ë³´ê°€ ì—†ìœ¼ë©´ `-: ë‚´ìš©`ìœ¼ë¡œ ì‘ì„±í•©ë‹ˆë‹¤. ì¹´ì¹´ì˜¤í†¡ ëŒ€í™”ì²˜ëŸ¼ ë°œí™”ì(ì´ë¦„/ë‹‰ë„¤ì„)ê³¼ ë©”ì‹œì§€ ë‚´ìš©ì„ `:`ë¡œ ì—°ê²°í•©ë‹ˆë‹¤. ì „ê° ë¬¸ìê°€ ì•„ë‹Œ ASCII ì½œë¡  `:`ë§Œ ì‚¬ìš©í•˜ì„¸ìš”.
5.  ëª¨ë“  ì…€ì—ëŠ” **ì¤„ë°”ê¿ˆì„ ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”**. ì…€ ë‚´ë¶€ ê°œí–‰(`\n`), íŒŒì´í”„(`|`), ë°±í‹±, ì½”ë“œë¸”ë¡ í‘œì‹œëŠ” ê¸ˆì§€í•©ë‹ˆë‹¤. ì¤„ë°”ê¿ˆì´ í•„ìš”í•œ ê²½ìš° **ê³µë°± í•˜ë‚˜**ë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤.
6.  `ìœ í˜•`ì€ `ìš•ì„¤`, `ë¹„í•˜`, `ëª¨ìš•`, `ë”°ëŒë¦¼`, `ìœ„í˜‘`, `ê´´ë¡­í˜` ì¤‘ì—ì„œë§Œ ì„ íƒí•˜ê³ , í•´ë‹¹ ì—†ìœ¼ë©´ `-`ë¡œ í‘œê¸°í•˜ì„¸ìš”.
7.  `ìœ„í—˜ë„`ëŠ” `ì—†ìŒ`, `ì˜ì‹¬`, `ì•½ê°„ ìˆìŒ`, `ìˆìŒ`, `ì‹¬ê°` ì¤‘ì—ì„œë§Œ ì„ íƒí•˜ì„¸ìš”.
8.  `í•´ì„¤`ì€ íŒë‹¨ ê·¼ê±°ë¥¼ **í•œ ì¤„ë¡œ** ê°„ê²°í•˜ê²Œ ìš”ì•½í•˜ì„¸ìš”. ì‚¬ë¡€/ê·¼ê±°ë¥¼ ì‰¼í‘œë¡œ ë‚˜ì—´í•˜ë˜ ì¤„ë°”ê¿ˆì€ ê¸ˆì§€í•©ë‹ˆë‹¤.
9.  **í‘œ ë°”ë¡œ ì•„ë˜ì—ëŠ” ë‹¤ìŒ ì„¸ ê°€ì§€ í•­ëª©ì„ ìˆœì„œëŒ€ë¡œ, ì •í™•í•œ ë¬¸êµ¬ë¡œ ì‘ì„±**í•´ì•¼ í•©ë‹ˆë‹¤. ê° í•­ëª© ì•ì—ëŠ” ì¤„ë°”ê¿ˆ í•œ ë²ˆë§Œ í—ˆìš©í•©ë‹ˆë‹¤.
    * `ì „ì²´ ëŒ€í™” ì‚¬ì´ë²„í­ë ¥ ìœ„í—˜ë„:` [ì—†ìŒ/ì˜ì‹¬/ì•½ê°„ ìˆìŒ/ìˆìŒ/ì‹¬ê°] ì¤‘ í•˜ë‚˜ë¡œ ê²°ë¡ 
    * `ëŒ€í™” ì „ì²´ ë¶„ìœ„ê¸° ìš”ì•½:` 2~3ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½ (ì¤„ë°”ê¿ˆ ì—†ì´ í•œ ì¤„)
    * `ì ì¬ì  ìœ„í—˜/ì£¼ì˜ì‚¬í•­:` êµ¬ì²´ì ì¸ ë‚´ìš© ì„œìˆ  (ì¤„ë°”ê¿ˆ ì—†ì´ í•œ ì¤„)

# ë°œí™”ì/ì—­í•  ì¶”ì • ê·œì¹™ (ì—„ê²© ì ìš©)
1) ë°œí™”ìëª…ì— `ê°€í•´ì`, `ì£¼ë™ì`ê°€ í¬í•¨ë˜ë©´ ê·¸ ì‚¬ëŒì€ ê°€í•´ì.
2) ë°œí™”ìëª…ì— `í”¼í•´ì`ê°€ í¬í•¨ë˜ë©´ í”¼í•´ì.
3) ë°œí™”ìëª…ì´ `-`(ë¯¸í™•ì •)ì¸ ê²½ìš° ê¸°ë³¸ì ìœ¼ë¡œ í”¼í•´ì(ì¶”ì •)ë¡œ ê°„ì£¼í•˜ë˜, ë¬¸ë§¥ì´ ëª…ë°±íˆ ê³µê²©/ê°•ìš”/ì¡°ë¡±ì´ë©´ ê°€í•´ìë¡œ í‘œê¸°.
4) ë‹¤ìŒ í‘œí˜„ì€ í”¼í•´ì ë‹¨ì„œ: `ë‚´ëˆ`, `ì‹«ì€ë°`, `ì•Œê² ì–´`, `ì‚¬ì¤„ê²Œ`, `ì•ˆë¼`, `ë¬´ì„œì›Œ`, `ê·¸ë§Œ`.
5) ë‹¤ìŒ í‘œí˜„ì€ ê°€í•´ì ë‹¨ì„œ: `ë‚´ê°€ í•˜ë¼ë©´ í•´`, `ì‚¬ì™€`, `ì‚¬ì¤˜`, `ëˆ`, `ë¹¨ë¦¬`, `ì‹œí‚¤ëŠ” ëŒ€ë¡œ`, `ë§ ì•ˆë“£ë„¤`.
6) ê¸ˆì „/ë¬¼í’ˆ ê°•ìš”(`ì‚¬ì™€/ì‚¬ì¤˜/ë‚´ê°€ ì‹œí‚¨ ëŒ€ë¡œ` ë“±)ì™€ ëª¨ìš•/ì¡°ë¡±/í˜‘ë°•ì€ ê°ê° `ê´´ë¡­í˜`, `ëª¨ìš•`, `ìœ„í˜‘`ìœ¼ë¡œ ë¶„ë¥˜.
7) í‘œì˜ `í”¼í•´ì`, `ê°€í•´ì` ì—´ì—ëŠ” ì´ë¦„(ë˜ëŠ” `í”¼í•´ì(ì¶”ì •)`, `ê°€í•´ì(ì¶”ì •)`)ì„ ëª…ì‹œ.

# ì¶œë ¥ ì˜ˆì‹œ (Example)
ì•„ë˜ëŠ” ë‹¹ì‹ ì´ ë”°ë¼ì•¼ í•  ì™„ë²½í•œ ì¶œë ¥ ì˜ˆì‹œì…ë‹ˆë‹¤. ë„ì–´ì“°ê¸°, ì¤„ ë°”ê¿ˆê¹Œì§€ ì •í™•íˆ ì¼ì¹˜ì‹œì¼œì•¼ í•©ë‹ˆë‹¤.

| ë¬¸ì¥ | ìœ í˜• | í”¼í•´ì | ê°€í•´ì | ìœ„í—˜ë„ | í•´ì„¤ |
| :--- | :--- | :--- | :--- | :--- | :--- |
| ë„ˆ ë•Œë¬¸ì— ë‹¤ ë§í–ˆì–´ | ë¹„í•˜ | ë¯¼ìˆ˜ | ì² ìˆ˜ | ìˆìŒ | íŠ¹ì •ì¸ì˜ íƒ“ìœ¼ë¡œ ëŒë¦¬ë©° ë¹„ë‚œí•˜ëŠ” ë°œì–¸ |
| ê·¸ëŸ° ì• ë‘ ë§ ì„ì§€ ë§ˆ | ë”°ëŒë¦¼ | ë¯¼ìˆ˜ | ì² ìˆ˜ | ì‹¬ê° | ê´€ê³„ì—ì„œ ëª…ì‹œì ìœ¼ë¡œ ë°°ì œí•˜ë ¤ëŠ” ì˜ë„ë¥¼ ë³´ì„ |
| ê·¸ëƒ¥ ì‚¬ë¼ì ¸ ë²„ë ¤ | ìœ„í˜‘ | ë¯¼ìˆ˜ | ì² ìˆ˜ | ì‹¬ê° | ê·¹ë‹¨ì ì¸ ì–¸ì–´ë¡œ ê³µí¬ì‹¬ì„ ìœ ë°œí•˜ëŠ” ë°œì–¸ |

ì „ì²´ ëŒ€í™” ì‚¬ì´ë²„í­ë ¥ ìœ„í—˜ë„: ì‹¬ê°

ëŒ€í™” ì „ì²´ ë¶„ìœ„ê¸° ìš”ì•½: í•œ ëª…ì„ ëŒ€ìƒìœ¼ë¡œ ì—¬ëŸ¬ ëª…ì´ ë¹„ë‚œê³¼ ë”°ëŒë¦¼, ìœ„í˜‘ì ì¸ ë°œì–¸ì„ ì´ì–´ê°€ê³  ìˆìŠµë‹ˆë‹¤. ëŒ€í™”ê°€ ì§„í–‰ë ìˆ˜ë¡ ê³µê²©ì˜ ìˆ˜ìœ„ê°€ ë†’ì•„ì§€ëŠ” ì–‘ìƒì…ë‹ˆë‹¤.

ì ì¬ì  ìœ„í—˜/ì£¼ì˜ì‚¬í•­: ì§ì ‘ì ì¸ ìœ„í˜‘ê³¼ ì‚¬íšŒì  ë°°ì œëŠ” í”¼í•´ìì—ê²Œ ì‹¬ê°í•œ ì •ì‹ ì  ê³ í†µì„ ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¦‰ê°ì ì¸ ê°œì…ê³¼ ë³´í˜¸ ì¡°ì¹˜ê°€ í•„ìš”í•œ ìƒí™©ì…ë‹ˆë‹¤.
"""
    try:
        print(f"========== Gemini API í˜¸ì¶œ ì‹œì‘ ==========")
        print(f"ëª¨ë¸: {model}")
        print(f"Client íƒ€ì…: {type(client).__name__}")
        print(f"í”„ë¡¬í”„íŠ¸ ê¸¸ì´: {len(prompt)} ë¬¸ì")
        response = client.models.generate_content(
            model=model,
            contents=prompt
        )
        result_text = response.text.strip()
        print(f"========== Gemini API í˜¸ì¶œ ì„±ê³µ! ==========")
        print(f"ì‘ë‹µ ê¸¸ì´: {len(result_text)} ë¬¸ì")
        # í‘œì™€ í‘œ ì•„ë˜ 3ì¤„ ë¶„ë¦¬
        lines = result_text.splitlines()
        table_lines = []
        summary_lines = []
        in_table = False
        
        for line in lines:
            s = line.strip()
            # í‘œ ì‹œì‘ ì¡°ê±´ì„ ì™„í™”: íŒŒì´í”„(|)ë¡œ ì‹œì‘í•˜ë©´ í‘œë¡œ ì¸ì‹
            if s.startswith("|"):
                in_table = True
            if in_table:
                if s == '' and table_lines:
                    in_table = False
                elif s.startswith("|"):
                    # ì…€ ë‚´ë¶€ ê°œí–‰ì´ ìˆì—ˆë‹¤ë©´ ê³µë°± í•˜ë‚˜ë¡œ ì •ê·œí™”í•˜ì—¬ ë‹¨ì¼ í–‰ ìœ ì§€
                    table_lines.append(s.replace("\t", " "))
                else:
                    in_table = False
            elif table_lines and not in_table:
                if s:
                    summary_lines.append(s)
        
        table = "\n".join(table_lines)
        summary_raw = "\n".join(summary_lines).strip()
        
        # ê° í•­ëª© ì•ì— ë¹ˆ ì¤„ì„ ê°•ì œë¡œ ì‚½ì…
        summary = re.sub(r'(ì „ì²´ ëŒ€í™” ì‚¬ì´ë²„í­ë ¥ ìœ„í—˜ë„:)', r'\n\1', summary_raw)
        summary = re.sub(r'(ëŒ€í™” ì „ì²´ ë¶„ìœ„ê¸° ìš”ì•½:)', r'\n\1', summary)
        summary = re.sub(r'(ì ì¬ì  ìœ„í—˜/ì£¼ì˜ì‚¬í•­:)', r'\n\1', summary)
        summary = summary.strip()
        # ì—°ì†ëœ \n 2ê°œë¥¼ \n\nìœ¼ë¡œ ì •ê·œí™”
        summary = re.sub(r'\n{2,}', '\n\n', summary)
        
        # ë§ˆí¬ë‹¤ìš´ í‘œë¥¼ HTMLë¡œ ë³€í™˜
        html_table = convert_markdown_table_to_html(table)
        
        return {"table": html_table, "summary": summary}
    except Exception as e:
        print(f"========== Gemini API í˜¸ì¶œ ì‹¤íŒ¨ ==========")
        print(f"ì˜¤ë¥˜ íƒ€ì…: {type(e).__name__}")
        print(f"ì˜¤ë¥˜ ë©”ì‹œì§€: {e}")
        import traceback
        error_detail = traceback.format_exc()
        print(f"ìƒì„¸ ì˜¤ë¥˜:\n{error_detail}")
        print("========== Fallback ë¶„ì„ìœ¼ë¡œ ì „í™˜ ==========")
        # API ì˜¤ë¥˜ ì‹œ ëŒ€ì²´ ë¶„ì„ ì œê³µ
        fb = _fallback_cyberbullying_analysis(text_content)
        fb['fallback_used'] = True
        fb['error'] = f"{type(e).__name__}: {str(e)}"
        fb['error_detail'] = error_detail
        return fb

def _fallback_cyberbullying_analysis(text_content):
    """Gemini API ì‹¤íŒ¨ ì‹œ ëŒ€ì²´ ì‚¬ì´ë²„í­ë ¥ ë¶„ì„"""
    print(f"ëŒ€ì²´ ì‚¬ì´ë²„í­ë ¥ ë¶„ì„ ì‹œì‘: {text_content[:100]}...")
    
    try:
        # ë” ì •êµí•œ í‚¤ì›Œë“œ ê¸°ë°˜ ë¶„ì„
        text_lower = text_content.lower()
        
        # ìœ„í—˜ í‚¤ì›Œë“œ ì •ì˜ (ë” ìƒì„¸í•˜ê²Œ)
        violent_keywords = ['ì£½ì–´', 'ë””ì ¸', 'ì£½ì—¬', 'ë•Œë ¤', 'íŒ¨ì¤„', 'êº¼ì ¸', 'ì‚¬ë¼ì ¸', 'ë°”ë³´', 'ë©ì²­ì´', 'ê°œìƒˆë¼', 'ë³‘ì‹ ', 'ì¡´ì¬ ìì²´ê°€ ì£„', 'ëª»ìƒê²¨ì„œ']
        threat_keywords = ['ê¹Œë¨¹ìœ¼ë©´', 'ì•ˆí•˜ë©´', 'ì•ˆë˜ë©´', 'ê·¸ëŸ¬ë©´', 'ê·¸ëŸ¼', 'ë””ì§„ë‹¤']
        bullying_keywords = ['ê·¸ëŸ° ì• ë‘', 'ë§ ì„ì§€ ë§ˆ', 'ë”°ëŒë ¤', 'ë¬´ì‹œí•´', 'ë†€ë ¤', 'ì‚´ë¹¼ë¼ì§€']
        derogatory_keywords = ['ë¹„í•˜', 'ëª¨ìš•', 'ìš•ì„¤', 'Xì•„', 'Xì•¼']
        
        # ë¬¸ì¥ë³„ ë¶„ì„
        # ì „ì²˜ë¦¬: ì¹´í†¡ êµ¬ì¡° ì •ê·œí™”
        normalized_text = _preprocess_kakao_chat_text(text_content)
        sentences = normalized_text.split('\n')
        analysis_lines = []
        risk_count = 0
        severe_count = 0
        
        for sentence in sentences:
            sentence = sentence.strip()
            if not sentence:
                continue

            # ë°œí™”ì/ë‚´ìš© ë¶„ë¦¬
            speaker, content = ('-', sentence)
            if ':' in sentence:
                sp, ct = sentence.split(':', 1)
                speaker = sp.strip() or '-'
                content = ct.strip()

            risk_level = "ì—†ìŒ"
            risk_type = "-"
            explanation = "ì¼ë°˜ì ì¸ ëŒ€í™” ë‚´ìš©"
            victim = "-"
            offender = "-"

            # ì—­í•  ë‹¨ì„œ: ì´ë¦„ ê¸°ë°˜
            if re.search(r'ê°€í•´ì|ì£¼ë™ì', speaker):
                offender = speaker
            if re.search(r'í”¼í•´ì', speaker):
                victim = speaker

            # ë” ì •êµí•œ ìœ„í—˜ë„ íŒë‹¨ ë° ì—­í•  ë³´ì •
            low = content.lower()
            if any(keyword in low for keyword in violent_keywords):
                if 'ì¡´ì¬ ìì²´ê°€ ì£„' in content or 'ëª»ìƒê²¨ì„œ' in content:
                    risk_level = "ì‹¬ê°"
                    risk_type = "ë¹„í•˜"
                    explanation = "ì¡´ì¬ ìì²´ë¥¼ ë¶€ì •í•˜ê±°ë‚˜ ì™¸ëª¨ë¥¼ ë¹„í•˜í•˜ëŠ” ê·¹ë‹¨ì  ë°œì–¸"
                else:
                    risk_level = "ì‹¬ê°"
                    risk_type = "ìš•ì„¤"
                    explanation = "í­ë ¥ì ì´ê±°ë‚˜ ëª¨ìš•ì ì¸ í‘œí˜„ í¬í•¨"
                offender = offender if offender != '-' else speaker
                risk_count += 1
                severe_count += 1
            elif any(keyword in low for keyword in threat_keywords):
                risk_level = "ìˆìŒ"
                risk_type = "ìœ„í˜‘"
                explanation = "í˜‘ë°•/ê°•ìš” ë˜ëŠ” ì¡°ê±´ë¶€ ìœ„í˜‘ì  í‘œí˜„"
                offender = offender if offender != '-' else speaker
                risk_count += 1
            elif any(keyword in low for keyword in bullying_keywords):
                risk_level = "ì•½ê°„ ìˆìŒ"
                risk_type = "ë”°ëŒë¦¼"
                explanation = "ë”°ëŒë¦¬ê±°ë‚˜ ë°°ì œí•˜ë ¤ëŠ” ì˜ë„"
                offender = offender if offender != '-' else speaker
                risk_count += 1
            elif any(keyword in low for keyword in derogatory_keywords):
                risk_level = "ìˆìŒ"
                risk_type = "ë¹„í•˜"
                explanation = "ë¹„í•˜ì /ëª¨ìš•ì  í‘œí˜„"
                offender = offender if offender != '-' else speaker
                risk_count += 1

            # í”¼í•´ì ë‹¨ì„œ (ìˆ˜ìš©/ê±°ì ˆ/ë°©ì–´ í‘œí˜„)
            if victim == '-' and re.search(r'ì•ˆë¼|ì‹«ì€ë°|ë¬´ì„œì›Œ|ê·¸ë§Œ|ì•Œê² ì–´|ì‚¬ì¤„ê²Œ', content):
                victim = speaker if speaker != '-' else 'í”¼í•´ì(ì¶”ì •)'

            analysis_lines.append(f"| {speaker}: {content} | {risk_type} | {victim} | {offender} | {risk_level} | {explanation} |")
        
        # HTML í…Œì´ë¸” ìƒì„±
        html_table = '<table class="analysis-table"><thead><tr><th>ë¬¸ì¥</th><th>ìœ í˜•</th><th>í”¼í•´ì</th><th>ê°€í•´ì</th><th>ìœ„í—˜ë„</th><th>í•´ì„¤</th></tr></thead><tbody>'
        for line in analysis_lines:
            cells = [cell.strip() for cell in line.split('|')[1:-1]]
            html_table += '<tr>'
            for cell in cells:
                html_table += f'<td>{cell}</td>'
            html_table += '</tr>'
        html_table += '</tbody></table>'
        
        # ë” ì •êµí•œ ìš”ì•½ ìƒì„±
        if severe_count >= 2:
            risk_summary = "ì‹¬ê°"
            mood_summary = f"í‚¤ì›Œë“œ ê¸°ë°˜ ë¶„ì„ ê²°ê³¼, {risk_count}ê°œì˜ ìœ„í—˜ ìš”ì†Œê°€ ë°œê²¬ë˜ì—ˆìœ¼ë©°, ê·¸ ì¤‘ {severe_count}ê°œê°€ ì‹¬ê°í•œ ìˆ˜ì¤€ì…ë‹ˆë‹¤. ëŒ€í™”ì—ì„œ í­ë ¥ì ì´ê±°ë‚˜ ëª¨ìš•ì ì¸ í‘œí˜„ì´ ë‹¤ìˆ˜ ë°œê²¬ë˜ì–´ ì¦‰ê°ì ì¸ ê°œì…ì´ í•„ìš”í•œ ìƒí™©ì…ë‹ˆë‹¤."
            warning = "ì‹¬ê°í•œ ì‚¬ì´ë²„í­ë ¥ ìš”ì†Œê°€ ë‹¤ìˆ˜ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. í”¼í•´ì ë³´í˜¸ì™€ ê°€í•´ì êµìœ¡ì´ ì‹œê¸‰í•˜ë©°, í•„ìš”ì‹œ ë²•ì  ì¡°ì¹˜ë¥¼ ê³ ë ¤í•´ì•¼ í•©ë‹ˆë‹¤. AI ë¶„ì„ ì„œë¹„ìŠ¤ ì¼ì‹œì  ì˜¤ë¥˜ë¡œ ì¸í•´ ê¸°ë³¸ í‚¤ì›Œë“œ ë¶„ì„ì„ ì œê³µí•©ë‹ˆë‹¤."
        elif risk_count >= 3:
            risk_summary = "ìˆìŒ"
            mood_summary = f"í‚¤ì›Œë“œ ê¸°ë°˜ ë¶„ì„ ê²°ê³¼, {risk_count}ê°œì˜ ìœ„í—˜ ìš”ì†Œê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. ëŒ€í™”ì—ì„œ ìœ„í˜‘ì ì´ê±°ë‚˜ ë¹„í•˜ì ì¸ í‘œí˜„ì´ í™•ì¸ë˜ì–´ ì£¼ì˜ê°€ í•„ìš”í•œ ìƒí™©ì…ë‹ˆë‹¤."
            warning = "ì‚¬ì´ë²„í­ë ¥ ìœ„í—˜ ìš”ì†Œê°€ ë‹¤ìˆ˜ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. ì§€ì†ì ì¸ ëª¨ë‹ˆí„°ë§ê³¼ ì ì ˆí•œ ê°œì…ì´ í•„ìš”í•˜ë©°, í”¼í•´ì ì§€ì›ì„ ê³ ë ¤í•´ì•¼ í•©ë‹ˆë‹¤. AI ë¶„ì„ ì„œë¹„ìŠ¤ ì¼ì‹œì  ì˜¤ë¥˜ë¡œ ì¸í•´ ê¸°ë³¸ í‚¤ì›Œë“œ ë¶„ì„ì„ ì œê³µí•©ë‹ˆë‹¤."
        elif risk_count >= 1:
            risk_summary = "ì•½ê°„ ìˆìŒ"
            mood_summary = f"í‚¤ì›Œë“œ ê¸°ë°˜ ë¶„ì„ ê²°ê³¼, {risk_count}ê°œì˜ ìœ„í—˜ ìš”ì†Œê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. ëŒ€í™”ì—ì„œ ì¼ë¶€ ë¶€ì ì ˆí•œ í‘œí˜„ì´ í™•ì¸ë˜ì–´ ì£¼ì˜ê°€ í•„ìš”í•œ ìƒí™©ì…ë‹ˆë‹¤."
            warning = "ì‚¬ì´ë²„í­ë ¥ ìœ„í—˜ ìš”ì†Œê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒí™©ì„ ì§€ì¼œë³´ê³  í•„ìš”ì‹œ ì ì ˆí•œ ê°œì…ì„ ê³ ë ¤í•´ì•¼ í•©ë‹ˆë‹¤. AI ë¶„ì„ ì„œë¹„ìŠ¤ ì¼ì‹œì  ì˜¤ë¥˜ë¡œ ì¸í•´ ê¸°ë³¸ í‚¤ì›Œë“œ ë¶„ì„ì„ ì œê³µí•©ë‹ˆë‹¤."
        else:
            risk_summary = "ì—†ìŒ"
            mood_summary = "í‚¤ì›Œë“œ ê¸°ë°˜ ë¶„ì„ ê²°ê³¼, ìœ„í—˜ ìš”ì†Œê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ëŒ€í™” ë‚´ìš©ì´ ì „ë°˜ì ìœ¼ë¡œ ê±´ì „í•˜ê³  ì ì ˆí•œ ìˆ˜ì¤€ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤."
            warning = "í˜„ì¬ ëŒ€í™”ì—ì„œ ì‚¬ì´ë²„í­ë ¥ ìœ„í—˜ ìš”ì†Œê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì§€ì†ì ì¸ ëª¨ë‹ˆí„°ë§ì„ í†µí•´ ê±´ì „í•œ ëŒ€í™” í™˜ê²½ì„ ìœ ì§€í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤. AI ë¶„ì„ ì„œë¹„ìŠ¤ ì¼ì‹œì  ì˜¤ë¥˜ë¡œ ì¸í•´ ê¸°ë³¸ í‚¤ì›Œë“œ ë¶„ì„ì„ ì œê³µí•©ë‹ˆë‹¤."
        
        summary = f"""
ì „ì²´ ëŒ€í™” ì‚¬ì´ë²„í­ë ¥ ìœ„í—˜ë„: {risk_summary}

ëŒ€í™” ì „ì²´ ë¶„ìœ„ê¸° ìš”ì•½: {mood_summary}

ì ì¬ì  ìœ„í—˜/ì£¼ì˜ì‚¬í•­: {warning}
"""
        
        return {"table": html_table, "summary": summary, "fallback_used": True}
        
    except Exception as e:
        print(f"ëŒ€ì²´ ë¶„ì„ ì˜¤ë¥˜: {e}")
        return {"table": "", "summary": f"ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}"}

def extract_risk_line(summary):
    """Gemini ë¶„ì„ ê²°ê³¼ì—ì„œ ìœ„í—˜ë„ ë¼ì¸ì„ ì¶”ì¶œ"""
    if not summary:
        return None
    import re
    match = re.search(r'ì „ì²´\s*ëŒ€í™”\s*ì‚¬ì´ë²„í­ë ¥\s*ìœ„í—˜ë„\s*:\s*([^\n\r]*)', summary, re.IGNORECASE)
    if match:
        value = match.group(1).strip()
        # ëŒ€ê´„í˜¸, íŠ¹ìˆ˜ë¬¸ì, ì¤„ë°”ê¿ˆ ë“± ëª¨ë‘ ì œê±°: í•œê¸€/ì˜ë¬¸/ê³µë°±ë§Œ ë‚¨ê¹€
        value = re.sub(r'^[\[\(\{\s]*', '', value)  # ì•ìª½ ê´„í˜¸/ê³µë°± ì œê±°
        value = re.sub(r'[\]\)\}\s]*$', '', value)  # ë’¤ìª½ ê´„í˜¸/ê³µë°± ì œê±°
        return value.strip()
    return None

def extract_conversation_atmosphere(summary):
    """ìš”ì•½ì—ì„œ ëŒ€í™” ì „ì²´ ë¶„ìœ„ê¸° ìš”ì•½ ì¶”ì¶œ"""
    if not summary:
        return "ë¶„ì„ ì¤‘..."
    
    import re
    # ì •ê·œí‘œí˜„ì‹ìœ¼ë¡œ "ëŒ€í™” ì „ì²´ ë¶„ìœ„ê¸° ìš”ì•½:" ë‹¤ìŒì˜ ë‚´ìš©ì„ ì¶”ì¶œ
    pattern = r'ëŒ€í™”\s*ì „ì²´\s*ë¶„ìœ„ê¸°\s*ìš”ì•½\s*:\s*(.*?)(?=\n\s*ì ì¬ì \s*ìœ„í—˜/ì£¼ì˜ì‚¬í•­\s*:|$)'
    match = re.search(pattern, summary, re.DOTALL | re.IGNORECASE)
    
    if match:
        result = match.group(1).strip()
        # ì—¬ëŸ¬ ì¤„ì„ í•˜ë‚˜ë¡œ í•©ì¹˜ê³  ë¶ˆí•„ìš”í•œ ê³µë°± ì œê±°
        result = re.sub(r'\s+', ' ', result)
        return result if result else "ë¶„ì„ ì¤‘..."
    
    # ì •ê·œí‘œí˜„ì‹ìœ¼ë¡œ ì°¾ì§€ ëª»í•œ ê²½ìš° ê¸°ì¡´ ë°©ì‹ ì‹œë„
    lines = summary.split('\n')
    for i, line in enumerate(lines):
        if 'ëŒ€í™” ì „ì²´ ë¶„ìœ„ê¸° ìš”ì•½:' in line:
            # ë‹¤ìŒ ì¤„ë¶€í„° ë‹¤ìŒ ì„¹ì…˜ê¹Œì§€ì˜ ë‚´ìš©ì„ ê°€ì ¸ì˜´
            atmosphere_lines = []
            for j in range(i + 1, len(lines)):
                if 'ì ì¬ì  ìœ„í—˜/ì£¼ì˜ì‚¬í•­:' in lines[j]:
                    break
                if lines[j].strip():
                    atmosphere_lines.append(lines[j].strip())
            result = ' '.join(atmosphere_lines)
            return result if result else "ë¶„ì„ ì¤‘..."
    
    # fallback ë¶„ì„ ê²°ê³¼ì—ì„œ ì§ì ‘ ì¶”ì¶œ ì‹œë„
    if 'í‚¤ì›Œë“œ ê¸°ë°˜ ë¶„ì„ ê²°ê³¼' in summary:
        lines = summary.split('\n')
        for line in lines:
            if 'í‚¤ì›Œë“œ ê¸°ë°˜ ë¶„ì„ ê²°ê³¼' in line and 'ìœ„í—˜ ìš”ì†Œ' in line:
                return line.strip()
    
    return "ë¶„ì„ ì¤‘..."

def extract_potential_risks(summary):
    """ìš”ì•½ì—ì„œ ì ì¬ì  ìœ„í—˜/ì£¼ì˜ì‚¬í•­ ì¶”ì¶œ"""
    if not summary:
        return "ë¶„ì„ ì¤‘..."
    
    import re
    # ì •ê·œí‘œí˜„ì‹ìœ¼ë¡œ "ì ì¬ì  ìœ„í—˜/ì£¼ì˜ì‚¬í•­:" ë‹¤ìŒì˜ ë‚´ìš©ì„ ì¶”ì¶œ
    pattern = r'ì ì¬ì \s*ìœ„í—˜/ì£¼ì˜ì‚¬í•­\s*:\s*(.*)'
    match = re.search(pattern, summary, re.DOTALL | re.IGNORECASE)
    
    if match:
        result = match.group(1).strip()
        # ì—¬ëŸ¬ ì¤„ì„ í•˜ë‚˜ë¡œ í•©ì¹˜ê³  ë¶ˆí•„ìš”í•œ ê³µë°± ì œê±°
        result = re.sub(r'\s+', ' ', result)
        return result if result else "ë¶„ì„ ì¤‘..."
    
    # ì •ê·œí‘œí˜„ì‹ìœ¼ë¡œ ì°¾ì§€ ëª»í•œ ê²½ìš° ê¸°ì¡´ ë°©ì‹ ì‹œë„
    lines = summary.split('\n')
    for i, line in enumerate(lines):
        if 'ì ì¬ì  ìœ„í—˜/ì£¼ì˜ì‚¬í•­:' in line:
            # ë‹¤ìŒ ì¤„ë¶€í„° ëê¹Œì§€ì˜ ë‚´ìš©ì„ ê°€ì ¸ì˜´
            risk_lines = []
            for j in range(i + 1, len(lines)):
                if lines[j].strip():
                    risk_lines.append(lines[j].strip())
            result = ' '.join(risk_lines)
            return result if result else "ë¶„ì„ ì¤‘..."
    
    # fallback ë¶„ì„ ê²°ê³¼ì—ì„œ ì§ì ‘ ì¶”ì¶œ ì‹œë„
    if 'AI ë¶„ì„ ì„œë¹„ìŠ¤ ì¼ì‹œì  ì˜¤ë¥˜' in summary:
        lines = summary.split('\n')
        for line in lines:
            if 'AI ë¶„ì„ ì„œë¹„ìŠ¤ ì¼ì‹œì  ì˜¤ë¥˜' in line:
                return line.strip()
    
    return "ë¶„ì„ ì¤‘..."

def pipe_table_to_html(text):
    """
    íŒŒì´í”„(|) êµ¬ë¶„ í…ìŠ¤íŠ¸ í‘œë¥¼ HTML <table>ë¡œ ë³€í™˜
    """
    import re
    lines = [line.strip() for line in text.splitlines() if line.strip()]
    table_lines = []
    summary_line = ""
    for i, line in enumerate(lines):
        if line.startswith("ë¶„ìœ„ê¸° ìš”ì•½:"):
            summary_line = line
            break
        if "|" in line:
            table_lines.append(line)
    if not table_lines:
        return text  # í‘œê°€ ì—†ìœ¼ë©´ ì›ë³¸ ë°˜í™˜

    html = ['<table class="md-table">']
    for idx, row in enumerate(table_lines):
        cols = [c.strip() for c in row.split("|")]
        tag = "th" if idx == 0 else "td"
        html.append("<tr>" + "".join(f"<{tag}>{c}</{tag}>" for c in cols) + "</tr>")
    html.append("</table>")
    if summary_line:
        html.append(f'<div style="margin-top:8px;"><b>{summary_line}</b></div>')
    return "\n".join(html)



def generate_pdf_report(analysis_result, pdf_path, analysis_type=None):
    """ë²•ì  ìš”ê±´ì„ ì¶©ì¡±í•˜ëŠ” ì „ë¬¸ì ì¸ ë””ì§€í„¸ ì¦ê±° ë¶„ì„ ë³´ê³ ì„œ ìƒì„± - HTML ê¸°ë°˜"""
    try:
        # HTML í…œí”Œë¦¿ ìƒì„±
        html_content = generate_report_html(analysis_result, analysis_type, pdf_path)
        
        # FontConfiguration ìƒì„± (í•œê¸€ í°íŠ¸ ì§€ì›)
        from weasyprint import HTML, CSS
        from weasyprint.text.fonts import FontConfiguration
        
        font_config = FontConfiguration()
        
        # CSS ìŠ¤íƒ€ì¼ ì¶”ê°€ (í•œê¸€ í°íŠ¸ ìš°ì„ ìˆœìœ„)
        css_content = """
        @font-face {
            font-family: 'Noto Sans KR';
            src: local('Noto Sans KR'), local('NotoSansKR-Regular');
            font-weight: normal;
            font-style: normal;
        }
        
        @font-face {
            font-family: 'Malgun Gothic';
            src: local('Malgun Gothic'), local('ë§‘ì€ ê³ ë”•');
            font-weight: normal;
            font-style: normal;
        }
        
        body {
            font-family: 'Noto Sans KR', 'Malgun Gothic', 'Arial', sans-serif !important;
        }
        
        * {
            font-family: 'Noto Sans KR', 'Malgun Gothic', 'Arial', sans-serif !important;
        }
        """
        
        # WeasyPrintë¡œ PDF ìƒì„± (í°íŠ¸ ì„¤ì • í¬í•¨)
        HTML(string=html_content).write_pdf(
            pdf_path,
            font_config=font_config,
            stylesheets=[CSS(string=css_content)]
        )
        return pdf_path
        
    except Exception as e:
        print(f"HTML-based PDF generation failed: {e}")
        # ìµœí›„ì˜ ìˆ˜ë‹¨: í…ìŠ¤íŠ¸ íŒŒì¼ ìƒì„±
        try:
            text_path = pdf_path.replace('.pdf', '.txt')
            with open(text_path, 'w', encoding='utf-8') as f:
                f.write("DIGITAL EVIDENCE ANALYSIS REPORT\n")
                f.write("AI-Based Deepfake and Cyberbullying Analysis\n")
                f.write("=" * 60 + "\n\n")
                f.write("EXPERT REPORT\n")
                f.write("Selected Expert: Legal-Tech Product Manager and Forensic Analyst\n\n")
                f.write("I. CASE AND EVIDENCE OVERVIEW\n")
                f.write("A. Case Information\n")
                f.write(f"Case Management Number: DF-CB-{datetime.now().strftime('%Y')}-001\n")
                f.write(f"Report ID: DF-CB-{datetime.now().strftime('%Y')}-001-v1.0\n")
                f.write(f"Issue Date: {datetime.now().strftime('%Y-%m-%d')}\n")
                f.write("Requesting Agency: Seoul Seocho Police Station Cyber Investigation Team\n")
                f.write("Lead Analyst: Senior Digital Forensic Analyst\n\n")
                f.write("II. AI-BASED FORENSIC ANALYSIS\n")
                f.write("A. Comprehensive Analysis Results\n")
                
                if analysis_type == 'deepfake' and 'deepfake_analysis' in analysis_result:
                    deepfake_analysis = analysis_result['deepfake_analysis']
                    if 'error' not in deepfake_analysis:
                        if deepfake_analysis.get('type', {}).get('deepfake'):
                            f.write(f"Deepfake Detection: {deepfake_analysis['type']['deepfake']:.1%} probability\n")
                
                elif analysis_type == 'cyberbullying' and 'cyberbullying_analysis_summary' in analysis_result:
                    summary = str(analysis_result['cyberbullying_analysis_summary'])
                    f.write(f"Cyberbullying Analysis: {summary[:500]}...\n" if len(summary) > 500 else f"Cyberbullying Analysis: {summary}\n")
                
                f.write(f"\nIII. EVIDENTIARY INTEGRITY\n")
                f.write(f"SHA-256 Hash: {analysis_result.get('sha256', 'N/A')}\n")
                f.write(f"Analysis Timestamp: {analysis_result.get('analysis_timestamp', 'N/A')}\n")
                f.write(f"Analysis Type: {analysis_type or 'N/A'}\n")
            
            return text_path
        except Exception as e2:
            print(f"Text file generation also failed: {e2}")
            raise e

def generate_image_html(original_image_path, analysis_result, original_file):
    """ì´ë¯¸ì§€ë¥¼ Base64ë¡œ ì¸ì½”ë”©í•˜ì—¬ HTMLì— ì„ë² ë“œ"""
    import base64
    
    print(f"ğŸ” ì´ë¯¸ì§€ HTML ìƒì„± ì‹œì‘...")
    
    # íŒŒì¼ ê²½ë¡œì—ì„œ ì´ë¯¸ì§€ ì°¾ê¸°
    print(f"   original_image_path ì¸ì: {original_image_path}")
    print(f"   uploaded_file_path: {analysis_result.get('uploaded_file_path', 'N/A')}")
    print(f"   static_file_path: {analysis_result.get('static_file_path', 'N/A')}")
    print(f"   file_path: {analysis_result.get('file_path', 'N/A')}")
    
    # ìš°ì„ ìˆœìœ„ 1: file_path (ë¶„ì„ì— ì‚¬ìš©ëœ ì›ë³¸ íŒŒì¼)
    file_path = analysis_result.get('file_path', '')
    if file_path and os.path.exists(file_path):
        original_image_path = file_path
        print(f"âœ… file_pathì—ì„œ ì´ë¯¸ì§€ ì°¾ìŒ: {original_image_path}")
    # ìš°ì„ ìˆœìœ„ 2: uploaded_file_path (ì‹¤ì œ ì €ì¥ëœ ê²½ë¡œ)
    elif analysis_result.get('uploaded_file_path', '') and os.path.exists(analysis_result.get('uploaded_file_path', '')):
        original_image_path = analysis_result.get('uploaded_file_path', '')
        print(f"âœ… uploaded_file_pathì—ì„œ ì´ë¯¸ì§€ ì°¾ìŒ: {original_image_path}")
    # ìš°ì„ ìˆœìœ„ 3: static_file_path
    elif analysis_result.get('static_file_path', '') and os.path.exists(analysis_result.get('static_file_path', '')):
        original_image_path = analysis_result.get('static_file_path', '')
        print(f"âœ… static_file_pathì—ì„œ ì´ë¯¸ì§€ ì°¾ìŒ: {original_image_path}")
    # ìš°ì„ ìˆœìœ„ 4: ê¸°ì¡´ original_image_path
    elif original_image_path and os.path.exists(original_image_path):
        print(f"âœ… ì¸ìë¡œ ì „ë‹¬ëœ ê²½ë¡œì—ì„œ ì´ë¯¸ì§€ ì°¾ìŒ: {original_image_path}")
    # ìš°ì„ ìˆœìœ„ 5: íŒŒì¼ëª…ìœ¼ë¡œ ë‹¤ì–‘í•œ ê²½ë¡œ íƒìƒ‰
    else:
        filename = original_file.get('filename', '')
        print(f"   íŒŒì¼ëª…ìœ¼ë¡œ íƒìƒ‰ ì‹œì‘: {filename}")
        possible_paths = [
            f'/app/tmp/{filename}',
            f'/app/static/uploads/{filename}',
            f'/app/app/static/uploads/{filename}',
            os.path.join(os.getcwd(), 'tmp', filename),
            os.path.join('tmp', filename),
            os.path.join('app', 'static', 'uploads', filename),
            os.path.join('static', 'uploads', filename),
            os.path.join(os.getcwd(), 'app', 'static', 'uploads', filename),
            os.path.join(os.getcwd(), 'static', 'uploads', filename),
        ]
        
        for path in possible_paths:
            if path and os.path.exists(path):
                original_image_path = path
                print(f"âœ… íƒìƒ‰ ê²½ë¡œì—ì„œ ì´ë¯¸ì§€ ì°¾ìŒ: {original_image_path}")
                break
        else:
            print(f"âŒ ëª¨ë“  ê²½ë¡œì—ì„œ ì´ë¯¸ì§€ë¥¼ ì°¾ì§€ ëª»í•¨")
    
    # ì´ë¯¸ì§€ë¥¼ Base64ë¡œ ì¸ì½”ë”©
    if original_image_path and os.path.exists(original_image_path):
        try:
            with open(original_image_path, 'rb') as img_file:
                img_data = img_file.read()
                base64_img = base64.b64encode(img_data).decode('utf-8')
                
                # ì´ë¯¸ì§€ í™•ì¥ì í™•ì¸
                ext = os.path.splitext(original_image_path)[1].lower()
                mime_type = {
                    '.jpg': 'image/jpeg',
                    '.jpeg': 'image/jpeg',
                    '.png': 'image/png',
                    '.gif': 'image/gif',
                    '.webp': 'image/webp'
                }.get(ext, 'image/jpeg')
                
                print(f"âœ… ì´ë¯¸ì§€ Base64 ì¸ì½”ë”© ì™„ë£Œ: {len(base64_img)} bytes, MIME: {mime_type}")
                
                return f'<img class="evidence" src="data:{mime_type};base64,{base64_img}" alt="ì›ë³¸ ì¦ê±° ì´ë¯¸ì§€" style="max-width: 100%; height: auto;"/>'
        except Exception as e:
            print(f"âŒ ì´ë¯¸ì§€ ì¸ì½”ë”© ì‹¤íŒ¨: {e}")
    
    # ì´ë¯¸ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì„ ë•Œ - ë””ë²„ê¹… ì •ë³´ ìƒì„¸ ì¶œë ¥
    print(f"âŒâŒâŒ ìµœì¢…: ì´ë¯¸ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ")
    print(f"   íŒŒì¼ëª…: {original_file.get('filename', 'N/A')}")
    print(f"   ì‹œë„í•œ ê²½ë¡œ: {original_image_path if original_image_path else 'ì—†ìŒ'}")
    print(f"   í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬: {os.getcwd()}")
    
    # tmp ë””ë ‰í† ë¦¬ ë‚´ìš© í™•ì¸
    tmp_paths = ['/app/tmp', os.path.join(os.getcwd(), 'tmp')]
    for tmp_path in tmp_paths:
        if os.path.exists(tmp_path):
            try:
                files = os.listdir(tmp_path)
                print(f"   ğŸ“‚ {tmp_path} ë‚´ìš©: {files[:10]}")  # ì²˜ìŒ 10ê°œë§Œ
            except Exception as e:
                print(f"   ğŸ“‚ {tmp_path} ì½ê¸° ì‹¤íŒ¨: {e}")
    
    return f'''<div style="background: #f8f9fa; border: 2px dashed #dee2e6; padding: 20px; text-align: center; color: #6c757d;">
        <p><strong>âš ï¸ ì›ë³¸ ì´ë¯¸ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</strong></p>
        <p>íŒŒì¼ëª…: {original_file.get("filename", "N/A")}</p>
        <p>ì‹œë„í•œ ê²½ë¡œ: {original_image_path if original_image_path else "ì—†ìŒ"}</p>
        <p>í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬: {os.getcwd()}</p>
    </div>'''

def generate_report_html(analysis_result, analysis_type=None, pdf_path=None):
    """ë³´ê³ ì„œ HTML í…œí”Œë¦¿ ìƒì„±"""
    original_file = analysis_result.get('file_info', {})
    
    # ë¶„ì„ ê²°ê³¼ í…ìŠ¤íŠ¸ ìƒì„±
    analysis_text = ""
    if analysis_type == 'deepfake' and 'deepfake_analysis' in analysis_result:
        deepfake_analysis = analysis_result['deepfake_analysis']
        if 'error' not in deepfake_analysis:
            if deepfake_analysis.get('type', {}).get('deepfake'):
                prob = deepfake_analysis['type']['deepfake']
                analysis_text = f"ë”¥í˜ì´í¬ì¼ í™•ë¥ : {prob:.1%}"
            else:
                analysis_text = "ë”¥í˜ì´í¬ì¼ í™•ë¥ : N/A%"
        else:
            analysis_text = f"ë”¥í˜ì´í¬ ë¶„ì„ ì˜¤ë¥˜: {str(deepfake_analysis['error'])[:100]}"
    
    elif analysis_type == 'cyberbullying' and 'cyberbullying_risk_line' in analysis_result:
        risk_line = analysis_result['cyberbullying_risk_line']
        analysis_text = f"ì „ì²´ ëŒ€í™” ì‚¬ì´ë²„í­ë ¥ ìœ„í—˜ë„: {risk_line}"
    
    # ë³´ê³ ì„œ ID ë° ìƒì„±ì¼ì‹œ
    report_id = f"DF-CB-{datetime.now().strftime('%Y')}-001-v1.0"
    created_at = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
    
    # íŒŒì¼ ì •ë³´
    filename = str(original_file.get('filename', 'N/A'))
    file_size = str(original_file.get('size_bytes', 'N/A'))
    sha256 = str(analysis_result.get('sha256', 'N/A'))
    
    # ì›ë³¸ ì´ë¯¸ì§€ ê²½ë¡œ ì°¾ê¸° - ê°œì„ ëœ ë°©ì‹
    original_image_path = analysis_result.get('original_image_path', '')
    
    # ì„¸ì…˜ì—ì„œ ì €ì¥ëœ ê²½ë¡œ ì •ë³´ í™œìš©
    if not original_image_path:
        # ë¶„ì„ ê²°ê³¼ì—ì„œ ì§ì ‘ ê²½ë¡œ ì •ë³´ í™•ì¸
        original_image_path = analysis_result.get('static_file_path', '')
        if not original_image_path:
            original_image_path = analysis_result.get('uploaded_file_path', '')
    
    # íŒŒì¼ëª…ìœ¼ë¡œ ì´ë¯¸ì§€ ì°¾ê¸° (fallback)
    if not original_image_path and 'filename' in original_file:
        filename = original_file['filename']
        # Railway í™˜ê²½ì„ ê³ ë ¤í•œ ì ˆëŒ€ ê²½ë¡œì™€ ìƒëŒ€ ê²½ë¡œ ëª¨ë‘ í™•ì¸
        possible_paths = [
            # Railway í™˜ê²½ì˜ ì ˆëŒ€ ê²½ë¡œ
            f'/app/tmp/{filename}',
            f'/app/static/uploads/{filename}',
            f'/app/app/static/uploads/{filename}',
            # ìƒëŒ€ ê²½ë¡œ
            os.path.join('app', 'static', 'uploads', filename),
            os.path.join('static', 'uploads', filename),
            os.path.join('tmp', filename),
            os.path.join('uploads', filename),
            # í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬ ê¸°ì¤€
            os.path.join(os.getcwd(), 'app', 'static', 'uploads', filename),
            os.path.join(os.getcwd(), 'static', 'uploads', filename),
            os.path.join(os.getcwd(), 'tmp', filename),
            os.path.join(os.getcwd(), 'uploads', filename),
            # íŒŒì¼ ì—…ë¡œë“œ ì‹œ ì €ì¥ëœ ê²½ë¡œ
            analysis_result.get('file_path', ''),
            analysis_result.get('upload_path', '')
        ]
        
        for path in possible_paths:
            if path and os.path.exists(path):
                original_image_path = os.path.abspath(path)
                print(f"ì´ë¯¸ì§€ ê²½ë¡œ ì°¾ìŒ: {original_image_path}")
                break
    
    # ì›¹ ê²½ë¡œ ìƒì„± - Railway í™˜ê²½ ê³ ë ¤
    web_image_path = ""
    if original_image_path and os.path.exists(original_image_path):
        # íŒŒì¼ëª…ë§Œ ì¶”ì¶œí•˜ì—¬ ì›¹ ê²½ë¡œ ìƒì„±
        filename = os.path.basename(original_image_path)
        # Railway í™˜ê²½ì—ì„œëŠ” /app/tmp/ ê²½ë¡œì˜ íŒŒì¼ë„ /static/uploads/ë¡œ ì ‘ê·¼ ê°€ëŠ¥
        web_image_path = f'/static/uploads/{filename}'
        print(f"ì›¹ ì´ë¯¸ì§€ ê²½ë¡œ: {web_image_path}")
        print(f"ì›ë³¸ ì´ë¯¸ì§€ ê²½ë¡œ: {original_image_path}")
    else:
        print(f"ì´ë¯¸ì§€ ê²½ë¡œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: {original_image_path}")
        print(f"íŒŒì¼ëª…: {original_file.get('filename', 'N/A')}")
        # í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬ì™€ ê°€ëŠ¥í•œ ê²½ë¡œë“¤ ì¶œë ¥
        print(f"í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬: {os.getcwd()}")
        print(f"tmp ë””ë ‰í† ë¦¬ ì¡´ì¬: {os.path.exists('/app/tmp')}")
        print(f"static/uploads ë””ë ‰í† ë¦¬ ì¡´ì¬: {os.path.exists('/app/static/uploads')}")
        
        # íŒŒì¼ëª…ë§Œìœ¼ë¡œë„ ì›¹ ê²½ë¡œ ìƒì„± ì‹œë„
        if 'filename' in original_file:
            web_image_path = f'/static/uploads/{original_file["filename"]}'
            
        # ë¶„ì„ ê²°ê³¼ì—ì„œ íŒŒì¼ ê²½ë¡œ ì •ë³´ í™•ì¸
        if 'file_path' in analysis_result:
            print(f"ë¶„ì„ ê²°ê³¼ì˜ file_path: {analysis_result['file_path']}")
        if 'upload_path' in analysis_result:
            print(f"ë¶„ì„ ê²°ê³¼ì˜ upload_path: {analysis_result['upload_path']}")

    # ì¶”ê°€ ì •ë³´ ì¶”ì¶œ
    uploader_id = analysis_result.get('uploader_id', 'N/A')
    uploader_ip = analysis_result.get('uploader_ip', 'N/A')
    upload_timestamp = analysis_result.get('upload_timestamp', 'N/A')
    file_size_mb = analysis_result.get('file_size_mb', 'N/A')
    image_width = analysis_result.get('image_width', 'N/A')
    image_height = analysis_result.get('image_height', 'N/A')
    image_resolution = analysis_result.get('image_resolution', 'N/A')
    extracted_text = analysis_result.get('extracted_text', '')
    cyberbullying_analysis = analysis_result.get('cyberbullying_analysis', '')
    cyberbullying_summary = analysis_result.get('cyberbullying_analysis_summary', '')
    
    # HTML í…œí”Œë¦¿ ìƒì„±
    html_content = f"""
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ì•ˆì‹¬í†¡ ë””ì§€í„¸ ì¦ê±° ë¶„ì„ ë³´ê³ ì„œ</title>
        <style>
            @font-face {{
                font-family: 'Noto Sans KR';
                src: local('Noto Sans KR'), local('NotoSansKR-Regular');
                font-weight: normal;
                font-style: normal;
            }}
            
            @font-face {{
                font-family: 'Malgun Gothic';
                src: local('Malgun Gothic'), local('ë§‘ì€ ê³ ë”•');
                font-weight: normal;
                font-style: normal;
            }}
            
            body {{ 
                font-family: 'Noto Sans KR', 'Malgun Gothic', 'Arial', sans-serif !important; 
                margin: 40px; 
                line-height: 1.6;
                word-wrap: break-word;
                overflow-wrap: break-word;
                color: #333;
            }}
            
            * {{
                font-family: 'Noto Sans KR', 'Malgun Gothic', 'Arial', sans-serif !important;
            }}
            
            h1, h2, h3 {{ 
                color: #1976d2; 
                page-break-after: auto; 
                page-break-inside: auto; 
                margin-top: 30px;
                margin-bottom: 15px;
            }}
            
            .code-block {{ 
                font-family: 'Consolas', 'Monaco', monospace; 
                background: #f5f5f5; 
                padding: 8px; 
                border-radius: 4px; 
                word-break: break-all; 
                font-size: 11px; 
                border: 1px solid #ddd;
            }}
            
            table {{ 
                border-collapse: collapse; 
                width: 100%; 
                margin: 15px 0; 
                font-size: 12px; 
                page-break-inside: auto; 
            }}
            
            th, td {{ 
                border: 1px solid #ddd; 
                padding: 8px 12px; 
                word-wrap: break-word; 
                text-align: left;
            }}
            
            th {{ 
                background: #f8f9fa; 
                font-weight: bold; 
                color: #495057;
            }}
            
            img.evidence {{ 
                max-width: 400px; 
                max-height: 500px; 
                margin: 15px 0; 
                page-break-inside: auto; 
                border: 1px solid #ddd; 
                border-radius: 4px; 
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }}
            
            .section {{ 
                margin-bottom: 40px; 
                page-break-inside: auto; 
            }}
            
            .box {{ 
                background: #f0f4ff; 
                border-radius: 8px; 
                padding: 15px; 
                margin: 15px 0; 
                page-break-inside: auto; 
                word-wrap: break-word; 
                border-left: 4px solid #1976d2;
            }}
            
            .extracted-text {{
                background: #f8f9fa;
                border: 1px solid #e9ecef;
                border-radius: 4px;
                padding: 15px;
                margin: 15px 0;
                font-family: 'Consolas', 'Monaco', monospace;
                font-size: 13px;
                line-height: 1.4;
                white-space: pre-wrap;
                word-wrap: break-word;
                word-break: break-all;
                overflow-x: hidden;
                column-count: 2;
                column-gap: 20px;
                column-fill: balance;
                page-break-inside: auto;
            }}
            
            .analysis-result {{
                background: #fff3cd;
                border: 1px solid #ffeaa7;
                border-radius: 4px;
                padding: 15px;
                margin: 15px 0;
                font-weight: bold;
                color: #856404;
            }}
            
            .analysis-table {{
                border-collapse: collapse;
                width: 100%;
                margin: 15px 0;
                font-size: 11px;
                page-break-inside: auto;
            }}
            
            .analysis-table th, .analysis-table td {{
                border: 1px solid #ddd;
                padding: 6px 8px;
                word-wrap: break-word;
                text-align: left;
                vertical-align: top;
            }}
            
            .analysis-table th {{
                background: #f8f9fa;
                font-weight: bold;
                color: #495057;
            }}
            
            .risk-none {{
                color: #28a745;
                font-weight: bold;
            }}
            
            .risk-severe {{
                color: #dc3545;
                font-weight: bold;
            }}
            
            .risk-moderate {{
                color: #ffc107;
                font-weight: bold;
            }}
            
            @page {{
                size: A4;
                margin: 40px 40px 50px 40px;
                @bottom-center {{
                    content: element(report-footer);
                }}
            }}
            
            #report-footer {{
                position: running(report-footer);
                font-size: 10px;
                color: #888;
                text-align: right;
                width: 100%;
                border-top: 1px solid #eee;
                padding-top: 10px;
            }}
            
            .metadata-item {{
                margin: 8px 0;
            }}
            
            .metadata-label {{
                font-weight: bold;
                color: #495057;
                display: inline-block;
                width: 120px;
            }}
            
            .metadata-value {{
                color: #333;
            }}
        </style>
    </head>
    <body>
        <div id="report-footer">
            ë³´ê³ ì„œID: {report_id} | ìƒì„±ì¼ì‹œ: {created_at} | í”Œë«í¼: ì•ˆì‹¬í†¡ AI í¬ë Œì‹ ë¶„ì„ ì‹œìŠ¤í…œ v1.0 | ë°°í¬ì¼: 2025-07-18
        </div>
        
        <h1>ì•ˆì‹¬í†¡ ë””ì§€í„¸ ì¦ê±° ë¶„ì„ ë³´ê³ ì„œ</h1>
        
        <div class="section">
            <h2>1. ê¸°ë³¸ ì •ë³´</h2>
            <table>
                <tr><th>ë³´ê³ ì„œ ID</th><td>{report_id}</td></tr>
                <tr><th>ìƒì„±ì¼ì‹œ</th><td>{created_at}</td></tr>
                <tr><th>ë¶„ì„ ìœ í˜•</th><td>{analysis_type or 'N/A'}</td></tr>
                <tr><th>ë¶„ì„ ì‹œìŠ¤í…œ</th><td>ì•ˆì‹¬í†¡ AI í¬ë Œì‹ ë¶„ì„ ì‹œìŠ¤í…œ v1.0</td></tr>
            </table>
        </div>
        
        <div class="section">
            <h2>2. ë¶„ì„ì— ì‚¬ìš©ëœ AI ëª¨ë¸ ì „ì²´ ëª©ë¡</h2>
            <table>
                <thead>
                    <tr>
                        <th>ë¶„ì„ ì‘ì—…</th>
                        <th>AI ëª¨ë¸</th>
                        <th>ë²„ì „</th>
                        <th>ì •í™•ë„</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>ë”¥í˜ì´í¬ íƒì§€</td>
                        <td>Sightengine Deepfake Detector</td>
                        <td>v1.0</td>
                        <td>99.7%</td>
                    </tr>
                    <tr>
                        <td>ì‚¬ì´ë²„í­ë ¥ ë¶„ì„</td>
                        <td>Google Gemini 2.0 Flash Lite (Vertex AI)</td>
                        <td>v2.0</td>
                        <td>74.1%</td>
                    </tr>
                    <tr>
                        <td>OCR í…ìŠ¤íŠ¸ ì¶”ì¶œ</td>
                        <td>Google Cloud Vision API</td>
                        <td>v1.0</td>
                        <td>81.8%</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="section">
            <h2>3. ë¶„ì„ ê²°ê³¼ ìš”ì•½</h2>
            <div class="analysis-result">
                {f'<strong>ë”¥í˜ì´í¬ ë¶„ì„ ê²°ê³¼ ìš”ì•½:</strong><br>ë”¥í˜ì´í¬ì¼ í™•ë¥ : {analysis_result.get("deepfake_analysis", {{}}).get("type", {{}}).get("deepfake", 0):.1%}' if analysis_type == 'deepfake' else f'<strong>ì‚¬ì´ë²„í­ë ¥ ë¶„ì„ ê²°ê³¼ ìš”ì•½:</strong><br>{cyberbullying_summary.replace(chr(10), "<br>") if cyberbullying_summary else "ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤."}'}
            </div>
        </div>
        
        <div class="section">
            <h2>4. ì¦ê±° íŒŒì¼ ì •ë³´</h2>
            <div class="metadata-item">
                <span class="metadata-label">íŒŒì¼ëª…:</span>
                <span class="metadata-value">{filename}</span>
            </div>
            <div class="metadata-item">
                <span class="metadata-label">íŒŒì¼ ìœ í˜•:</span>
                <span class="metadata-value">{analysis_type or 'N/A'}</span>
            </div>
            <div class="metadata-item">
                <span class="metadata-label">íŒŒì¼ í¬ê¸°:</span>
                <span class="metadata-value">{file_size} Bytes</span>
            </div>
            <div class="metadata-item">
                <span class="metadata-label">ì—…ë¡œë“œ ì¼ì‹œ:</span>
                <span class="metadata-value">{upload_timestamp}</span>
            </div>
            <div class="metadata-item">
                <span class="metadata-label">ì—…ë¡œë” ID:</span>
                <span class="metadata-value code-block">{uploader_id}</span>
            </div>
            <div class="metadata-item">
                <span class="metadata-label">ì—…ë¡œë“œ IP:</span>
                <span class="metadata-value">{uploader_ip}</span>
            </div>
            <div class="metadata-item">
                <span class="metadata-label">ì›ë³¸ í•´ì‹œê°’ (SHA-256):</span>
                <span class="metadata-value code-block">{sha256}</span>
            </div>
        </div>
        
        <div class="section">
            <h2>ì›ë³¸ íŒŒì¼ ë©”íƒ€ë°ì´í„°</h2>
            <div class="metadata-item">
                <span class="metadata-label">íŒŒì¼ í˜•ì‹:</span>
                <span class="metadata-value">{original_file.get('type', 'N/A')}</span>
            </div>
            <div class="metadata-item">
                <span class="metadata-label">ë¶„ì„ íƒ€ì…:</span>
                <span class="metadata-value">{analysis_type or 'N/A'}</span>
            </div>
            <div class="metadata-item">
                <span class="metadata-label">ë¶„ì„ íƒ€ì„ìŠ¤íƒ¬í”„:</span>
                <span class="metadata-value">{analysis_result.get('analysis_timestamp', 'N/A')}</span>
            </div>
            <div class="metadata-item">
                <span class="metadata-label">íŒŒì¼ í¬ê¸° (ë°”ì´íŠ¸):</span>
                <span class="metadata-value">{file_size} bytes</span>
            </div>
            <div class="metadata-item">
                <span class="metadata-label">íŒŒì¼ í¬ê¸° (MB):</span>
                <span class="metadata-value">{file_size_mb} MB</span>
            </div>
            <div class="metadata-item">
                <span class="metadata-label">ì´ë¯¸ì§€ í•´ìƒë„:</span>
                <span class="metadata-value">{image_resolution}</span>
            </div>
            <div class="metadata-item">
                <span class="metadata-label">ì´ë¯¸ì§€ ë„ˆë¹„:</span>
                <span class="metadata-value">{image_width} pixels</span>
            </div>
            <div class="metadata-item">
                <span class="metadata-label">ì´ë¯¸ì§€ ë†’ì´:</span>
                <span class="metadata-value">{image_height} pixels</span>
            </div>
        </div>
        
        <div class="section">
            <h2>5. ì—°ê³„ ë³´ê´€ì„± (Chain of Custody)</h2>
            <table>
                <thead>
                    <tr>
                        <th>ë‹¨ê³„</th>
                        <th>ì‹œê°</th>
                        <th>ì„œë²„/AI ì •ë³´</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>íŒŒì¼ ì—…ë¡œë“œ</td>
                        <td>{upload_timestamp}</td>
                        <td>ì•ˆì‹¬í†¡ ì„œë²„</td>
                    </tr>
                    <tr>
                        <td>í•´ì‹œê°’ ê³„ì‚°</td>
                        <td>{upload_timestamp}</td>
                        <td>SHA-256</td>
                    </tr>
                    <tr>
                        <td>AI ë¶„ì„</td>
                        <td>{upload_timestamp}</td>
                        <td>AI ì„œë²„ (Gemini 2.5 Flash v1.0)</td>
                    </tr>
                    <tr>
                        <td>ê²°ê³¼ ìƒì„±</td>
                        <td>{upload_timestamp}</td>
                        <td>ë³´ê³ ì„œ ìƒì„± ì„œë²„</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="section">
            <h2>6. AI ë¶„ì„ ê²°ê³¼</h2>
            
            {f'''
            <h3>ë”¥í˜ì´í¬ ë¶„ì„ ê²°ê³¼(Sightengine):</h3>
            <div class="analysis-result">
                ë”¥í˜ì´í¬ì¼ í™•ë¥ : {analysis_result.get("deepfake_analysis", {{}}).get("type", {{}}).get("deepfake", 0):.1%}
            </div>
            
            <h3>ìƒì„¸ ë¶„ì„ ê²°ê³¼:</h3>
            <div class="box">
                <pre style="white-space: pre-wrap; font-family: 'Noto Sans KR', sans-serif; font-size: 12px; line-height: 1.4; margin: 0; padding: 10px; background-color: #f8f9fa; border-radius: 5px; overflow-x: auto;">{json.dumps(analysis_result.get('deepfake_analysis', {{}}), indent=2, ensure_ascii=False) if analysis_result.get('deepfake_analysis') else 'ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.'}</pre>
            </div>
            ''' if analysis_type == 'deepfake' else f'''
            <h3>ì¶”ì¶œ í…ìŠ¤íŠ¸(OCR):</h3>
            <div class="extracted-text">{extracted_text}</div>
            
            <h3>ì‚¬ì´ë²„í­ë ¥ ë¶„ì„ ê²°ê³¼(Gemini):</h3>
            <div class="analysis-result">
                ì „ì²´ ëŒ€í™” ì‚¬ì´ë²„í­ë ¥ ìœ„í—˜ë„: {analysis_result.get('cyberbullying_risk_line', 'N/A')}
            </div>
            
            <h3>ìƒì„¸ ë¶„ì„ ê²°ê³¼:</h3>
            <div class="box" style="font-size: 13px; line-height: 1.4; page-break-inside: auto;">
                {cyberbullying_analysis if cyberbullying_analysis else 'ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.'}
            </div>
            
            <h3>ì „ì²´ ë¶„ì„ ìš”ì•½:</h3>
            <div class="box" style="background: #f8f9fa; border-left: 4px solid #28a745; font-size: 13px; line-height: 1.4; page-break-inside: auto;">
                {cyberbullying_summary.replace('\n', '<br>') if cyberbullying_summary else 'ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.'}
            </div>
            '''}
        </div>
        
        <div class="section">
            <h2>7. ì›ë³¸ ì¦ê±° ì´ë¯¸ì§€</h2>
            {generate_image_html(original_image_path, analysis_result, original_file)}
            <div style="color:#1976d2; font-size:12px; margin-top:10px;">
                * ìœ„ ì´ë¯¸ì§€ëŠ” ë¶„ì„ ëŒ€ìƒ ì›ë³¸ ì¦ê±°ë¬¼ì…ë‹ˆë‹¤.
            </div>
        </div>
        
        <div class="section">
            <h2>8. ë¬´ê²°ì„± ë° ë²•ì  ê²€ì¦</h2>
            <ul>
                <li><b>ì›ë³¸(ì´ë¯¸ì§€) í•´ì‹œê°’:</b> <span class="code-block">{str(analysis_result.get('sha256', 'N/A'))}</span></li>
                <br>
                <li><b>ë²•ì  ì±…ì„ ì„ ì–¸:</b> <span class="long-text">ë³¸ ë³´ê³ ì„œëŠ” AI ê¸°ë°˜ ë¶„ì„ ê²°ê³¼ë¥¼ ì œê³µí•˜ë©° ë²•ë¥  ì „ë¬¸ê°€ì˜ íŒë‹¨ì„ ëŒ€ì²´í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë³´ê³ ì„œ ë‚´ìš©ì€ ì°¸ê³  ìë£Œë¡œë§Œ ì‚¬ìš©ë˜ì–´ì•¼ í•˜ë©° ë²•ì  ì±…ì„ì„ ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤. ì •í™•í•œ ë²•ì  ì¡°ì¹˜ë‚˜ ìƒë‹´ì„ ìœ„í•´ì„œëŠ” ë³€í˜¸ì‚¬ë‚˜ ê´€ë ¨ ê¸°ê´€ì— ë¬¸ì˜í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.</span></li>
            </ul>
        </div>
    </body>
    </html>
    """
    
    return html_content
```

---

## 6. app/templates/index.html
```html
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì•ˆì‹¬í†¡ - AI ê¸°ë°˜ ë””ì§€í„¸ ì•ˆì „ë§</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ì•ˆì‹¬í†¡</h1>
            <p class="tagline">AIë¡œ ë””ì§€í„¸ ì¦ê±°ë¥¼ ë¶„ì„í•˜ê³  ì•ˆì „í•˜ê²Œ ì¦ê±°í™”í•˜ì„¸ìš”.</p>
            <p class="developers">ê°œë°œì: ìœ¤ì—¬ì¤€íŒ€ì¥, ê¹€íƒœì–‘, ê¹€íƒœì˜</p>
        </div>
        
        <div class="analysis-sections">
            <!-- ë”¥í˜ì´í¬ ë¶„ì„ ì„¹ì…˜ -->
            <div class="analysis-card">
                <h2>ë”¥í˜ì´í¬ ë¶„ì„</h2>
                <p class="file-type-info">ì§€ì› íŒŒì¼ í˜•ì‹: PNG, JPG, JPEG (ì´ë¯¸ì§€ íŒŒì¼)</p>
                <form action="{{ url_for('main.analyze_deepfake') }}" method="post" enctype="multipart/form-data">
                    <div class="file-input-group">
                        <input type="file" name="file" id="deepfake-file" accept=".png,.jpg,.jpeg" style="display: none;">
                        <button type="button" class="file-select-btn" onclick="document.getElementById('deepfake-file').click()">íŒŒì¼ ì„ íƒ</button>
                        <span class="file-name" id="deepfake-file-name">ì„ íƒëœ íŒŒì¼ ì—†ìŒ</span>
                        <button type="submit" class="analyze-btn deepfake-btn">ë¶„ì„ ì‹œì‘</button>
                    </div>
                </form>
                <div style="margin-top: 10px; text-align: right;">
                    <a href="{{ url_for('main.deepfake_help') }}" class="help-link-btn" style="font-size:1em; color:#1976d2; font-weight:bold;">ë”¥í˜ì´í¬ í”¼í•´ ìƒë‹´/ì‹ ê³  ì•ˆë‚´ â†’</a>
                </div>
            </div>

            <!-- ì‚¬ì´ë²„í­ë ¥ ë¶„ì„ ì„¹ì…˜ -->
            <div class="analysis-card">
                <h2>ì‚¬ì´ë²„í­ë ¥ ë¶„ì„</h2>
                <p class="file-type-info">ì§€ì› íŒŒì¼ í˜•ì‹: TXT, PNG, JPG, JPEG (í…ìŠ¤íŠ¸ ë˜ëŠ” ì´ë¯¸ì§€ íŒŒì¼)</p>
                <form action="{{ url_for('main.analyze_cyberbullying') }}" method="post" enctype="multipart/form-data">
                    <div class="file-input-group">
                        <input type="file" name="file" id="cyberbullying-file" accept=".txt,.png,.jpg,.jpeg" style="display: none;">
                        <button type="button" class="file-select-btn" onclick="document.getElementById('cyberbullying-file').click()">íŒŒì¼ ì„ íƒ</button>
                        <span class="file-name" id="cyberbullying-file-name">ì„ íƒëœ íŒŒì¼ ì—†ìŒ</span>
                        <button type="submit" class="analyze-btn cyberbullying-btn">ë¶„ì„ ì‹œì‘</button>
                    </div>
                </form>
                <div style="margin-top: 10px; text-align: right;">
                    <a href="{{ url_for('main.cyberbullying_help') }}" class="help-link-btn" style="font-size:1em; color:#1976d2; font-weight:bold;">ì‚¬ì´ë²„í­ë ¥ ì‹ ê³  ì•ˆë‚´ â†’</a>
                </div>
            </div>
        </div>

        {% with messages = get_flashed_messages() %}
          {% if messages %}
            <div class="flash-messages">
              {% for message in messages %}
                <div class="flash-message">{{ message }}</div>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}
    </div>

    <script>
        // ë”¥í˜ì´í¬ íŒŒì¼ ì„ íƒ
        document.getElementById('deepfake-file').addEventListener('change', function(e) {
            const fileName = e.target.files[0] ? e.target.files[0].name : 'ì„ íƒëœ íŒŒì¼ ì—†ìŒ';
            document.getElementById('deepfake-file-name').textContent = fileName;
        });

        // ì‚¬ì´ë²„í­ë ¥ íŒŒì¼ ì„ íƒ
        document.getElementById('cyberbullying-file').addEventListener('change', function(e) {
            const fileName = e.target.files[0] ? e.target.files[0].name : 'ì„ íƒëœ íŒŒì¼ ì—†ìŒ';
            document.getElementById('cyberbullying-file-name').textContent = fileName;
        });
    </script>
</body>
</html>
```

---

## 7. app/templates/results.html
```html
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì•ˆì‹¬í†¡ - ë¶„ì„ ê²°ê³¼</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ë¶„ì„ ê²°ê³¼</h1>
            <p class="tagline">ìš”ì²­í•˜ì‹  íŒŒì¼ì— ëŒ€í•œ ë¶„ì„ ê²°ê³¼ì…ë‹ˆë‹¤.</p>
        </div>
        
        <div class="result-section file-info-section">
            <h2>íŒŒì¼ ì •ë³´</h2>
            <p><strong>íŒŒì¼ëª…:</strong> {{ result.file_info.filename }}</p>
            <p><strong>íŒŒì¼ í¬ê¸°:</strong> {{ "{:.2f} MB".format(result.file_info.size_bytes / (1024 * 1024)) }}</p>
            <p><strong>íŒŒì¼ íƒ€ì…:</strong> {{ result.file_info.type | upper }}</p>
            <p><strong>SHA-256 í•´ì‹œ:</strong> {{ result.sha256 }}</p>
            <p><strong>ë¶„ì„ ìš”ì²­ ì‹œê°:</strong> {{ result.analysis_timestamp }}</p>
        </div>

        {% if result.analysis_type == 'deepfake' %}
            <div class="result-section deepfake-analysis-section">
                <h2>AI ë”¥í˜ì´í¬ ë¶„ì„ ìš”ì•½</h2>
                {% if result.deepfake_analysis.error %}
                    <p class="error-message">ì˜¤ë¥˜: {{ result.deepfake_analysis.error }}</p>
                {% else %}
                    {% if result.deepfake_analysis.get('type', {}).get('deepfake') %}
                        <p><strong>ë”¥í˜ì´í¬ì¼ í™•ë¥ :</strong> <span class="score">{{ "{:.1f}%".format(result.deepfake_analysis.get('type', {}).get('deepfake', 0) * 100) }}</span></p>
                    {% endif %}
                    
                    {% if result.deepfake_analysis.get('offensive') %}
                        <p><strong>ìœ í•´ì„± ì ìˆ˜:</strong> <span class="score">{{ "{:.1f}%".format(result.deepfake_analysis.get('offensive', {}).get('prob', 0) * 100) }}</span></p>
                    {% endif %}
                    
                    {% if result.deepfake_analysis.get('nudity') %}
                        <p><strong>ë…¸ì¶œ ì ìˆ˜:</strong> <span class="score">{{ "{:.1f}%".format(result.deepfake_analysis.get('nudity', {}).get('raw', 0) * 100) }}</span></p>
                    {% endif %}
                    
                    <h3>ìƒì„¸ ë¶„ì„ ê²°ê³¼ (Raw Data):</h3>
                    <div class="raw-data-box">
                        <pre>{{ result.deepfake_analysis | tojson(indent=2) }}</pre>
                    </div>
                {% endif %}
            </div>
        {% elif result.analysis_type == 'cyberbullying' %}
            <!-- ì‚¬ì´ë²„í­ë ¥ ìœ„í—˜ë„ ì¹´ë“œ -->
            <div class="result-section risk-level-card">
                <div class="risk-header">
                    <div style="display: flex; justify-content: space-between; align-items: center; font-size: 1.2em;">
                        <span style="color: #3498db;">ì „ì²´ ëŒ€í™” ì‚¬ì´ë²„í­ë ¥ ìœ„í—˜ë„</span>
                        {% set risk_level = 'ë¶„ì„ ì¤‘' %}
                        {% set risk_class = 'risk-suspicion' %}
                        {% if result.cyberbullying_risk_line %}
                            {% set risk_level = result.cyberbullying_risk_line %}
                            {% if 'ì‹¬ê°' in result.cyberbullying_risk_line %}
                                {% set risk_class = 'risk-severe' %}
                            {% elif 'ìˆìŒ' in result.cyberbullying_risk_line %}
                                {% set risk_class = 'risk-present' %}
                            {% elif 'ì•½ê°„ ìˆìŒ' in result.cyberbullying_risk_line %}
                                {% set risk_class = 'risk-slight' %}
                            {% elif 'ì˜ì‹¬' in result.cyberbullying_risk_line %}
                                {% set risk_class = 'risk-suspicion' %}
                            {% elif 'ì—†ìŒ' in result.cyberbullying_risk_line %}
                                {% set risk_class = 'risk-none' %}
                            {% else %}
                                {% set risk_class = 'risk-suspicion' %}
                            {% endif %}
                        {% endif %}
                        <span class="risk-value {{ risk_class }}" style="color: #e74c3c;">{{ risk_level }}</span>
                    </div>
                </div>
            </div>

            <!-- ìƒì„¸ ë¶„ì„ ê²°ê³¼ëŠ” PDFì—ì„œë§Œ í‘œì‹œë˜ë„ë¡ ìˆ¨ê¹€ -->
            <div class="result-section cyberbullying-analysis-section">
                <h2>AI ëŒ€í™” ë‚´ìš© ë¶„ì„ ìš”ì•½</h2>
                
                {% if result.extracted_text %}
                    <h3>ì´ë¯¸ì§€ ì† ì¶”ì¶œ í…ìŠ¤íŠ¸:</h3>
                    <div class="extracted-text-box">
                        <pre>{{ result.extracted_text }}</pre>
                    </div>
                {% endif %}

                {% if result.cyberbullying_analysis %}
                    <h3>ì‚¬ì´ë²„í­ë ¥ ë¶„ì„ ê²°ê³¼(Gemini):</h3>
                    <div class="analysis-container" style="white-space: pre-line; background: #f8f8f8; padding: 1em; border-radius: 8px; line-height: 1.6;">
                        {{ result.cyberbullying_analysis | safe }}
                    </div>
                    
                    {% if result.cyberbullying_analysis_summary %}
                        <div class="analysis-summary" style="white-space: pre-line; background: #f0f0ff; padding: 1em; border-radius: 8px; line-height: 1.6; margin-top: 1em;">
                            <h4>ì „ì²´ ë¶„ì„ ìš”ì•½:</h4>
                            {% if result.cyberbullying_risk_line and 'ì „ì²´ ëŒ€í™” ì‚¬ì´ë²„í­ë ¥ ìœ„í—˜ë„:' not in result.cyberbullying_analysis_summary %}
ì „ì²´ ëŒ€í™” ì‚¬ì´ë²„í­ë ¥ ìœ„í—˜ë„: {{ result.cyberbullying_risk_line }}

{% endif %}{{ result.cyberbullying_analysis_summary | safe }}
                        </div>
                    {% endif %}
                {% else %}
                    <p class="error-message">ì‚¬ì´ë²„í­ë ¥ ë¶„ì„ ê²°ê³¼ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                {% endif %}
            </div>
        {% endif %}

        <div class="actions">
            <a href="{{ url_for('main.download_pdf') }}" class="btn primary-btn">ì¦ê±° ë³´ê³ ì„œ(PDF) ë‹¤ìš´ë¡œë“œ</a>
            {% if result.analysis_type == 'deepfake' %}
                <a href="{{ url_for('main.deepfake_help') }}" class="btn secondary-btn">ìƒë‹´/ì‹ ê³  ì•ˆë‚´</a>
            {% elif result.analysis_type == 'cyberbullying' %}
                <a href="{{ url_for('main.cyberbullying_help') }}" class="btn secondary-btn">ìƒë‹´/ì‹ ê³  ì•ˆë‚´</a>
            {% else %}
                <a href="https://www.safe182.go.kr/" target="_blank" class="btn secondary-btn">ìƒë‹´/ì‹ ê³  ì•ˆë‚´</a>
            {% endif %}
            <a href="{{ url_for('main.reset') }}" class="btn tertiary-btn">ìƒˆë¡œìš´ ë¶„ì„ ì‹œì‘</a>
        </div>
    </div>
</body>
</html>
```

---

## 8. app/templates/cyberbullying_help.html
```html
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì‚¬ì´ë²„í­ë ¥Â·ë”°ëŒë¦¼, ì–´ë–»ê²Œ ëŒ€ì²˜í• ê¹Œ?</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .help-container { max-width: 900px; margin: 40px auto; background: #fff; border-radius: 12px; box-shadow: 0 2px 8px #eee; padding: 32px; }
        .help-title { font-size: 1.7em; font-weight: bold; color: #b71c1c; margin-bottom: 10px; }
        .help-desc { font-size: 1.1em; margin-bottom: 24px; }
        .help-table { width: 100%; border-collapse: collapse; margin-bottom: 24px; }
        .help-table th, .help-table td { border: 1px solid #e0e0e0; padding: 12px 8px; text-align: left; }
        .help-table th { background: #f5f5f5; color: #333; }
        .help-table td a { text-decoration: none; font-weight: bold; color: #1976d2; }
        .help-table td a:hover { text-decoration: underline; }
        .help-tip { background: #fffde7; border-left: 6px solid #ffd600; padding: 14px 18px; margin-bottom: 18px; font-size: 1.05em; }
        .help-tip strong { color: #b71c1c; }
        .help-footer { font-size: 0.98em; color: #666; margin-top: 18px; }
        @media (max-width: 700px) { .help-container { padding: 10px; } .help-table th, .help-table td { font-size: 0.95em; } }
    </style>
</head>
<body>
<div class="help-container">
    <div class="help-title">ì‚¬ì´ë²„í­ë ¥Â·ë”°ëŒë¦¼, ì–´ë–»ê²Œ ëŒ€ì²˜í• ê¹Œ?</div>
    <div class="help-desc">
        ì˜¨ë¼ì¸ì—ì„œ ìš•ì„¤, ë”°ëŒë¦¼ ë“± ê´´ë¡­í˜ì„ ë‹¹í–ˆë‹¤ë©´, ê°€ì¥ ì¤‘ìš”í•œ ê±´ <b>'ë‚´ ë§ˆìŒ ì±™ê¸°ê¸°'</b>ì™€ <b>'í™•ì‹¤í•œ ì¦ê±° í™•ë³´í•˜ê¸°'</b>ì˜ˆìš”.<br>
        ì°¸ì§€ ë§ê³  ë°”ë¡œ ë„ì›€ì„ ìš”ì²­í•´ ë³´ì„¸ìš”.
    </div>
    <table class="help-table">
        <thead>
        <tr>
            <th>ê¸°ê´€ ì´ë¦„</th>
            <th>ì´ëŸ° ë„ì›€ì„ ì¤˜ìš”!</th>
            <th>ê¼­ ì•Œì•„ë‘ì„¸ìš”!</th>
            <th>ì´ëŸ° ìƒí™©ì— ë”±ì´ì—ìš”!</th>
            <th>ë°”ë¡œ ê°€ê¸°</th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td><b>1388 ì²­ì†Œë…„ ìƒë‹´ë³µì§€ì„¼í„°</b></td>
            <td>âœ… ìµëª… ìƒë‹´! 365ì¼ ì–¸ì œë“  ë‚´ ê³ ë¯¼ ë“£ê³  ë§ˆìŒ ì•ˆì • ë„ì™€ì¤Œ</td>
            <td>âš ï¸ ê°€í•´ì ì²˜ë²Œì´ë‚˜ ì§ì ‘ì  ì¡°ì¹˜ëŠ” ë¶ˆê°€ëŠ¥, ì¶”ê°€ ì‹ ê³  í•„ìš”</td>
            <td>ë§ˆìŒì´ í˜ë“¤ê³  ì–´ë–»ê²Œ í• ì§€ ëª¨ë¥´ê² ì„ ë•Œ ê°€ì¥ ë¨¼ì €!</td>
            <td>ğŸ“ 1388<br>ğŸ“± #1388 (ë¬¸ì)<br>ğŸ’¬ <a href="https://www.1388.go.kr/cco/YTOSP_SC_CCH_01" target="_blank">ì±„íŒ… ìƒë‹´</a></td>
        </tr>
        <tr>
            <td><b>117 í•™êµí­ë ¥ ì‹ ê³ ì„¼í„°</b></td>
            <td>âœ… ì¦‰ì‹œ ì¤‘ë‹¨ ê°€ëŠ¥! ê²½ì°°ì´ ì¦‰ê° ê°œì…í•´ ê´´ë¡­í˜ ì¤‘ë‹¨ ë° ë³´í˜¸ ì§€ì›</td>
            <td>âš ï¸ ê²½ì°° ê°œì…ìœ¼ë¡œ í•™êµì— ì•Œë ¤ì§ˆ ìˆ˜ ìˆìŒ, ì¹œêµ¬ ê´€ê³„ê°€ ì‹ ê²½ ì“°ì¸ë‹¤ë©° ì‹ ì¤‘í•˜ê²Œ ê²°ì •</td>
            <td>ì§€ì†ì ì¸ ê´´ë¡­í˜ì„ ë‹¹ì¥ ë©ˆì¶”ê³  ì‹¶ì€ ê¸´ê¸‰ ìƒí™©ì¼ ë•Œ</td>
            <td>ğŸ“ 117<br>ğŸ“± #0117 (ë¬¸ì)<br>ğŸŒ <a href="https://www.safe182.go.kr/pot/selectRptList.do?rptTyGubun=09" target="_blank">ì˜¨ë¼ì¸ ì‹ ê³ </a></td>
        </tr>

        <tr>
            <td><b>ê²½ì°°ì²­ ì‚¬ì´ë²„ë²”ì£„ ì‹ ê³ ì‹œìŠ¤í…œ(ECRM)</b></td>
            <td>âœ… ì •ì‹ ìˆ˜ì‚¬ ê°€ëŠ¥! ì˜¨ë¼ì¸ìœ¼ë¡œ í˜‘ë°•, ëª…ì˜ˆí›¼ì† ë“± ë²•ì  ì¡°ì¹˜ ê°€ëŠ¥</td>
            <td>âš ï¸ ì‹ ê³ ì„œ ì‘ì„± ë° ì¦ê±° í•„ìš”, ë²•ì  ì ˆì°¨ê°€ ë¶€ë‹´ë  ìˆ˜ ìˆìŒ</td>
            <td>ë²•ì  ì²˜ë²Œì´ í•„ìš”í•  ë§Œí¼ ì‹¬ê°í•œ í”¼í•´ë¥¼ ì…ì—ˆì„ ë•Œ</td>
            <td>ğŸŒ <a href="https://ecrm.police.go.kr/sci/pcc_V3_send?rp=c" target="_blank">ì˜¨ë¼ì¸ ì‹ ê³ </a></td>
        </tr>
        </tbody>
    </table>
    <div class="help-tip">
        <strong>ì‚¬ì´ë²„í­ë ¥ ëŒ€ì‘ TIP!</strong><br>
        â€¢ <b>í™•ì‹¤í•œ ì¦ê±° í•„ìˆ˜!</b> ìš•ì„¤ì´ë‚˜ ë”°ëŒë¦¼ í™”ë©´ì„ ë‚ ì§œì™€ í•¨ê»˜ ìº¡ì²˜í•´ ë³´ê´€í•˜ì„¸ìš”.<br>
        â€¢ <b>í•™êµì—ë„ ì•Œë¦¬ê¸°!</b> ë‹´ì„ ì„ ìƒë‹˜ì´ë‚˜ í•™êµì „ë‹´ê²½ì°°ê´€(SPO)ì—ê²Œë„ ì•Œë ¤ ë„ì›€ì„ ìš”ì²­í•˜ì„¸ìš”.<br>
        â€¢ <b>í”Œë«í¼ ì‹ ê³  ê¼­ í™œìš©!</b> SNS, ê²Œì„ ì±„íŒ… ë‚´ ì‹ ê³  ê¸°ëŠ¥ë„ ì¦‰ì‹œ ì‚¬ìš©í•˜ë©´ ì‹ ì†í•œ ì¡°ì¹˜ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.
    </div>
    <div class="help-footer">
        ê° ê¸°ê´€ëª… ì˜†ì˜ <b>ğŸŒ</b> ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ í•´ë‹¹ ê¸°ê´€ì˜ ê³µì‹ í™ˆí˜ì´ì§€/ìƒë‹´/ì‹ ê³  í˜ì´ì§€ë¡œ ë°”ë¡œ ì´ë™í•©ë‹ˆë‹¤.<br>
        ìƒë‹´/ì‹ ê³  ì „, ì¦ê±°(í™”ë©´ ìº¡ì²˜ ë“±)ë¥¼ ë¯¸ë¦¬ í™•ë³´í•´ë‘ë©´ ë”ìš± ì‹ ì†í•œ ì²˜ë¦¬ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.
    </div>
    <div style="margin-top:30px; text-align:right;">
        <a href="{{ url_for('main.index') }}" style="color:#1976d2; font-weight:bold;">â† ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
    </div>
</div>
</body>
</html>
```

---

## 9. app/templates/deepfake_help.html
```html
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë”¥í˜ì´í¬ í”¼í•´ ìƒë‹´/ì‹ ê³  ì•ˆë‚´</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .help-container { max-width: 900px; margin: 40px auto; background: #fff; border-radius: 12px; box-shadow: 0 2px 8px #eee; padding: 32px; }
        .help-title { font-size: 1.7em; font-weight: bold; color: #b71c1c; margin-bottom: 10px; }
        .help-desc { font-size: 1.1em; margin-bottom: 24px; }
        .help-table { width: 100%; border-collapse: collapse; margin-bottom: 24px; }
        .help-table th, .help-table td { border: 1px solid #e0e0e0; padding: 12px 8px; text-align: left; }
        .help-table th { background: #f5f5f5; color: #333; }
        .help-table td a { text-decoration: none; font-weight: bold; color: #1976d2; }
        .help-table td a:hover { text-decoration: underline; }
        .help-tip { background: #fffde7; border-left: 6px solid #ffd600; padding: 14px 18px; margin-bottom: 18px; font-size: 1.05em; }
        .help-tip strong { color: #b71c1c; }
        .help-footer { font-size: 0.98em; color: #666; margin-top: 18px; }
        @media (max-width: 700px) { .help-container { padding: 10px; } .help-table th, .help-table td { font-size: 0.95em; } }
    </style>
</head>
<body>
<div class="help-container">
    <div class="help-title">ë”¥í˜ì´í¬ í”¼í•´, ì–´ë””ì— ë„ì›€ì„ ì²­í• ê¹Œ?</div>
    <div class="help-desc">
        ë‚´ ì–¼êµ´ì´ ì´ìƒí•œ ì‚¬ì§„ì´ë‚˜ ì˜ìƒì— í•©ì„±ë˜ì–´ í¼ì§€ê³  ìˆë‹¤ë©´, ê°€ì¥ ì¤‘ìš”í•œ ê±´ <b>â€˜ë¹ ë¥¸ ì‚­ì œâ€™ì™€ â€˜í™•ì‚° ë°©ì§€â€™</b>ì˜ˆìš”.<br>
        ë‚˜ì—ê²Œ ë§ëŠ” ê¸°ê´€ì„ ë¹ ë¥´ê²Œ ì„ íƒí•´ ë„ì›€ì„ ìš”ì²­í•˜ì„¸ìš”.
    </div>
    <table class="help-table">
        <thead>
        <tr>
            <th>ê¸°ê´€ ì´ë¦„</th>
            <th>ì´ëŸ° ë„ì›€ì„ ì¤˜ìš”!</th>
            <th>ê¼­ ì•Œì•„ë‘ì„¸ìš”!</th>
            <th>ì´ëŸ° ìƒí™©ì— ë”±ì´ì—ìš”!</th>
            <th>ë°”ë¡œ ê°€ê¸°</th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td><b>ë””ì§€í„¸ì„±ë²”ì£„ í”¼í•´ì ì§€ì›ì„¼í„°</b></td>
            <td>ì‚­ì œ ì „ë¬¸ê°€! í”¼í•´ ì˜ìƒ ì‚­ì œ, ìœ í¬ í˜„í™© ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ì§€ì›(ë¬´ë£Œ)</td>
            <td>ì‚­ì œ ìš”ì²­ë§Œ ê°€ëŠ¥, í•´ì™¸ ì‚¬ì´íŠ¸ëŠ” ì²˜ë¦¬ ì§€ì—°ë  ìˆ˜ ìˆìŒ. ì¦ê±° ì œì¶œ í•„ìš”</td>
            <td>ë‚´ í•©ì„± ì‚¬ì§„/ì˜ìƒì´ ì¸í„°ë„·ì— í¼ì§€ê³  ìˆì„ ë•Œ ê°€ì¥ ë¨¼ì €!</td>
            <td><a href="https://d4u.stop.or.kr/write_consulting" target="_blank">ğŸŒ ìƒë‹´ ì‹ ì²­</a><br>02-735-8994</td>
        </tr>
        <tr>
            <td><b>117 í•™êµí­ë ¥ ì‹ ê³ ì„¼í„°</b></td>
            <td>ê°•ë ¥í•œ ë²•ì  ì¡°ì¹˜! ê²½ì°°ì´ ì§ì ‘ ê°€í•´ì ìˆ˜ì‚¬ ë° ì²˜ë²Œ, ê¸´ê¸‰ ë³´í˜¸ ì§€ì›</td>
            <td>ê²½ì°° ê°œì…ìœ¼ë¡œ ë¶€ëª¨ë‹˜ì´ë‚˜ í•™êµì— ì•Œë ¤ì§ˆ ê°€ëŠ¥ì„± ìˆìŒ</td>
            <td>ë°˜ë“œì‹œ ê°€í•´ìë¥¼ ì²˜ë²Œí•˜ê±°ë‚˜ ì‹ ë³€ ìœ„í—˜ì´ ëŠê»´ì§ˆ ë•Œ</td>
            <td><a href="https://www.safe182.go.kr/pot/selectRptList.do?rptTyGubun=09" target="_blank">ğŸŒ ì˜¨ë¼ì¸ ì‹ ê³ </a><br>â˜ 117<br>#0117 (ë¬¸ì)</td>
        </tr>
        <tr>
            <td><b>1388 ì²­ì†Œë…„ ìƒë‹´ë³µì§€ì„¼í„°</b></td>
            <td>ë§ˆìŒì˜ ì‘ê¸‰ì²˜ì¹˜! 365ì¼ ì–¸ì œë‚˜ ìµëª…ìœ¼ë¡œ ë‚´ ê³ ë¯¼/ìœ„ê¸° ë§ˆìŒ ì•ˆì • ì§€ì›</td>
            <td>ìƒë‹´ ì¤‘ì‹¬ìœ¼ë¡œ ì§ì ‘ì ì¸ ì‚­ì œë‚˜ ì²˜ë²Œ ë¶ˆê°€, ì¶”ê°€ ì¡°ì¹˜ í•„ìš”</td>
            <td>ë¶ˆì•ˆí•˜ê³  í˜ë“¤ ë•Œ, ëˆ„êµ¬í•˜ê³  ì¦‰ì‹œ ì´ì•¼ê¸°í•˜ê³  ì‹¶ì„ ë•Œ</td>
            <td><a href="https://www.1388.go.kr/cco/YTOSP_SC_CCH_01" target="_blank">ğŸŒ ì±„íŒ…ìƒë‹´</a><br>â˜ 1388</td>
        </tr>
        <tr>
            <td><b>ë°©ì†¡í†µì‹ ì‹¬ì˜ìœ„ì›íšŒ</b></td>
            <td>ê³µì‹ì ì¸ ì‚­ì œ ìš”ì²­! ëª…ì˜ˆí›¼ì† ê²Œì‹œë¬¼ ê³µì‹ ì‹¬ì˜ ë° ì‚­ì œ/ì°¨ë‹¨ ìš”ì²­ ê°€ëŠ¥</td>
            <td>ì²˜ë¦¬ê¹Œì§€ í•œ ë‹¬ ì´ìƒ ì†Œìš”ë  ìˆ˜ ìˆê³  ê¸´ê¸‰ ìƒí™©ì—” ì í•©í•˜ì§€ ì•ŠìŒ</td>
            <td>êµ­ë‚´ ì‚¬ì´íŠ¸ ê²Œì‹œë¬¼ì´ ì‚­ì œë˜ì§€ ì•Šì„ ë•Œ ê³µì‹ ì¡°ì¹˜ í•„ìš”</td>
            <td><a href="https://report.kocsc.or.kr/report/auth/digitalSexualAssault" target="_blank">ğŸŒ ë”¥í˜ì´í¬ ì‹ ê³ </a><br>â˜ 1377</td>
        </tr>
        </tbody>
    </table>
    <div class="help-tip">
        <strong>ë”¥í˜ì´í¬ í”¼í•´ ëŒ€ì‘ TIP!</strong><br>
        â€¢ <b>ì¦ê±° í™•ë³´ í•„ìˆ˜!</b> í”¼í•´ ì˜ìƒ, ì‚¬ì§„, URLì„ ê¼­ ì €ì¥í•´ë‘ì„¸ìš”.<br>
        â€¢ <b>SNS ìì²´ ì‹ ê³  í™œìš©!</b> ì¸ìŠ¤íƒ€ê·¸ë¨, í‹±í†¡ ë“± SNSì˜ ì‹ ê³  ê¸°ëŠ¥ë„ ì¦‰ì‹œ ì‚¬ìš©í•˜ì„¸ìš”.
    </div>
    <div class="help-footer">
        ê° ê¸°ê´€ëª… ì˜†ì˜ <b>ğŸŒ</b> ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ í•´ë‹¹ ê¸°ê´€ì˜ ê³µì‹ í™ˆí˜ì´ì§€/ìƒë‹´/ì‹ ê³  í˜ì´ì§€ë¡œ ë°”ë¡œ ì´ë™í•©ë‹ˆë‹¤.<br>
        ìƒë‹´/ì‹ ê³  ì „, ì¦ê±°(ì˜ìƒ, ì‚¬ì§„, URL ë“±)ë¥¼ ë¯¸ë¦¬ í™•ë³´í•´ë‘ë©´ ë”ìš± ì‹ ì†í•œ ì²˜ë¦¬ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.
    </div>
    <div style="margin-top:30px; text-align:right;">
        <a href="{{ url_for('main.index') }}" style="color:#1976d2; font-weight:bold;">â† ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
    </div>
</div>
</body>
</html>
```

---

## 10. app/templates/evidence_report.html
```html
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>ì•ˆì‹¬í†¡ ë””ì§€í„¸ ì¦ê±° ë¶„ì„ ë³´ê³ ì„œ</title>
  <style>
    @font-face {
      font-family: 'NanumGothic';
      src: url('{{ url_for("static", filename="fonts/NanumGothic.ttf") }}') format('truetype');
      font-weight: normal;
      font-style: normal;
    }
    
    body { 
      font-family: 'NanumGothic', 'Malgun Gothic', 'Arial', sans-serif; 
      margin: 40px; 
      line-height: 1.6;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
    
    h1, h2, h3 { 
      color: #1976d2; 
      page-break-after: avoid;
      page-break-inside: avoid;
    }
    
    .code-block { 
      font-family: 'Consolas', 'Monaco', monospace; 
      background: #eee; 
      padding: 8px; 
      border-radius: 4px; 
      word-break: break-all;
      font-size: 11px;
    }
    
    .highlight { 
      color: #fff; 
      background: #1976d2; 
      padding: 4px 8px; 
      border-radius: 4px; 
    }
    
    table { 
      border-collapse: collapse; 
      width: 100%; 
      margin: 10px 0; 
      font-size: 11px;
      page-break-inside: avoid;
    }
    
    th, td { 
      border: 1px solid #bbb; 
      padding: 6px 8px; 
      word-wrap: break-word;
      max-width: 200px;
    }
    
    th { 
      background: #f5f5f5; 
      font-weight: bold;
    }
    
    img.evidence { 
      max-width: 400px; 
      margin: 10px 0; 
      page-break-inside: avoid;
    }
    
    .section { 
      margin-bottom: 30px; 
      page-break-inside: avoid; 
    }
    
    ul { 
      margin: 0 0 0 20px; 
      page-break-inside: avoid;
    }
    
    li {
      margin-bottom: 5px;
      word-wrap: break-word;
    }
    
    .box { 
      background: #f0f4ff; 
      border-radius: 8px; 
      padding: 12px; 
      margin: 10px 0; 
      page-break-inside: avoid;
      word-wrap: break-word;
    }
    
    .emph { 
      font-weight: bold; 
      color: #d32f2f; 
    }
    
    pre {
      white-space: pre-wrap;
      word-wrap: break-word;
      font-size: 10px;
      max-width: 100%;
      overflow-x: auto;
    }
    
    /* ê¸´ í…ìŠ¤íŠ¸ ì²˜ë¦¬ */
    .long-text {
      word-wrap: break-word;
      overflow-wrap: break-word;
      max-width: 100%;
    }
    
    /* WeasyPrint footer for every page */
    @page {
      size: A4;
      margin: 40px 40px 50px 40px;
      @bottom-center {
        content: element(report-footer);
      }
    }
    
    #report-footer {
      position: running(report-footer);
      font-size: 10px;
      color: #888;
      text-align: right;
      width: 100%;
    }
    
    /* í‘œ ë‚´ìš©ì´ ê¸¸ ë•Œ ì²˜ë¦¬ */
    .md-table {
      font-size: 10px;
    }
    
    .md-table th,
    .md-table td {
      max-width: 150px;
      word-wrap: break-word;
      vertical-align: top;
    }
  </style>
</head>
<body>
  <div id="report-footer">
    ë³´ê³ ì„œID: {{ report_id }} | ìƒì„±ì¼ì‹œ: {{ created_at }} | í”Œë«í¼: {{ software_info.platform }} | ë°°í¬ì¼: {{ software_info.release_date }}
  </div>
  <h1>ì•ˆì‹¬í†¡ ë””ì§€í„¸ ì¦ê±° ë¶„ì„ ë³´ê³ ì„œ</h1>
  <div class="section">
    <h2>1. ê¸°ë³¸ ì •ë³´</h2>
    <ul>
      <li><b>ë³´ê³ ì„œ ID:</b> {{ report_id }}</li>
      <li><b>ìƒì„±ì¼ì‹œ:</b> {{ created_at }}</li>
      <li><b>í”Œë«í¼ ë²„ì „:</b> {{ software_info.platform }}</li>
      <li><b>ë°°í¬ì¼:</b> {{ software_info.release_date }}</li>
      <li><b>ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸:</b> {{ software_info.last_updated }}</li>
    </ul>
  </div>
  <div class="section">
    <h2>2. ë¶„ì„ì— ì‚¬ìš©ëœ AI ëª¨ë¸ ì „ì²´ ëª©ë¡</h2>
    <table>
      <tr><th>ë¶„ì„ Task</th><th>ëª¨ë¸ëª…</th><th>ë²„ì „</th><th>ì •í™•ë„</th></tr>
      {% for m in ai_models %}
      <tr>
        <td>{{ m.task }}</td>
        <td>{{ m.model }}</td>
        <td>{{ m.version }}</td>
        <td>{{ m.ì •í™•ë„ }}</td>
      </tr>
      {% endfor %}
    </table>
  </div>
  <div class="section">
    <h2>3. ë¶„ì„ ê²°ê³¼ ìš”ì•½</h2>
    <div class="box" style="font-size: 1.1em;">
      {% if analysis_type == 'chat' %}
        <span style="color:#1976d2; font-weight:bold;">ì‚¬ì´ë²„í­ë ¥ ë¶„ì„ ê²°ê³¼ ìš”ì•½</span><br>
        <span style="color:#d32f2f; font-weight:bold; font-size:1.2em;">{{ ai_results.gemini.cyberbullying_label or 'ë¶„ì„ ê²°ê³¼ ì—†ìŒ' }}</span>
      {% elif analysis_type == 'deepfake' %}
        <span style="color:#1976d2; font-weight:bold;">AI ë”¥í˜ì´í¬ ë¶„ì„ ìš”ì•½</span><br>
        {% if ai_results.deepfake.score is defined and ai_results.deepfake.score is not none %}
          <span>ë”¥í˜ì´í¬ì¼ í™•ë¥ : <b>{{ (ai_results.deepfake.score * 100) | round(1) }}%</b></span>
        {% elif ai_results.deepfake.raw is defined and 'score' in ai_results.deepfake.raw and ai_results.deepfake.raw['score'] is not none %}
          <span>ë”¥í˜ì´í¬ì¼ í™•ë¥ : <b>{{ (ai_results.deepfake.raw['score'] * 100) | round(1) }}%</b></span>
        {% elif ai_results.deepfake.raw is defined and 'type' in ai_results.deepfake.raw and 'deepfake' in ai_results.deepfake.raw['type'] and ai_results.deepfake.raw['type']['deepfake'] is not none %}
          <span>ë”¥í˜ì´í¬ì¼ í™•ë¥ : <b>{{ (ai_results.deepfake.raw['type']['deepfake'] * 100) | round(1) }}%</b></span>
        {% else %}
          <span>ë”¥í˜ì´í¬ì¼ í™•ë¥ : <b>N/A%</b></span>
        {% endif %}
      {% else %}
        <div class="long-text">{{ analysis_summary or 'ë¶„ì„ ê²°ê³¼ ìš”ì•½ì´ ì œê³µë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.' }}</div>
      {% endif %}
    </div>
  </div>
  <div class="section">
    <h2>4. ì¦ê±° íŒŒì¼ ì •ë³´</h2>
    <ul>
      <li><b>íŒŒì¼ëª…:</b> <span class="long-text">{{ original_file.filename }}</span></li>
      <li><b>íŒŒì¼ ìœ í˜•:</b> {{ original_file.filetype }}</li>
      <li><b>íŒŒì¼ í¬ê¸°:</b> {{ original_file.filesize }} Bytes</li>
      <li><b>ì—…ë¡œë“œ ì¼ì‹œ:</b> {{ original_file.uploaded_at }}</li>
      <li><b>ì—…ë¡œë” ID:</b> {{ original_file.uploader_id }}</li>
      <li><b>ì—…ë¡œë“œ IP:</b> {{ original_file.uploader_ip }}</li>
      <li><b>ì›ë³¸ í•´ì‹œê°’ (SHA-256):</b> <span class="code-block">{{ original_file.sha256 }}</span></li>
    </ul>
    <h3>ì›ë³¸ íŒŒì¼ ë©”íƒ€ë°ì´í„°</h3>
    <ul>
      {% for k, v in original_file.metadata.items() %}
        <li><b>{{ k }}:</b> <span class="long-text">{{ v }}</span></li>
      {% endfor %}
    </ul>
  </div>
  <div class="section">
    <h2>5. ì—°ê³„ ë³´ê´€ì„±(Chain of Custody)</h2>
    <table>
      <tr>
        <th>ë‹¨ê³„</th>
        <th>ì‹œê°</th>
        <th>ì„œë²„/AI ì •ë³´</th>
      </tr>
      {% for log in analysis_log %}
      <tr>
        <td>{{ log.step }}</td>
        <td>{{ log.timestamp }}</td>
        <td class="long-text">
          {{ log.server }}
          {% if log.ai_model %} ({{ log.ai_model }} {{ log.version }}){% endif %}
        </td>
      </tr>
      {% endfor %}
    </table>
  </div>
  <div class="section">
    <h2>6. AI ë¶„ì„ ê²°ê³¼</h2>
    {% if analysis_type == 'deepfake' %}
      <div class="box">
        <b>ë”¥í˜ì´í¬ ë¶„ì„ ê²°ê³¼ (Deepfake-Detector):</b><br>
        <div style="white-space:pre-line; background:#f0f0ff; padding:0.5em; border-radius:6px; font-size: 11px;" class="long-text">
          {{ ai_results.deepfake.analysis_summary or 'ë¶„ì„ ê²°ê³¼ ì—†ìŒ' }}
        </div>
        <div style="margin-top:10px; font-size:11px; color:#555;">
          <b>ì›ë³¸ ë¶„ì„ ë°ì´í„°:</b><br>
          <pre style="background:#f8f8f8; border-radius:6px; padding:0.5em;">{{ ai_results.deepfake.raw | tojson(indent=2) }}</pre>
        </div>
      </div>
    {% elif analysis_type == 'chat' %}
      <div class="box">
        <b>ì¶”ì¶œ í…ìŠ¤íŠ¸(OCR):</b><br>
        <div style="white-space:pre-line; background:#f8f8f8; padding:0.5em; border-radius:6px; font-size: 11px;" class="long-text">{{ ai_results.ocr.extracted_text or 'ì—†ìŒ' }}</div>
      </div>
      <div class="box">
        <b>ì‚¬ì´ë²„í­ë ¥ ë¶„ì„ ê²°ê³¼(Gemini):</b><br>
        <div style="white-space:pre-line; line-height:1.6; font-size: 11px;" class="long-text">
          {{ ai_results.gemini.cyberbullying_analysis | pipe_table_to_html | safe }}
        </div>
      </div>
      <div class="box" style="margin-top:10px; white-space:pre-line; line-height:1.6; font-size: 11px;" class="long-text">
        {{ ai_results.gemini.cyberbullying_analysis_summary }}
      </div>
    {% endif %}
  </div>
  <div class="section">
    <h2>7. ì›ë³¸ ì¦ê±° ì´ë¯¸ì§€</h2>
    {% if image_path %}
      <img class="evidence" src="{{ image_path }}" alt="ì¦ê±° ì´ë¯¸ì§€"/>
      {% if highlight_regions %}
        <div style="color:#1976d2; font-size:12px;">* í•˜ì´ë¼ì´íŠ¸: 
          {% for region in highlight_regions %}
            [{{ region.label }}: x={{ region.x }}, y={{ region.y }}, w={{ region.width }}, h={{ region.height }}]
          {% endfor %}
        </div>
      {% endif %}
    {% else %}
      <p>ì´ë¯¸ì§€ ì—†ìŒ</p>
    {% endif %}
  </div>
  <div class="section">
    <h2>8. ë¬´ê²°ì„± ë° ë²•ì  ê²€ì¦</h2>
    <ul>
      <li><b>ì›ë³¸(ì´ë¯¸ì§€) í•´ì‹œê°’:</b> <span class="code-block">{{ original_file.sha256 }}</span></li>
      <br><br>
      <li><b>PDF í•´ì‹œê°’:</b> <span class="code-block">{{ pdf_sha256 }}</span></li>
      <br>
      <li><b>ë²•ì  ì±…ì„ ì„ ì–¸:</b> <span class="long-text">{{ legal_disclaimer }}</span></li>
    </ul>
  </div>
</body>
</html>
```

---

## 11. app/templates/evidence.html
```html
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì•ˆì‹¬í†¡ - ì¦ê±° ë³´ê³ ì„œ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <h1>ì¦ê±° ë³´ê³ ì„œ</h1>
        <p>ë¶„ì„ ê²°ê³¼ë¥¼ PDFë¡œ ì €ì¥í•´ ë²•ì  ì¦ê±°ë¡œ í™œìš©í•˜ì„¸ìš”.</p>
        <div id="downloadMsg" style="margin-top:10px; color:green; display:none;">
            ë‹¤ìš´ë¡œë“œê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.<br>
            ë‹¤ìš´ë¡œë“œê°€ ì™„ë£Œë˜ë©´ <b>ë¸Œë¼ìš°ì €ì˜ ê¸°ë³¸ ë‹¤ìš´ë¡œë“œ í´ë”</b>ì—ì„œ íŒŒì¼ì„ í™•ì¸í•˜ì„¸ìš”.
        </div>
        <div class="actions">
            <a href="{{ url_for('main.download_pdf') }}" class="btn">PDF ë‹¤ìš´ë¡œë“œ</a>
            <a href="https://www.safe182.go.kr/" target="_blank" class="btn">ìƒë‹´/ì‹ ê³  ì•ˆë‚´</a>
            <a href="/" class="btn">ë¶„ì„ ì¢…ë£Œ ë° ìƒˆë¡œ ì‹œì‘</a>
        </div>
    </div>
    <script>
    document.getElementById('download-pdf').addEventListener('click', function() {
        document.getElementById('downloadMsg').style.display = 'block';
    });
    </script>
</body>
</html>
```

---

## 12. app/static/css/style.css
```css
/* Font Face Definitions */
@font-face {
    font-family: 'NanumGothic';
    src: url('../fonts/NanumGothic.ttf') format('truetype');
    font-weight: normal;
    font-style: normal;
}

@font-face {
    font-family: 'NanumGothic';
    src: url('../fonts/NanumGothic-Bold.ttf') format('truetype');
    font-weight: bold;
    font-style: normal;
}

@font-face {
    font-family: 'NanumGothic';
    src: url('../fonts/NanumGothic-ExtraBold.ttf') format('truetype');
    font-weight: 800;
    font-style: normal;
}

/* General Body Styles */
body {
    font-family: 'NanumGothic', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: #333;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    min-height: 100vh;
    margin: 0;
    padding: 20px;
    box-sizing: border-box;
    overflow-x: hidden;
}

/* Container for the main content */
.container {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    padding: 40px 50px;
    border-radius: 25px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15), 0 10px 20px rgba(0, 0, 0, 0.1);
    text-align: center;
    max-width: 700px;
    width: 100%;
    box-sizing: border-box;
    word-wrap: break-word;
    overflow-wrap: break-word;
    border: 1px solid rgba(255, 255, 255, 0.3);
    backdrop-filter: blur(10px);
}

/* Header Section */
.header {
    margin-bottom: 40px;
}

.header h1 {
    color: #2c3e50; /* Darker, professional blue */
    margin-bottom: 10px;
    font-size: 2.8em;
    font-weight: 700;
}

.header .tagline {
    color: #7f8c8d; /* Muted grey for body text */
    margin-bottom: 15px;
    font-size: 1.2em;
    line-height: 1.6;
}

.header .developers {
    color: #95a5a6;
    font-size: 0.9em;
}

/* Analysis Sections */
.analysis-sections {
    display: flex;
    flex-direction: column; /* Stack cards vertically */
    gap: 30px; /* Space between cards */
    margin-bottom: 40px;
}

.analysis-card {
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    padding: 30px;
    border-radius: 16px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08), 0 3px 10px rgba(0, 0, 0, 0.03);
    text-align: left;
    border: 1px solid rgba(0, 0, 0, 0.05);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.analysis-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 35px rgba(0, 0, 0, 0.12), 0 5px 15px rgba(0, 0, 0, 0.05);
}

.analysis-card h2 {
    color: #34495e;
    font-size: 1.8em;
    margin-bottom: 15px;
    border-bottom: 2px solid #eceff1;
    padding-bottom: 10px;
}

.analysis-card .file-type-info {
    font-size: 0.95em;
    color: #7f8c8d;
    margin-bottom: 25px;
}

/* File Input Group */
.file-input-group {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap; /* Allow wrapping on small screens */
}

.file-select-btn {
    background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
    color: white;
    padding: 12px 24px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-size: 1em;
    font-weight: 600;
    transition: all 0.3s ease;
    white-space: nowrap;
    box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
}

.file-select-btn:hover {
    background: linear-gradient(135deg, #2980b9 0%, #1f5f8b 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
}

.file-name {
    flex-grow: 1;
    padding: 10px;
    border: 1px solid #bdc3c7;
    border-radius: 8px;
    background-color: #ecf0f1;
    color: #34495e;
    font-size: 0.95em;
    word-wrap: break-word;
    overflow-wrap: break-word;
    min-width: 0; /* Allow flex item to shrink */
}

.analyze-btn {
    background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
    color: white;
    padding: 12px 24px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-size: 1em;
    font-weight: 600;
    transition: all 0.3s ease;
    white-space: nowrap;
    box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
}

.analyze-btn:hover {
    background: linear-gradient(135deg, #27ae60 0%, #1e8449 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(46, 204, 113, 0.4);
}

/* Result Section Styling */
.result-section {
    margin-bottom: 30px;
    text-align: left;
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    padding: 25px;
    border-radius: 16px;
    border: 1px solid #e9ecef;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.result-section:hover {
    transform: translateY(-1px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
}

.result-section h2 {
    color: #2c3e50;
    border-bottom: 2px solid #cfd8dc; /* Lighter border */
    padding-bottom: 12px;
    margin-bottom: 20px;
    font-size: 1.8em;
    font-weight: 600;
}

.result-section h3 {
    color: #34495e;
    margin-top: 25px;
    margin-bottom: 15px;
    font-size: 1.4em;
    font-weight: 600;
}

.result-section p, .result-section ul {
    color: #555;
    font-size: 1em;
    line-height: 1.5;
    word-wrap: break-word;
    overflow-wrap: break-word;
    white-space: normal;
}

.result-section ul {
    list-style: none;
    padding: 0;
}

.result-section ul li {
    margin-bottom: 10px;
}

.result-section strong {
    color: #2c3e50;
    word-wrap: break-word;
    overflow-wrap: break-word;
}

/* Label Styling (for severity, etc.) */
.label {
    background-color: #f1c40f; /* Yellow for general labels */
    color: #333;
    padding: 5px 10px;
    border-radius: 5px;
    font-weight: 700;
    display: inline-block;
    margin-left: 5px;
}

/* Actions Section */
.actions {
    margin-top: 40px;
    display: flex;
    justify-content: center;
    gap: 20px; /* Space between buttons */
}

/* Button Variants */
.btn {
    padding: 12px 25px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1em;
    font-weight: 600;
    text-decoration: none;
    display: inline-block;
    transition: background-color 0.3s ease, transform 0.2s ease;
    white-space: nowrap;
}

.primary-btn {
    background-color: #3498db; /* Blue */
    color: white;
}

.primary-btn:hover {
    background-color: #2980b9;
    transform: translateY(-2px);
}

.secondary-btn {
    background-color: #95a5a6; /* Muted grey */
    color: white;
}

.secondary-btn:hover {
    background-color: #7f8c8d;
    transform: translateY(-2px);
}

.tertiary-btn {
    background-color: #e74c3c; /* Red for reset/danger */
    color: white;
}

.tertiary-btn:hover {
    background-color: #c0392b;
    transform: translateY(-2px);
}

/* Flash Messages */
.flash-messages {
    list-style: none;
    padding: 0;
    margin: 25px 0 0 0;
}

.flash-message {
    padding: 15px 20px;
    margin-bottom: 15px;
    border-radius: 8px;
    font-weight: 600;
    text-align: center;
}

/* Severity Labels */
.label.severity-ì—†ìŒ {
    background-color: #27ae60; /* Green */
    color: white;
}

.label.severity-ì˜ì‹¬ {
    background-color: #f39c12; /* Orange */
    color: white;
}

.label.severity-ì•½ê°„ìˆìŒ {
    background-color: #e67e22; /* Dark orange */
    color: white;
}

.label.severity-ìˆìŒ {
    background-color: #e74c3c; /* Red */
    color: white;
}

.label.severity-ì‹¬ê° {
    background-color: #8e44ad; /* Purple */
    color: white;
}

/* Extracted Text Box */
.extracted-text-box {
    background-color: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 15px;
    margin-top: 15px;
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    font-size: 0.9em;
    line-height: 1.4;
    overflow-x: auto;
    white-space: pre-wrap;
    word-wrap: break-word;
}

/* Analysis Table */
.analysis-table table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}

.analysis-table th, .analysis-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #e9ecef;
}

.analysis-table th {
    background-color: #f8f9fa;
    font-weight: 600;
    color: #2c3e50;
}

/* Analysis Summary */
.analysis-summary {
    background-color: #f0f0ff;
    border: 1px solid #d6d6ff;
    border-radius: 8px;
    padding: 20px;
    margin-top: 20px;
    line-height: 1.6;
}

.analysis-summary h4 {
    color: #2c3e50;
    margin-top: 0;
    margin-bottom: 15px;
    font-size: 1.2em;
    font-weight: 600;
}

/* Analysis Container */
.analysis-container {
    background-color: #f8f8f8;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 20px;
    margin-top: 15px;
    line-height: 1.6;
    white-space: pre-line;
}

/* Analysis Table */
.analysis-table {
    margin-top: 20px;
    overflow-x: auto;
}

.analysis-table th, .analysis-table td {
    padding: 12px 15px;
    text-align: left;
    border-bottom: 1px solid #e9ecef;
    font-size: 0.95em;
}

.analysis-table th {
    background-color: #f8f9fa;
    font-weight: 600;
    color: #2c3e50;
    position: sticky;
    top: 0;
}

.analysis-table tr:nth-child(even) {
    background-color: #f8f9fa;
}

.analysis-table tr:hover {
    background-color: #e9ecef;
}

/* Risk Level Colors */
.risk-severe {
    color: #e74c3c !important;
    font-weight: 700;
}

.risk-present {
    color: #f39c12 !important;
    font-weight: 700;
}

.risk-slight {
    color: #f1c40f !important;
    font-weight: 700;
}

.risk-suspicion {
    color: #3498db !important;
    font-weight: 700;
}

.risk-none {
    color: #27ae60 !important;
    font-weight: 700;
}

/* Error Message */
.error-message {
    color: #e74c3c;
    background-color: #fdf2f2;
    border: 1px solid #fecaca;
    border-radius: 8px;
    padding: 15px;
    margin-top: 15px;
    font-weight: 600;
}

/* Score Styling */
.score {
    font-weight: 700;
    color: #e74c3c;
    font-size: 1.1em;
}

/* Raw Data Box */
.raw-data-box {
    background-color: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 15px;
    margin-top: 15px;
    overflow-x: auto;
    font-family: 'Courier New', monospace;
    font-size: 0.85em;
    line-height: 1.4;
    word-wrap: break-word;
    overflow-wrap: break-word;
}

.raw-data-box pre {
    margin: 0;
    white-space: pre-wrap;
    word-wrap: break-word;
    color: #2c3e50;
}

/* File Info Section */
.file-info-section p {
    word-wrap: break-word;
    overflow-wrap: break-word;
    white-space: normal;
    margin-bottom: 12px;
    padding: 8px 0;
    border-bottom: 1px solid #f0f0f0;
}

.file-info-section p:last-child {
    border-bottom: none;
}

.file-info-section strong {
    display: inline-block;
    min-width: 120px;
    color: #2c3e50;
    font-weight: 600;
}

/* Risk Level Card */
.risk-level-card {
    background-color: #ffffff;
    border: 2px solid #e9ecef;
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 30px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
}

.risk-level-card .risk-header {
    margin-bottom: 15px;
}

.risk-level-card .risk-title {
    font-size: 1.3em;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 10px;
}

.risk-level-card .risk-value {
    font-size: 1.4em;
    font-weight: 700;
    padding: 8px 16px;
    border-radius: 8px;
    display: inline-block;
}

.risk-level-card .risk-severe {
    background-color: #fdf2f2;
    color: #e74c3c;
}

.risk-level-card .risk-present {
    background-color: #fef5e7;
    color: #f39c12;
}

.risk-level-card .risk-slight {
    background-color: #fef9e7;
    color: #f1c40f;
}

.risk-level-card .risk-suspicion {
    background-color: #ebf8ff;
    color: #3498db;
}

.risk-level-card .risk-none {
    background-color: #f0fff4;
    color: #27ae60;
}

/* Mobile Responsive Design */
@media (max-width: 768px) {
    body {
        padding: 10px;
        align-items: flex-start;
        overflow-x: hidden;
    }
    
    .container {
        padding: 25px 20px;
        margin-top: 20px;
        margin-bottom: 20px;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    
    .header h1 {
        font-size: 2.2em;
    }
    
    .header .tagline {
        font-size: 1.1em;
    }
    
    .analysis-card {
        padding: 20px;
    }
    
    .analysis-card h2 {
        font-size: 1.6em;
    }
    
    .file-input-group {
        flex-direction: column;
        align-items: stretch;
        gap: 15px;
    }
    
    .file-select-btn, .analyze-btn {
        width: 100%;
        margin-bottom: 10px;
        white-space: normal;
        word-wrap: break-word;
    }
    
    .file-name {
        margin-bottom: 10px;
        word-wrap: break-word;
        overflow-wrap: break-word;
        white-space: normal;
    }
    
    .actions {
        flex-direction: column;
        gap: 15px;
    }
    
    .btn {
        width: 100%;
        text-align: center;
    }
    
    .result-section {
        padding: 20px;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    
    .file-info-section p {
        font-size: 0.9em;
        line-height: 1.4;
    }
    
    .file-info-section strong {
        min-width: 100px;
        font-size: 0.9em;
    }
    
    .result-section h2 {
        font-size: 1.6em;
        word-wrap: break-word;
    }
    
    .result-section h3 {
        font-size: 1.3em;
        word-wrap: break-word;
    }
    
    .analysis-table {
        font-size: 0.9em;
        table-layout: fixed;
        width: 100%;
    }
    
    .analysis-table th, .analysis-table td {
        padding: 8px 10px;
        word-wrap: break-word;
        overflow-wrap: break-word;
        white-space: normal;
    }
    
    .label {
        font-size: 0.9em;
        padding: 4px 8px;
    }
    
    .extracted-text-box {
        font-size: 0.85em;
        padding: 12px;
    }
    
    .raw-data-box {
        font-size: 0.8em;
        padding: 12px;
        word-wrap: break-word;
        overflow-wrap: break-word;
        white-space: pre-wrap;
    }
    
    .risk-level-card {
        padding: 20px;
    }
    
    .risk-level-card .risk-value {
        font-size: 1.2em;
        padding: 6px 12px;
    }
}

@media (max-width: 480px) {
    body {
        padding: 5px;
        overflow-x: hidden;
    }
    
    .container {
        padding: 20px 15px;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    
    .header h1 {
        font-size: 1.8em;
    }
    
    .header .tagline {
        font-size: 1em;
    }
    
    .analysis-card {
        padding: 15px;
    }
    
    .analysis-card h2 {
        font-size: 1.4em;
    }
    
    .result-section {
        padding: 15px;
    }
    
    .file-info-section p {
        font-size: 0.85em;
        line-height: 1.3;
    }
    
    .file-info-section strong {
        min-width: 80px;
        font-size: 0.85em;
    }
    
    .result-section h2 {
        font-size: 1.4em;
    }
    
    .result-section h3 {
        font-size: 1.2em;
    }
    
    .analysis-table {
        font-size: 0.85em;
        table-layout: fixed;
        width: 100%;
    }
    
    .analysis-table th, .analysis-table td {
        padding: 6px 8px;
        word-wrap: break-word;
        overflow-wrap: break-word;
        white-space: normal;
    }
    
    .label {
        font-size: 0.85em;
        padding: 3px 6px;
        word-wrap: break-word;
        white-space: normal;
    }
    
    .extracted-text-box {
        font-size: 0.8em;
        padding: 10px;
    }
    
    .raw-data-box {
        font-size: 0.75em;
        padding: 10px;
        word-wrap: break-word;
        overflow-wrap: break-word;
        white-space: pre-wrap;
    }
}

/* Landscape Mode for Mobile */
@media (max-width: 768px) and (orientation: landscape) {
    body {
        align-items: flex-start;
        padding: 10px;
    }
    
    .container {
        margin-top: 10px;
        margin-bottom: 10px;
        max-height: 90vh;
        overflow-y: auto;
    }
}

/* High DPI Displays */
@media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
    .container {
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    }
    
    .analysis-card {
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
}

/* Print Styles */
@media print {
    body {
        background: white;
        padding: 0;
    }
    
    .container {
        box-shadow: none;
        border: 1px solid #ccc;
    }
    
    .file-input-group, .actions {
        display: none;
    }
}
```

---

## 13. requirements.txt (Python ì˜ì¡´ì„±)
```
gunicorn
Flask
python-dotenv
pillow
google-cloud-vision
openai
requests
google-generativeai
weasyprint==62.2
fpdf2
google-cloud-aiplatform
```

---

## 14. Dockerfile (Docker ì»¨í…Œì´ë„ˆ ë¹Œë“œ/ì‹¤í–‰)
```dockerfile
FROM python:3.12-slim

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1

WORKDIR /app

# Install system dependencies for WeasyPrint
RUN apt-get update && apt-get install -y \
    libcairo2-dev \
    libpango1.0-dev \
    libgirepository1.0-dev \
    libglib2.0-dev \
    libffi-dev \
    pkg-config \
    fonts-noto-cjk \
    && rm -rf /var/lib/apt/lists/*

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

EXPOSE 8000

# ê°„ë‹¨í•œ ì‹œì‘ ëª…ë ¹ì–´
CMD ["python", "run.py"] 
```

---

## 15. railway.toml (Railway ë°°í¬ ì„¤ì •)
```
[build]
builder = "dockerfile"

[deploy]
healthcheckPath = "/health"
healthcheckTimeout = 600
restartPolicyType = "on_failure" 
```

---

## 16. ì‹¤í–‰/ë°°í¬ ì•ˆë‚´

### ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ (Flask)

**í´ë” ì´ë¦„**: `ansimtalk (2)`

**ìœ„ì¹˜**: `D:\coding sutdy\ansimtalk (2)\`

**í´ë” êµ¬ì¡°**:
```
ansimtalk (2)/
â”œâ”€â”€ run.py                    # Flask ì•± ì§„ì…ì 
â”œâ”€â”€ config.py                 # í™˜ê²½ ì„¤ì •
â”œâ”€â”€ requirements.txt          # Python ì˜ì¡´ì„±
â”œâ”€â”€ Dockerfile               # Docker ì»¨í…Œì´ë„ˆ ì„¤ì •
â”œâ”€â”€ railway.toml             # Railway ë°°í¬ ì„¤ì •
â”œâ”€â”€ dazzling-howl-465316-m7-1940c1e7d0a2.json  # Google Cloud ì¸ì¦
â””â”€â”€ app/
    â”œâ”€â”€ __init__.py          # Flask ì•± íŒ©í† ë¦¬
    â”œâ”€â”€ routes.py            # ë¼ìš°íŠ¸ ì •ì˜ (ë©”ì¸ ë¡œì§)
    â”œâ”€â”€ services.py          # ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ (AI ë¶„ì„, PDF ìƒì„±)
    â”œâ”€â”€ static/
    â”‚   â”œâ”€â”€ css/
    â”‚   â”‚   â””â”€â”€ style.css    # ì›¹ ìŠ¤íƒ€ì¼ì‹œíŠ¸
    â”‚   â””â”€â”€ fonts/           # í•œê¸€ í°íŠ¸ (NanumGothic)
    â”‚       â”œâ”€â”€ NanumGothic.ttf
    â”‚       â”œâ”€â”€ NanumGothic-Bold.ttf
    â”‚       â””â”€â”€ NanumGothic-ExtraBold.ttf
    â””â”€â”€ templates/           # HTML í…œí”Œë¦¿
        â”œâ”€â”€ index.html       # ë©”ì¸ í˜ì´ì§€
        â”œâ”€â”€ results.html     # ë¶„ì„ ê²°ê³¼ í˜ì´ì§€
        â”œâ”€â”€ evidence_report.html  # PDF ë³´ê³ ì„œ í…œí”Œë¦¿
        â”œâ”€â”€ deepfake_help.html    # ë”¥í˜ì´í¬ ì‹ ê³  ì•ˆë‚´
        â”œâ”€â”€ cyberbullying_help.html  # ì‚¬ì´ë²„í­ë ¥ ì‹ ê³  ì•ˆë‚´
        â””â”€â”€ evidence.html    # ì¦ê±° ë³´ê³ ì„œ í˜ì´ì§€
```

**ì‹¤í–‰ ë°©ë²•**:
- **ë¡œì»¬ ì‹¤í–‰**: 
  ```bash
  cd "D:\coding sutdy\ansimtalk (2)"
  python run.py
  ```
- **Docker ì‹¤í–‰**: 
  ```bash
  docker build -t ansimtalk .
  docker run -p 8000:8000 ansimtalk
  ```
- **Railway ë°°í¬**: railway.toml, Dockerfile ì°¸ê³ 
- **í•„ìˆ˜ í™˜ê²½ë³€ìˆ˜**: 
  - `SIGHTENGINE_API_USER`: Sightengine API ì‚¬ìš©ì ID
  - `SIGHTENGINE_API_SECRET`: Sightengine API ì‹œí¬ë¦¿
  - `GOOGLE_GEMINI_API_KEY`: Google Gemini API í‚¤
  - `GOOGLE_SERVICE_ACCOUNT_JSON`: Google Cloud ì„œë¹„ìŠ¤ ê³„ì • JSON
  
**ì£¼ìš” ê¸°ëŠ¥**:
1. **ë”¥í˜ì´í¬ íƒì§€** (`analyze_deepfake`)
   - Sightengine APIë¡œ ì´ë¯¸ì§€ ë¶„ì„
   - ë”¥í˜ì´í¬ í™•ë¥ , ìœ í•´ì„±, ë…¸ì¶œë„ ì ìˆ˜ ì œê³µ
   
2. **ì‚¬ì´ë²„í­ë ¥ ë¶„ì„** (`analyze_cyberbullying`)
   - Google Cloud Vision APIë¡œ OCR (í…ìŠ¤íŠ¸ ì¶”ì¶œ)
   - Google Gemini APIë¡œ ëŒ€í™” ë‚´ìš© ë¶„ì„
   - ìœ„í—˜ë„ íŒì • (ì—†ìŒ/ì˜ì‹¬/ì•½ê°„ìˆìŒ/ìˆìŒ/ì‹¬ê°)
   
3. **PDF ì¦ê±° ë³´ê³ ì„œ ìƒì„±** (`generate_pdf_report`)
   - WeasyPrintë¡œ ë²•ì  ì¦ê±°ìš© PDF ìƒì„±
   - íŒŒì¼ í•´ì‹œê°’, ë©”íƒ€ë°ì´í„°, ë¶„ì„ ê²°ê³¼ í¬í•¨
   - ì›ë³¸ ì´ë¯¸ì§€ Base64 ì¸ì½”ë”© ì„ë² ë“œ

---

## 17. ì•ˆë“œë¡œì´ë“œ ëª¨ë°”ì¼ ì•± (Kotlin)

### ì•± ì •ë³´

**í´ë” ì´ë¦„**: `ansimtalk_app`

**ìœ„ì¹˜**: `D:\coding sutdy\ansimtalk_app\`

**íŒ¨í‚¤ì§€ëª…**: `com.ansimtalk.app`

**ê°œë°œ ì–¸ì–´**: Kotlin

**ì•„í‚¤í…ì²˜**: MVVM + Clean Architecture + Hilt (DI)

**ì£¼ìš” ë¼ì´ë¸ŒëŸ¬ë¦¬**:
- Jetpack Compose (UI)
- Hilt (ì˜ì¡´ì„± ì£¼ì…)
- Retrofit + OkHttp (ë„¤íŠ¸ì›Œí¬)
- Kotlin Coroutines (ë¹„ë™ê¸° ì²˜ë¦¬)
- Coil (ì´ë¯¸ì§€ ë¡œë”©)
- WeasyPrint (PDF ìƒì„± - ë°±ì—”ë“œ ì—°ë™)

### í´ë” êµ¬ì¡°

```
ansimtalk_app/
â”œâ”€â”€ build.gradle.kts          # í”„ë¡œì íŠ¸ ë ˆë²¨ Gradle ì„¤ì •
â”œâ”€â”€ settings.gradle.kts       # Gradle ì„¤ì •
â”œâ”€â”€ local.properties          # ë¡œì»¬ í™˜ê²½ ì„¤ì •
â””â”€â”€ app/
    â”œâ”€â”€ build.gradle.kts      # ì•± ë ˆë²¨ Gradle ì„¤ì •
    â”œâ”€â”€ src/
    â”‚   â””â”€â”€ main/
    â”‚       â”œâ”€â”€ AndroidManifest.xml  # ì•± ë§¤ë‹ˆí˜ìŠ¤íŠ¸
    â”‚       â”œâ”€â”€ java/com/ansimtalk/app/
    â”‚       â”‚   â”œâ”€â”€ AnsimTalkApplication.kt  # Application í´ë˜ìŠ¤
    â”‚       â”‚   â”œâ”€â”€ MainActivity.kt          # ë©”ì¸ ì•¡í‹°ë¹„í‹°
    â”‚       â”‚   â”œâ”€â”€ ResultActivity.kt        # ê²°ê³¼ í™”ë©´ ì•¡í‹°ë¹„í‹°
    â”‚       â”‚   â”œâ”€â”€ data/                    # ë°ì´í„° ë ˆì´ì–´
    â”‚       â”‚   â”‚   â”œâ”€â”€ model/               # ë°ì´í„° ëª¨ë¸
    â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ AnalysisResult.kt    # ë¶„ì„ ê²°ê³¼ ëª¨ë¸
    â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ Resource.kt          # API ìƒíƒœ ë˜í¼
    â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ PdfRequestBody.kt   # PDF ìš”ì²­ ëª¨ë¸
    â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ PdfGenerationResult.kt
    â”‚       â”‚   â”‚   â”‚   â””â”€â”€ PdfErrors.kt
    â”‚       â”‚   â”‚   â”œâ”€â”€ api/                 # API ì¸í„°í˜ì´ìŠ¤
    â”‚       â”‚   â”‚   â”‚   â””â”€â”€ AnsimTalkApiService.kt
    â”‚       â”‚   â”‚   â”œâ”€â”€ remote/              # ì›ê²© ë°ì´í„° ì†ŒìŠ¤
    â”‚       â”‚   â”‚   â”‚   â””â”€â”€ ApiService.kt
    â”‚       â”‚   â”‚   â””â”€â”€ repository/          # ë¦¬í¬ì§€í† ë¦¬ êµ¬í˜„
    â”‚       â”‚   â”‚       â”œâ”€â”€ AnsimTalkRepository.kt
    â”‚       â”‚   â”‚       â”œâ”€â”€ AnsimTalkRepositoryImpl.kt
    â”‚       â”‚   â”‚       â””â”€â”€ PdfRepository.kt
    â”‚       â”‚   â”œâ”€â”€ domain/                  # ë„ë©”ì¸ ë ˆì´ì–´
    â”‚       â”‚   â”‚   â”œâ”€â”€ repository/          # ë¦¬í¬ì§€í† ë¦¬ ì¸í„°í˜ì´ìŠ¤
    â”‚       â”‚   â”‚   â”‚   â””â”€â”€ AnsimTalkRepository.kt
    â”‚       â”‚   â”‚   â””â”€â”€ usecase/             # ìœ ìŠ¤ì¼€ì´ìŠ¤
    â”‚       â”‚   â”‚       â”œâ”€â”€ AnalyzeDeepfakeUseCase.kt
    â”‚       â”‚   â”‚       â”œâ”€â”€ AnalyzeCyberbullyingUseCase.kt
    â”‚       â”‚   â”‚       â”œâ”€â”€ GeneratePdfUseCase.kt
    â”‚       â”‚   â”‚       â”œâ”€â”€ DownloadPdfUseCase.kt
    â”‚       â”‚   â”‚       â”œâ”€â”€ HealthCheckUseCase.kt
    â”‚       â”‚   â”‚       â”œâ”€â”€ GetResultsUseCase.kt
    â”‚       â”‚   â”‚       â””â”€â”€ GetEvidenceUseCase.kt
    â”‚       â”‚   â”œâ”€â”€ di/                      # ì˜ì¡´ì„± ì£¼ì…
    â”‚       â”‚   â”‚   â”œâ”€â”€ NetworkModule.kt     # ë„¤íŠ¸ì›Œí¬ ëª¨ë“ˆ
    â”‚       â”‚   â”‚   â””â”€â”€ RepositoryModule.kt  # ë¦¬í¬ì§€í† ë¦¬ ëª¨ë“ˆ
    â”‚       â”‚   â”œâ”€â”€ presentation/            # í”„ë ˆì  í…Œì´ì…˜ ë ˆì´ì–´
    â”‚       â”‚   â”‚   â”œâ”€â”€ ui/
    â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ screen/
    â”‚       â”‚   â”‚   â”‚   â”‚   â””â”€â”€ MainScreen.kt  # ë©”ì¸ í™”ë©´ (1518ì¤„)
    â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ state/
    â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ AnalysisUiState.kt      # ë¶„ì„ UI ìƒíƒœ
    â”‚       â”‚   â”‚   â”‚   â”‚   â””â”€â”€ PdfDownloadUiState.kt   # PDF ë‹¤ìš´ë¡œë“œ ìƒíƒœ
    â”‚       â”‚   â”‚   â”‚   â””â”€â”€ theme/
    â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ Color.kt     # ìƒ‰ìƒ íŒ”ë ˆíŠ¸
    â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ Theme.kt     # í…Œë§ˆ ì„¤ì •
    â”‚       â”‚   â”‚   â”‚       â””â”€â”€ Type.kt      # íƒ€ì´í¬ê·¸ë˜í”¼
    â”‚       â”‚   â”‚   â””â”€â”€ viewmodel/
    â”‚       â”‚   â”‚       â”œâ”€â”€ MainViewModel.kt      # ë©”ì¸ ë·°ëª¨ë¸
    â”‚       â”‚   â”‚       â””â”€â”€ ResultViewModel.kt    # ê²°ê³¼ ë·°ëª¨ë¸
    â”‚       â”‚   â””â”€â”€ util/
    â”‚       â”‚       â””â”€â”€ PdfConverter.kt      # PDF ë³€í™˜ ìœ í‹¸
    â”‚       â””â”€â”€ res/                         # ë¦¬ì†ŒìŠ¤
    â”‚           â”œâ”€â”€ drawable/                # ì•„ì´ì½˜
    â”‚           â”œâ”€â”€ layout/                  # XML ë ˆì´ì•„ì›ƒ
    â”‚           â”œâ”€â”€ values/
    â”‚           â”‚   â”œâ”€â”€ strings.xml          # ë¬¸ìì—´ ë¦¬ì†ŒìŠ¤
    â”‚           â”‚   â”œâ”€â”€ colors.xml           # ìƒ‰ìƒ ë¦¬ì†ŒìŠ¤
    â”‚           â”‚   â””â”€â”€ themes.xml           # í…Œë§ˆ
    â”‚           â””â”€â”€ xml/
    â”‚               â””â”€â”€ file_paths.xml       # FileProvider ê²½ë¡œ
    â””â”€â”€ README.md                            # ì•± ì„¤ëª…
```

### ì£¼ìš” íŒŒì¼ ì—­í• 

#### 1. Application í´ë˜ìŠ¤

**íŒŒì¼**: `app/src/main/java/com/ansimtalk/app/AnsimTalkApplication.kt`

**ì—­í• **: Hilt ì˜ì¡´ì„± ì£¼ì… ì´ˆê¸°í™”, WebView ì„¤ì •

#### 2. MainActivity

**íŒŒì¼**: `app/src/main/java/com/ansimtalk/app/MainActivity.kt`

**ì—­í• **: 
- ì•± ì§„ì…ì 
- Jetpack Compose UI ì„¤ì •
- ì˜¤ë¥˜ í•¸ë“¤ë§

#### 3. ResultActivity

**íŒŒì¼**: `app/src/main/java/com/ansimtalk/app/ResultActivity.kt`

**ì—­í• **:
- ë¶„ì„ ê²°ê³¼ í‘œì‹œ
- PDF ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥

#### 4. Data Layer (ë°ì´í„° ë ˆì´ì–´)

**model/**:
- `AnalysisResult.kt`: ì„œë²„ì—ì„œ ë°›ì€ ë¶„ì„ ê²°ê³¼ ë°ì´í„° ëª¨ë¸
- `Resource.kt`: API ìƒíƒœ ë˜í¼ (Loading, Success, Error)
- `PdfRequestBody.kt`: PDF ìƒì„± ìš”ì²­ ëª¨ë¸

**api/** & **remote/**:
- `AnsimTalkApiService.kt`: Retrofit API ì¸í„°í˜ì´ìŠ¤ ì •ì˜
- `ApiService.kt`: ì‹¤ì œ HTTP ìš”ì²­ ì¸í„°í˜ì´ìŠ¤

**repository/**:
- `AnsimTalkRepository.kt`: ë¦¬í¬ì§€í† ë¦¬ ì¸í„°í˜ì´ìŠ¤
- `AnsimTalkRepositoryImpl.kt`: ë¦¬í¬ì§€í† ë¦¬ êµ¬í˜„ (ë„¤íŠ¸ì›Œí¬ ìš”ì²­ ë¡œì§)
- `PdfRepository.kt`: PDF ìƒì„±/ë‹¤ìš´ë¡œë“œ ë¦¬í¬ì§€í† ë¦¬

#### 5. Domain Layer (ë„ë©”ì¸ ë ˆì´ì–´)

**usecase/**:
ê° ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ìº¡ìŠí™”í•œ ìœ ìŠ¤ì¼€ì´ìŠ¤ë“¤:
- `AnalyzeDeepfakeUseCase.kt`: ë”¥í˜ì´í¬ ë¶„ì„ ìš”ì²­
- `AnalyzeCyberbullyingUseCase.kt`: ì‚¬ì´ë²„í­ë ¥ ë¶„ì„ ìš”ì²­
- `GeneratePdfUseCase.kt`: PDF ìƒì„± ìš”ì²­
- `DownloadPdfUseCase.kt`: PDF ë‹¤ìš´ë¡œë“œ
- `HealthCheckUseCase.kt`: API í—¬ìŠ¤ ì²´í¬

#### 6. DI (ì˜ì¡´ì„± ì£¼ì…)

**di/**:
- `NetworkModule.kt`: Retrofit, OkHttpClient ì œê³µ
- `RepositoryModule.kt`: Repository ì¸ìŠ¤í„´ìŠ¤ ì œê³µ

#### 7. Presentation Layer (í”„ë ˆì  í…Œì´ì…˜ ë ˆì´ì–´)

**ui/screen/**:
- `MainScreen.kt` (1518ì¤„):
  - ë©”ì¸ í™”ë©´ Composable
  - íŒŒì¼ ì„ íƒ ë¡œì§
  - ë¶„ì„ ê²°ê³¼ í‘œì‹œ
  - PDF ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥
  - ì‹ ê³  ì•ˆë‚´ ë§í¬

**ui/state/**:
- `AnalysisUiState.kt`: ë¶„ì„ UI ìƒíƒœ (Idle, Loading, Success, Error)
- `PdfDownloadUiState.kt`: PDF ë‹¤ìš´ë¡œë“œ ìƒíƒœ

**ui/theme/**:
- `Color.kt`: ì•± ìƒ‰ìƒ íŒ”ë ˆíŠ¸ ì •ì˜
- `Theme.kt`: Material3 í…Œë§ˆ ì„¤ì •
- `Type.kt`: íƒ€ì´í¬ê·¸ë˜í”¼ ì„¤ì •

**viewmodel/**:
- `MainViewModel.kt`: ë©”ì¸ í™”ë©´ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ê´€ë¦¬
- `ResultViewModel.kt`: ê²°ê³¼ í™”ë©´ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ê´€ë¦¬

### ì•± ë¹Œë“œ ë° ì‹¤í–‰

**ë¹Œë“œ íƒ€ì…**:
1. **debug**: í”„ë¡œë•ì…˜ ì„œë²„ ì—°ê²° (https://ansimtalk-production.up.railway.app/)
2. **debugLocalEmu**: ì—ë®¬ë ˆì´í„° ë¡œì»¬ ì„œë²„ (http://10.0.2.2:8000/)
3. **debugProd**: í”„ë¡œë•ì…˜ ì„œë²„ í…ŒìŠ¤íŠ¸ìš©
4. **debugDevice**: ì‹¤ê¸°ê¸° USB ë””ë²„ê¹… + ë¡œì»¬ ì„œë²„ (http://127.0.0.1:8000/)
5. **release**: í”„ë¡œë•ì…˜ ë¦´ë¦¬ìŠ¤

**ì‹¤í–‰ ë°©ë²•**:
```bash
cd "D:\coding sutdy\ansimtalk_app"

# Windowsì—ì„œ Gradle ë¹Œë“œ
gradlew.bat assembleDebug

# ë””ë²„ê·¸ APK ì„¤ì¹˜
adb install app/build/outputs/apk/debug/app-debug.apk
```

**Android Studioì—ì„œ ì‹¤í–‰**:
1. Android Studioì—ì„œ `ansimtalk_app` í´ë” ì—´ê¸°
2. Build Variantsì—ì„œ ì›í•˜ëŠ” ë¹Œë“œ íƒ€ì… ì„ íƒ
3. Run ë²„íŠ¼ í´ë¦­

### ì•± ì£¼ìš” ê¸°ëŠ¥

1. **API í—¬ìŠ¤ ì²´í¬**
   - ì•± ì‹œì‘ ì‹œ ì„œë²„ ì—°ê²° ìƒíƒœ í™•ì¸
   - ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ í•¸ë“¤ë§

2. **ë”¥í˜ì´í¬ ë¶„ì„**
   - ê°¤ëŸ¬ë¦¬ì—ì„œ ì´ë¯¸ì§€ ì„ íƒ
   - ì„œë²„ë¡œ Multipart ì—…ë¡œë“œ
   - ë¶„ì„ ê²°ê³¼ ì‹¤ì‹œê°„ í‘œì‹œ
   - ë”¥í˜ì´í¬ í™•ë¥ , ìœ í•´ì„± ì ìˆ˜ í‘œì‹œ

3. **ì‚¬ì´ë²„í­ë ¥ ë¶„ì„**
   - ì´ë¯¸ì§€ ë˜ëŠ” í…ìŠ¤íŠ¸ íŒŒì¼ ì—…ë¡œë“œ
   - OCR + AI ë¶„ì„
   - ìœ„í—˜ë„ ì¹´ë“œ í‘œì‹œ
   - ëŒ€í™” ë‚´ìš© ë¶„ì„ í…Œì´ë¸”

4. **PDF ì¦ê±° ë³´ê³ ì„œ ìƒì„±**
   - ì„œë²„ PDF ìƒì„± API í˜¸ì¶œ
   - Downloads/AnsimTalkEvidence í´ë”ì— ì €ì¥
   - ìë™ìœ¼ë¡œ PDF ë¦¬ë” ì•± ì—´ê¸°

5. **ì‹ ê³  ì•ˆë‚´**
   - ë”¥í˜ì´í¬ í”¼í•´ ìƒë‹´/ì‹ ê³  ì•ˆë‚´ í˜ì´ì§€ ë§í¬
   - ì‚¬ì´ë²„í­ë ¥ ì‹ ê³  ì•ˆë‚´ í˜ì´ì§€ ë§í¬
   - WebViewë¡œ ì›¹ í˜ì´ì§€ ì—´ê¸°

### ì•± ê¸°ìˆ  ìŠ¤íƒ

**ì–¸ì–´**: Kotlin 1.9.22

**ìµœì†Œ SDK**: 26 (Android 8.0 Oreo)

**íƒ€ê²Ÿ SDK**: 34 (Android 14)

**UI í”„ë ˆì„ì›Œí¬**: Jetpack Compose (Material3)

**ì•„í‚¤í…ì²˜ íŒ¨í„´**: MVVM + Clean Architecture

**ì˜ì¡´ì„± ì£¼ì…**: Hilt 2.48

**ë„¤íŠ¸ì›Œí¬**: Retrofit 2.9.0 + OkHttp 4.12.0

**ì´ë¯¸ì§€ ë¡œë”©**: Coil 2.5.0

**ë¹„ë™ê¸° ì²˜ë¦¬**: Kotlin Coroutines 1.8.0 + Flow

---

## 18. ì•ˆë“œë¡œì´ë“œ ì•± - ì „ì²´ Kotlin ì½”ë“œ

### 18.1. build.gradle.kts (í”„ë¡œì íŠ¸ ë ˆë²¨)

**ìœ„ì¹˜**: `ansimtalk_app/build.gradle.kts`

**ì—­í• **: í”„ë¡œì íŠ¸ ì „ì²´ í”ŒëŸ¬ê·¸ì¸ ì„¤ì •

```kotlin
// Top-level build file where you add configuration options common to all sub-projects/modules.
plugins {
    id("com.android.application") version "8.11.1" apply false
    id("org.jetbrains.kotlin.android") version "1.9.22" apply false
    id("com.google.dagger.hilt.android") version "2.48" apply false
}
```

---

### 18.2. settings.gradle.kts

**ìœ„ì¹˜**: `ansimtalk_app/settings.gradle.kts`

**ì—­í• **: Gradle ë¦¬í¬ì§€í† ë¦¬ ì„¤ì •

```kotlin
pluginManagement {
    repositories {
        google()
        mavenCentral()
        gradlePluginPortal()
    }
}
dependencyResolutionManagement {
    repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
    repositories {
        google()
        mavenCentral()
    }
}
rootProject.name = "AnsimTalk"
include(":app")
```

---

### 18.3. app/build.gradle.kts

**ìœ„ì¹˜**: `ansimtalk_app/app/build.gradle.kts`

**ì—­í• **: ì•± ëª¨ë“ˆ ë¹Œë“œ ì„¤ì •, ì˜ì¡´ì„± ê´€ë¦¬, ë¹Œë“œ íƒ€ì… ì •ì˜

```kotlin
plugins {
    id("com.android.application")
    id("org.jetbrains.kotlin.android")
    id("kotlin-kapt")
    id("dagger.hilt.android.plugin")
    id("kotlin-parcelize")
}

android {
    namespace = "com.ansimtalk.app"
    compileSdk = 34

    defaultConfig {
        applicationId = "com.ansimtalk.app"
        minSdk = 26
        targetSdk = 34
        versionCode = 1
        versionName = "1.0"

        testInstrumentationRunner = "androidx.test.runner.AndroidJUnitRunner"
        vectorDrawables {
            useSupportLibrary = true
        }
    }

    buildTypes {
        // ê¸°ë³¸ ë””ë²„ê·¸ëŠ” í”„ë¡œë•ì…˜ ì„œë²„ë¡œ ì—°ê²°ë˜ë„ë¡ ì„¤ì •
        debug {
            buildConfigField("String", "BASE_URL", "\"https://ansimtalk-production.up.railway.app/\"")
        }
        // ì—ë®¬ë ˆì´í„° ë¡œì»¬ ì„œë²„ í…ŒìŠ¤íŠ¸ìš© (í•„ìš” ì‹œ ì„ íƒí•´ì„œ ì‚¬ìš©)
        create("debugLocalEmu") {
            initWith(getByName("debug"))
            applicationIdSuffix = ".localemu"
            versionNameSuffix = "-localemu"
            buildConfigField("String", "BASE_URL", "\"http://10.0.2.2:8000/\"")
        }
        // ë””ë²„ê·¸ ì„¤ì •ì„ ê·¸ëŒ€ë¡œ ì“°ë©´ì„œ í”„ë¡œë•ì…˜ ì„œë²„ë¡œ ë¶™ëŠ” í…ŒìŠ¤íŠ¸ìš© ë¹Œë“œíƒ€ì…
        create("debugProd") {
            initWith(getByName("debug"))
            applicationIdSuffix = ".prod"
            versionNameSuffix = "-prod"
            buildConfigField(
                "String",
                "BASE_URL",
                "\"https://ansimtalk-production.up.railway.app/\""
            )
        }
        // ì‹¤ê¸°ê¸° + USB ë””ë²„ê¹…ì—ì„œ ë¡œì»¬ ì„œë²„(PCì˜ 8000 í¬íŠ¸)ë¡œ ì—°ê²°í•˜ëŠ” ë¹Œë“œíƒ€ì…
        // ì‹¤í–‰ ì „: adb reverse tcp:8000 tcp:8000
        create("debugDevice") {
            initWith(getByName("debug"))
            applicationIdSuffix = ".device"
            versionNameSuffix = "-device"
            buildConfigField(
                "String",
                "BASE_URL",
                "\"http://127.0.0.1:8000/\""
            )
        }
        release {
            isMinifyEnabled = false
            proguardFiles(
                getDefaultProguardFile("proguard-android-optimize.txt"),
                "proguard-rules.pro"
            )
            // ì‹¤ì œ ì„œë¹„ìŠ¤ ì„œë²„ ì£¼ì†Œë¡œ ì„¤ì •
            buildConfigField("String", "BASE_URL", "\"https://ansimtalk-production.up.railway.app/\"")
        }
    }
    
    compileOptions {
        sourceCompatibility = JavaVersion.VERSION_11
        targetCompatibility = JavaVersion.VERSION_11
    }
    
    kotlinOptions {
        jvmTarget = "11"
    }
    
    buildFeatures {
        buildConfig = true
        compose = true
        viewBinding = true
    }
    
    composeOptions {
        kotlinCompilerExtensionVersion = "1.5.8"
    }
    
    packaging {
        resources {
            excludes += "/META-INF/{AL2.0,LGPL2.1}"
        }
    }
}

dependencies {
    // Core Android
    implementation("androidx.core:core-ktx:1.12.0")
    implementation("androidx.lifecycle:lifecycle-runtime-ktx:2.7.0")
    implementation("androidx.activity:activity-compose:1.8.2")
    implementation("androidx.appcompat:appcompat:1.6.1")
    implementation("com.google.android.material:material:1.11.0")
    
    // Compose
    implementation(platform("androidx.compose:compose-bom:2024.02.00"))
    implementation("androidx.compose.ui:ui")
    implementation("androidx.compose.ui:ui-graphics")
    implementation("androidx.compose.ui:ui-tooling-preview")
    implementation("androidx.compose.material3:material3")
    implementation("androidx.compose.material:material-icons-extended")
    
    // Navigation
    implementation("androidx.navigation:navigation-compose:2.7.6")
    
    // ViewModel & LiveData
    implementation("androidx.lifecycle:lifecycle-viewmodel-ktx:2.7.0")
    implementation("androidx.lifecycle:lifecycle-viewmodel-compose:2.7.0")
    implementation("androidx.lifecycle:lifecycle-runtime-compose:2.7.0")
    
    // Hilt
    implementation("com.google.dagger:hilt-android:2.48")
    kapt("com.google.dagger:hilt-compiler:2.48")
    implementation("androidx.hilt:hilt-navigation-compose:1.1.0")
    
    // Retrofit & Network
    implementation("com.squareup.retrofit2:retrofit:2.9.0")
    implementation("com.squareup.retrofit2:converter-gson:2.9.0")
    implementation("com.squareup.okhttp3:logging-interceptor:4.12.0")
    implementation("com.google.code.gson:gson:2.10.1")
    
    // Coroutines
    implementation("org.jetbrains.kotlinx:kotlinx-coroutines-core:1.8.0")
    implementation("org.jetbrains.kotlinx:kotlinx-coroutines-android:1.8.0")
    
    // Image Loading
    implementation("io.coil-kt:coil-compose:2.5.0")
    
    // File Handling
    implementation("androidx.documentfile:documentfile:1.0.1")
    
    // Testing
    testImplementation("junit:junit:4.13.2")
    androidTestImplementation("androidx.test.ext:junit:1.1.5")
    androidTestImplementation("androidx.test.espresso:espresso-core:3.5.1")
    androidTestImplementation(platform("androidx.compose:compose-bom:2024.02.00"))
    androidTestImplementation("androidx.compose.ui:ui-test-junit4")
    debugImplementation("androidx.compose.ui:ui-tooling")
    debugImplementation("androidx.compose.ui:ui-test-manifest")
}

kapt {
    correctErrorTypes = true
}
```

---

### 18.4. AndroidManifest.xml

**ìœ„ì¹˜**: `ansimtalk_app/app/src/main/AndroidManifest.xml`

**ì—­í• **: ì•± ê¶Œí•œ, ì•¡í‹°ë¹„í‹°, í”„ë¡œë°”ì´ë” ì„ ì–¸

```xml
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:tools="http://schemas.android.com/tools">

    <uses-permission android:name="android.permission.INTERNET" />
    <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
    <uses-permission android:name="android.permission.POST_NOTIFICATIONS" />

    <application
        android:name=".AnsimTalkApplication"
        android:allowBackup="true"
        android:dataExtractionRules="@xml/data_extraction_rules"
        android:fullBackupContent="@xml/backup_rules"
        android:icon="@mipmap/ic_launcher"
        android:label="@string/app_name"
        android:roundIcon="@mipmap/ic_launcher_round"
        android:supportsRtl="true"
        android:theme="@style/Theme.AnsimTalk"
        android:usesCleartextTraffic="true"
        tools:targetApi="31">

        <activity
            android:name=".MainActivity"
            android:exported="true"
            android:theme="@style/Theme.AnsimTalk">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>

        <activity
            android:name=".ResultActivity"
            android:exported="false"
            android:theme="@style/Theme.AnsimTalk" />

        <provider
            android:name="androidx.core.content.FileProvider"
            android:authorities="${applicationId}.fileprovider"
            android:exported="false"
            android:grantUriPermissions="true">
            <meta-data
                android:name="android.support.FILE_PROVIDER_PATHS"
                android:resource="@xml/file_paths" />
        </provider>

    </application>

</manifest>
```

---

### 18.5. AnsimTalkApplication.kt

**ìœ„ì¹˜**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/AnsimTalkApplication.kt`

**ì—­í• **: 
- Hilt ì˜ì¡´ì„± ì£¼ì… ì´ˆê¸°í™” (@HiltAndroidApp)
- WebView ì „ì—­ ì„¤ì • (PDF ìƒì„± ì•ˆì •ì„±)

```kotlin
package com.ansimtalk.app

import android.app.Application
import android.os.Build
import android.webkit.WebView
import dagger.hilt.android.HiltAndroidApp

@HiltAndroidApp
class AnsimTalkApplication : Application() {
    override fun onCreate() {
        super.onCreate()
        // PDF ìƒì„± ì•ˆì •ì„±ì„ ìœ„í•´ ì•± ì‹œì‘ ì‹œì ì— ì „ì²´ ë¬¸ì„œ ê·¸ë¦¬ê¸° í™œì„±í™”
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.LOLLIPOP) {
            try {
                WebView.enableSlowWholeDocumentDraw()
            } catch (_: Throwable) {
                // ì¼ë¶€ í™˜ê²½ì—ì„œ WebView ì´ˆê¸°í™” ì´ìŠˆê°€ ìˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë¬´ì‹œ
            }
        }
    }
}
```

---

### 18.6. MainActivity.kt

**ìœ„ì¹˜**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/MainActivity.kt`

**ì—­í• **: 
- ì•± ë©”ì¸ ì§„ì…ì 
- Compose UI ì„¤ì •
- ì˜¤ë¥˜ í•¸ë“¤ë§ ë° Fallback UI

```kotlin
package com.ansimtalk.app

import android.os.Bundle
import android.util.Log
import androidx.activity.compose.setContent
import androidx.appcompat.app.AppCompatActivity
import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.padding
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Surface
import androidx.compose.material3.Text
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import com.ansimtalk.app.presentation.ui.screen.MainScreen
import com.ansimtalk.app.presentation.ui.theme.AnsimTalkTheme
import dagger.hilt.android.AndroidEntryPoint

@AndroidEntryPoint
class MainActivity : AppCompatActivity() {
    
    companion object {
        private const val TAG = "MainActivity"
    }
    
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        
        try {
            Log.d(TAG, "MainActivity onCreate ì‹œì‘")
            
            // ê¸°ë³¸ UI ì„¤ì •
            setupBasicUI()
            
            Log.d(TAG, "MainActivity onCreate ì™„ë£Œ")
            
        } catch (e: Exception) {
            Log.e(TAG, "MainActivity onCreate ì˜¤ë¥˜", e)
            // ì˜¤ë¥˜ ë°œìƒ ì‹œ ê¸°ë³¸ ì˜¤ë¥˜ UI í‘œì‹œ
            showErrorUI("ì•± ì´ˆê¸°í™” ì˜¤ë¥˜: \${e.message}")
        }
    }
    
    private fun setupBasicUI() {
        try {
            setContent {
                AnsimTalkTheme {
                    Surface(
                        modifier = Modifier.fillMaxSize(),
                        color = MaterialTheme.colorScheme.background
                    ) {
                        MainScreen()
                    }
                }
            }
        } catch (e: Exception) {
            Log.e(TAG, "Compose UI ì„¤ì • ì˜¤ë¥˜", e)
            // Compose ì˜¤ë¥˜ ì‹œ ê¸°ë³¸ View ê¸°ë°˜ ì˜¤ë¥˜ UI í‘œì‹œ
            showErrorUI("UI ì„¤ì • ì˜¤ë¥˜: \${e.message}")
        }
    }
    
    private fun showErrorUI(errorMessage: String) {
        try {
            setContentView(android.widget.LinearLayout(this).apply {
                orientation = android.widget.LinearLayout.VERTICAL
                gravity = android.view.Gravity.CENTER
                setPadding(32, 32, 32, 32)
                
                addView(android.widget.TextView(this@MainActivity).apply {
                    text = "ì•ˆì‹¬í†¡"
                    textSize = 24f
                    gravity = android.view.Gravity.CENTER
                    setTextColor(android.graphics.Color.BLACK)
                    setPadding(0, 0, 0, 16)
                })
                
                addView(android.widget.TextView(this@MainActivity).apply {
                    text = "ì•± ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤"
                    textSize = 16f
                    gravity = android.view.Gravity.CENTER
                    setTextColor(android.graphics.Color.RED)
                    setPadding(0, 0, 0, 16)
                })
                
                addView(android.widget.TextView(this@MainActivity).apply {
                    text = errorMessage
                    textSize = 14f
                    gravity = android.view.Gravity.CENTER
                    setTextColor(android.graphics.Color.DKGRAY)
                    setPadding(0, 0, 0, 32)
                })
                
                addView(android.widget.Button(this@MainActivity).apply {
                    text = "ë‹¤ì‹œ ì‹œë„"
                    setOnClickListener {
                        try {
                            setupBasicUI()
                        } catch (e: Exception) {
                            Log.e(TAG, "ì¬ì‹œë„ ì‹¤íŒ¨", e)
                        }
                    }
                })
            })
        } catch (e: Exception) {
            Log.e(TAG, "ì˜¤ë¥˜ UI í‘œì‹œ ì‹¤íŒ¨", e)
            // ìµœí›„ì˜ ìˆ˜ë‹¨: ê¸°ë³¸ í…ìŠ¤íŠ¸ë§Œ í‘œì‹œ
            setContentView(android.widget.TextView(this).apply {
                text = "ì•± ì˜¤ë¥˜\n$errorMessage"
                textSize = 16f
                gravity = android.view.Gravity.CENTER
                setTextColor(android.graphics.Color.RED)
                setPadding(32, 32, 32, 32)
            })
        }
    }
}
```

---

### 18.7. ResultActivity.kt

**ìœ„ì¹˜**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/ResultActivity.kt`

**ì—­í• **:
- ë¶„ì„ ê²°ê³¼ í‘œì‹œ í™”ë©´
- PDF ë‹¤ìš´ë¡œë“œ ë²„íŠ¼
- MediaStoreë¥¼ í†µí•œ íŒŒì¼ ì €ì¥

```kotlin
package com.ansimtalk.app

import android.content.ContentValues
import android.content.Context
import android.os.Bundle
import android.os.Environment
import android.provider.MediaStore
import android.widget.Toast
import androidx.activity.ComponentActivity
import androidx.activity.compose.setContent
import androidx.activity.viewModels
import androidx.compose.foundation.layout.*
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.unit.dp
import androidx.core.content.IntentCompat
import com.ansimtalk.app.data.model.AnalysisResult
import com.ansimtalk.app.data.model.Resource
import com.ansimtalk.app.presentation.viewmodel.ResultViewModel
import com.google.gson.GsonBuilder
import dagger.hilt.android.AndroidEntryPoint
import kotlinx.coroutines.flow.collectLatest
import okhttp3.ResponseBody
import java.io.IOException

@AndroidEntryPoint
class ResultActivity : ComponentActivity() {

    private val viewModel: ResultViewModel by viewModels()

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)

        val result = IntentCompat.getParcelableExtra(intent, "result", AnalysisResult::class.java)

        if (result == null) {
            Toast.makeText(this, "ë¶„ì„ ê²°ê³¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", Toast.LENGTH_SHORT).show()
            finish()
            return
        }

        setContent {
            ResultScreen(viewModel = viewModel, analysisResult = result)
        }
    }
}

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun ResultScreen(viewModel: ResultViewModel, analysisResult: AnalysisResult) {
    val context = LocalContext.current
    var isLoading by remember { mutableStateOf(false) }

    LaunchedEffect(Unit) {
        viewModel.downloadState.collectLatest {
            when (it) {
                is Resource.Loading -> {
                    isLoading = true
                }
                is Resource.Success -> {
                    isLoading = false
                    it.data.let {
                        val fileName = "AnsimTalk_Report_\${System.currentTimeMillis()}.pdf"
                        savePdfToDownloads(context, it, fileName)
                    }
                }
                is Resource.Error -> {
                    isLoading = false
                    Toast.makeText(context, "ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: \${it.message}", Toast.LENGTH_LONG).show()
                }
            }
        }
    }

    MaterialTheme {
        Scaffold(
            topBar = {
                TopAppBar(
                    title = { Text("ë¶„ì„ ê²°ê³¼", color = androidx.compose.ui.graphics.Color.White) },
                    colors = TopAppBarDefaults.topAppBarColors(
                        containerColor = com.ansimtalk.app.presentation.ui.theme.Primary800,
                        titleContentColor = androidx.compose.ui.graphics.Color.White
                    )
                )
            }
        ) {
            Column(
                modifier = Modifier
                    .fillMaxSize()
                    .padding(it)
                    .padding(16.dp),
                horizontalAlignment = Alignment.CenterHorizontally,
                verticalArrangement = Arrangement.SpaceBetween
            ) {
                AnalysisResultDetails(analysisResult)

                if (isLoading) {
                    CircularProgressIndicator()
                } else {
                    Button(
                        onClick = { viewModel.downloadPdf(analysisResult) },
                        modifier = Modifier.fillMaxWidth()
                    ) {
                        Text("PDF ë³´ê³ ì„œ ë‹¤ìš´ë¡œë“œ")
                    }
                }
            }
        }
    }
}

@Composable
fun AnalysisResultDetails(result: AnalysisResult) {
    val gson = GsonBuilder().setPrettyPrinting().create()
    val resultJson = gson.toJson(result)
    Card(modifier = Modifier.fillMaxWidth()) {
        Column(modifier = Modifier.padding(16.dp)) {
            Text(text = resultJson, style = MaterialTheme.typography.bodySmall)
        }
    }
}

private fun savePdfToDownloads(context: Context, body: ResponseBody, fileName: String) {
    val contentValues = ContentValues().apply {
        put(MediaStore.MediaColumns.DISPLAY_NAME, fileName)
        put(MediaStore.MediaColumns.MIME_TYPE, "application/pdf")
        put(MediaStore.MediaColumns.RELATIVE_PATH, Environment.DIRECTORY_DOWNLOADS)
    }

    val resolver = context.contentResolver
    val uri = resolver.insert(MediaStore.Downloads.EXTERNAL_CONTENT_URI, contentValues)

    if (uri != null) {
        try {
            resolver.openOutputStream(uri).use { outputStream ->
                if (outputStream == null) {
                    throw IOException("Failed to get output stream.")
                }
                body.byteStream().use { inputStream ->
                    inputStream.copyTo(outputStream)
                }
            }
            Toast.makeText(context, "ë‹¤ìš´ë¡œë“œ ì™„ë£Œ: Downloads í´ë”ë¥¼ í™•ì¸í•˜ì„¸ìš”.", Toast.LENGTH_LONG).show()
        } catch (e: IOException) {
            e.printStackTrace()
            Toast.makeText(context, "íŒŒì¼ ì €ì¥ ì‹¤íŒ¨: \${e.message}", Toast.LENGTH_LONG).show()
        }
    } else {
        Toast.makeText(context, "íŒŒì¼ ì €ì¥ ì‹¤íŒ¨: URIë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", Toast.LENGTH_LONG).show()
    }
}
```

---

### 18.8. Data Models (ë°ì´í„° ëª¨ë¸)

#### AnalysisResult.kt

**ìœ„ì¹˜**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/data/model/AnalysisResult.kt`

**ì—­í• **: ì„œë²„ API ì‘ë‹µ ë°ì´í„° ëª¨ë¸, Parcelableë¡œ ì•¡í‹°ë¹„í‹° ê°„ ì „ë‹¬ ê°€ëŠ¥

```kotlin
package com.ansimtalk.app.data.model

import android.os.Parcelable
import com.google.gson.annotations.SerializedName
import kotlinx.parcelize.Parcelize

@Parcelize
data class AnalysisResult(
    @SerializedName("file_info")
    val fileInfo: FileInfo,
    @SerializedName("analysis_timestamp")
    val analysisTimestamp: String,
    @SerializedName("sha256")
    val sha256: String,
    @SerializedName("analysis_type")
    val analysisType: String,
    @SerializedName("deepfake_analysis")
    val deepfakeAnalysis: DeepfakeAnalysis?,
    @SerializedName("extracted_text")
    val extractedText: String?,
    @SerializedName("cyberbullying_analysis")
    val cyberbullyingAnalysis: String?,
    @SerializedName("cyberbullying_analysis_summary")
    val cyberbullyingAnalysisSummary: String?,
    @SerializedName("cyberbullying_risk_line")
    val cyberbullyingRiskLine: String?,
    @SerializedName("original_image_path")
    val originalImagePath: String?,
    @SerializedName("error")
    val error: String?,
    // MainScreen.ktì—ì„œ ì‚¬ìš©í•˜ëŠ” í•„ë“œ ì¶”ê°€
    val result: String?,
    val confidence: Double?
) : Parcelable

@Parcelize
data class FileInfo(
    @SerializedName("filename")
    val filename: String,
    @SerializedName("type")
    val type: String,
    @SerializedName("size_bytes")
    val sizeBytes: Long
) : Parcelable

@Parcelize
data class DeepfakeAnalysis(
    @SerializedName("status")
    val status: String,
    @SerializedName("request")
    val request: Request?,
    @SerializedName("type")
    val type: Type?,
    @SerializedName("offensive")
    val offensive: Offensive?,
    @SerializedName("nudity")
    val nudity: Nudity?,
    @SerializedName("wad")
    val wad: Wad?,
    @SerializedName("error")
    val error: String?
) : Parcelable

@Parcelize
data class Request(
    @SerializedName("id")
    val id: String,
    @SerializedName("timestamp")
    val timestamp: Double,
    @SerializedName("operations")
    val operations: Int
) : Parcelable

@Parcelize
data class Type(
    @SerializedName("ai_generated")
    val aiGenerated: Double,
    @SerializedName("deepfake")
    val deepfake: Double
) : Parcelable

@Parcelize
data class Offensive(
    @SerializedName("prob")
    val prob: Double
) : Parcelable

@Parcelize
data class Nudity(
    @SerializedName("sexual_activity")
    val sexualActivity: Double,
    @SerializedName("sexual_display")
    val sexualDisplay: Double,
    @SerializedName("erotica")
    val erotica: Double,
    @SerializedName("suggestive")
    val suggestive: Double,
    @SerializedName("none")
    val none: Double,
    @SerializedName("raw")
    val raw: Double
) : Parcelable

@Parcelize
data class Wad(
    @SerializedName("prob")
    val prob: Double
) : Parcelable
```

---

### 18.9. Resource.kt

**ìœ„ì¹˜**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/data/model/Resource.kt`

**ì—­í• **: API ì‘ë‹µ ìƒíƒœë¥¼ ê°ì‹¸ëŠ” ë˜í¼ í´ë˜ìŠ¤ (Loading/Success/Error)

```kotlin
package com.ansimtalk.app.data.model

sealed class Resource<out T> {
    object Loading : Resource<Nothing>()
    data class Success<T>(val data: T) : Resource<T>()
    data class Error(val message: String) : Resource<Nothing>()
}
```

---

### 18.10. PdfRequestBody.kt

**ìœ„ì¹˜**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/data/model/PdfRequestBody.kt`

**ì—­í• **: PDF ìƒì„± API ìš”ì²­ ë°”ë””

```kotlin
package com.ansimtalk.app.data.model

import com.google.gson.annotations.SerializedName

data class PdfRequestBody(
    @SerializedName("analysis_type")
    val analysisType: String,
    @SerializedName("analysis_result")
    val analysisResult: AnalysisResult,
    @SerializedName("original_image_path")
    val originalImagePath: String? = null
)
```

---

### 18.11. PdfGenerationResult.kt

**ìœ„ì¹˜**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/data/model/PdfGenerationResult.kt`

**ì—­í• **: PDF ìƒì„± ê²°ê³¼ ìƒíƒœ

```kotlin
package com.ansimtalk.app.data.model

import okhttp3.ResponseBody
import java.io.File

sealed class PdfGenerationResult {
    data class Success(val data: Any) : PdfGenerationResult() // ResponseBody or File
    data class Failure(val error: Exception) : PdfGenerationResult()
}
```

---

### 18.12. PdfErrors.kt

**ìœ„ì¹˜**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/data/model/PdfErrors.kt`

**ì—­í• **: PDF ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜ ë¶„ë¥˜ ë° ìƒì„¸ ë©”ì‹œì§€ ì œê³µ

```kotlin
package com.ansimtalk.app.data.model

/** ìƒì„¸ ì›ì¸ì„ ë‹´ëŠ” ì˜ˆì™¸. UI/ë¡œê·¸ì—ì„œ ë¶„ê¸° ì²˜ë¦¬ ê°€ëŠ¥ */
class PdfDownloadException(
    val kind: Kind,
    val httpCode: Int? = null,
    val serverMessage: String? = null,
    val serverBody: String? = null,
    cause: Throwable? = null
) : Exception(buildMessage(kind, httpCode, serverMessage, serverBody), cause) {
    enum class Kind { Network, Http4xx, Http5xx, EmptyBody, Unexpected }

    companion object {
        private fun buildMessage(kind: Kind, code: Int?, msg: String?, body: String?): String {
            return when (kind) {
                Kind.Network -> "ì„œë²„ ì—°ê²° ì‹¤íŒ¨(ë„¤íŠ¸ì›Œí¬/íƒ€ì„ì•„ì›ƒ)."
                Kind.Http4xx -> "ìš”ì²­ ì˜¤ë¥˜(\${code ?: "4xx"}): \${msg ?: "í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ ê²€ì¦ ì‹¤íŒ¨"}\${body?.let { " | $it" } ?: ""}"
                Kind.Http5xx -> "ì„œë²„ ì˜¤ë¥˜(\${code ?: "5xx"}): \${msg ?: "ì„œë²„ ë‚´ë¶€ ì˜¤ë¥˜"}\${body?.let { " | $it" } ?: ""}"
                Kind.EmptyBody -> "ì„œë²„ ì‘ë‹µì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤(2xxì¸ë° body null)."
                Kind.Unexpected -> "ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜: \${msg ?: "ì›ì¸ ë¶ˆëª…"}"
            }
        }
    }
}
```

---

### 18.13. API Services

#### AnsimTalkApiService.kt

**ìœ„ì¹˜**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/data/api/AnsimTalkApiService.kt`

**ì—­í• **: Retrofit API ì¸í„°í˜ì´ìŠ¤ ì •ì˜

```kotlin
package com.ansimtalk.app.data.api

import com.ansimtalk.app.data.model.AnalysisResult
import okhttp3.MultipartBody
import okhttp3.ResponseBody
import retrofit2.Response
import retrofit2.http.*

interface AnsimTalkApiService {
    @Multipart
    @POST("analyze_deepfake")
    suspend fun analyzeDeepfake(@Part file: MultipartBody.Part): Response<AnalysisResult>

    @Multipart
    @POST("analyze_cyberbullying")
    suspend fun analyzeCyberbullying(@Part file: MultipartBody.Part): Response<AnalysisResult>

    @GET("download_pdf")
    suspend fun downloadPdf(): Response<ResponseBody>

    @GET("health")
    suspend fun healthCheck(): Response<Map<String, Any>>

    @GET("results")
    suspend fun getResults(): Response<List<AnalysisResult>>

    @GET("evidence")
    suspend fun getEvidence(): Response<Map<String, Any>>
}
```

---

#### ApiService.kt

**ìœ„ì¹˜**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/data/remote/ApiService.kt`

**ì—­í• **: ì‹¤ì œ HTTP ìš”ì²­ ì¸í„°í˜ì´ìŠ¤

```kotlin
package com.ansimtalk.app.data.remote

import com.ansimtalk.app.data.model.PdfRequestBody
import okhttp3.MultipartBody
import okhttp3.ResponseBody
import retrofit2.http.GET
import retrofit2.http.Multipart
import retrofit2.http.POST
import retrofit2.http.Part
import retrofit2.Response
import retrofit2.http.Body
import retrofit2.http.Headers

interface ApiService {
    @GET("/api/health")
    suspend fun healthCheck(): Map<String, Any>

    @Multipart
    @Headers("Accept: application/json")
    @POST("/api/analyze_deepfake")
    suspend fun analyzeDeepfake(@Part file: MultipartBody.Part): Response<ResponseBody>

    @Multipart
    @Headers("Accept: application/json")
    @POST("/api/analyze_cyberbullying")
    suspend fun analyzeCyberbullying(@Part file: MultipartBody.Part): Response<ResponseBody>

    @POST("/api/download_pdf")
    suspend fun downloadPdf(@Body body: PdfRequestBody): Response<ResponseBody>
}
```

---

### 18.14. Repositories

#### AnsimTalkRepository.kt (Domain Interface)

**ìœ„ì¹˜**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/domain/repository/AnsimTalkRepository.kt`

**ì—­í• **: ë¦¬í¬ì§€í† ë¦¬ ì¸í„°í˜ì´ìŠ¤ (Clean Architecture)

```kotlin
package com.ansimtalk.app.domain.repository

import com.ansimtalk.app.data.model.AnalysisResult
import com.ansimtalk.app.data.model.PdfRequestBody
import com.ansimtalk.app.data.model.Resource
import kotlinx.coroutines.flow.Flow
import okhttp3.MultipartBody
import okhttp3.ResponseBody

interface AnsimTalkRepository {
    fun healthCheck(): Flow<Resource<Map<String, Any>>>
    fun analyzeDeepfake(file: MultipartBody.Part): Flow<Resource<AnalysisResult>>
    fun analyzeCyberbullying(file: MultipartBody.Part): Flow<Resource<AnalysisResult>>
    fun downloadPdf(body: PdfRequestBody): Flow<Resource<ResponseBody>>
    fun getResults(): Flow<Resource<List<AnalysisResult>>>
    fun getEvidence(): Flow<Resource<Map<String, Any>>>
}
```

---

#### AnsimTalkRepositoryImpl.kt

**ìœ„ì¹˜**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/data/repository/AnsimTalkRepositoryImpl.kt`

**ì—­í• **: ë¦¬í¬ì§€í† ë¦¬ êµ¬í˜„ (API í˜¸ì¶œ, JSON íŒŒì‹±, ì˜¤ë¥˜ í•¸ë“¤ë§)

```kotlin
package com.ansimtalk.app.data.repository

import com.ansimtalk.app.data.model.AnalysisResult
import com.ansimtalk.app.data.model.PdfRequestBody
import com.ansimtalk.app.data.model.Resource
import com.ansimtalk.app.data.remote.ApiService
import com.ansimtalk.app.domain.repository.AnsimTalkRepository
import kotlinx.coroutines.flow.Flow
import kotlinx.coroutines.flow.flow
import okhttp3.MultipartBody
import okhttp3.ResponseBody
import javax.inject.Inject

class AnsimTalkRepositoryImpl @Inject constructor(
    private val apiService: ApiService
) : AnsimTalkRepository {
    override fun healthCheck(): Flow<Resource<Map<String, Any>>> = flow {
        emit(Resource.Loading)
        try {
            val response = apiService.healthCheck()
            emit(Resource.Success(response))
        } catch (e: Exception) {
            val message = e.message ?: "Unknown Error"
            emit(Resource.Error(message))
        }
    }

    override fun analyzeDeepfake(file: MultipartBody.Part): Flow<Resource<AnalysisResult>> = flow {
        emit(Resource.Loading)
        try {
            val response = apiService.analyzeDeepfake(file)
            if (response.isSuccessful) {
                val body = response.body()?.string() ?: "{}"
                val trimmed = body.trim()
                if (!trimmed.startsWith("{")) {
                    val snippet = trimmed.take(300)
                    emit(Resource.Error("ì„œë²„ê°€ JSON ëŒ€ì‹  ë¬¸ìì—´ì„ ë°˜í™˜: $snippet"))
                    return@flow
                }
                val gson = com.google.gson.Gson()
                val parsed = gson.fromJson(trimmed, com.ansimtalk.app.data.model.AnalysisResult::class.java)
                val errorText = parsed.error
                val deepfakeStatus = parsed.deepfakeAnalysis?.status ?: ""
                if (errorText != null && errorText.isNotBlank()) {
                    emit(Resource.Error(errorText))
                } else if (deepfakeStatus.equals("error", ignoreCase = true)) {
                    val fallback = parsed.copy(
                        deepfakeAnalysis = com.ansimtalk.app.data.model.DeepfakeAnalysis(
                            status = "fallback",
                            request = com.ansimtalk.app.data.model.Request("n/a", 0.0, 0),
                            type = com.ansimtalk.app.data.model.Type(0.0, 0.0),
                            offensive = com.ansimtalk.app.data.model.Offensive(0.0),
                            nudity = com.ansimtalk.app.data.model.Nudity(0.0,0.0,0.0,0.0,0.0,0.0),
                            wad = com.ansimtalk.app.data.model.Wad(0.0),
                            error = null
                        ),
                        error = null
                    )
                    emit(Resource.Success(fallback))
                } else {
                    emit(Resource.Success(parsed))
                }
            } else {
                val raw = response.errorBody()?.string() ?: "HTTP \${response.code()}"
                val gson = com.google.gson.Gson()
                val isModelErrorJson = raw.contains("\"status\"") && raw.contains("\"code\"") && raw.contains("\"message\"")
                if (isModelErrorJson) {
                    val now = java.time.LocalDateTime.now().toString()
                    val fallback = com.ansimtalk.app.data.model.AnalysisResult(
                        fileInfo = com.ansimtalk.app.data.model.FileInfo(filename = "N/A", type = "deepfake", sizeBytes = 0L),
                        analysisTimestamp = now,
                        sha256 = "N/A",
                        analysisType = "deepfake",
                        deepfakeAnalysis = com.ansimtalk.app.data.model.DeepfakeAnalysis(
                            status = "fallback",
                            request = com.ansimtalk.app.data.model.Request("n/a", 0.0, 0),
                            type = com.ansimtalk.app.data.model.Type(0.0, 0.0),
                            offensive = com.ansimtalk.app.data.model.Offensive(0.0),
                            nudity = com.ansimtalk.app.data.model.Nudity(0.0,0.0,0.0,0.0,0.0,0.0),
                            wad = com.ansimtalk.app.data.model.Wad(0.0),
                            error = null
                        ),
                        extractedText = null,
                        cyberbullyingAnalysis = null,
                        cyberbullyingAnalysisSummary = null,
                        cyberbullyingRiskLine = null,
                        error = null,
                        result = null,
                        confidence = null,
                        originalImagePath = null
                    )
                    emit(Resource.Success(fallback))
                } else {
                    val message = try {
                        val mapType = object : com.google.gson.reflect.TypeToken<Map<String, Any>>() {}.type
                        val map: Map<String, Any> = gson.fromJson(raw, mapType)
                        map["error"]?.toString() ?: raw
                    } catch (_: Exception) {
                        raw
                    }
                    emit(Resource.Error(message))
                }
            }
        } catch (e: Exception) {
            val message = e.message ?: "Unknown Error"
            emit(Resource.Error(message))
        }
    }

    override fun analyzeCyberbullying(file: MultipartBody.Part): Flow<Resource<AnalysisResult>> = flow {
        emit(Resource.Loading)
        try {
            val response = apiService.analyzeCyberbullying(file)
            if (response.isSuccessful) {
                val body = response.body()?.string() ?: "{}"
                val trimmed = body.trim()
                if (!trimmed.startsWith("{")) {
                    val snippet = trimmed.take(300)
                    emit(Resource.Error("ì„œë²„ê°€ JSON ëŒ€ì‹  ë¬¸ìì—´ì„ ë°˜í™˜: $snippet"))
                    return@flow
                }
                val gson = com.google.gson.Gson()
                val parsed = gson.fromJson(trimmed, com.ansimtalk.app.data.model.AnalysisResult::class.java)
                val errorText = parsed.error
                if (errorText != null && errorText.isNotBlank()) {
                    emit(Resource.Error(errorText))
                } else {
                    emit(Resource.Success(parsed))
                }
            } else {
                val raw = response.errorBody()?.string() ?: "HTTP \${response.code()}"
                val gson = com.google.gson.Gson()
                val message = try {
                    val mapType = object : com.google.gson.reflect.TypeToken<Map<String, Any>>() {}.type
                    val map: Map<String, Any> = gson.fromJson(raw, mapType)
                    map["error"]?.toString() ?: raw
                } catch (_: Exception) {
                    raw
                }
                emit(Resource.Error(message))
            }
        } catch (e: Exception) {
            val message = e.message ?: "Unknown Error"
            emit(Resource.Error(message))
        }
    }

    override fun downloadPdf(body: PdfRequestBody): Flow<Resource<ResponseBody>> = flow {
        emit(Resource.Loading)
        try {
            val response = apiService.downloadPdf(body)
            if (response.isSuccessful) {
                response.body()?.let {
                    emit(Resource.Success(it))
                } ?: emit(Resource.Error("PDF ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤."))
            } else {
                val errorBody = response.errorBody()?.string() ?: "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"
                emit(Resource.Error("PDF ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: $errorBody"))
            }
        } catch (e: Exception) {
            emit(Resource.Error("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: \${e.message}"))
        }
    }

    override fun getResults(): Flow<Resource<List<AnalysisResult>>> = flow {
        emit(Resource.Loading)
        try {
            // ì„ì‹œë¡œ ë¹ˆ ë¦¬ìŠ¤íŠ¸ ë°˜í™˜ (ì‹¤ì œë¡œëŠ” APIì—ì„œ ê²°ê³¼ë¥¼ ê°€ì ¸ì™€ì•¼ í•¨)
            emit(Resource.Success(emptyList()))
        } catch (e: Exception) {
            emit(Resource.Error(e.message ?: "Unknown Error"))
        }
    }

    override fun getEvidence(): Flow<Resource<Map<String, Any>>> = flow {
        emit(Resource.Loading)
        try {
            // ì„ì‹œë¡œ ë¹ˆ ë§µ ë°˜í™˜ (ì‹¤ì œë¡œëŠ” APIì—ì„œ ì¦ê±°ë¥¼ ê°€ì ¸ì™€ì•¼ í•¨)
            emit(Resource.Success(emptyMap()))
        } catch (e: Exception) {
            emit(Resource.Error(e.message ?: "Unknown Error"))
        }
    }
}
```

---

#### PdfRepository.kt

**ìœ„ì¹˜**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/data/repository/PdfRepository.kt`

**ì—­í• **: 
- ì„œë²„ PDF ìƒì„± API í˜¸ì¶œ
- WebView ê¸°ë°˜ ë¡œì»¬ PDF ìƒì„± (Fallback)
- MediaStoreë¥¼ í†µí•œ íŒŒì¼ ì €ì¥

```kotlin
package com.ansimtalk.app.data.repository

import android.content.ContentValues
import android.content.Context
import android.os.Environment
import android.webkit.WebView
import android.view.View
import android.view.View.MeasureSpec
import android.graphics.pdf.PdfDocument
import android.graphics.Bitmap
import android.graphics.Canvas
import android.graphics.Paint
import android.os.Handler
import android.os.Looper
import com.ansimtalk.app.data.model.PdfGenerationResult
import com.ansimtalk.app.data.model.PdfDownloadException
import com.ansimtalk.app.data.model.PdfRequestBody
import com.ansimtalk.app.data.remote.ApiService
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.suspendCancellableCoroutine
import kotlinx.coroutines.withContext
import okhttp3.ResponseBody
import java.io.File
import kotlin.coroutines.resume

class PdfRepository(
    private val context: Context,
    private val apiService: ApiService
) {
    suspend fun generatePdfReport(body: PdfRequestBody): PdfGenerationResult {
        return try {
            val response = withContext(Dispatchers.IO) { apiService.downloadPdf(body) }
            if (response.isSuccessful) {
                val rb: ResponseBody? = response.body()
                if (rb != null) PdfGenerationResult.Success(rb)
                else PdfGenerationResult.Failure(PdfDownloadException(PdfDownloadException.Kind.EmptyBody))
            } else {
                val code = response.code()
                val errText = try { response.errorBody()?.string() } catch (_: Exception) { null }
                android.util.Log.e("PdfRepository", "download_pdf failed: code=$code body=$errText")
                val kind = if (code in 400..499) PdfDownloadException.Kind.Http4xx else PdfDownloadException.Kind.Http5xx
                PdfGenerationResult.Failure(PdfDownloadException(kind, httpCode = code, serverMessage = response.message(), serverBody = errText))
            }
        } catch (e: java.net.SocketTimeoutException) {
            PdfGenerationResult.Failure(PdfDownloadException(PdfDownloadException.Kind.Network, serverMessage = e.message, cause = e))
        } catch (e: java.io.IOException) {
            PdfGenerationResult.Failure(PdfDownloadException(PdfDownloadException.Kind.Network, serverMessage = e.message, cause = e))
        } catch (e: Exception) {
            PdfGenerationResult.Failure(PdfDownloadException(PdfDownloadException.Kind.Unexpected, serverMessage = e.message, cause = e))
        }
    }

    // ì„œë²„ PDFë§Œ ì‚¬ìš©í•˜ë¯€ë¡œ HTML/ë¡œì»¬ í´ë°± ê²½ë¡œ ì œê±°

    private fun enforceA4Width(html: String): String {
        // 1) viewportë¥¼ ê³ ì • í­ìœ¼ë¡œ êµì²´
        val viewportRegex = Regex("<meta[^>]*name=\\\"viewport\\\"[^>]*>", RegexOption.IGNORE_CASE)
        var out = viewportRegex.replace(html) {
            """<meta name=\"viewport\" content=\"width=595, initial-scale=1, maximum-scale=1, user-scalable=no\" />"""
        }
        if (!out.contains("name=\"viewport\"", ignoreCase = true)) {
            out = out.replace("</head>", """<meta name=\"viewport\" content=\"width=595, initial-scale=1\" /></head>""", ignoreCase = true)
        }
        // 2) html/body í­ì„ 595pxë¡œ ê³ ì •í•˜ëŠ” ìŠ¤íƒ€ì¼ ì£¼ì…
        val style = """
            <style>
              html, body { width:595px !important; margin:0; padding:0; }
              body { margin:40px; -webkit-text-size-adjust:100%; }
            </style>
        """.trimIndent()
        return if (out.contains("</head>", ignoreCase = true))
            out.replace(Regex("</head>", RegexOption.IGNORE_CASE), style + "\n</head>")
        else "<head>$style</head>$out"
    }

    private fun buildHtmlFromBody(body: PdfRequestBody): String {
        // ê²½ëŸ‰ HTML í…œí”Œë¦¿ (ê°’ ì‹¤ì œ ì¹˜í™˜, ëª¨ë°”ì¼/ì›¹ë·° ë Œë” ì•ˆì • CSS í¬í•¨)
        val result = body.analysisResult
        val createdAt = java.time.LocalDateTime.now().toString().replace('T',' ')
        val reportId = "DF-CB-\${java.time.LocalDate.now()}-001-v1.0"
        val deepfakeProb = result.deepfakeAnalysis?.type?.deepfake ?: 0.0
        val cbRisk = result.cyberbullyingRiskLine ?: "N/A"
        val summary = if (body.analysisType == "deepfake")
            "ë”¥í˜ì´í¬ í™•ë¥ : \${String.format("%.1f%%", deepfakeProb * 100)}"
        else
            "ì‚¬ì´ë²„í­ë ¥ ìœ„í—˜ë„: $cbRisk"
        val fileName = result.fileInfo.filename
        val fileSize = "\${result.fileInfo.sizeBytes} bytes"
        val sha256 = result.sha256
        val extracted = result.extractedText ?: ""
        val cbHtml = result.cyberbullyingAnalysis ?: ""
        val cbSummary = result.cyberbullyingAnalysisSummary ?: ""

        return """
            <!DOCTYPE html>
            <html lang="ko">
            <head>
              <meta charset="UTF-8" />
              <meta name="viewport" content="width=device-width, initial-scale=1" />
              <style>
                html, body { margin:0; padding:0; width:595px; }
                body{
                  font-family: 'Noto Sans KR', 'Malgun Gothic', Arial, sans-serif;
                  margin:40px; line-height:1.6; color:#333;
                  word-break: keep-all; white-space: normal; letter-spacing: normal;
                }
                h1,h2{ color:#1976d2; margin: 0 0 12px 0; }
                table{ border-collapse:collapse; width:100%; font-size:12px; margin:12px 0 }
                th,td{ border:1px solid #ddd; padding:8px 12px; text-align:left }
                .box{ background:#f0f4ff; border-left:4px solid #1976d2; border-radius:8px; padding:12px; margin:12px 0 }
                .container{ max-width:100%; }
              </style>
            </head>
            <body>
              <div class="container">
                <h1>ì•ˆì‹¬í†¡ ë””ì§€í„¸ ì¦ê±° ë¶„ì„ ë³´ê³ ì„œ</h1>
                <h2>1. ê¸°ë³¸ ì •ë³´</h2>
                <table>
                  <tr><th>ë³´ê³ ì„œ ID</th><td>$reportId</td></tr>
                  <tr><th>ìƒì„±ì¼ì‹œ</th><td>$createdAt</td></tr>
                  <tr><th>ë¶„ì„ ìœ í˜•</th><td>\${body.analysisType}</td></tr>
                </table>

                <h2>2. ë¶„ì„ ê²°ê³¼ ìš”ì•½</h2>
                <div class="box">$summary</div>

                <h2>3. ì¦ê±° íŒŒì¼ ì •ë³´</h2>
                <table>
                  <tr><th>íŒŒì¼ëª…</th><td>$fileName</td></tr>
                  <tr><th>íŒŒì¼ í¬ê¸°</th><td>$fileSize</td></tr>
                  <tr><th>SHA-256</th><td style="font-family:monospace;">$sha256</td></tr>
                </table>

                <h2>4. ì›ë³¸ í…ìŠ¤íŠ¸(OCR)</h2>
                <div class="box" style="font-family:monospace; white-space:pre-wrap;">$extracted</div>

                <h2>5. AI ë¶„ì„ ìƒì„¸</h2>
                <div class="box">\${cbHtml}</div>
                <h2>6. ë¶„ì„ ìš”ì•½</h2>
                <div class="box">\${cbSummary.replace("\n", "<br>")}</div>
              </div>
            </body>
            </html>
        """.trimIndent()
    }

    private suspend fun generatePdfLocally(html: String): PdfGenerationResult = withContext(Dispatchers.Main) {
        suspendCancellableCoroutine { cont ->
            val pageWidthPt = 595 // A4 72dpi ê¸°ì¤€ í­ (pt)
            val pageHeightPt = 842
            val scale = 1 // ì„œë²„ í…œí”Œë¦¿(A4 í­ 595px) ê¸°ì¤€ ì¶•ì†Œ ì™œê³¡ ë°©ì§€ ìœ„í•´ 1ë°° ìŠ¤ì¼€ì¼ë¡œ ë Œë”
            val webView = WebView(context)
            webView.settings.javaScriptEnabled = false
            webView.setLayerType(View.LAYER_TYPE_SOFTWARE, null)
            webView.settings.textZoom = 100
            webView.settings.useWideViewPort = false
            webView.settings.loadWithOverviewMode = false
            webView.webViewClient = object : android.webkit.WebViewClient() {
                override fun onPageFinished(view: WebView?, url: String?) {
                    try {
                        // A4 í­ ê¸°ë°˜ ë ˆì´ì•„ì›ƒ í­
                        val contentWidthPx = pageWidthPt * scale

                        val handler = Handler(Looper.getMainLooper())
                        var tries = 0
                        var lastHeight = 0

                        fun proceed() {
                            try {
                                val contentHeightPx = (webView.contentHeight * scale).coerceAtLeast(pageHeightPt * scale)
                                val pageHeightPx = pageHeightPt * scale
                                webView.layout(0, 0, contentWidthPx, contentHeightPx)

                                val pdf = PdfDocument()
                                var currentY = 0
                                var pageNumber = 1
                                while (currentY < contentHeightPx && pageNumber <= 100) {
                                    val visible = kotlin.math.min(pageHeightPx, contentHeightPx - currentY)
                                    val bitmap = Bitmap.createBitmap(contentWidthPx, visible, Bitmap.Config.ARGB_8888)
                                    val canvas = Canvas(bitmap)
                                    canvas.drawColor(android.graphics.Color.WHITE)
                                    canvas.save()
                                    canvas.translate(0f, -currentY.toFloat())
                                    webView.draw(canvas)
                                    canvas.restore()

                                    val pageInfo = PdfDocument.PageInfo.Builder(pageWidthPt, pageHeightPt, pageNumber).create()
                                    val page = pdf.startPage(pageInfo)
                                    val paint = Paint(Paint.FILTER_BITMAP_FLAG)
                                    page.canvas.save()
                                    val scaleX = pageWidthPt.toFloat() / contentWidthPx.toFloat()
                                    val scaleY = pageHeightPt.toFloat() / pageHeightPx.toFloat()
                                    page.canvas.scale(scaleX, scaleY)
                                    page.canvas.drawBitmap(bitmap, 0f, 0f, paint)
                                    page.canvas.restore()
                                    pdf.finishPage(page)
                                    bitmap.recycle()

                                    currentY += visible
                                    pageNumber += 1
                                }

                                val outFile = File(context.cacheDir, "evidence_\${System.currentTimeMillis()}.pdf")
                                outFile.outputStream().use { pdf.writeTo(it) }
                                pdf.close()
                                webView.destroy()
                                cont.resume(PdfGenerationResult.Success(outFile))
                            } catch (e: Exception) {
                                cont.resume(PdfGenerationResult.Failure(e))
                            }
                        }

                        fun waitStable() {
                            webView.measure(
                                MeasureSpec.makeMeasureSpec(contentWidthPx, MeasureSpec.EXACTLY),
                                MeasureSpec.makeMeasureSpec(0, MeasureSpec.UNSPECIFIED)
                            )
                            val h = webView.contentHeight
                            if ((h > 0 && kotlin.math.abs(h - lastHeight) < 2) || tries >= 40) {
                                proceed()
                            } else {
                                lastHeight = h
                                tries += 1
                                handler.postDelayed({ waitStable() }, 50)
                            }
                        }

                        waitStable()
                    } catch (e: Exception) {
                        cont.resume(PdfGenerationResult.Failure(e))
                    }
                }

                override fun onReceivedError(view: WebView?, request: android.webkit.WebResourceRequest?, error: android.webkit.WebResourceError?) {
                    cont.resume(PdfGenerationResult.Failure(Exception("WebView error")))
                }
            }
            webView.loadDataWithBaseURL("about:blank", html, "text/html", "UTF-8", null)
        }
    }

    fun saveToDownloads(bytes: ByteArray, displayName: String): Boolean {
        val values = ContentValues().apply {
            put(android.provider.MediaStore.MediaColumns.DISPLAY_NAME, displayName)
            put(android.provider.MediaStore.MediaColumns.MIME_TYPE, "application/pdf")
            put(android.provider.MediaStore.MediaColumns.RELATIVE_PATH, Environment.DIRECTORY_DOWNLOADS)
        }
        val resolver = context.contentResolver
        val uri = resolver.insert(android.provider.MediaStore.Downloads.EXTERNAL_CONTENT_URI, values)
        if (uri != null) {
            resolver.openOutputStream(uri).use { out ->
                if (out != null) {
                    out.write(bytes)
                    out.flush()
                    return true
                }
            }
        }
        return false
    }
}
```

---

### 18.15. Use Cases

#### AnalyzeDeepfakeUseCase.kt

**ìœ„ì¹˜**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/domain/usecase/AnalyzeDeepfakeUseCase.kt`

```kotlin
package com.ansimtalk.app.domain.usecase

import com.ansimtalk.app.data.model.AnalysisResult
import com.ansimtalk.app.data.model.Resource
import com.ansimtalk.app.domain.repository.AnsimTalkRepository
import kotlinx.coroutines.flow.Flow
import okhttp3.MultipartBody
import javax.inject.Inject

class AnalyzeDeepfakeUseCase @Inject constructor(
    private val repository: AnsimTalkRepository
) {
    operator fun invoke(file: MultipartBody.Part): Flow<Resource<AnalysisResult>> {
        return repository.analyzeDeepfake(file)
    }
}
```

---

#### AnalyzeCyberbullyingUseCase.kt

**ìœ„ì¹˜**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/domain/usecase/AnalyzeCyberbullyingUseCase.kt`

```kotlin
package com.ansimtalk.app.domain.usecase

import com.ansimtalk.app.data.model.AnalysisResult
import com.ansimtalk.app.data.model.Resource
import com.ansimtalk.app.domain.repository.AnsimTalkRepository
import kotlinx.coroutines.flow.Flow
import okhttp3.MultipartBody
import javax.inject.Inject

class AnalyzeCyberbullyingUseCase @Inject constructor(
    private val repository: AnsimTalkRepository
) {
    operator fun invoke(file: MultipartBody.Part): Flow<Resource<AnalysisResult>> {
        return repository.analyzeCyberbullying(file)
    }
}
```

---

#### GeneratePdfUseCase.kt

**ìœ„ì¹˜**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/domain/usecase/GeneratePdfUseCase.kt`

```kotlin
package com.ansimtalk.app.domain.usecase

import com.ansimtalk.app.data.model.PdfGenerationResult
import com.ansimtalk.app.data.model.PdfRequestBody
import com.ansimtalk.app.data.repository.PdfRepository
import javax.inject.Inject

class GeneratePdfUseCase @Inject constructor(
    private val repository: PdfRepository
) {
    suspend operator fun invoke(body: PdfRequestBody): PdfGenerationResult {
        return repository.generatePdfReport(body)
    }
}
```

---

#### DownloadPdfUseCase.kt

**ìœ„ì¹˜**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/domain/usecase/DownloadPdfUseCase.kt`

```kotlin
package com.ansimtalk.app.domain.usecase

import com.ansimtalk.app.data.model.PdfRequestBody
import com.ansimtalk.app.data.model.Resource
import com.ansimtalk.app.domain.repository.AnsimTalkRepository
import kotlinx.coroutines.flow.Flow
import okhttp3.ResponseBody
import javax.inject.Inject

class DownloadPdfUseCase @Inject constructor(
    private val repository: AnsimTalkRepository
) {
    operator fun invoke(body: PdfRequestBody): Flow<Resource<ResponseBody>> {
        return repository.downloadPdf(body)
    }
}
```

---

#### HealthCheckUseCase.kt

**ìœ„ì¹˜**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/domain/usecase/HealthCheckUseCase.kt`

```kotlin
package com.ansimtalk.app.domain.usecase

import com.ansimtalk.app.data.model.Resource
import com.ansimtalk.app.domain.repository.AnsimTalkRepository
import kotlinx.coroutines.flow.Flow
import javax.inject.Inject

class HealthCheckUseCase @Inject constructor(
    private val repository: AnsimTalkRepository
) {
    operator fun invoke(): Flow<Resource<Map<String, Any>>> {
        return repository.healthCheck()
    }
}
```

---

#### GetResultsUseCase.kt

**ìœ„ì¹˜**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/domain/usecase/GetResultsUseCase.kt`

```kotlin
package com.ansimtalk.app.domain.usecase

import com.ansimtalk.app.data.model.AnalysisResult
import com.ansimtalk.app.data.model.Resource
import com.ansimtalk.app.domain.repository.AnsimTalkRepository
import kotlinx.coroutines.flow.Flow
import javax.inject.Inject

class GetResultsUseCase @Inject constructor(
    private val repository: AnsimTalkRepository
) {
    operator fun invoke(): Flow<Resource<List<AnalysisResult>>> {
        return repository.getResults()
    }
}
```

---

#### GetEvidenceUseCase.kt

**ìœ„ì¹˜**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/domain/usecase/GetEvidenceUseCase.kt`

```kotlin
package com.ansimtalk.app.domain.usecase

import com.ansimtalk.app.data.model.Resource
import com.ansimtalk.app.domain.repository.AnsimTalkRepository
import kotlinx.coroutines.flow.Flow
import javax.inject.Inject

class GetEvidenceUseCase @Inject constructor(
    private val repository: AnsimTalkRepository
) {
    operator fun invoke(): Flow<Resource<Map<String, Any>>> {
        return repository.getEvidence()
    }
}
```

---

### 18.16. DI Modules

#### NetworkModule.kt

**ìœ„ì¹˜**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/di/NetworkModule.kt`

**ì—­í• **: Retrofit, OkHttpClient ì„¤ì • ë° ì œê³µ

```kotlin
package com.ansimtalk.app.di

import com.ansimtalk.app.data.remote.ApiService
import com.ansimtalk.app.BuildConfig
import dagger.Module
import dagger.Provides
import dagger.hilt.InstallIn
import dagger.hilt.components.SingletonComponent
import okhttp3.OkHttpClient
import okhttp3.logging.HttpLoggingInterceptor
import retrofit2.Retrofit
import retrofit2.converter.gson.GsonConverterFactory
import javax.inject.Singleton
import com.google.gson.GsonBuilder

@Module
@InstallIn(SingletonComponent::class)
object NetworkModule {

    @Provides
    @Singleton
    fun provideLoggingInterceptor(): HttpLoggingInterceptor {
        return HttpLoggingInterceptor().setLevel(HttpLoggingInterceptor.Level.BODY)
    }

    @Provides
    @Singleton
    fun provideOkHttpClient(loggingInterceptor: HttpLoggingInterceptor): OkHttpClient {
        return OkHttpClient.Builder()
            .addInterceptor(loggingInterceptor)
            .addInterceptor { chain ->
                val original = chain.request()
                val request = original.newBuilder()
                    .header("Accept", "application/json")
                    .build()
                chain.proceed(request)
            }
            .retryOnConnectionFailure(true)
            .connectTimeout(15, java.util.concurrent.TimeUnit.SECONDS)
            .readTimeout(60, java.util.concurrent.TimeUnit.SECONDS)
            .writeTimeout(60, java.util.concurrent.TimeUnit.SECONDS)
            .callTimeout(75, java.util.concurrent.TimeUnit.SECONDS)
            .build()
    }

    @Provides
    @Singleton
    fun provideRetrofit(okHttpClient: OkHttpClient): Retrofit {
        val gson = GsonBuilder()
            .setLenient()
            .create()
        return Retrofit.Builder()
            .baseUrl(BuildConfig.BASE_URL)
            .client(okHttpClient)
            .addConverterFactory(GsonConverterFactory.create(gson))
            .build()
    }

    @Provides
    @Singleton
    fun provideApiService(retrofit: Retrofit): ApiService {
        return retrofit.create(ApiService::class.java)
    }
}
```

---

#### RepositoryModule.kt

**ìœ„ì¹˜**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/di/RepositoryModule.kt`

**ì—­í• **: Repository ë°”ì¸ë”© ë° ì œê³µ

```kotlin
package com.ansimtalk.app.di

import android.content.Context
import com.ansimtalk.app.data.remote.ApiService
import com.ansimtalk.app.data.repository.AnsimTalkRepositoryImpl
import com.ansimtalk.app.data.repository.PdfRepository
import com.ansimtalk.app.domain.repository.AnsimTalkRepository
import dagger.Binds
import dagger.Module
import dagger.Provides
import dagger.hilt.InstallIn
import dagger.hilt.android.qualifiers.ApplicationContext
import dagger.hilt.components.SingletonComponent
import javax.inject.Singleton

@Module
@InstallIn(SingletonComponent::class)
abstract class RepositoryModule {

    @Binds
    @Singleton
    abstract fun bindAnsimTalkRepository(
        ansimTalkRepositoryImpl: AnsimTalkRepositoryImpl
    ): AnsimTalkRepository

    companion object {
        @Provides
        @Singleton
        fun providePdfRepository(
            @ApplicationContext context: Context,
            apiService: ApiService
        ): PdfRepository = PdfRepository(context, apiService)
    }
}
```

---

### 18.17. ViewModels

#### MainViewModel.kt

**ìœ„ì¹˜**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/presentation/viewmodel/MainViewModel.kt`

**ì—­í• **: ë©”ì¸ í™”ë©´ ìƒíƒœ ê´€ë¦¬ ë° ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§

```kotlin
package com.ansimtalk.app.presentation.viewmodel

import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.ansimtalk.app.data.model.Resource
import com.ansimtalk.app.domain.usecase.AnalyzeCyberbullyingUseCase
import com.ansimtalk.app.domain.usecase.AnalyzeDeepfakeUseCase
import com.ansimtalk.app.domain.usecase.HealthCheckUseCase
import com.ansimtalk.app.domain.usecase.DownloadPdfUseCase
import com.ansimtalk.app.presentation.ui.state.AnalysisUiState
import com.ansimtalk.app.presentation.ui.state.PdfDownloadUiState
import dagger.hilt.android.lifecycle.HiltViewModel
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.StateFlow
import kotlinx.coroutines.flow.catch
import kotlinx.coroutines.flow.onStart
import kotlinx.coroutines.launch
import okhttp3.MultipartBody
import javax.inject.Inject

@HiltViewModel
class MainViewModel @Inject constructor(
    private val healthCheckUseCase: HealthCheckUseCase,
    private val analyzeDeepfakeUseCase: AnalyzeDeepfakeUseCase,
    private val analyzeCyberbullyingUseCase: AnalyzeCyberbullyingUseCase,
    private val downloadPdfUseCase: DownloadPdfUseCase
) : ViewModel() {

    private val _healthState = MutableStateFlow<Resource<Map<String, Any>>>(Resource.Loading)
    val healthState: StateFlow<Resource<Map<String, Any>>> = _healthState

    private val _deepfakeAnalysisState = MutableStateFlow<AnalysisUiState>(AnalysisUiState.Idle)
    val deepfakeAnalysisState: StateFlow<AnalysisUiState> = _deepfakeAnalysisState

    private val _cyberbullyingAnalysisState = MutableStateFlow<AnalysisUiState>(AnalysisUiState.Idle)
    val cyberbullyingAnalysisState: StateFlow<AnalysisUiState> = _cyberbullyingAnalysisState

    private val _pdfDownloadState = MutableStateFlow<PdfDownloadUiState>(PdfDownloadUiState.Idle)
    val pdfDownloadState: StateFlow<PdfDownloadUiState> = _pdfDownloadState
    private val _pdfBytes = MutableStateFlow<ByteArray?>(null)
    val pdfBytes: StateFlow<ByteArray?> = _pdfBytes

    fun checkHealth() {
        viewModelScope.launch {
            healthCheckUseCase()
                .onStart { _healthState.value = Resource.Loading }
                .catch { e -> _healthState.value = Resource.Error(e.message ?: "Unknown Error") }
                .collect { result -> _healthState.value = result }
        }
    }

    fun analyzeDeepfake(file: MultipartBody.Part) {
        viewModelScope.launch {
            analyzeDeepfakeUseCase(file)
                .onStart { _deepfakeAnalysisState.value = AnalysisUiState.Loading }
                .catch { e -> _deepfakeAnalysisState.value = AnalysisUiState.Error(e.message ?: "Unknown Error") }
                .collect { result ->
                    when (result) {
                        is Resource.Success -> _deepfakeAnalysisState.value = AnalysisUiState.Success(result.data)
                        is Resource.Error -> _deepfakeAnalysisState.value = AnalysisUiState.Error(result.message)
                        is Resource.Loading -> _deepfakeAnalysisState.value = AnalysisUiState.Loading
                    }
                }
        }
    }

    fun analyzeCyberbullying(file: MultipartBody.Part) {
        viewModelScope.launch {
            analyzeCyberbullyingUseCase(file)
                .onStart { _cyberbullyingAnalysisState.value = AnalysisUiState.Loading }
                .catch { e -> _cyberbullyingAnalysisState.value = AnalysisUiState.Error(e.message ?: "Unknown Error") }
                .collect { result ->
                    when (result) {
                        is Resource.Success -> _cyberbullyingAnalysisState.value = AnalysisUiState.Success(result.data)
                        is Resource.Error -> _cyberbullyingAnalysisState.value = AnalysisUiState.Error(result.message)
                        is Resource.Loading -> _cyberbullyingAnalysisState.value = AnalysisUiState.Loading
                    }
                }
        }
    }
    
    fun setPdfBytes(bytes: ByteArray) { _pdfBytes.value = bytes }
    fun markPdfDownloading() { _pdfDownloadState.value = PdfDownloadUiState.Downloading }
    fun markPdfSuccess() { _pdfDownloadState.value = PdfDownloadUiState.Success }
    fun markPdfError(message: String) { _pdfDownloadState.value = PdfDownloadUiState.Error(message) }

    fun resetDeepfakeAnalysis() {
        _deepfakeAnalysisState.value = AnalysisUiState.Idle
    }

    fun resetCyberbullyingAnalysis() {
        _cyberbullyingAnalysisState.value = AnalysisUiState.Idle
    }

    fun resetPdfDownload() {
        _pdfDownloadState.value = PdfDownloadUiState.Idle
    }
}
```

---

#### ResultViewModel.kt

**ìœ„ì¹˜**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/presentation/viewmodel/ResultViewModel.kt`

**ì—­í• **: ê²°ê³¼ í™”ë©´ PDF ë‹¤ìš´ë¡œë“œ ê´€ë¦¬

```kotlin
package com.ansimtalk.app.presentation.viewmodel

import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.ansimtalk.app.data.model.AnalysisResult
import com.ansimtalk.app.data.model.PdfGenerationResult
import com.ansimtalk.app.data.model.PdfRequestBody
import com.ansimtalk.app.data.model.Resource
import com.ansimtalk.app.domain.usecase.DownloadPdfUseCase
import com.ansimtalk.app.domain.usecase.GeneratePdfUseCase
import com.ansimtalk.app.data.model.PdfDownloadException
import dagger.hilt.android.lifecycle.HiltViewModel
import kotlinx.coroutines.flow.MutableSharedFlow
import kotlinx.coroutines.flow.asSharedFlow
import kotlinx.coroutines.flow.launchIn
import kotlinx.coroutines.flow.onEach
import okhttp3.ResponseBody
import javax.inject.Inject
import kotlinx.coroutines.launch

@HiltViewModel
class ResultViewModel @Inject constructor(
    private val downloadPdfUseCase: DownloadPdfUseCase,
    private val generatePdfUseCase: GeneratePdfUseCase
) : ViewModel() {

    private val _downloadState = MutableSharedFlow<Resource<ResponseBody>>()
    val downloadState = _downloadState.asSharedFlow()

    private val _pdfGenerationState = MutableSharedFlow<PdfGenerationResult>()
    val pdfGenerationState = _pdfGenerationState.asSharedFlow()

    fun downloadPdf(analysisResult: AnalysisResult) {
        val requestBody = PdfRequestBody(
            analysisType = analysisResult.analysisType,
            analysisResult = analysisResult,
            originalImagePath = analysisResult.originalImagePath
        )

        downloadPdfUseCase(requestBody).onEach {
            _downloadState.emit(it)
        }.launchIn(viewModelScope)
    }

    fun generateAndSavePdf(analysisResult: AnalysisResult) {
        val body = PdfRequestBody(
            analysisType = analysisResult.analysisType,
            analysisResult = analysisResult,
            originalImagePath = analysisResult.originalImagePath
        )
        viewModelScope.launch {
            val result = generatePdfUseCase(body)
            _pdfGenerationState.emit(result)
        }
    }
}
```

---

### 18.18. UI States

#### AnalysisUiState.kt

**ìœ„ì¹˜**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/presentation/ui/state/AnalysisUiState.kt`

```kotlin
package com.ansimtalk.app.presentation.ui.state

import com.ansimtalk.app.data.model.AnalysisResult

sealed class AnalysisUiState {
    object Idle : AnalysisUiState()
    object Loading : AnalysisUiState()
    data class Success(val result: AnalysisResult) : AnalysisUiState()
    data class Error(val message: String) : AnalysisUiState()
}
```

---

#### PdfDownloadUiState.kt

**ìœ„ì¹˜**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/presentation/ui/state/PdfDownloadUiState.kt`

```kotlin
package com.ansimtalk.app.presentation.ui.state

sealed class PdfDownloadUiState {
    object Idle : PdfDownloadUiState()
    object Downloading : PdfDownloadUiState()
    object Success : PdfDownloadUiState()
    data class Error(val message: String) : PdfDownloadUiState()
}
```

---

### 18.19. UI Theme

#### Color.kt

**ìœ„ì¹˜**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/presentation/ui/theme/Color.kt`

```kotlin
package com.ansimtalk.app.presentation.ui.theme

import androidx.compose.ui.graphics.Color

// Core palette (web parity)
val Primary800 = Color(0xFF1E40AF)   // Top AppBar
val Primary700 = Color(0xFF1D4ED8)   // Pressed/Hover
val Primary600 = Color(0xFF2563EB)   // CTA buttons

val Surface = Color(0xFFFFFFFF)
val Background = Color(0xFFF8FAFC)
val Border = Color(0xFFEAECF0)
val TextStrong = Color(0xFF101828)
val TextMuted = Color(0xFF475467)

val Success100 = Color(0xFFECFDF3)
val SuccessText = Color(0xFF067647)

// Backward compatible names
val Purple80 = Color(0xFF60A5FA)
val PurpleGrey80 = Color(0xFFA1A1AA)
val Pink80 = Color(0xFF66D47E)

val Purple40 = Primary800
val PurpleGrey40 = Color(0xFF6B7280)
val Pink40 = Color(0xFF34C759)
```

---

#### Theme.kt

**ìœ„ì¹˜**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/presentation/ui/theme/Theme.kt`

```kotlin
package com.ansimtalk.app.presentation.ui.theme

import android.app.Activity
import android.os.Build
import androidx.compose.foundation.isSystemInDarkTheme
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.darkColorScheme
import androidx.compose.material3.dynamicDarkColorScheme
import androidx.compose.material3.dynamicLightColorScheme
import androidx.compose.material3.lightColorScheme
import androidx.compose.material3.Shapes
import androidx.compose.runtime.Composable
import androidx.compose.runtime.SideEffect
import androidx.compose.ui.graphics.toArgb
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.platform.LocalView
import androidx.core.view.WindowCompat
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.ui.unit.dp

private val DarkColorScheme = darkColorScheme(
    primary = Purple80,
    secondary = PurpleGrey80,
    tertiary = Pink80
)

private val LightColorScheme = lightColorScheme(
    primary = Primary600,
    onPrimary = androidx.compose.ui.graphics.Color.White,
    secondary = PurpleGrey40,
    tertiary = Pink40,
    background = Background,
    surface = Surface
)

@Composable
fun AnsimTalkTheme(
    darkTheme: Boolean = isSystemInDarkTheme(),
    dynamicColor: Boolean = false,
    content: @Composable () -> Unit
) {
    val colorScheme = when {
        dynamicColor && Build.VERSION.SDK_INT >= Build.VERSION_CODES.S -> {
            val context = LocalContext.current
            if (darkTheme) dynamicDarkColorScheme(context) else dynamicLightColorScheme(context)
        }

        darkTheme -> DarkColorScheme
        else -> LightColorScheme
    }
    val view = LocalView.current
    if (!view.isInEditMode) {
        SideEffect {
            val window = (view.context as Activity).window
            // StatusBar matches top app bar background (Primary800)
            window.statusBarColor = Primary800.toArgb()
            WindowCompat.getInsetsController(window, view).isAppearanceLightStatusBars = false
        }
    }

    val shapes = Shapes(
        extraSmall = RoundedCornerShape(8.dp),
        small = RoundedCornerShape(12.dp),
        medium = RoundedCornerShape(16.dp),
        large = RoundedCornerShape(20.dp),
        extraLarge = RoundedCornerShape(28.dp)
    )

    MaterialTheme(
        colorScheme = colorScheme,
        typography = Typography,
        shapes = shapes,
        content = content
    )
}
```

---

#### Type.kt

**ìœ„ì¹˜**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/presentation/ui/theme/Type.kt`

```kotlin
package com.ansimtalk.app.presentation.ui.theme

import androidx.compose.material3.Typography
import androidx.compose.ui.text.TextStyle
import androidx.compose.ui.text.font.FontFamily
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.sp

val Typography = Typography(
    bodyLarge = TextStyle(
        fontFamily = FontFamily.Default,
        fontWeight = FontWeight.Medium,
        fontSize = 16.sp,
        lineHeight = 22.sp,
        letterSpacing = 0.sp
    ),
    bodyMedium = TextStyle(
        fontFamily = FontFamily.Default,
        fontWeight = FontWeight.Normal,
        fontSize = 14.sp,
        lineHeight = 20.sp,
        letterSpacing = 0.sp
    ),
    titleLarge = TextStyle(
        fontFamily = FontFamily.Default,
        fontWeight = FontWeight.SemiBold,
        fontSize = 24.sp,
        lineHeight = 30.sp,
        letterSpacing = (-0.2).sp
    ),
    titleMedium = TextStyle(
        fontFamily = FontFamily.Default,
        fontWeight = FontWeight.SemiBold,
        fontSize = 18.sp,
        lineHeight = 24.sp,
        letterSpacing = (-0.1).sp
    ),
    labelLarge = TextStyle(
        fontFamily = FontFamily.Default,
        fontWeight = FontWeight.SemiBold,
        fontSize = 14.sp,
        lineHeight = 18.sp,
        letterSpacing = 0.sp
    )
)
```

---

#### PdfConverter.kt

**ìœ„ì¹˜**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/util/PdfConverter.kt`

```kotlin
package com.ansimtalk.app.util

// ë¹ˆ ê»ë°ê¸° (SDKì˜ package-private ì½œë°± ì œì•½ìœ¼ë¡œ ë¯¸ì‚¬ìš©)
object PdfConverter
```

---

### 18.20. Resources

#### strings.xml

**ìœ„ì¹˜**: `ansimtalk_app/app/src/main/res/values/strings.xml`

```xml
<?xml version="1.0" encoding="utf-8"?>
<resources>
    <string name="app_name">ì•ˆì‹¬í†¡</string>
    
    <!-- ë©”ì¸ í™”ë©´ -->
    <string name="main_title">ì•ˆì‹¬í†¡</string>
    <string name="main_subtitle">AIë¡œ ë””ì§€í„¸ ì¦ê±°ë¥¼ ë¶„ì„í•˜ê³  ì•ˆì „í•˜ê²Œ ì¦ê±°í™”í•˜ì„¸ìš”</string>
    <string name="developers">ê°œë°œì: ìœ¤ì—¬ì¤€íŒ€ì¥, ê¹€íƒœì–‘, ê¹€íƒœì˜</string>
    
    <!-- ë”¥í˜ì´í¬ ë¶„ì„ -->
    <string name="deepfake_title">ë”¥í˜ì´í¬ ë¶„ì„</string>
    <string name="deepfake_description">ì§€ì› íŒŒì¼ í˜•ì‹: PNG, JPG, JPEG (ì´ë¯¸ì§€ íŒŒì¼)</string>
    <string name="select_file">íŒŒì¼ ì„ íƒ</string>
    <string name="no_file_selected">ì„ íƒëœ íŒŒì¼ ì—†ìŒ</string>
    <string name="start_analysis">ë¶„ì„ ì‹œì‘</string>
    <string name="deepfake_help">ë”¥í˜ì´í¬ í”¼í•´ ìƒë‹´/ì‹ ê³  ì•ˆë‚´ â†’</string>
    
    <!-- ì‚¬ì´ë²„í­ë ¥ ë¶„ì„ -->
    <string name="cyberbullying_title">ì‚¬ì´ë²„í­ë ¥ ë¶„ì„</string>
    <string name="cyberbullying_description">ì§€ì› íŒŒì¼ í˜•ì‹: TXT, PNG, JPG, JPEG (í…ìŠ¤íŠ¸ ë˜ëŠ” ì´ë¯¸ì§€ íŒŒì¼)</string>
    <string name="cyberbullying_help">ì‚¬ì´ë²„í­ë ¥ ì‹ ê³  ì•ˆë‚´ â†’</string>
    
    <!-- ë¶„ì„ ê²°ê³¼ -->
    <string name="analysis_result">ë¶„ì„ ê²°ê³¼</string>
    <string name="analysis_in_progress">ë¶„ì„ ì¤‘...</string>
    <string name="analysis_complete">ë¶„ì„ ì™„ë£Œ</string>
    <string name="analysis_failed">ë¶„ì„ ì‹¤íŒ¨</string>
    
    <!-- ì˜¤ë¥˜ ë©”ì‹œì§€ -->
    <string name="error_file_too_large">íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤</string>
    <string name="error_unsupported_format">ì§€ì›ë˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤</string>
    <string name="error_no_file">íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”</string>
    <string name="error_network">ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</string>
    
    <!-- ê¶Œí•œ -->
    <string name="permission_storage_required">ì €ì¥ì†Œ ì ‘ê·¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤</string>
    <string name="permission_camera_required">ì¹´ë©”ë¼ ì ‘ê·¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤</string>
    
    <!-- PDF ë‹¤ìš´ë¡œë“œ -->
    <string name="download_pdf">PDF ë‹¤ìš´ë¡œë“œ</string>
    <string name="pdf_download_success">PDF ë‹¤ìš´ë¡œë“œ ì™„ë£Œ</string>
    <string name="pdf_download_failed">PDF ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨</string>
    
    <!-- ê³µí†µ -->
    <string name="ok">í™•ì¸</string>
    <string name="cancel">ì·¨ì†Œ</string>
    <string name="retry">ë‹¤ì‹œ ì‹œë„</string>
    <string name="close">ë‹«ê¸°</string>
</resources>
```

---

## 19. MainScreen.kt (ë©”ì¸ UI í™”ë©´ - ì „ì²´ ì½”ë“œ 1,518ì¤„)

**ìœ„ì¹˜**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/presentation/ui/screen/MainScreen.kt`

**ì—­í• **: 
- ì „ì²´ ì•±ì˜ ë©”ì¸ í™”ë©´ Composable í•¨ìˆ˜
- íŒŒì¼ ì„ íƒ, ì—…ë¡œë“œ, ë¶„ì„ ê²°ê³¼ í‘œì‹œ, PDF ë‹¤ìš´ë¡œë“œ
- 1,518ì¤„ì˜ ëŒ€í˜• íŒŒì¼ë¡œ ëª¨ë“  UI ë¡œì§ í¬í•¨

**ì£¼ìš” Composable í•¨ìˆ˜**:
- `MainScreen()` - ë©”ì¸ í™”ë©´ ë£¨íŠ¸
- `ResultsScreen()` - ë¶„ì„ ê²°ê³¼ í™”ë©´
- `DeepfakeResultCard()` - ë”¥í˜ì´í¬ ê²°ê³¼ ì¹´ë“œ
- `CyberbullyingResultCard()` - ì‚¬ì´ë²„í­ë ¥ ê²°ê³¼ ì¹´ë“œ
- `RiskLevelCard()` - ìœ„í—˜ë„ ì¹´ë“œ
- `FileInfoSection()` - íŒŒì¼ ì •ë³´ ì„¹ì…˜
- `HeaderSection()` - í—¤ë” ì„¹ì…˜
- `HealthStatusSection()` - API ìƒíƒœ ì„¹ì…˜
- `DeepfakeAnalysisSection()` - ë”¥í˜ì´í¬ ë¶„ì„ ì„¹ì…˜
- `CyberbullyingAnalysisSection()` - ì‚¬ì´ë²„í­ë ¥ ë¶„ì„ ì„¹ì…˜
- ê¸°íƒ€ í—¬í¼ í•¨ìˆ˜ë“¤ (PDF ìƒì„±, íŒŒì¼ ì²˜ë¦¬ ë“±)

**ì „ì²´ ì½”ë“œ (1,518ì¤„):**

```kotlin
package com.ansimtalk.app.presentation.ui.screen

import android.net.Uri
import androidx.activity.compose.rememberLauncherForActivityResult
import androidx.activity.result.contract.ActivityResultContracts
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.background
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.verticalScroll
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.automirrored.filled.ArrowBack
import androidx.compose.material.icons.filled.Info
import androidx.compose.material.icons.filled.OpenInNew
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import androidx.hilt.navigation.compose.hiltViewModel
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.graphics.toArgb
import androidx.compose.runtime.rememberCoroutineScope
import androidx.compose.ui.viewinterop.AndroidView
import androidx.compose.foundation.BorderStroke
import androidx.compose.foundation.shape.CircleShape
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.launch
import kotlinx.coroutines.withContext
import com.ansimtalk.app.data.model.AnalysisResult
import com.ansimtalk.app.presentation.ui.state.AnalysisUiState
import com.ansimtalk.app.presentation.ui.state.PdfDownloadUiState
import com.ansimtalk.app.presentation.viewmodel.MainViewModel
import com.ansimtalk.app.presentation.viewmodel.ResultViewModel
import com.ansimtalk.app.BuildConfig
import okhttp3.MediaType.Companion.toMediaTypeOrNull
import okhttp3.MultipartBody
import okhttp3.RequestBody.Companion.asRequestBody
import java.io.File
import com.google.gson.GsonBuilder
import android.graphics.pdf.PdfDocument
import android.graphics.Canvas
import android.graphics.Paint
import android.text.TextPaint
import android.graphics.Typeface
// WebView ê¸°ë°˜ PDF ìƒì„±/í‘œì‹œëŠ” ì œê±°. ì„œë²„ PDFë§Œ ì‚¬ìš©
 
import android.widget.Toast
import android.content.Intent
import kotlinx.coroutines.flow.collect
import android.content.ContentValues
import android.os.Environment
import android.provider.MediaStore
import android.view.ViewGroup

@Composable
fun MainScreen(
    viewModel: MainViewModel = hiltViewModel()
) {
    val context = LocalContext.current
    val pdfViewModel: ResultViewModel = hiltViewModel()
    // ì˜¤í”„ìŠ¤í¬ë¦° WebView (ë²¡í„° ì¸ì‡„ìš©)
    // ì„œë²„ PDFë§Œ ì‚¬ìš©: ë²¡í„°/ë˜ìŠ¤í„° í´ë°± ê´€ë ¨ ìƒíƒœ ì œê±°
    val scope = rememberCoroutineScope()
    var showResults by remember { mutableStateOf(false) }
    var currentAnalysisType by remember { mutableStateOf<String?>(null) }
    var showErrorDialog by remember { mutableStateOf(false) }
    var errorMessage by remember { mutableStateOf("") }

    val deepfakeState by viewModel.deepfakeAnalysisState.collectAsState()
    val cyberbullyingState by viewModel.cyberbullyingAnalysisState.collectAsState()
    val healthState by viewModel.healthState.collectAsState()
    val pdfState by viewModel.pdfDownloadState.collectAsState()
    val pdfBytes by viewModel.pdfBytes.collectAsState()
    // ì„œë²„ ìš°ì„  PDF ìƒì„± ìƒíƒœ ìˆ˜ì§‘ â†’ ë‹¤ìš´ë¡œë“œ ì €ì¥ ì²˜ë¦¬
    LaunchedEffect(Unit) {
        pdfViewModel.pdfGenerationState.collect { result ->
            when (result) {
                is com.ansimtalk.app.data.model.PdfGenerationResult.Success -> {
                    try {
                        val name = "AnsimTalk_Report_\${System.currentTimeMillis()}.pdf"
                        val uri = when (val data = result.data) {
                            is okhttp3.ResponseBody -> savePdfToEvidence(context, data.bytes(), name)
                            is java.io.File -> {
                                val u = savePdfToEvidence(context, data.readBytes(), name)
                                kotlin.runCatching { data.delete() }
                                u
                            }
                            else -> null
                        }
                        if (uri != null) {
                            openPdf(context, uri)
                        } else {
                            Toast.makeText(context, "PDF ì €ì¥ ì‹¤íŒ¨", Toast.LENGTH_LONG).show()
                        }
                    } catch (e: Exception) {
                        Toast.makeText(context, "PDF ì €ì¥ ì‹¤íŒ¨: \${e.message}", Toast.LENGTH_LONG).show()
                    }
                }
                is com.ansimtalk.app.data.model.PdfGenerationResult.Failure -> {
                    val err = result.error
                    val msg = when (err) {
                        is com.ansimtalk.app.data.model.PdfDownloadException -> when (err.kind) {
                            com.ansimtalk.app.data.model.PdfDownloadException.Kind.Network -> "ì„œë²„ ì—°ê²° ì‹¤íŒ¨(ë„¤íŠ¸ì›Œí¬/íƒ€ì„ì•„ì›ƒ)"
                            com.ansimtalk.app.data.model.PdfDownloadException.Kind.Http4xx -> "ìš”ì²­ ì˜¤ë¥˜(\${err.httpCode}): \${err.serverMessage ?: "ê²€ì¦ ì‹¤íŒ¨"}"
                            com.ansimtalk.app.data.model.PdfDownloadException.Kind.Http5xx -> "ì„œë²„ ì˜¤ë¥˜(\${err.httpCode}): \${err.serverMessage ?: "ì„œë²„ ë‚´ë¶€ ì˜¤ë¥˜"}"
                            com.ansimtalk.app.data.model.PdfDownloadException.Kind.EmptyBody -> "ì„œë²„ ì‘ë‹µì´ ë¹„ì—ˆìŠµë‹ˆë‹¤"
                            com.ansimtalk.app.data.model.PdfDownloadException.Kind.Unexpected -> "ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜"
                        }
                        else -> err.message ?: "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"
                    }
                    Toast.makeText(context, msg, Toast.LENGTH_LONG).show()
                }
            }
        }
    }

    // PDF ìƒíƒœ ë³€í™”ëŠ” ì–´ëŠ í™”ë©´ì—ì„œë“  íŒŒì¼ ì €ì¥/ì—´ê¸°ë¡œ ì´ì–´ì§€ë„ë¡ ì „ì—­ì—ì„œ ê´€ì°°
    LaunchedEffect(pdfState) {
        if (pdfState is PdfDownloadUiState.Success && pdfBytes != null) {
            try {
                val name = "AnsimTalk_Report_\${System.currentTimeMillis()}.pdf"
                savePdfToEvidence(context, pdfBytes!!, name)?.let { openPdf(context, it) }
            } catch (e: Exception) {
                errorMessage = "PDF ì—´ê¸° ì‹¤íŒ¨: \${e.message}"
                showErrorDialog = true
            }
        }
    }

    LaunchedEffect(Unit) {
        try {
            viewModel.checkHealth()
        } catch (e: Exception) {
            errorMessage = "API ìƒíƒœ í™•ì¸ ì‹¤íŒ¨: \${e.message}"
            showErrorDialog = true
        }
    }

    val fileLauncher = rememberLauncherForActivityResult(
        contract = ActivityResultContracts.GetContent()
    ) { uri: Uri? ->
        uri?.let { selectedUri ->
            try {
                val filePart = prepareMultipartFromUri(context, selectedUri)

                currentAnalysisType?.let { type ->
                    when (type) {
                        "deepfake" -> viewModel.analyzeDeepfake(filePart)
                        "cyberbullying" -> viewModel.analyzeCyberbullying(filePart)
                    }
                }
            } catch (e: Exception) {
                errorMessage = "íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜: \${e.message}"
                showErrorDialog = true
            }
        }
    }

    if (showErrorDialog) {
        AlertDialog(
            onDismissRequest = { showErrorDialog = false },
            title = { Text("ì˜¤ë¥˜") },
            text = { Text(errorMessage) },
            confirmButton = {
                TextButton(onClick = { showErrorDialog = false }) {
                    Text("í™•ì¸")
                }
            }
        )
    }

    val shouldShowResults = (deepfakeState is AnalysisUiState.Success || cyberbullyingState is AnalysisUiState.Success)

    if (shouldShowResults && showResults) {
        ResultsScreen(
            deepfakeState = deepfakeState,
            cyberbullyingState = cyberbullyingState,
            onBackToMain = { showResults = false },
            onDownloadPdf = {
                // ì„œë²„ ìš°ì„  ê²½ë¡œë¡œ ìƒì„± (ì‹¤íŒ¨ ì‹œ ë¦¬í¬ì§€í† ë¦¬ì—ì„œ í…ìŠ¤íŠ¸ PDF í´ë°±)
                val ar = (deepfakeState as? AnalysisUiState.Success)?.result
                    ?: (cyberbullyingState as? AnalysisUiState.Success)?.result
                if (ar != null) pdfViewModel.generateAndSavePdf(ar)
                else Toast.makeText(context, "ë¨¼ì € ë¶„ì„ì„ ì™„ë£Œí•˜ì„¸ìš”.", Toast.LENGTH_SHORT).show()
            },
            onReset = {
                try {
                    viewModel.resetDeepfakeAnalysis()
                    viewModel.resetCyberbullyingAnalysis()
                    showResults = false
                } catch (e: Exception) {
                    errorMessage = "ë¦¬ì…‹ ì‹¤íŒ¨: \${e.message}"
                    showErrorDialog = true
                }
            }
        )
        // PDF ì„±ê³µ ì‹œ ì €ì¥/ì—´ê¸°
        LaunchedEffect(pdfState) {
            if (pdfState is PdfDownloadUiState.Success && pdfBytes != null) {
                try {
                    val name = "AnsimTalk_Report_\${System.currentTimeMillis()}.pdf"
                    savePdfToEvidence(context, pdfBytes!!, name)?.let { openPdf(context, it) }
                } catch (e: Exception) {
                    errorMessage = "PDF ì—´ê¸° ì‹¤íŒ¨: \${e.message}"
                    showErrorDialog = true
                }
            }
        }
    } else {
        Column(
            modifier = Modifier
                .fillMaxSize()
                .padding(16.dp)
                .verticalScroll(rememberScrollState()),
            horizontalAlignment = Alignment.CenterHorizontally
        ) {
            HeaderSection()

            Spacer(modifier = Modifier.height(32.dp))

            HealthStatusSection(healthState = healthState)

            Spacer(modifier = Modifier.height(24.dp))

            DeepfakeAnalysisSection(
                state = deepfakeState,
                onAnalyzeClick = {
                    currentAnalysisType = "deepfake"
                    fileLauncher.launch("image/*")
                },
                onReset = {
                    try {
                        viewModel.resetDeepfakeAnalysis()
                    } catch (e: Exception) {
                        errorMessage = "ë¦¬ì…‹ ì‹¤íŒ¨: \${e.message}"
                        showErrorDialog = true
                    }
                }
            )

            Spacer(modifier = Modifier.height(24.dp))

            CyberbullyingAnalysisSection(
                state = cyberbullyingState,
                onAnalyzeClick = {
                    currentAnalysisType = "cyberbullying"
                    fileLauncher.launch("image/*")
                },
                onReset = {
                    try {
                        viewModel.resetCyberbullyingAnalysis()
                    } catch (e: Exception) {
                        errorMessage = "ë¦¬ì…‹ ì‹¤íŒ¨: \${e.message}"
                        showErrorDialog = true
                    }
                }
            )

            Spacer(modifier = Modifier.height(24.dp))

            if (shouldShowResults) {
                Button(
                    onClick = { showResults = true },
                    modifier = Modifier.fillMaxWidth(),
                    colors = ButtonDefaults.buttonColors(
                        containerColor = com.ansimtalk.app.presentation.ui.theme.Primary600,
                        contentColor = Color.White
                    )
                ) {
                    Text("ë¶„ì„ ê²°ê³¼ ë³´ê¸°", color = Color.White, fontSize = 16.sp)
                }
            }
        }
    }
}

// ì„œë²„ì˜ services.generate_report_htmlì™€ ë™ì¼í•œ êµ¬ì¡°/ìŠ¤íƒ€ì¼ì„ ìµœëŒ€í•œ ë°˜ì˜í•œ HTML ìƒì„±
private fun buildHtmlReport(
    context: android.content.Context,
    deepfakeState: AnalysisUiState,
    cyberbullyingState: AnalysisUiState
): String {
    val isDeepfake = deepfakeState is AnalysisUiState.Success
    val result = when {
        deepfakeState is AnalysisUiState.Success -> deepfakeState.result
        cyberbullyingState is AnalysisUiState.Success -> cyberbullyingState.result
        else -> null
    }
    val analysisType = when {
        deepfakeState is AnalysisUiState.Success -> "deepfake"
        cyberbullyingState is AnalysisUiState.Success -> "cyberbullying"
        else -> "N/A"
    }

    val reportId = "DF-CB-\${java.time.LocalDate.now()}-001-v1.0"
    val createdAt = java.time.LocalDateTime.now().toString().replace('T', ' ')

    val filename = result?.fileInfo?.filename ?: "N/A"
    val sizeBytes = result?.fileInfo?.sizeBytes?.toString() ?: "N/A"
    val sha256 = result?.sha256 ?: "N/A"
    val uploadTs = result?.analysisTimestamp ?: createdAt

    val imageHtml = "" // ì•±ì—ì„œëŠ” ì›ë³¸ ì´ë¯¸ì§€ ê²½ë¡œ í™•ë³´ê°€ ì–´ë ¤ì›Œ ì„œë²„ì™€ ë™ì¼í•œ í”Œë ˆì´ìŠ¤í™€ë” ì‚¬ìš©
    val extractedText = result?.extractedText ?: ""
    val cbHtml = result?.cyberbullyingAnalysis ?: ""
    val cbSummary = result?.cyberbullyingAnalysisSummary?.replace("\n", "<br>") ?: ""
    val cbRisk = result?.cyberbullyingRiskLine ?: "N/A"
    val deepfakeProb = result?.deepfakeAnalysis?.type?.deepfake ?: 0.0

    return \"\"\"
    <!DOCTYPE html>
    <html lang=\"ko\">
    <head>
        <meta charset=\"UTF-8\" />
        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />
        <title>ì•ˆì‹¬í†¡ ë””ì§€í„¸ ì¦ê±° ë¶„ì„ ë³´ê³ ì„œ</title>
        <style>
            body { font-family: 'Noto Sans KR', 'Malgun Gothic', Arial, sans-serif; margin: 40px; line-height: 1.6; color: #333; }
            h1, h2, h3 { color: #1976d2; margin-top: 30px; margin-bottom: 15px; }
            table { border-collapse: collapse; width: 100%; margin: 15px 0; font-size: 12px; }
            th, td { border: 1px solid #ddd; padding: 8px 12px; text-align: left; }
            th { background: #f8f9fa; color: #495057; }
            .analysis-result { background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; padding: 15px; margin: 15px 0; font-weight: bold; color: #856404; }
            .box { background: #f0f4ff; border-left: 4px solid #1976d2; border-radius: 8px; padding: 15px; margin: 15px 0; }
            .extracted-text { background:#f8f9fa; border:1px solid #e9ecef; border-radius:4px; padding:15px; margin:15px 0; font-family: Consolas, Monaco, monospace; font-size:11px; white-space:pre-wrap; }
            .analysis-table { border-collapse: collapse; width: 100%; font-size: 11px; }
            .analysis-table th, .analysis-table td { border: 1px solid #ddd; padding: 6px 8px; vertical-align: top; }
            .risk-none { color: #28a745; font-weight: bold; }
            .risk-severe { color: #dc3545; font-weight: bold; }
            #report-footer { font-size: 10px; color: #888; text-align: right; width: 100%; border-top: 1px solid #eee; padding-top: 10px; position: fixed; bottom: 20px; right: 40px; }
        </style>
    </head>
    <body>
        <div id=\"report-footer\">ë³´ê³ ì„œID: $reportId | ìƒì„±ì¼ì‹œ: $createdAt | í”Œë«í¼: ì•ˆì‹¬í†¡ AI í¬ë Œì‹ ë¶„ì„ ì‹œìŠ¤í…œ v1.0 | ë°°í¬ì¼: 2025-07-18</div>
        <h1>ì•ˆì‹¬í†¡ ë””ì§€í„¸ ì¦ê±° ë¶„ì„ ë³´ê³ ì„œ</h1>
        <div class=\"section\">
            <h2>1. ê¸°ë³¸ ì •ë³´</h2>
            <table>
                <tr><th>ë³´ê³ ì„œ ID</th><td>$reportId</td></tr>
                <tr><th>ìƒì„±ì¼ì‹œ</th><td>$createdAt</td></tr>
                <tr><th>ë¶„ì„ ìœ í˜•</th><td>$analysisType</td></tr>
                <tr><th>ë¶„ì„ ì‹œìŠ¤í…œ</th><td>ì•ˆì‹¬í†¡ AI í¬ë Œì‹ ë¶„ì„ ì‹œìŠ¤í…œ v1.0</td></tr>
            </table>
        </div>
        <div class=\"section\">
            <h2>2. ë¶„ì„ì— ì‚¬ìš©ëœ AI ëª¨ë¸ ì „ì²´ ëª©ë¡</h2>
            <table>
                <thead><tr><th>ë¶„ì„ ì‘ì—…</th><th>AI ëª¨ë¸</th><th>ë²„ì „</th><th>ì •í™•ë„</th></tr></thead>
                <tbody>
                    <tr><td>ë”¥í˜ì´í¬ íƒì§€</td><td>Sightengine Deepfake Detector</td><td>v1.0</td><td>98.2%</td></tr>
                    <tr><td>ì‚¬ì´ë²„í­ë ¥ ë¶„ì„</td><td>Google Gemini 2.5 Flash</td><td>v1.0</td><td>94.5%</td></tr>
                    <tr><td>OCR í…ìŠ¤íŠ¸ ì¶”ì¶œ</td><td>Google Cloud Vision API</td><td>v1.0</td><td>99.1%</td></tr>
                </tbody>
            </table>
        </div>
        <div class=\"section\">
            <h2>3. ë¶„ì„ ê²°ê³¼ ìš”ì•½</h2>
            <div class=\"analysis-result\">\${if (isDeepfake) "ë”¥í˜ì´í¬ ë¶„ì„ ê²°ê³¼ ìš”ì•½:<br>ë”¥í˜ì´í¬ì¼ í™•ë¥ : \${String.format("%.1f%%", deepfakeProb*100)}" else "ì‚¬ì´ë²„í­ë ¥ ë¶„ì„ ê²°ê³¼ ìš”ì•½:<br>ì „ì²´ ëŒ€í™” ì‚¬ì´ë²„í­ë ¥ ìœ„í—˜ë„: $cbRisk"}</div>
        </div>
        <div class=\"section\">
            <h2>4. ì¦ê±° íŒŒì¼ ì •ë³´</h2>
            <div class=\"metadata-item\"><b>íŒŒì¼ëª…:</b> $filename</div>
            <div class=\"metadata-item\"><b>íŒŒì¼ ìœ í˜•:</b> $analysisType</div>
            <div class=\"metadata-item\"><b>íŒŒì¼ í¬ê¸°:</b> $sizeBytes Bytes</div>
            <div class=\"metadata-item\"><b>ì—…ë¡œë“œ ì¼ì‹œ:</b> $uploadTs</div>
            <div class=\"metadata-item\"><b>ì—…ë¡œë” ID:</b> <span style=\"background:#f5f5f5;border:1px solid #ddd;padding:3px 6px;border-radius:4px;\">ANSiMTALK_USER</span></div>
            <div class=\"metadata-item\"><b>ì—…ë¡œë“œ IP:</b> 100.64.0.3</div>
            <div class=\"metadata-item\"><b>ì›ë³¸ í•´ì‹œê°’ (SHA-256):</b> <span style=\"background:#f5f5f5;border:1px solid #ddd;padding:3px 6px;border-radius:4px;\">$sha256</span></div>
        </div>
        <div class=\"section\">
            <h2>ì›ë³¸ íŒŒì¼ ë©”íƒ€ë°ì´í„°</h2>
            <div class=\"metadata-item\"><b>íŒŒì¼ í˜•ì‹:</b> \${result?.fileInfo?.type?.uppercase() ?: "N/A"}</div>
            <div class=\"metadata-item\"><b>ë¶„ì„ íƒ€ì…:</b> $analysisType</div>
            <div class=\"metadata-item\"><b>ë¶„ì„ íƒ€ì„ìŠ¤íƒ¬í”„:</b> \${result?.analysisTimestamp ?: createdAt}</div>
            <div class=\"metadata-item\"><b>íŒŒì¼ í¬ê¸° (ë°”ì´íŠ¸):</b> $sizeBytes bytes</div>
        </div>
        <div class=\"section\">
            <h2>5. ì—°ê³„ ë³´ê´€ì„± (Chain of Custody)</h2>
            <table>
                <thead><tr><th>ë‹¨ê³„</th><th>ì‹œê°</th><th>ì„œë²„/AI ì •ë³´</th></tr></thead>
                <tbody>
                    <tr><td>íŒŒì¼ ì—…ë¡œë“œ</td><td>$uploadTs</td><td>ì•ˆì‹¬í†¡ ì„œë²„</td></tr>
                    <tr><td>í•´ì‹œê°’ ê³„ì‚°</td><td>$uploadTs</td><td>SHA-256</td></tr>
                    <tr><td>AI ë¶„ì„</td><td>$uploadTs</td><td>AI ì„œë²„ (Gemini 2.5 Flash v1.0)</td></tr>
                    <tr><td>ê²°ê³¼ ìƒì„±</td><td>$uploadTs</td><td>ë³´ê³ ì„œ ìƒì„± ì„œë²„</td></tr>
                </tbody>
            </table>
        </div>
        <div class=\"section\">
            <h2>6. AI ë¶„ì„ ê²°ê³¼</h2>
            \${if (isDeepfake) \"\"\"
            <h3>ë”¥í˜ì´í¬ ë¶„ì„ ê²°ê³¼(Sightengine):</h3>
            <div class=\"analysis-result\">ë”¥í˜ì´í¬ì¼ í™•ë¥ : \${String.format("%.1f%%", deepfakeProb*100)}</div>
            <h3>ìƒì„¸ ë¶„ì„ ê²°ê³¼:</h3>
            <div class=\"box\"><pre style=\"white-space:pre-wrap;font-family:'Noto Sans KR',sans-serif;font-size:12px;\">\${result?.deepfakeAnalysis?.let { GsonBuilder().setPrettyPrinting().create().toJson(it) } ?: "ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤."}</pre></div>
            \"\"\" else \"\"\"
            <h3>ì¶”ì¶œ í…ìŠ¤íŠ¸(OCR):</h3>
            <div class=\"extracted-text\">$extractedText</div>
            <h3>ì‚¬ì´ë²„í­ë ¥ ë¶„ì„ ê²°ê³¼(Gemini):</h3>
            <div class=\"analysis-result\">ì „ì²´ ëŒ€í™” ì‚¬ì´ë²„í­ë ¥ ìœ„í—˜ë„: $cbRisk</div>
            <h3>ìƒì„¸ ë¶„ì„ ê²°ê³¼:</h3>
            <div class=\"box\">\${if (cbHtml.isNotBlank()) cbHtml else "ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤."}</div>
            <h3>ì „ì²´ ë¶„ì„ ìš”ì•½:</h3>
            <div class=\"box\" style=\"background:#f8f9fa;border-left:4px solid #28a745;\">$cbSummary</div>
            \"\"\"}
        </div>
        <div class=\"section\">
            <h2>7. ì›ë³¸ ì¦ê±° ì´ë¯¸ì§€</h2>
            <div style=\"background:#f8f9fa;border:2px dashed #dee2e6;padding:20px;text-align:center;color:#6c757d;\">
                <p><strong>ì›ë³¸ ì´ë¯¸ì§€</strong></p>
                <p>ì•± ë‚´ ë¡œì»¬ ê²½ë¡œ ì œì•½ìœ¼ë¡œ ë¯¸í‘œì‹œ</p>
            </div>
            <div style=\"color:#1976d2;font-size:12px;margin-top:10px;\">* ìœ„ ì´ë¯¸ì§€ëŠ” ë¶„ì„ ëŒ€ìƒ ì›ë³¸ ì¦ê±°ë¬¼ì…ë‹ˆë‹¤.</div>
        </div>
        <div class=\"section\">
            <h2>8. ë¬´ê²°ì„± ë° ë²•ì  ê²€ì¦</h2>
            <ul>
                <li><b>ì›ë³¸(ì´ë¯¸ì§€) í•´ì‹œê°’:</b> <span style=\"background:#f5f5f5;border:1px solid #ddd;padding:3px 6px;border-radius:4px;\">$sha256</span></li>
                <br>
                <li><b>ë²•ì  ì±…ì„ ì„ ì–¸:</b> ë³¸ ë³´ê³ ì„œëŠ” AI ê¸°ë°˜ ë¶„ì„ ê²°ê³¼ë¥¼ ì œê³µí•˜ë©° ë²•ë¥  ì „ë¬¸ê°€ì˜ íŒë‹¨ì„ ëŒ€ì²´í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë³´ê³ ì„œ ë‚´ìš©ì€ ì°¸ê³  ìë£Œë¡œë§Œ ì‚¬ìš©ë˜ì–´ì•¼ í•˜ë©° ë²•ì  ì±…ì„ì„ ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤. ì •í™•í•œ ë²•ì  ì¡°ì¹˜ë‚˜ ìƒë‹´ì„ ìœ„í•´ì„œëŠ” ë³€í˜¸ì‚¬ë‚˜ ê´€ë ¨ ê¸°ê´€ì— ë¬¸ì˜í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.</li>
            </ul>
        </div>
    </body>
    </html>
    \"\"\".trimIndent()
}

// ë²¡í„°/ì˜¤í”„ìŠ¤í¬ë¦° WebView ê´€ë ¨ ë¡œì§ ì œê±°: ì„œë²„ PDFë§Œ ì‚¬ìš©

// WebView + PrintDocumentAdapter ê¸°ë°˜ ê³ í’ˆì§ˆ PDF ìƒì„± (ë¬´ìŒ ì¸ì‡„, A4 600dpi)
// (í”„ë¦°íŠ¸ í”„ë ˆì„ì›Œí¬ ë°©ì‹ì€ ë¦¬í¬ì§€í† ë¦¬ êµ¬í˜„ì—ì„œ ì‚¬ìš©. ì´ íŒŒì¼ì—ì„œëŠ” ì œê±°)

private fun savePdfToEvidence(context: android.content.Context, bytes: ByteArray, displayName: String): android.net.Uri? {
    // Android 10+ (scoped storage): Downloads/AnsimTalkEvidence
    val relativePath = Environment.DIRECTORY_DOWNLOADS + "/AnsimTalkEvidence"
    val values = ContentValues().apply {
        put(MediaStore.MediaColumns.DISPLAY_NAME, displayName)
        put(MediaStore.MediaColumns.MIME_TYPE, "application/pdf")
        put(MediaStore.MediaColumns.RELATIVE_PATH, relativePath)
    }
    val resolver = context.contentResolver
    val uri = resolver.insert(MediaStore.Downloads.EXTERNAL_CONTENT_URI, values) ?: return null
    resolver.openOutputStream(uri)?.use { out ->
        out.write(bytes)
        out.flush()
    }
    return uri
}

private fun openPdf(context: android.content.Context, uri: android.net.Uri) {
    try {
        val intent = android.content.Intent(android.content.Intent.ACTION_VIEW).apply {
            setDataAndType(uri, "application/pdf")
            addFlags(android.content.Intent.FLAG_GRANT_READ_URI_PERMISSION)
        }
        context.startActivity(intent)
    } catch (e: Exception) {
        Toast.makeText(context, "PDF ì—´ê¸° ì•±ì´ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ì€ Downloads/AnsimTalkEvidenceì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.", Toast.LENGTH_LONG).show()
    }
}

// ë¡œì»¬ HTMLâ†’PDF (WebView) ì œê±°: ì„œë²„ PDFë§Œ ì‚¬ìš©

@Composable
fun ResultsScreen(
    deepfakeState: AnalysisUiState,
    cyberbullyingState: AnalysisUiState,
    onBackToMain: () -> Unit,
    onDownloadPdf: () -> Unit,
    onReset: () -> Unit
) {
    Column(
        modifier = Modifier
            .fillMaxSize()
            .padding(16.dp)
            .verticalScroll(rememberScrollState()),
        horizontalAlignment = Alignment.CenterHorizontally
    ) {
        Row(
            modifier = Modifier.fillMaxWidth(),
            horizontalArrangement = Arrangement.SpaceBetween,
            verticalAlignment = Alignment.CenterVertically
        ) {
            IconButton(onClick = onBackToMain) {
                Icon(
                    imageVector = Icons.AutoMirrored.Filled.ArrowBack,
                    contentDescription = "ë’¤ë¡œ ê°€ê¸°"
                )
            }
            Text(
                text = "ë¶„ì„ ê²°ê³¼",
                fontSize = 24.sp,
                fontWeight = FontWeight.Bold,
                color = MaterialTheme.colorScheme.primary
            )
            Spacer(modifier = Modifier.width(48.dp))
        }

        Spacer(modifier = Modifier.height(24.dp))

        if (deepfakeState is AnalysisUiState.Success) {
            DeepfakeResultCard(result = deepfakeState.result)
            Spacer(modifier = Modifier.height(16.dp))
        }

        if (cyberbullyingState is AnalysisUiState.Success) {
            CyberbullyingResultCard(result = cyberbullyingState.result)
            Spacer(modifier = Modifier.height(16.dp))
        }

        // ì‹ ê³  ì•ˆë‚´ ë§í¬ ë²„íŠ¼ (ê²°ê³¼ í™”ë©´) - í•´ë‹¹ ë¶„ì„ ì¢…ë¥˜ì— ë§ëŠ” ë²„íŠ¼ë§Œ í‘œì‹œ
        val ctx = LocalContext.current
        val hasDeepfake = deepfakeState is AnalysisUiState.Success
        val hasCyber = cyberbullyingState is AnalysisUiState.Success
        if (hasDeepfake || hasCyber) {
            if (hasDeepfake) {
                Button(
                    onClick = {
                        val url = "\${BuildConfig.BASE_URL}/deepfake_help"
                        val intent = Intent(Intent.ACTION_VIEW, android.net.Uri.parse(url))
                        ctx.startActivity(intent)
                    },
                    modifier = Modifier.fillMaxWidth(),
                    colors = ButtonDefaults.buttonColors(containerColor = MaterialTheme.colorScheme.primary)
                ) {
                    Text("ë”¥í˜ì´í¬ í”¼í•´ ìƒë‹´/ì‹ ê³  ì•ˆë‚´ â†’", color = MaterialTheme.colorScheme.onPrimary)
                }
            } else if (hasCyber) {
                Button(
                    onClick = {
                        val url = "\${BuildConfig.BASE_URL}/cyberbullying_help"
                        val intent = Intent(Intent.ACTION_VIEW, android.net.Uri.parse(url))
                        ctx.startActivity(intent)
                    },
                    modifier = Modifier.fillMaxWidth(),
                    colors = ButtonDefaults.buttonColors(containerColor = MaterialTheme.colorScheme.primary)
                ) {
                    Text("ì‚¬ì´ë²„í­ë ¥ ì‹ ê³  ì•ˆë‚´ â†’", color = MaterialTheme.colorScheme.onPrimary)
                }
            }
            Spacer(modifier = Modifier.height(12.dp))
        }
        

        Row(
            modifier = Modifier.fillMaxWidth(),
            horizontalArrangement = Arrangement.spacedBy(8.dp)
        ) {
            Button(
                onClick = onDownloadPdf,
                modifier = Modifier.weight(1f),
                colors = ButtonDefaults.buttonColors(
                    containerColor = com.ansimtalk.app.presentation.ui.theme.Primary600
                )
            ) {
                Text("ì¦ê±° ë³´ê³ ì„œ(PDF) ë‹¤ìš´ë¡œë“œ", color = Color.White, fontSize = 16.sp)
            }

            OutlinedButton(
                onClick = onReset,
                modifier = Modifier.weight(1f),
                border = BorderStroke(1.dp, com.ansimtalk.app.presentation.ui.theme.Border),
                colors = ButtonDefaults.outlinedButtonColors(
                    contentColor = com.ansimtalk.app.presentation.ui.theme.TextStrong
                )
            ) {
                Text("ìƒˆë¡œìš´ ë¶„ì„ ì‹œì‘", fontSize = 16.sp)
            }
        }
    }
}

@Composable
fun DeepfakeResultCard(result: AnalysisResult) {
    val gson = remember { GsonBuilder().setPrettyPrinting().create() }

    Card(
        modifier = Modifier.fillMaxWidth(),
        colors = CardDefaults.cardColors(
            containerColor = MaterialTheme.colorScheme.surface
        ),
        border = BorderStroke(1.dp, com.ansimtalk.app.presentation.ui.theme.Border),
        elevation = CardDefaults.cardElevation(defaultElevation = 1.dp)
    ) {
        Column(
            modifier = Modifier.padding(16.dp)
        ) {
            Text(
                text = "AI ë”¥í˜ì´í¬ ë¶„ì„ ìš”ì•½",
                fontSize = 20.sp,
                fontWeight = FontWeight.Bold,
                color = MaterialTheme.colorScheme.onPrimaryContainer
            )
            Spacer(modifier = Modifier.height(16.dp))

            FileInfoSection(result = result)
            Spacer(modifier = Modifier.height(16.dp))

            result.deepfakeAnalysis?.let { analysis ->
                if (analysis.error == null) {
                    Row(
                        modifier = Modifier.fillMaxWidth(),
                        horizontalArrangement = Arrangement.SpaceBetween
                    ) {
                        Text(
                            text = "ë”¥í˜ì´í¬ì¼ í™•ë¥ :",
                            style = MaterialTheme.typography.bodyMedium,
                            color = MaterialTheme.colorScheme.onPrimaryContainer
                        )
                        Text(
                            text = "\${String.format("%.1f", (analysis.type?.deepfake ?: 0.0) * 100)}%",
                            style = MaterialTheme.typography.bodyMedium,
                            fontWeight = FontWeight.Bold,
                            color = MaterialTheme.colorScheme.error
                        )
                    }
                    Spacer(modifier = Modifier.height(8.dp))

                    Row(
                        modifier = Modifier.fillMaxWidth(),
                        horizontalArrangement = Arrangement.SpaceBetween
                    ) {
                        Text(
                            text = "ìœ í•´ì„± ì ìˆ˜:",
                            style = MaterialTheme.typography.bodyMedium,
                            color = MaterialTheme.colorScheme.onPrimaryContainer
                        )
                        Text(
                            text = "\${String.format("%.1f", (analysis.offensive?.prob ?: 0.0) * 100)}%",
                            style = MaterialTheme.typography.bodyMedium,
                            fontWeight = FontWeight.Bold,
                            color = MaterialTheme.colorScheme.error
                        )
                    }
                    Spacer(modifier = Modifier.height(8.dp))

                    Row(
                        modifier = Modifier.fillMaxWidth(),
                        horizontalArrangement = Arrangement.SpaceBetween
                    ) {
                        Text(
                            text = "ë…¸ì¶œ ì ìˆ˜:",
                            style = MaterialTheme.typography.bodyMedium,
                            color = MaterialTheme.colorScheme.onPrimaryContainer
                        )
                        Text(
                            text = "\${String.format("%.1f", (analysis.nudity?.raw ?: 0.0) * 100)}%",
                            style = MaterialTheme.typography.bodyMedium,
                            fontWeight = FontWeight.Bold,
                            color = MaterialTheme.colorScheme.error
                        )
                    }
                    Spacer(modifier = Modifier.height(16.dp))

                    Text(
                        text = "ìƒì„¸ ë¶„ì„ ê²°ê³¼ (Raw Data):",
                        fontSize = 16.sp,
                        fontWeight = FontWeight.Bold,
                        color = MaterialTheme.colorScheme.onPrimaryContainer
                    )
                    Spacer(modifier = Modifier.height(8.dp))
                    Card(
                        colors = CardDefaults.cardColors(
                            containerColor = MaterialTheme.colorScheme.surface
                        )
                    ) {
                        Text(
                            text = gson.toJson(result.deepfakeAnalysis),
                            style = MaterialTheme.typography.bodySmall,
                            modifier = Modifier.padding(12.dp),
                            color = MaterialTheme.colorScheme.onSurface
                        )
                    }
                } else {
                    Text(
                        text = "ì˜¤ë¥˜: \${analysis.error}",
                        color = MaterialTheme.colorScheme.error,
                        style = MaterialTheme.typography.bodyMedium
                    )
                }
            }
        }
    }
}

@Composable
fun CyberbullyingResultCard(result: AnalysisResult) {
    Card(
        modifier = Modifier.fillMaxWidth(),
        colors = CardDefaults.cardColors(
            containerColor = MaterialTheme.colorScheme.surface
        ),
        border = BorderStroke(1.dp, com.ansimtalk.app.presentation.ui.theme.Border),
        elevation = CardDefaults.cardElevation(defaultElevation = 1.dp)
    ) {
        Column(
            modifier = Modifier.padding(16.dp)
        ) {
            Text(
                text = "AI ëŒ€í™” ë‚´ìš© ë¶„ì„ ìš”ì•½",
                fontSize = 20.sp,
                fontWeight = FontWeight.Bold,
                color = MaterialTheme.colorScheme.onSurface
            )
            Spacer(modifier = Modifier.height(16.dp))

            FileInfoSection(result = result)
            Spacer(modifier = Modifier.height(16.dp))

            RiskLevelCard(result = result)
            Spacer(modifier = Modifier.height(16.dp))

            result.extractedText?.let { extractedText ->
                Text(
                    text = "ì´ë¯¸ì§€ ì† ì¶”ì¶œ í…ìŠ¤íŠ¸:",
                    fontSize = 16.sp,
                    fontWeight = FontWeight.Bold,
                    color = MaterialTheme.colorScheme.onSurface
                )
                Spacer(modifier = Modifier.height(8.dp))
                Card(
                    colors = CardDefaults.cardColors(
                        containerColor = MaterialTheme.colorScheme.surface
                    )
                ) {
                    Text(
                        text = extractedText,
                        style = MaterialTheme.typography.bodyMedium,
                        modifier = Modifier.padding(12.dp),
                        color = MaterialTheme.colorScheme.onSurface
                    )
                }
                Spacer(modifier = Modifier.height(16.dp))
            }

            result.cyberbullyingAnalysis?.let { analysis ->
                Text(
                    text = "ì‚¬ì´ë²„í­ë ¥ ë¶„ì„ ê²°ê³¼(Gemini):",
                    fontSize = 16.sp,
                    fontWeight = FontWeight.Bold,
                    color = MaterialTheme.colorScheme.onSurface
                )
                Spacer(modifier = Modifier.height(8.dp))
                HtmlTable(html = analysis)
            }

            result.cyberbullyingAnalysisSummary?.let { summary ->
                Spacer(modifier = Modifier.height(16.dp))
                Text(
                    text = "ì „ì²´ ë¶„ì„ ìš”ì•½:",
                    fontSize = 16.sp,
                    fontWeight = FontWeight.Bold,
                    color = MaterialTheme.colorScheme.onSurface
                )
                Spacer(modifier = Modifier.height(8.dp))
                Card(
                    colors = CardDefaults.cardColors(
                        containerColor = MaterialTheme.colorScheme.surfaceVariant
                    )
                ) {
                    Text(
                        text = summary,
                        style = MaterialTheme.typography.bodyMedium,
                        modifier = Modifier.padding(12.dp),
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )
                }
            }

            if (result.cyberbullyingAnalysis == null) {
                Text(
                    text = "ì‚¬ì´ë²„í­ë ¥ ë¶„ì„ ê²°ê³¼ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.",
                    color = MaterialTheme.colorScheme.error,
                    style = MaterialTheme.typography.bodyMedium
                )
            }
        }
    }
}

@Composable
private fun HtmlTable(html: String) {
    val background = MaterialTheme.colorScheme.surface
    AndroidView(
        factory = { context ->
            android.webkit.WebView(context).apply {
                layoutParams = ViewGroup.LayoutParams(
                    ViewGroup.LayoutParams.MATCH_PARENT,
                    ViewGroup.LayoutParams.WRAP_CONTENT
                )
                setBackgroundColor(background.toArgb())
                settings.javaScriptEnabled = false
            }
        },
        update = { webView ->
            val styled = \"\"\"
                <html>
                <head>
                <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />
                <style>
                body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans KR', Arial, sans-serif; color: #111827; margin:0; padding:12px; }
                table { border-collapse: collapse; width: 100%; }
                th, td { border: 1px solid #e5e7eb; padding: 8px; text-align: left; vertical-align: top; }
                th { background: #f8fafc; }
                .risk-severe { color: #dc2626; font-weight: 700; }
                .risk-none { color: #16a34a; font-weight: 700; }
                </style>
                </head>
                <body>$html</body>
                </html>
            \"\"\".trimIndent()
            webView.loadDataWithBaseURL(null, styled, "text/html", "utf-8", null)
        }
    )
}

// í…ìŠ¤íŠ¸ ê¸°ë°˜ ë ˆì´ì•„ì›ƒ(PdfDocument)ìœ¼ë¡œ ì„œë²„ ë³´ê³ ì„œì™€ ìœ ì‚¬í•œ ì–‘ì‹ì„ ìƒì„± (ê¸°ê¸° í˜¸í™˜ì„± ì•ˆì •)
private fun generatePdfTextLayout(
    context: android.content.Context,
    deepfakeState: AnalysisUiState,
    cyberbullyingState: AnalysisUiState
): ByteArray {
    val pageWidth = 595; val pageHeight = 842
    val margin = 40f; val contentWidth = pageWidth - (margin * 2)
    val pdf = PdfDocument()
    val title = TextPaint(Paint.ANTI_ALIAS_FLAG).apply { color = 0xFF1976D2.toInt(); textSize = 20f; typeface = Typeface.create(Typeface.SANS_SERIF, Typeface.BOLD) }
    val h2 = TextPaint(Paint.ANTI_ALIAS_FLAG).apply { color = 0xFF1976D2.toInt(); textSize = 16f; typeface = Typeface.create(Typeface.SANS_SERIF, Typeface.BOLD) }
    val body = TextPaint(Paint.ANTI_ALIAS_FLAG).apply { color = 0xFF333333.toInt(); textSize = 11f; typeface = Typeface.SANS_SERIF }

    val pageInfo = PdfDocument.PageInfo.Builder(pageWidth, pageHeight, 1).create()
    var page = pdf.startPage(pageInfo)
    var canvas = page.canvas
    var y = margin

    fun newPage(add: Float) {
        if (y + add > pageHeight - margin) {
            pdf.finishPage(page)
            page = pdf.startPage(pageInfo)
            canvas = page.canvas; y = margin
        }
    }
    fun drawTitle(t: String) { canvas.drawText(t, margin, y, title); y += 26f }
    fun drawHeader(t: String) { newPage(20f); canvas.drawText(t, margin, y, h2); y += 18f }
    fun drawKV(k: String, v: String) { wrapText("$k $v", body, contentWidth).forEach{ newPage(14f); canvas.drawText(it, margin, y, body); y+=14f } }
    fun drawPara(t: String) { wrapText(t, body, contentWidth).forEach{ newPage(14f); canvas.drawText(it, margin, y, body); y+=14f }; y+=6f }

    drawTitle("ì•ˆì‹¬í†¡ ë””ì§€í„¸ ì¦ê±° ë¶„ì„ ë³´ê³ ì„œ")

    fun renderFileInfo(r: com.ansimtalk.app.data.model.AnalysisResult) {
        drawHeader("íŒŒì¼ ì •ë³´")
        drawKV("íŒŒì¼ëª…:", r.fileInfo.filename)
        drawKV("íŒŒì¼ íƒ€ì…:", r.fileInfo.type.uppercase())
        drawKV("íŒŒì¼ í¬ê¸°:", String.format("%.2f MB", r.fileInfo.sizeBytes/(1024.0*1024.0)))
        drawKV("SHA-256:", r.sha256)
        drawKV("ë¶„ì„ ì‹œê°:", r.analysisTimestamp)
        drawKV("ë¶„ì„ ìœ í˜•:", r.analysisType)
    }

    when {
        deepfakeState is AnalysisUiState.Success -> {
            val r = deepfakeState.result
            renderFileInfo(r)
            r.deepfakeAnalysis?.let { df ->
                drawHeader("ë”¥í˜ì´í¬ ë¶„ì„ ìš”ì•½")
                drawKV("ë”¥í˜ì´í¬ì¼ í™•ë¥ :", String.format("%.1f%%", (df.type?.deepfake ?: 0.0) * 100))
                drawKV("ìœ í•´ì„± ì ìˆ˜:", String.format("%.1f%%", (df.offensive?.prob ?: 0.0) * 100))
                drawKV("ë…¸ì¶œ ì ìˆ˜:", String.format("%.1f%%", (df.nudity?.raw ?: 0.0) * 100))
            }
        }
        cyberbullyingState is AnalysisUiState.Success -> {
            val r = cyberbullyingState.result
            renderFileInfo(r)
            drawHeader("ì‚¬ì´ë²„í­ë ¥ ë¶„ì„ ìš”ì•½")
            drawKV("ì „ì²´ ëŒ€í™” ì‚¬ì´ë²„í­ë ¥ ìœ„í—˜ë„:", r.cyberbullyingRiskLine ?: "ë¶„ì„ ì¤‘")
            if (!r.extractedText.isNullOrBlank()) { drawHeader("ì¶”ì¶œ í…ìŠ¤íŠ¸(OCR)"); drawPara(r.extractedText ?: "") }
            r.cyberbullyingAnalysis?.let { html ->
                drawHeader("ìƒì„¸ ë¶„ì„ ê²°ê³¼")
                val plain = android.text.Html.fromHtml(html, android.text.Html.FROM_HTML_MODE_LEGACY).toString()
                drawPara(plain)
            }
            r.cyberbullyingAnalysisSummary?.let { summary -> drawHeader("ì „ì²´ ë¶„ì„ ìš”ì•½"); drawPara(summary) }
        }
        else -> { drawHeader("ì•ˆë‚´"); drawPara("ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¶„ì„ì„ ì™„ë£Œí•˜ì„¸ìš”.") }
    }

    pdf.finishPage(page)
    val out = java.io.ByteArrayOutputStream(); pdf.writeTo(out); pdf.close(); return out.toByteArray()
}

private fun wrapText(text: String, paint: TextPaint, maxWidth: Float): List<String> {
    if (text.isBlank()) return emptyList()
    val out = mutableListOf<String>()
    val paragraphs = text.replace("\r", "").split("\n")
    for (p in paragraphs) {
        var start = 0
        val s = p.trim()
        while (start < s.length) {
            var count = paint.breakText(s, start, s.length, true, maxWidth, null)
            if (count <= 0) break
            // ì¤„ ëì„ ë‹¨ì–´ ê²½ê³„ë¡œ ë³´ì •
            var end = start + count
            if (end < s.length && !s[end - 1].isWhitespace()) {
                val lastSpace = s.lastIndexOf(' ', end - 1)
                if (lastSpace > start) end = lastSpace
            }
            out.add(s.substring(start, end).trim())
            start = if (end == start) end + 1 else end
        }
        if (s.isEmpty()) out.add("")
    }
    return out
}

@Composable
fun RiskLevelCard(result: AnalysisResult) {
    val riskLevel = result.cyberbullyingRiskLine ?: "ë¶„ì„ ì¤‘"
    val riskClass = when {
        "ì‹¬ê°" in riskLevel -> "risk-severe"
        "ìˆìŒ" in riskLevel -> "risk-present"
        "ì•½ê°„ ìˆìŒ" in riskLevel -> "risk-slight"
        "ì˜ì‹¬" in riskLevel -> "risk-suspicion"
        "ì—†ìŒ" in riskLevel -> "risk-none"
        else -> "risk-suspicion"
    }

    val riskColor = when (riskClass) {
        "risk-severe" -> MaterialTheme.colorScheme.error
        "risk-present" -> MaterialTheme.colorScheme.error
        "risk-slight" -> MaterialTheme.colorScheme.tertiary
        "risk-suspicion" -> MaterialTheme.colorScheme.tertiary
        "risk-none" -> MaterialTheme.colorScheme.primary
        else -> MaterialTheme.colorScheme.tertiary
    }

    Card(
        colors = CardDefaults.cardColors(
            containerColor = MaterialTheme.colorScheme.surface
        )
    ) {
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .padding(16.dp),
            horizontalArrangement = Arrangement.SpaceBetween,
            verticalAlignment = Alignment.CenterVertically
        ) {
            Text(
                text = "ì „ì²´ ëŒ€í™” ì‚¬ì´ë²„í­ë ¥ ìœ„í—˜ë„",
                fontSize = 18.sp,
                fontWeight = FontWeight.Bold,
                color = MaterialTheme.colorScheme.primary
            )
            Text(
                text = riskLevel,
                fontSize = 18.sp,
                fontWeight = FontWeight.Bold,
                color = riskColor
            )
        }
    }
}

@Composable
fun FileInfoSection(result: AnalysisResult) {
    Card(
        colors = CardDefaults.cardColors(
            containerColor = MaterialTheme.colorScheme.surface
        )
    ) {
        Column(
            modifier = Modifier.padding(12.dp)
        ) {
            Text(
                text = "íŒŒì¼ ì •ë³´",
                fontSize = 16.sp,
                fontWeight = FontWeight.Bold,
                color = MaterialTheme.colorScheme.onSurface
            )
            Spacer(modifier = Modifier.height(8.dp))

            Text(
                text = "íŒŒì¼ëª…: \${result.fileInfo.filename}",
                style = MaterialTheme.typography.bodyMedium,
                color = MaterialTheme.colorScheme.onSurface
            )
            Text(
                text = "íŒŒì¼ í¬ê¸°: \${String.format("%.2f", result.fileInfo.sizeBytes / (1024.0 * 1024.0))} MB",
                style = MaterialTheme.typography.bodyMedium,
                color = MaterialTheme.colorScheme.onSurface
            )
            Text(
                text = "íŒŒì¼ íƒ€ì…: \${result.fileInfo.type.uppercase()}",
                style = MaterialTheme.typography.bodyMedium,
                color = MaterialTheme.colorScheme.onSurface
            )
            Text(
                text = "SHA-256 í•´ì‹œ: \${result.sha256}",
                style = MaterialTheme.typography.bodySmall,
                color = MaterialTheme.colorScheme.onSurface
            )
            Text(
                text = "ë¶„ì„ ìš”ì²­ ì‹œê°: \${result.analysisTimestamp}",
                style = MaterialTheme.typography.bodySmall,
                color = MaterialTheme.colorScheme.onSurface
            )
        }
    }
}

@Composable
private fun ErrorFallbackUI(
    errorMessage: String,
    onRetry: () -> Unit
) {
    Box(
        modifier = Modifier.fillMaxSize(),
        contentAlignment = Alignment.Center
    ) {
        Column(
            horizontalAlignment = Alignment.CenterHorizontally,
            modifier = Modifier.padding(16.dp)
        ) {
            Text(
                text = "í™”ë©´ ë¡œë“œ ì˜¤ë¥˜",
                fontSize = 20.sp,
                fontWeight = FontWeight.Bold,
                color = MaterialTheme.colorScheme.error
            )
            Spacer(modifier = Modifier.height(16.dp))
            Text(
                text = errorMessage,
                textAlign = TextAlign.Center,
                color = MaterialTheme.colorScheme.onSurface
            )
            Spacer(modifier = Modifier.height(24.dp))
            Button(onClick = onRetry) {
                Text("ë‹¤ì‹œ ì‹œë„")
            }
        }
    }
}

@Composable
fun HeaderSection() {
    Column(
        horizontalAlignment = Alignment.CenterHorizontally
    ) {
        Text(
            text = "ì•ˆì‹¬í†¡",
            fontSize = 32.sp,
            fontWeight = FontWeight.Bold,
            color = MaterialTheme.colorScheme.primary
        )
        Spacer(modifier = Modifier.height(8.dp))
        Text(
            text = "AI ê¸°ë°˜ ë””ì§€í„¸ ì¦ê±° ë¶„ì„ ì•±",
            fontSize = 16.sp,
            color = MaterialTheme.colorScheme.onSurfaceVariant,
            textAlign = TextAlign.Center
        )
    }
}

@Composable
fun HealthStatusSection(healthState: com.ansimtalk.app.data.model.Resource<Map<String, Any>>) {
    Card(
        modifier = Modifier.fillMaxWidth(),
        colors = CardDefaults.cardColors(containerColor = MaterialTheme.colorScheme.surface),
        border = BorderStroke(1.dp, com.ansimtalk.app.presentation.ui.theme.Border),
        elevation = CardDefaults.cardElevation(defaultElevation = 1.dp)
    ) {
        Column(
            modifier = Modifier.padding(16.dp)
        ) {
            Text(
                text = "API ìƒíƒœ",
                fontSize = 18.sp,
                fontWeight = FontWeight.Bold,
                color = MaterialTheme.colorScheme.onSurface
            )
            Spacer(modifier = Modifier.height(4.dp))
            Text(
                text = "í˜„ì¬ ì„œë²„: \${BuildConfig.BASE_URL}",
                style = MaterialTheme.typography.bodySmall,
                color = MaterialTheme.colorScheme.onSurface.copy(alpha = 0.8f)
            )
            Spacer(modifier = Modifier.height(8.dp))
            when (healthState) {
                is com.ansimtalk.app.data.model.Resource.Loading -> {
                    CircularProgressIndicator(
                        modifier = Modifier.align(Alignment.CenterHorizontally)
                    )
                    Text(
                        text = "ì—°ê²° í™•ì¸ ì¤‘...",
                        modifier = Modifier.align(Alignment.CenterHorizontally),
                        style = MaterialTheme.typography.bodyMedium
                    )
                }
                is com.ansimtalk.app.data.model.Resource.Success -> {
                    Row(
                        modifier = Modifier
                            .background(color = com.ansimtalk.app.presentation.ui.theme.Success100, shape = CircleShape)
                            .padding(horizontal = 10.dp, vertical = 6.dp)
                            .align(Alignment.Start),
                        verticalAlignment = Alignment.CenterVertically
                    ) {
                        Text(
                            text = "âœ… API ì—°ê²° ì •ìƒ",
                            color = com.ansimtalk.app.presentation.ui.theme.SuccessText,
                            style = MaterialTheme.typography.bodyMedium,
                            fontWeight = FontWeight.Bold
                        )
                    }
                }
                is com.ansimtalk.app.data.model.Resource.Error -> {
                    Text(
                        text = "âŒ API ì—°ê²° ì˜¤ë¥˜: \${healthState.message}",
                        color = MaterialTheme.colorScheme.onErrorContainer,
                        style = MaterialTheme.typography.bodyMedium
                    )
                }
            }
        }
    }
}

@Composable
fun DeepfakeAnalysisSection(
    state: AnalysisUiState,
    onAnalyzeClick: () -> Unit,
    onReset: () -> Unit
) {
    Card(
        modifier = Modifier.fillMaxWidth(),
        colors = CardDefaults.cardColors(
            containerColor = MaterialTheme.colorScheme.surface
        ),
        border = BorderStroke(1.dp, com.ansimtalk.app.presentation.ui.theme.Border),
        elevation = CardDefaults.cardElevation(defaultElevation = 1.dp)
    ) {
        Column(
            modifier = Modifier.padding(16.dp)
        ) {
            Text(
                text = "ë”¥í˜ì´í¬ ë¶„ì„",
                fontSize = 20.sp,
                fontWeight = FontWeight.Bold,
                color = MaterialTheme.colorScheme.onSurface
            )
            Spacer(modifier = Modifier.height(8.dp))
            Text(
                text = "ì´ë¯¸ì§€ë‚˜ ì˜ìƒì´ AIë¡œ ì¡°ì‘ë˜ì—ˆëŠ”ì§€ ë¶„ì„í•©ë‹ˆë‹¤",
                fontSize = 14.sp,
                color = MaterialTheme.colorScheme.onSurface.copy(alpha = 0.7f)
            )
            Spacer(modifier = Modifier.height(16.dp))

            when (state) {
                is AnalysisUiState.Idle -> {
                    Button(
                        onClick = onAnalyzeClick,
                        modifier = Modifier
                            .fillMaxWidth()
                            .height(48.dp),
                        colors = ButtonDefaults.buttonColors(
                            containerColor = com.ansimtalk.app.presentation.ui.theme.Primary600,
                            contentColor = Color.White
                        )
                    ) {
                        Text("ì´ë¯¸ì§€ ì„ íƒí•˜ì—¬ ë¶„ì„", fontSize = 16.sp)
                    }
                }
                is AnalysisUiState.Loading -> {
                    CircularProgressIndicator(
                        modifier = Modifier.align(Alignment.CenterHorizontally)
                    )
                    Text(
                        text = "ë¶„ì„ ì¤‘...",
                        modifier = Modifier.align(Alignment.CenterHorizontally),
                        style = MaterialTheme.typography.bodyMedium
                    )
                }
                is AnalysisUiState.Success -> {
                    AnalysisResultContent(result = state.result)
                    OutlinedButton(
                        onClick = onReset,
                        modifier = Modifier
                            .fillMaxWidth()
                            .height(44.dp),
                        border = BorderStroke(1.dp, com.ansimtalk.app.presentation.ui.theme.Border),
                        colors = ButtonDefaults.outlinedButtonColors(
                            contentColor = com.ansimtalk.app.presentation.ui.theme.TextStrong
                        )
                    ) {
                        Text("ë‹¤ì‹œ ë¶„ì„", fontSize = 16.sp)
                    }
                }
                is AnalysisUiState.Error -> {
                    val message = state.message
                    Text(
                        text = if (message.length > 300) message.take(300) + "â€¦" else message,
                        color = MaterialTheme.colorScheme.error,
                        style = MaterialTheme.typography.bodyMedium
                    )
                    Button(
                        onClick = onReset,
                        modifier = Modifier
                            .fillMaxWidth()
                            .height(44.dp),
                        colors = ButtonDefaults.buttonColors(
                            containerColor = com.ansimtalk.app.presentation.ui.theme.Primary600,
                            contentColor = Color.White
                        )
                    ) {
                        Text("ë‹¤ì‹œ ì‹œë„", fontSize = 16.sp)
                    }
                }
            }

            Spacer(modifier = Modifier.height(8.dp))
            val ctx = LocalContext.current
            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.End
            ) {
                OutlinedButton(
                    onClick = {
                        val url = "\${BuildConfig.BASE_URL}/deepfake_help"
                        val intent = Intent(Intent.ACTION_VIEW, android.net.Uri.parse(url))
                        ctx.startActivity(intent)
                    },
                    border = BorderStroke(1.dp, com.ansimtalk.app.presentation.ui.theme.Border),
                    colors = ButtonDefaults.outlinedButtonColors(
                        contentColor = com.ansimtalk.app.presentation.ui.theme.TextStrong
                    )
                ) {
                    Icon(Icons.Filled.Info, contentDescription = null, tint = com.ansimtalk.app.presentation.ui.theme.TextStrong)
                    Spacer(Modifier.width(6.dp))
                    Text("ë”¥í˜ì´í¬ í”¼í•´ ìƒë‹´/ì‹ ê³  ì•ˆë‚´", fontSize = 14.sp, color = com.ansimtalk.app.presentation.ui.theme.TextStrong)
                    Spacer(Modifier.width(6.dp))
                    Icon(Icons.Filled.OpenInNew, contentDescription = null, tint = com.ansimtalk.app.presentation.ui.theme.TextStrong)
                }
            }
        }
    }
}

@Composable
fun CyberbullyingAnalysisSection(
    state: AnalysisUiState,
    onAnalyzeClick: () -> Unit,
    onReset: () -> Unit
) {
    Card(
        modifier = Modifier.fillMaxWidth(),
        colors = CardDefaults.cardColors(containerColor = MaterialTheme.colorScheme.surface),
        border = BorderStroke(1.dp, com.ansimtalk.app.presentation.ui.theme.Border),
        elevation = CardDefaults.cardElevation(defaultElevation = 1.dp)
    ) {
        Column(
            modifier = Modifier.padding(16.dp)
        ) {
            Text(
                text = "ì‚¬ì´ë²„ í­ë ¥ ë¶„ì„",
                fontSize = 20.sp,
                fontWeight = FontWeight.Bold,
                color = MaterialTheme.colorScheme.onSecondaryContainer
            )
            Spacer(modifier = Modifier.height(8.dp))
            Text(
                text = "ì±„íŒ…ì´ë‚˜ í…ìŠ¤íŠ¸ì˜ í­ë ¥ì„± ë° ìœ í•´ì„±ì„ ë¶„ì„í•©ë‹ˆë‹¤",
                fontSize = 14.sp,
                color = MaterialTheme.colorScheme.onSecondaryContainer.copy(alpha = 0.7f)
            )
            Spacer(modifier = Modifier.height(16.dp))

            when (state) {
                is AnalysisUiState.Idle -> {
                    Button(
                        onClick = onAnalyzeClick,
                        modifier = Modifier.fillMaxWidth()
                    ) {
                        Text("ì´ë¯¸ì§€ ì„ íƒí•˜ì—¬ ë¶„ì„")
                    }
                }
                is AnalysisUiState.Loading -> {
                    CircularProgressIndicator(
                        modifier = Modifier.align(Alignment.CenterHorizontally)
                    )
                    Text(
                        text = "ë¶„ì„ ì¤‘...",
                        modifier = Modifier.align(Alignment.CenterHorizontally),
                        style = MaterialTheme.typography.bodyMedium
                    )
                }
                is AnalysisUiState.Success -> {
                    AnalysisResultContent(result = state.result)
                    OutlinedButton(
                        onClick = onReset,
                        modifier = Modifier.fillMaxWidth(),
                        border = BorderStroke(1.dp, com.ansimtalk.app.presentation.ui.theme.Border),
                        colors = ButtonDefaults.outlinedButtonColors(
                            contentColor = com.ansimtalk.app.presentation.ui.theme.TextStrong
                        )
                    ) {
                        Text("ë‹¤ì‹œ ë¶„ì„")
                    }
                }
                is AnalysisUiState.Error -> {
                    val message = state.message
                    Text(
                        text = if (message.length > 300) message.take(300) + "â€¦" else message,
                        color = MaterialTheme.colorScheme.error,
                        style = MaterialTheme.typography.bodyMedium
                    )
                    Button(
                        onClick = onReset,
                        modifier = Modifier.fillMaxWidth()
                    ) {
                        Text("ë‹¤ì‹œ ì‹œë„")
                    }
                }
            }

            Spacer(modifier = Modifier.height(8.dp))
            val ctx = LocalContext.current
            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.End
            ) {
                OutlinedButton(
                    onClick = {
                        val url = "\${BuildConfig.BASE_URL}/cyberbullying_help"
                        val intent = Intent(Intent.ACTION_VIEW, android.net.Uri.parse(url))
                        ctx.startActivity(intent)
                    },
                    border = BorderStroke(1.dp, com.ansimtalk.app.presentation.ui.theme.Border),
                    colors = ButtonDefaults.outlinedButtonColors(
                        contentColor = com.ansimtalk.app.presentation.ui.theme.TextStrong
                    )
                ) {
                    Icon(Icons.Filled.Info, contentDescription = null, tint = com.ansimtalk.app.presentation.ui.theme.TextStrong)
                    Spacer(Modifier.width(6.dp))
                    Text("ì‚¬ì´ë²„í­ë ¥ ì‹ ê³  ì•ˆë‚´", fontSize = 14.sp, color = com.ansimtalk.app.presentation.ui.theme.TextStrong)
                    Spacer(Modifier.width(6.dp))
                    Icon(Icons.Filled.OpenInNew, contentDescription = null, tint = com.ansimtalk.app.presentation.ui.theme.TextStrong)
                }
            }
        }
    }
}

@Composable
fun AnalysisResultContent(result: AnalysisResult) {
    Column {
        Text(
            text = "ë¶„ì„ ê²°ê³¼",
            fontWeight = FontWeight.Bold,
            style = MaterialTheme.typography.titleMedium
        )
        Spacer(modifier = Modifier.height(8.dp))
        result.result?.let {
            Text(
                text = "ê²°ê³¼: $it",
                style = MaterialTheme.typography.bodyMedium
            )
        }
        result.confidence?.let { confidence ->
            Text(
                text = "ì‹ ë¢°ë„: \${String.format("%.2f", confidence)}%",
                style = MaterialTheme.typography.bodyMedium
            )
        }
        Text(
            text = "íŒŒì¼: \${result.fileInfo.filename}",
            style = MaterialTheme.typography.bodySmall
        )
    }
}

@Composable
fun PdfDownloadButton(
    state: PdfDownloadUiState,
    onDownloadClick: () -> Unit,
    onReset: () -> Unit
) {
    Card(
        modifier = Modifier.fillMaxWidth(),
        colors = CardDefaults.cardColors(
            containerColor = MaterialTheme.colorScheme.tertiaryContainer
        )
    ) {
        Column(
            modifier = Modifier.padding(16.dp)
        ) {
            Text(
                text = "PDF ë¦¬í¬íŠ¸",
                fontSize = 20.sp,
                fontWeight = FontWeight.Bold,
                color = MaterialTheme.colorScheme.onTertiaryContainer
            )
            Spacer(modifier = Modifier.height(8.dp))
            Text(
                text = "ë¶„ì„ ê²°ê³¼ë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤",
                fontSize = 14.sp,
                color = MaterialTheme.colorScheme.onTertiaryContainer.copy(alpha = 0.7f)
            )
            Spacer(modifier = Modifier.height(16.dp))

            when (state) {
                is PdfDownloadUiState.Idle -> {
                    Button(
                        onClick = onDownloadClick,
                        modifier = Modifier.fillMaxWidth()
                    ) {
                        Text("PDF ë‹¤ìš´ë¡œë“œ")
                    }
                }
                is PdfDownloadUiState.Downloading -> {
                    CircularProgressIndicator(
                        modifier = Modifier.align(Alignment.CenterHorizontally)
                    )
                    Text(
                        text = "ë‹¤ìš´ë¡œë“œ ì¤‘...",
                        modifier = Modifier.align(Alignment.CenterHorizontally),
                        style = MaterialTheme.typography.bodyMedium
                    )
                }
                is PdfDownloadUiState.Success -> {
                    Text(
                        text = "ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!",
                        color = MaterialTheme.colorScheme.primary,
                        style = MaterialTheme.typography.bodyMedium
                    )
                    Button(
                        onClick = onReset,
                        modifier = Modifier.fillMaxWidth()
                    ) {
                        Text("ë‹¤ì‹œ ë‹¤ìš´ë¡œë“œ")
                    }
                }
                is PdfDownloadUiState.Error -> {
                    Text(
                        text = "ì˜¤ë¥˜: \${state.message}",
                        color = MaterialTheme.colorScheme.error,
                        style = MaterialTheme.typography.bodyMedium
                    )
                    Button(
                        onClick = onReset,
                        modifier = Modifier.fillMaxWidth()
                    ) {
                        Text("ë‹¤ì‹œ ì‹œë„")
                    }
                }
            }
        }
    }
}

// ì„ íƒí•œ íŒŒì¼ì„ ì›ë³¸ íŒŒì¼ëª…/í™•ì¥ìë¥¼ ìœ ì§€í•´ ìºì‹œì— ì €ì¥í•˜ê³ , ì˜¬ë°”ë¥¸ MIMEìœ¼ë¡œ Multipartë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
private fun prepareMultipartFromUri(context: android.content.Context, uri: Uri): MultipartBody.Part {
    val cr = context.contentResolver

    // MIME íƒ€ì… í™•ì¸ (ê¸°ë³¸ê°’ì€ ì´ì§„íŒŒì¼)
    val mimeType = cr.getType(uri) ?: "application/octet-stream"

    // í‘œì‹œ ì´ë¦„(íŒŒì¼ëª…) ì¡°íšŒ
    val displayName = run {
        if (uri.scheme == "content") {
            cr.query(uri, arrayOf(android.provider.OpenableColumns.DISPLAY_NAME), null, null, null)?.use { cursor ->
                if (cursor.moveToFirst()) cursor.getString(0) else null
            }
        } else if (uri.scheme == "file") {
            File(requireNotNull(uri.path)).name
        } else null
    }

    // í™•ì¥ì ê²°ì •
    val extFromName = displayName?.substringAfterLast('.', missingDelimiterValue = "").orEmpty()
    val ext = if (extFromName.isNotBlank()) extFromName.lowercase() else when (mimeType) {
        "image/png" -> "png"
        "image/jpeg" -> "jpg"
        "text/plain" -> "txt"
        else -> ""
    }

    // í—ˆìš© í™•ì¥ì ê²€ì¦(ì„œë²„ ì¸¡ ì •ì±…ê³¼ ì¼ì¹˜)
    val allowed = setOf("png", "jpg", "jpeg", "txt")
    if (ext.isNotBlank() && ext !in allowed) {
        throw IllegalArgumentException("í—ˆìš©ë˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤. (png, jpg, jpeg, txt)")
    }

    // ì €ì¥ íŒŒì¼ëª… êµ¬ì„± (í™•ì¥ì ì—†ìœ¼ë©´ MIME ê¸°ë°˜ ì¶”ì •ì¹˜ ì‚¬ìš©)
    val baseName = displayName?.takeIf { it.isNotBlank() } ?: "upload_\${System.currentTimeMillis()}"
    val hasDot = baseName.contains('.')
    val safeName = if (hasDot) baseName else baseName + if (ext.isNotBlank()) ".\${ext}" else ""

    // ìºì‹œì— ë³µì‚¬ ì €ì¥
    val inputStream = cr.openInputStream(uri)
    requireNotNull(inputStream) { "Failed to open input stream for URI: $uri" }
    val tempFile = File(context.cacheDir, safeName)
    tempFile.outputStream().use { output -> inputStream.copyTo(output) }
    inputStream.close()

    val partMime = (if (ext in setOf("png", "jpg", "jpeg")) {
        if (ext == "png") "image/png" else "image/jpeg"
    } else if (ext == "txt") {
        "text/plain"
    } else mimeType).toMediaTypeOrNull()

    val body = tempFile.asRequestBody(partMime)
    return MultipartBody.Part.createFormData("file", tempFile.name, body)
}
```

---

## 20. ì „ì²´ í”„ë¡œì íŠ¸ ìš”ì•½

### ğŸ“ ì „ì²´ í´ë” êµ¬ì¡°

```
D:\coding sutdy\
â”œâ”€â”€ ansimtalk (2)/                # ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ (Flask)
â”‚   â”œâ”€â”€ run.py
â”‚   â”œâ”€â”€ config.py
â”‚   â”œâ”€â”€ requirements.txt
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”œâ”€â”€ railway.toml
â”‚   â””â”€â”€ app/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ routes.py
â”‚       â”œâ”€â”€ services.py           # AI ë¶„ì„ í•µì‹¬ ë¡œì§
â”‚       â”œâ”€â”€ static/
â”‚       â”‚   â”œâ”€â”€ css/style.css
â”‚       â”‚   â””â”€â”€ fonts/            # NanumGothic í°íŠ¸ 3ê°œ
â”‚       â””â”€â”€ templates/            # HTML í…œí”Œë¦¿ 7ê°œ
â”‚
â””â”€â”€ ansimtalk_app/                # ì•ˆë“œë¡œì´ë“œ ì•± (Kotlin)
    â”œâ”€â”€ build.gradle.kts
    â”œâ”€â”€ settings.gradle.kts
    â””â”€â”€ app/
        â”œâ”€â”€ build.gradle.kts
        â””â”€â”€ src/main/
            â”œâ”€â”€ AndroidManifest.xml
            â”œâ”€â”€ java/com/ansimtalk/app/
            â”‚   â”œâ”€â”€ AnsimTalkApplication.kt
            â”‚   â”œâ”€â”€ MainActivity.kt
            â”‚   â”œâ”€â”€ ResultActivity.kt
            â”‚   â”œâ”€â”€ data/              # ë°ì´í„° ë ˆì´ì–´ (11ê°œ íŒŒì¼)
            â”‚   â”œâ”€â”€ domain/            # ë„ë©”ì¸ ë ˆì´ì–´ (8ê°œ íŒŒì¼)
            â”‚   â”œâ”€â”€ presentation/      # í”„ë ˆì  í…Œì´ì…˜ ë ˆì´ì–´ (9ê°œ íŒŒì¼)
            â”‚   â”œâ”€â”€ di/                # DI ëª¨ë“ˆ (2ê°œ íŒŒì¼)
            â”‚   â””â”€â”€ util/              # ìœ í‹¸ (1ê°œ íŒŒì¼)
            â””â”€â”€ res/                   # ì•ˆë“œë¡œì´ë“œ ë¦¬ì†ŒìŠ¤
```

---

### ğŸ“Š ì½”ë“œ í†µê³„

**ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜**:
- Python íŒŒì¼: 4ê°œ (run.py, config.py, __init__.py, routes.py, services.py)
- HTML í…œí”Œë¦¿: 7ê°œ
- CSS íŒŒì¼: 1ê°œ
- ì´ ë¼ì¸ ìˆ˜: ì•½ 2,500ì¤„

**ì•ˆë“œë¡œì´ë“œ ì•±**:
- Kotlin íŒŒì¼: 32ê°œ
- XML íŒŒì¼: 23ê°œ
- Gradle íŒŒì¼: 3ê°œ
- ì´ ë¼ì¸ ìˆ˜: ì•½ 5,000ì¤„ (MainScreen.ktë§Œ 1,518ì¤„)

---

### ğŸ”§ ê°œë°œ í™˜ê²½ ìš”êµ¬ì‚¬í•­

**ì›¹ (Flask)**:
- Python 3.12
- pip packages: Flask, google-cloud-vision, google-generativeai, weasyprint, pillow, requests
- API í‚¤: Sightengine, Google Gemini, Google Cloud Vision

**ì•± (Android)**:
- Android Studio (ìµœì‹  ë²„ì „)
- JDK 11
- Android SDK 26-34
- Kotlin 1.9.22
- Gradle 8.11.1

---

### ğŸš€ ì‹¤í–‰ ìˆœì„œ

1. **ì›¹ ì„œë²„ ì‹¤í–‰**:
```bash
cd "D:\coding sutdy\ansimtalk (2)"
python run.py
# ì„œë²„ê°€ http://localhost:8000 ì—ì„œ ì‹¤í–‰ë¨
```

2. **ì•± ì‹¤í–‰** (ì—ë®¬ë ˆì´í„°ë¡œ ë¡œì»¬ ì„œë²„ í…ŒìŠ¤íŠ¸):
```bash
cd "D:\coding sutdy\ansimtalk_app"
# Android Studioì—ì„œ Build Variantë¥¼ debugLocalEmuë¡œ ì„ íƒ
# Run ë²„íŠ¼ í´ë¦­
```

3. **ì•± ì‹¤í–‰** (í”„ë¡œë•ì…˜ ì„œë²„ ì—°ê²°):
```bash
# Android Studioì—ì„œ Build Variantë¥¼ debugë¡œ ì„ íƒ
# Run ë²„íŠ¼ í´ë¦­ (Railway ë°°í¬ëœ ì„œë²„ë¡œ ìë™ ì—°ê²°)
```

---
