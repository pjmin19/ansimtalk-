# 🏆 안심톡(AnsimTalk) 대회 제출용 전체 코드 및 리소스

본 문서는 ansimtalk 프로젝트의 대회 제출용 전체 코드, 템플릿, 리소스, 환경설정, 실행법을 한 글자도 빠짐없이 포함합니다.

---

## 📖 프로젝트 개요 (요약)
- **안심톡(AnsimTalk)**: AI 기반 딥페이크 탐지 및 사이버폭력 분석, 디지털 증거 PDF 자동생성, 법적 효력 강화, 모바일/웹 최적화, 개인정보 보호, 실시간 분석 서비스
- **주요 기술**: Python 3.12, Flask, Sightengine API, Google Gemini/Vision, WeasyPrint, Docker, Railway, HTML/CSS/JS
- **실행법**: 아래 "실행/배포 안내" 참고

---

## 1. run.py (Flask 앱 실행 진입점)
```python
import os
from app import create_app

app = create_app()

if __name__ == '__main__':
    port = int(os.environ.get('PORT', 8000))
    print(f"Starting AnsimTalk on port {port}")
    app.run(host='0.0.0.0', port=port, debug=False)
```

---

## 2. config.py (환경 변수 및 기본 설정)
```python
import os

# Flask 기본 설정
SECRET_KEY = os.environ.get('SECRET_KEY', 'your-secret-key')

# Sightengine API (환경 변수에서 가져옴)
SIGHTENGINE_API_USER = os.environ.get('SIGHTENGINE_API_USER', '')
SIGHTENGINE_API_SECRET = os.environ.get('SIGHTENGINE_API_SECRET', '')

# Google Cloud Vision/Gemini
GOOGLE_APPLICATION_CREDENTIALS = os.environ.get('GOOGLE_APPLICATION_CREDENTIALS', 'dazzling-howl-465316-m7-6605bfd84de1.json')
GOOGLE_GEMINI_API_KEY = os.environ.get('GOOGLE_GEMINI_API_KEY', '')

# 실제 배포 시에는 환경변수로 민감정보를 관리하세요.

BASE_DIR = os.path.abspath(os.path.dirname(__file__))
UPLOAD_FOLDER = os.path.join(BASE_DIR, 'tmp')
ALLOWED_EXTENSIONS = {'txt', 'png', 'jpg', 'jpeg'} 
```

---

## 3. app/__init__.py (Flask 앱 팩토리 및 블루프린트 등록)
```python
import os
from flask import Flask
from .routes import bp

def create_app():
    app = Flask(__name__)
    
    # 로그 레벨을 DEBUG로 설정
    app.logger.setLevel('DEBUG')
    
    # 시크릿 키 설정
    app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY', 'ansimtalk-secret-key-2024')
    
    # 환경 변수에서 API 키들 가져오기
    app.config['SIGHTENGINE_API_USER'] = os.environ.get('SIGHTENGINE_API_USER', '1052068557')
    app.config['SIGHTENGINE_API_SECRET'] = os.environ.get('SIGHTENGINE_API_SECRET', 'JbRcN79c6iunXBHG29WRzyQyFHRoYnQa')
    app.config['GOOGLE_GEMINI_API_KEY'] = os.environ.get('GOOGLE_GEMINI_API_KEY', 'AIzaSyAZ__v5f-3pYxDfMi--rdCyphpcqsxxrLo')
    app.config['GOOGLE_CLOUD_VISION_API_KEY'] = os.environ.get('GOOGLE_CLOUD_VISION_API_KEY', 'your-vision-api-key-here')
    
    # Google Cloud 자격 증명 파일 경로 설정
    app.config['GOOGLE_APPLICATION_CREDENTIALS'] = os.environ.get('GOOGLE_APPLICATION_CREDENTIALS', 'dazzling-howl-465316-m7-1940c1e7d0a2.json')
    
    # 블루프린트 등록
    app.register_blueprint(bp)
    
    return app
```

---

## 4. app/routes.py
```python
import os
import uuid
from datetime import datetime
from flask import Blueprint, render_template, request, redirect, url_for, current_app, session, flash, send_file
from werkzeug.utils import secure_filename
from .services import analyze_file, generate_pdf_report
import shutil
from PIL import Image, ExifTags
import hashlib

bp = Blueprint('main', __name__)

ALLOWED_EXTENSIONS = {'txt', 'png', 'jpg', 'jpeg'}
MAX_FILE_SIZE = 5 * 1024 * 1024

# 파일 확장자 체크
def allowed_file(filename):
    return '.' in filename and filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS

# 파일 메타데이터 추출
def extract_metadata(image_path):
    try:
        img = Image.open(image_path)
        exif = img._getexif()
        meta = {}
        if exif:
            for tag, value in exif.items():
                decoded = ExifTags.TAGS.get(tag, tag)
                meta[decoded] = value
        meta['해상도'] = f"{img.width}x{img.height}"
        return meta
    except Exception:
        return {"해상도": "알수없음"}

# SHA-256 해시값 생성
def get_file_sha256(filepath):
    h = hashlib.sha256()
    with open(filepath, 'rb') as f:
        while True:
            chunk = f.read(8192)
            if not chunk:
                break
            h.update(chunk)
    return h.hexdigest()

def _handle_file_upload_and_analysis(analysis_type):
    try:
        current_app.logger.info(f"=== {analysis_type} 분석 시작 ===")
        print(f"=== {analysis_type} 분석 시작 ===")
        
        if 'file' not in request.files:
            current_app.logger.error("오류: 파일이 요청에 없습니다.")
            print("오류: 파일이 요청에 없습니다.")
            flash('파일이 없습니다.')
            return redirect(url_for('main.index'))
        
        file = request.files['file']
        current_app.logger.info(f"업로드된 파일명: {file.filename}")
        print(f"업로드된 파일명: {file.filename}")
        
        if file.filename == '':
            current_app.logger.error("오류: 파일명이 비어있습니다.")
            print("오류: 파일명이 비어있습니다.")
            flash('파일을 선택해주세요.')
            return redirect(url_for('main.index'))
        
        if not allowed_file(file.filename):
            current_app.logger.error(f"오류: 허용되지 않는 파일 형식: {file.filename}")
            print(f"오류: 허용되지 않는 파일 형식: {file.filename}")
            flash('허용되지 않는 파일 형식입니다.')
            return redirect(url_for('main.index'))
        
        # 파일 크기 확인
        file.seek(0, os.SEEK_END)
        file_size = file.tell()
        file.seek(0)
        current_app.logger.info(f"파일 크기: {file_size} bytes")
        print(f"파일 크기: {file_size} bytes")
        
        if file_size > MAX_FILE_SIZE:
            current_app.logger.error(f"오류: 파일 크기가 너무 큼: {file_size} bytes")
            print(f"오류: 파일 크기가 너무 큼: {file_size} bytes")
            flash('파일 크기가 너무 큽니다.')
            return redirect(url_for('main.index'))

        original_filename = secure_filename(file.filename)
        file_extension = original_filename.rsplit('.', 1)[1].lower()
        unique_filename = f"{uuid.uuid4().hex}_{datetime.now().strftime('%Y%m%d%H%M%S')}.{file_extension}"
        
        current_app.logger.info(f"원본 파일명: {original_filename}")
        current_app.logger.info(f"고유 파일명: {unique_filename}")
        current_app.logger.info(f"파일 확장자: {file_extension}")
        print(f"원본 파일명: {original_filename}")
        print(f"고유 파일명: {unique_filename}")
        print(f"파일 확장자: {file_extension}")
        
        # 현재 작업 디렉토리 확인
        current_dir = os.getcwd()
        current_app.logger.info(f"현재 작업 디렉토리: {current_dir}")
        print(f"현재 작업 디렉토리: {current_dir}")
        
        # 업로드 폴더를 현재 디렉토리 내에 생성
        upload_folder = os.path.join(current_dir, 'tmp')
        if not os.path.exists(upload_folder):
            os.makedirs(upload_folder)
            current_app.logger.info(f"업로드 폴더 생성: {upload_folder}")
            print(f"업로드 폴더 생성: {upload_folder}")
        
        file_path = os.path.join(upload_folder, unique_filename)
        current_app.logger.info(f"파일 저장 경로: {file_path}")
        print(f"파일 저장 경로: {file_path}")
        
        # 파일 저장
        file.save(file_path)
        current_app.logger.info(f"파일 저장 완료: {file_path}")
        print(f"파일 저장 완료: {file_path}")
        
        # 파일 존재 확인
        if not os.path.exists(file_path):
            current_app.logger.error(f"오류: 파일 저장 후에도 존재하지 않음: {file_path}")
            print(f"오류: 파일 저장 후에도 존재하지 않음: {file_path}")
            flash('파일 저장에 실패했습니다.')
            return redirect(url_for('main.index'))
        
        # 파일 크기 재확인
        saved_file_size = os.path.getsize(file_path)
        current_app.logger.info(f"저장된 파일 크기: {saved_file_size} bytes")
        print(f"저장된 파일 크기: {saved_file_size} bytes")

        # static/uploads로 복사
        static_uploads = os.path.join(current_app.root_path, 'static', 'uploads')
        if not os.path.exists(static_uploads):
            os.makedirs(static_uploads)
            current_app.logger.info(f"static 업로드 폴더 생성: {static_uploads}")
            print(f"static 업로드 폴더 생성: {static_uploads}")
        
        static_file_path = os.path.join(static_uploads, unique_filename)
        shutil.copy(file_path, static_file_path)
        current_app.logger.info(f"static 폴더로 복사 완료: {static_file_path}")
        print(f"static 폴더로 복사 완료: {static_file_path}")

        # 파일 정보 추출
        file_stat = os.stat(file_path)
        metadata = extract_metadata(file_path)
        sha256 = get_file_sha256(file_path)
        
        current_app.logger.info(f"파일 메타데이터: {metadata}")
        current_app.logger.info(f"SHA-256: {sha256}")
        print(f"파일 메타데이터: {metadata}")
        print(f"SHA-256: {sha256}")

        # 세션에 저장
        session['uploaded_file_path'] = file_path
        session['static_file_path'] = static_file_path
        session['original_filename'] = original_filename
        session['file_extension'] = file_extension
        session['file_stat'] = {'st_size': file_stat.st_size}
        session['metadata'] = metadata
        session['sha256'] = sha256
        session['static_image_url'] = f"uploads/{unique_filename}"
        session['original_image_path'] = static_file_path
        session['analysis_type'] = analysis_type
        
        current_app.logger.info("세션 정보 저장 완료")
        print("세션 정보 저장 완료")

        # 분석 결과 생성
        try:
            current_app.logger.info(f"분석 시작: {analysis_type}")
            current_app.logger.info(f"분석할 파일 경로: {file_path}")
            print(f"분석 시작: {analysis_type}")
            print(f"분석할 파일 경로: {file_path}")
            
            # 파일이 실제로 존재하는지 다시 한번 확인
            if not os.path.exists(file_path):
                current_app.logger.error(f"분석 전 파일 존재 확인 실패: {file_path}")
                print(f"분석 전 파일 존재 확인 실패: {file_path}")
                flash('분석할 파일을 찾을 수 없습니다.')
                return redirect(url_for('main.index'))
            
            analysis_result = analyze_file(file_path, analysis_type, file_extension)
            current_app.logger.info(f"분석 완료: {analysis_result}")
            print(f"분석 완료: {analysis_result}")
            
            # 업로더 정보 추가
            upload_timestamp = datetime.now()
            analysis_result['uploader_id'] = f"ANSIMTALK_USER_{upload_timestamp.strftime('%Y%m%d')}_{uuid.uuid4().hex[:8].upper()}"
            analysis_result['uploader_ip'] = request.remote_addr
            analysis_result['upload_timestamp'] = upload_timestamp.isoformat()
            analysis_result['file_size_bytes'] = file_stat.st_size
            analysis_result['file_size_mb'] = round(file_stat.st_size / (1024 * 1024), 2)
            
            # 이미지 크기 정보 추가
            if file_extension in {'jpg', 'jpeg', 'png'}:
                try:
                    with Image.open(file_path) as img:
                        analysis_result['image_width'] = img.width
                        analysis_result['image_height'] = img.height
                        analysis_result['image_resolution'] = f"{img.width}x{img.height}"
                        current_app.logger.info(f"이미지 크기: {img.width}x{img.height}")
                        print(f"이미지 크기: {img.width}x{img.height}")
                except Exception as e:
                    current_app.logger.error(f"이미지 크기 추출 오류: {e}")
                    print(f"이미지 크기 추출 오류: {e}")
                    analysis_result['image_width'] = 'N/A'
                    analysis_result['image_height'] = 'N/A'
                    analysis_result['image_resolution'] = 'N/A'
            else:
                analysis_result['image_width'] = 'N/A'
                analysis_result['image_height'] = 'N/A'
                analysis_result['image_resolution'] = 'N/A'
            
            session['analysis_result'] = analysis_result
            current_app.logger.info("분석 결과 세션 저장 완료")
            print("분석 결과 세션 저장 완료")
            
        except Exception as e:
            current_app.logger.error(f"분석 중 오류 발생: {e}")
            print(f"분석 중 오류 발생: {e}")
            import traceback
            current_app.logger.error(f"상세 오류 정보: {traceback.format_exc()}")
            print(f"상세 오류 정보: {traceback.format_exc()}")
            flash(f'{analysis_type} 분석 중 오류: {e}')
            if os.path.exists(file_path):
                os.remove(file_path)
                current_app.logger.info(f"임시 파일 삭제: {file_path}")
                print(f"임시 파일 삭제: {file_path}")
            return redirect(url_for('main.index'))
        
        current_app.logger.info(f"=== {analysis_type} 분석 완료 ===")
        print(f"=== {analysis_type} 분석 완료 ===")
        return redirect(url_for('main.results'))
        
    except Exception as e:
        current_app.logger.error(f"파일 처리 중 예상치 못한 오류: {e}")
        print(f"파일 처리 중 예상치 못한 오류: {e}")
        import traceback
        current_app.logger.error(f"상세 오류 정보: {traceback.format_exc()}")
        print(f"상세 오류 정보: {traceback.format_exc()}")
        flash(f'파일 처리 중 오류: {e}')
        return redirect(url_for('main.index'))

@bp.route('/health')
def health():
    try:
        # 기본 상태 확인
        status = {
            "status": "healthy",
            "timestamp": datetime.now().isoformat(),
            "service": "AnsimTalk AI Forensic Analysis",
            "version": "1.0.0",
            "environment": "production"
        }
        return status, 200
    except Exception as e:
        return {"status": "unhealthy", "error": str(e)}, 500

@bp.route('/')
def index():
    try:
        return render_template('index.html')
    except Exception as e:
        return f"AnsimTalk is running! Error: {str(e)}", 200

@bp.route('/analyze_deepfake', methods=['POST'])
def analyze_deepfake():
    return _handle_file_upload_and_analysis('deepfake')

@bp.route('/analyze_cyberbullying', methods=['POST'])
def analyze_cyberbullying():
    return _handle_file_upload_and_analysis('cyberbullying')

@bp.route('/results')
def results():
    analysis_result = session.get('analysis_result')
    analysis_type = session.get('analysis_type') # 분석 타입 가져오기
    if not analysis_result:
        flash('분석 결과가 없습니다.')
        return redirect(url_for('main.index'))
    return render_template('results.html', result=analysis_result, analysis_type=analysis_type)

@bp.route('/evidence')
def evidence():
    return render_template('evidence.html')

@bp.route('/deepfake_help')
def deepfake_help():
    return render_template('deepfake_help.html')

@bp.route('/cyberbullying_help')
def cyberbullying_help():
    return render_template('cyberbullying_help.html')

@bp.route('/download_pdf')
def download_pdf():
    try:
        analysis_result = session.get('analysis_result')
        analysis_type = session.get('analysis_type') # 분석 타입 가져오기
        if not analysis_result:
            flash('분석 결과가 없습니다.')
            return redirect(url_for('main.index'))
        
        # 원본 이미지 경로 추가
        analysis_result['original_image_path'] = session.get('original_image_path', '')
        
        # PDF 파일 경로 생성
        pdf_filename = f"evidence_{uuid.uuid4().hex}_{datetime.now().strftime('%Y%m%d%H%M%S')}.pdf"
        pdf_path = os.path.join(current_app.root_path, '..', 'tmp', pdf_filename)
        # PDF 생성
        generate_pdf_report(analysis_result, pdf_path, analysis_type) # analysis_type 전달
        print(f"Attempting to send file from: {pdf_path}")
        if not os.path.exists(pdf_path):
            print(f"Error: PDF file does not exist at {pdf_path} right before sending.")
            flash('PDF 파일 생성에 실패했습니다.')
            return redirect(url_for('main.index'))
        return send_file(pdf_path, as_attachment=True, download_name=pdf_filename)
    except Exception as e:
        flash(f'PDF 생성/다운로드 중 오류: {e}')
        return redirect(url_for('main.index'))

@bp.route('/reset')
def reset():
    # 임시파일 삭제
    file_path = session.get('uploaded_file_path')
    if file_path and os.path.exists(file_path):
        os.remove(file_path)
    static_file_path = session.get('static_file_path')
    if static_file_path and os.path.exists(static_file_path):
        os.remove(static_file_path)
    
    # 세션 클리어
    session.clear()
    return redirect(url_for('main.index'))

# ============================================
# API 엔드포인트 (모바일 앱용 - JSON 응답)
# ============================================

@bp.route('/api/health', methods=['GET'])
def api_health():
    """API 상태 확인 (JSON 응답)"""
    try:
        return jsonify({
            "status": "healthy",
            "timestamp": datetime.now().isoformat(),
            "service": "AnsimTalk AI Forensic Analysis",
            "version": "1.0.0",
            "environment": "production"
        }), 200
    except Exception as e:
        return jsonify({"status": "unhealthy", "error": str(e)}), 500

@bp.route('/api/analyze_deepfake', methods=['POST'])
def api_analyze_deepfake():
    """딥페이크 분석 API (JSON 응답)"""
    try:
        current_app.logger.info("=== API 딥페이크 분석 시작 ===")
        
        if 'file' not in request.files:
            return jsonify({'error': '파일이 없습니다.'}), 400
        
        file = request.files['file']
        
        if file.filename == '':
            return jsonify({'error': '파일을 선택해주세요.'}), 400
        
        if not allowed_file(file.filename):
            return jsonify({'error': '허용되지 않는 파일 형식입니다.'}), 400
        
        # 파일 크기 확인
        file.seek(0, os.SEEK_END)
        file_size = file.tell()
        file.seek(0)
        
        if file_size > MAX_FILE_SIZE:
            return jsonify({'error': '파일 크기가 5MB를 초과합니다.'}), 400

        # 파일 저장
        original_filename = secure_korean_filename(file.filename)
        file_extension = original_filename.rsplit('.', 1)[1].lower()
        unique_filename = f"{uuid.uuid4().hex}_{datetime.now().strftime('%Y%m%d%H%M%S')}.{file_extension}"
        
        upload_folder = os.path.join(os.getcwd(), 'tmp')
        if not os.path.exists(upload_folder):
            os.makedirs(upload_folder)
        
        file_path = os.path.join(upload_folder, unique_filename)
        file.save(file_path)
        
        current_app.logger.info(f"파일 저장 완료: {file_path}")

        # 분석 수행
        analysis_result = analyze_file(file_path, 'deepfake', file_extension)
        
        # 파일 정보 추가
        file_stat = os.stat(file_path)
        analysis_result['file_info'] = {
            'filename': original_filename,
            'type': file_extension,
            'size_bytes': file_stat.st_size
        }
        analysis_result['analysis_timestamp'] = datetime.now().isoformat()
        
        # SHA-256 해시
        with open(file_path, 'rb') as f:
            sha256 = hashlib.sha256(f.read()).hexdigest()
        analysis_result['sha256'] = sha256
        analysis_result['analysis_type'] = 'deepfake'
        
        current_app.logger.info("=== API 딥페이크 분석 완료 ===")
        
        # 임시 파일 삭제 (선택적)
        try:
            os.remove(file_path)
        except:
            pass
        
        return jsonify(analysis_result), 200
        
    except Exception as e:
        current_app.logger.error(f"API 딥페이크 분석 오류: {e}")
        import traceback
        current_app.logger.error(traceback.format_exc())
        return jsonify({'error': f'분석 중 오류 발생: {str(e)}'}), 500

@bp.route('/api/analyze_cyberbullying', methods=['POST'])
def api_analyze_cyberbullying():
    """사이버폭력 분석 API (JSON 응답)"""
    try:
        current_app.logger.info("=== API 사이버폭력 분석 시작 ===")
        
        if 'file' not in request.files:
            return jsonify({'error': '파일이 없습니다.'}), 400
        
        file = request.files['file']
        
        if file.filename == '':
            return jsonify({'error': '파일을 선택해주세요.'}), 400
        
        if not allowed_file(file.filename):
            return jsonify({'error': '허용되지 않는 파일 형식입니다.'}), 400
        
        # 파일 크기 확인
        file.seek(0, os.SEEK_END)
        file_size = file.tell()
        file.seek(0)
        
        if file_size > MAX_FILE_SIZE:
            return jsonify({'error': '파일 크기가 5MB를 초과합니다.'}), 400

        # 파일 저장
        original_filename = secure_korean_filename(file.filename)
        file_extension = original_filename.rsplit('.', 1)[1].lower()
        unique_filename = f"{uuid.uuid4().hex}_{datetime.now().strftime('%Y%m%d%H%M%S')}.{file_extension}"
        
        upload_folder = os.path.join(os.getcwd(), 'tmp')
        if not os.path.exists(upload_folder):
            os.makedirs(upload_folder)
        
        file_path = os.path.join(upload_folder, unique_filename)
        file.save(file_path)
        
        current_app.logger.info(f"파일 저장 완료: {file_path}")

        # 분석 수행
        analysis_result = analyze_file(file_path, 'cyberbullying', file_extension)
        
        # 파일 정보 추가
        file_stat = os.stat(file_path)
        analysis_result['file_info'] = {
            'filename': original_filename,
            'type': file_extension,
            'size_bytes': file_stat.st_size
        }
        analysis_result['analysis_timestamp'] = datetime.now().isoformat()
        
        # SHA-256 해시
        with open(file_path, 'rb') as f:
            sha256 = hashlib.sha256(f.read()).hexdigest()
        analysis_result['sha256'] = sha256
        analysis_result['analysis_type'] = 'cyberbullying'
        
        current_app.logger.info("=== API 사이버폭력 분석 완료 ===")
        
        # 임시 파일 삭제 (선택적)
        try:
            os.remove(file_path)
        except:
            pass
        
        return jsonify(analysis_result), 200
        
    except Exception as e:
        current_app.logger.error(f"API 사이버폭력 분석 오류: {e}")
        import traceback
        current_app.logger.error(traceback.format_exc())
        return jsonify({'error': f'분석 중 오류 발생: {str(e)}'}), 500

@bp.route('/api/download_pdf', methods=['POST'])
def api_download_pdf():
    """PDF 생성 및 다운로드 API"""
    try:
        current_app.logger.info("=== API PDF 다운로드 시작 ===")
        
        # JSON 데이터 받기
        data = request.get_json()
        if not data or 'analysis_result' not in data:
            return jsonify({'error': '분석 결과가 없습니다.'}), 400
        
        analysis_result = data['analysis_result']
        analysis_type = data.get('analysis_type', 'deepfake')
        
        # tmp 디렉토리 생성
        tmp_dir = os.path.join(os.getcwd(), 'tmp')
        if not os.path.exists(tmp_dir):
            os.makedirs(tmp_dir)
        
        # PDF 파일 경로 생성
        pdf_filename = f"evidence_{uuid.uuid4().hex}_{datetime.now().strftime('%Y%m%d%H%M%S')}.pdf"
        pdf_path = os.path.join(tmp_dir, pdf_filename)
        
        # PDF 생성
        generate_pdf_report(analysis_result, pdf_path, analysis_type)
        
        if not os.path.exists(pdf_path):
            return jsonify({'error': 'PDF 파일 생성에 실패했습니다.'}), 500
        
        current_app.logger.info(f"PDF 생성 완료: {pdf_path}")
        
        # PDF 파일 전송
        return send_file(
            pdf_path,
            mimetype='application/pdf',
            as_attachment=True,
            download_name=pdf_filename
        )
        
    except Exception as e:
        current_app.logger.error(f"API PDF 생성 오류: {e}")
        import traceback
        current_app.logger.error(traceback.format_exc())
        return jsonify({'error': f'PDF 생성 중 오류 발생: {str(e)}'}), 500
```

---

## 5. app/services.py
이 파일은 서버의 핵심 비즈니스 로직을 담당하며, 딥페이크 분석, 사이버폭력 분석, PDF 생성 등의 기능을 제공합니다.

**위치**: `ansimtalk (2)/app/services.py`

**주요 기능**:
- `analyze_file()`: 파일 분석 메인 함수 (딥페이크/사이버폭력)
- `analyze_image_with_sightengine()`: Sightengine API로 딥페이크 탐지
- `extract_text_from_image()`: Google Cloud Vision API로 OCR 수행
- `analyze_text_with_gemini()`: Google Gemini API로 사이버폭력 분석
- `generate_pdf_report()`: WeasyPrint로 PDF 보고서 생성
- `_preprocess_kakao_chat_text()`: 카카오톡 대화 텍스트 전처리

```python
import requests
import json
from flask import current_app
import os
from PIL import Image
import hashlib
from datetime import datetime
from weasyprint import HTML
from google.cloud import vision
from google import genai
import re

def convert_markdown_table_to_html(markdown_table):
    """마크다운 표를 HTML 표로 변환"""
    if not markdown_table.strip():
        return "<p>분석 결과가 없습니다.</p>"
    
    lines = markdown_table.strip().split('\n')
    if len(lines) < 2:
        return f"<p>표 형식이 올바르지 않습니다: {markdown_table}</p>"
    
    html_lines = ['<table class="analysis-table">']
    
    for i, line in enumerate(lines):
        line = line.strip()
        if not line.startswith('|'):
            continue
            
        # 파이프 제거하고 셀 분리
        cells = [cell.strip() for cell in line.split('|')[1:-1]]
        
        if i == 0:
            # 헤더 행
            html_lines.append('  <thead>')
            html_lines.append('    <tr>')
            for cell in cells:
                html_lines.append(f'      <th>{cell}</th>')
            html_lines.append('    </tr>')
            html_lines.append('  </thead>')
            html_lines.append('  <tbody>')
        elif i == 1 and '---' in line:
            # 구분선 행은 건너뛰기
            continue
        else:
            # 데이터 행
            html_lines.append('    <tr>')
            for j, cell in enumerate(cells):
                # 위험도에 따른 CSS 클래스 추가
                if j == 4:  # 위험도 컬럼 (5번째)
                    risk_class = get_risk_class(cell)
                    html_lines.append(f'      <td class="{risk_class}">{cell}</td>')
                else:
                    html_lines.append(f'      <td>{cell}</td>')
            html_lines.append('    </tr>')
    
    html_lines.append('  </tbody>')
    html_lines.append('</table>')
    
    result = '\n'.join(html_lines)
    print(f"변환된 HTML 테이블: {result[:300]}...")
    return result

def get_risk_class(risk_text):
    """위험도 텍스트에 따른 CSS 클래스 반환"""
    risk_text = risk_text.strip().lower()
    if '심각' in risk_text:
        return 'risk-severe'
    elif '있음' in risk_text:
        return 'risk-present'
    elif '약간' in risk_text:
        return 'risk-slight'
    elif '의심' in risk_text:
        return 'risk-suspicion'
    elif '없음' in risk_text:
        return 'risk-none'
    else:
        return ''

def get_image_metadata(filepath):
    try:
        img = Image.open(filepath)
        metadata = {
            "format": img.format,
            "mode": img.mode,
            "size": img.size, # (width, height)
            "info": img.info # Exif data, etc.
        }
        return metadata
    except Exception as e:
        return {"error": f"메타데이터 추출 실패: {e}"}

def analyze_file(file_path, analysis_type, file_extension):
    with open(file_path, 'rb') as f:
        sha256 = hashlib.sha256(f.read()).hexdigest()
    
    # 파일명 처리 (한글 지원)
    try:
        filename = os.path.basename(file_path)
    except UnicodeDecodeError:
        # 한글 파일명 처리 오류 시 대체 방법
        filename = os.path.basename(file_path).encode('utf-8', errors='replace').decode('utf-8')
    
    result = {
        'file_info': {
            'filename': filename,
            'type': file_extension,
            'size_bytes': os.path.getsize(file_path),
            'sha256': sha256
        },
        'analysis_timestamp': datetime.now().isoformat(),
        'sha256': sha256,
        'analysis_type': analysis_type # Add analysis_type to result
    }

    if analysis_type == 'deepfake':
        if file_extension in {'png', 'jpg', 'jpeg'}:
            result['deepfake_analysis'] = analyze_image_with_sightengine(file_path)
            # For deepfake analysis, we might still want to extract text if present
            extracted_text = extract_text_from_image(file_path)
            if extracted_text.strip():
                result['extracted_text'] = extracted_text
        else:
            result['error'] = '딥페이크 분석은 이미지 파일만 지원합니다.'

    elif analysis_type == 'cyberbullying':
        if file_extension in {'png', 'jpg', 'jpeg'}:
            extracted_text = extract_text_from_image(file_path)
            # 카톡 OCR 전처리로 '발화자: 내용' 재구성
            if extracted_text and not extracted_text.startswith('['):
                extracted_text = _preprocess_kakao_chat_text(extracted_text)
        if file_extension in {'png', 'jpg', 'jpeg'}:
            extracted_text = extract_text_from_image(file_path)
            if extracted_text and not extracted_text.startswith('['):
                extracted_text = _preprocess_kakao_chat_text(extracted_text)
            if extracted_text.strip():
                gemini_result = analyze_text_with_gemini(extracted_text)
                result['extracted_text'] = extracted_text
                result['cyberbullying_analysis'] = gemini_result.get('table', '')
                result['cyberbullying_analysis_summary'] = gemini_result.get('summary', '')
                result['cyberbullying_risk_line'] = extract_risk_line(gemini_result.get('summary', ''))
            else:
                result['error'] = '이미지에서 텍스트를 추출할 수 없습니다.'
        elif file_extension == 'txt':
            # 한글 텍스트 파일 읽기 (다양한 인코딩 지원)
            try:
                with open(file_path, 'r', encoding='utf-8') as f:
                    text = f.read()
            except UnicodeDecodeError:
                # UTF-8 실패 시 다른 인코딩 시도
                try:
                    with open(file_path, 'r', encoding='cp949') as f:
                        text = f.read()
                except UnicodeDecodeError:
                    with open(file_path, 'r', encoding='utf-8', errors='replace') as f:
                        text = f.read()
            # TXT도 카톡 포맷일 수 있으므로 동일 전처리 적용
            normalized = _preprocess_kakao_chat_text(text)
            gemini_result = analyze_text_with_gemini(normalized)
            result['extracted_text'] = normalized
            result['cyberbullying_analysis'] = gemini_result.get('table', '')
            result['cyberbullying_analysis_summary'] = gemini_result.get('summary', '')
            result['cyberbullying_risk_line'] = extract_risk_line(gemini_result.get('summary', ''))
        else:
            result['error'] = '사이버폭력 분석은 텍스트 또는 이미지 파일만 지원합니다.'
    else:
        result['error'] = '알 수 없는 분석 타입입니다.'

    return result

def analyze_image_with_sightengine(file_path):
    api_user = current_app.config['SIGHTENGINE_API_USER']
    api_secret = current_app.config['SIGHTENGINE_API_SECRET']
    url = 'https://api.sightengine.com/1.0/check.json'
    files = {'media': open(file_path, 'rb')}
    params = {
        'models': 'deepfake,offensive,nudity,wad',
        'api_user': api_user,
        'api_secret': api_secret
    }
    try:
        response = requests.post(url, files=files, data=params)
        response.raise_for_status()
        result = response.json()
        
        # 디버깅을 위한 로그 출력
        print(f"Sightengine API 응답: {result}")
        
        return result
    except Exception as e:
        print(f"Sightengine API 오류: {e}")
        return {'error': str(e)}
    finally:
        files['media'].close()

def extract_text_from_image(image_path):
    # Railway 환경에서 환경 변수로 설정된 서비스 계정 키 사용
    import json
    from google.oauth2 import service_account
    
    try:
        # 환경 변수에서 서비스 계정 키 JSON 가져오기
        service_account_info = os.environ.get('GOOGLE_SERVICE_ACCOUNT_JSON')
        if service_account_info:
            # JSON 문자열을 파싱하여 서비스 계정 정보 생성
            service_account_dict = json.loads(service_account_info)
            credentials = service_account.Credentials.from_service_account_info(service_account_dict)
            client = vision.ImageAnnotatorClient(credentials=credentials)
        else:
            # 기존 방식 (로컬 파일)
            credentials_path = current_app.config['GOOGLE_APPLICATION_CREDENTIALS']
            if os.path.exists(credentials_path):
                os.environ["GOOGLE_APPLICATION_CREDENTIALS"] = credentials_path
                client = vision.ImageAnnotatorClient()
            else:
                print("Google Cloud 인증 정보가 설정되지 않았습니다")
                return "[Google Cloud 인증 정보가 설정되지 않았습니다. 관리자에게 문의하세요.]"
        
        with open(image_path, "rb") as image_file:
            content = image_file.read()
        image = vision.Image(content=content)
        response = client.text_detection(image=image)
        texts = response.text_annotations
        if not texts:
            return ""
        return texts[0].description.strip()
    except Exception as e:
        print(f"Google Cloud Vision API 오류: {e}")
        return f"[Google Cloud Vision API 오류: {e}]"

def _preprocess_kakao_chat_text(raw_text: str) -> str:
    """카카오톡 OCR 텍스트를 분석 친화적으로 정규화하여
    각 발화를 '이름: 내용' 단일 행으로 재구성한다.

    규칙:
    - 시간/날짜/시스템 라인 제거
    - 단독 이름 라인 + 다음 내용 라인을 병합하여 '이름: 내용'
    - 이름을 알 수 없으면 '-: 내용'
    - 셀 내부 개행을 최소화하기 위해 연속 공백을 1칸으로 정규화
    """
    if not raw_text:
        return ""

    # 패턴 정의
    time_pattern = re.compile(r'^(?:오전|오후)\s?\d{1,2}:\d{2}$')
    date_time_pattern = re.compile(r'^\d{4}[./-]\s?\d{1,2}[./-]\s?\d{1,2}(?:\s+(?:오전|오후)\s?\d{1,2}:\d{2})?$')
    # 명시적 잡음만 제거 (역할명은 제거하지 않음)
    noise_exact = {"사진", "이모티콘"}
    possible_name_pattern = re.compile(r'^[가-힣A-Za-z0-9_]{1,16}$')

    lines = [ln.strip() for ln in raw_text.splitlines()]
    processed: list[str] = []
    pending_speaker: str | None = None

    for ln in lines:
        if not ln:
            continue
        # 시간/날짜 라인 제거
        if time_pattern.match(ln) or date_time_pattern.match(ln):
            continue
        # 명확한 잡음 라인 제거
        if ln in noise_exact:
            continue
        # 너무 짧은 한 글자 잡음 제거
        if len(ln) == 1 and ln in {"-", ".", ","}:
            continue
        # 이미 '이름: 내용' 형태면 그대로 반영
        if ':' in ln and not ln.endswith(':'):
            # 전각 콜론 등은 ASCII 콜론으로 통일
            ln = ln.replace('：', ':')
            # 다중 콜론은 첫 콜론만 분리하여 이름: 내용 보장
            parts = ln.split(':', 1)
            speaker = parts[0].strip()
            content = parts[1].strip()
            if not speaker:
                speaker = '-'
            if not content:
                continue
            processed.append(f"{speaker}: {re.sub(r'\s+', ' ', content)}")
            pending_speaker = None
            continue

        # 이름 후보만 있는 라인 감지
        if possible_name_pattern.match(ln):
            pending_speaker = ln
            continue

        # 일반 내용 라인
        content = re.sub(r'\s+', ' ', ln)
        if pending_speaker:
            processed.append(f"{pending_speaker}: {content}")
            pending_speaker = None
        else:
            processed.append(f"-: {content}")

    # 잔여 대기 이름 제거
    return "\n".join(processed)

def analyze_text_with_gemini(text_content):
    # Railway 환경에서 환경 변수로 설정된 서비스 계정 키 사용
    import json
    from google.oauth2 import service_account
    
    try:
        # 1) API Key 우선 사용 (Vertex 설정/결제 없이 동작 가능)
        raw_key = os.environ.get('GOOGLE_GEMINI_API_KEY') or current_app.config.get('GOOGLE_GEMINI_API_KEY')
        api_key = raw_key.strip() if isinstance(raw_key, str) else None
        # 흔한 placeholder/무효 키 패턴 차단
        if api_key and (api_key.lower().startswith('your-') or api_key.lower().startswith('aizasy') or api_key.endswith('-lo') or len(api_key) < 25):
            print(f"무효한 Gemini API Key 패턴 감지 (길이: {len(api_key)}, 시작: {api_key[:10]}...) → Vertex 경로 시도")
            api_key = None
        
        # API Key 모드 시도 (유효성 미리 검증 불가하므로 Vertex 경로도 준비)
        client_initialized = False
        if api_key:
            try:
                client = genai.Client(api_key=api_key)
                print(f"Gemini Client 초기화: API Key 모드 (키 길이: {len(api_key)})")
                client_initialized = True
            except Exception as key_err:
                print(f"API Key 모드 초기화 실패: {key_err} → Vertex 경로로 전환")
                api_key = None
        
        if not client_initialized:
            # 환경 변수에서 서비스 계정 키 JSON 가져오기
            service_account_info = os.environ.get('GOOGLE_SERVICE_ACCOUNT_JSON')
            if service_account_info:
                # JSON 문자열을 파싱하여 서비스 계정 정보 생성
                service_account_dict = json.loads(service_account_info)
                
                # 명시적 범위 지정 - 이것이 핵심 해결책!
                scopes = ["https://www.googleapis.com/auth/cloud-platform"]
                credentials = service_account.Credentials.from_service_account_info(
                    service_account_dict,
                    scopes=scopes
                )
                
                project_id = service_account_dict.get('project_id') or current_app.config.get('GCP_PROJECT') or 'us-central1'
                location = os.environ.get('GEMINI_LOCATION', 'us-central1')
                client = genai.Client(
                    vertexai=True,
                    project=project_id,
                    location=location,
                    credentials=credentials
                )
                print(f"Vertex 모드: project={project_id}, location={location} (서비스 계정/명시적 범위)")
            else:
                # 기존 방식 (로컬 파일)
                credentials_path = current_app.config['GOOGLE_APPLICATION_CREDENTIALS']
                if os.path.exists(credentials_path):
                    # 로컬 파일에서도 명시적 범위 지정
                    scopes = ["https://www.googleapis.com/auth/cloud-platform"]
                    credentials = service_account.Credentials.from_service_account_file(
                        credentials_path,
                        scopes=scopes
                    )
                    # 파일에서 project_id 유도
                    try:
                        with open(credentials_path, 'r', encoding='utf-8') as _f:
                            _cred_json = json.load(_f)
                            project_id = _cred_json.get('project_id')
                    except Exception:
                        project_id = current_app.config.get('GCP_PROJECT')
                    if not project_id:
                        project_id = 'dazzling-howl-465316-m7'
                    location = os.environ.get('GEMINI_LOCATION', 'us-central1')
                    client = genai.Client(
                        vertexai=True,
                        project=project_id,
                        location=location,
                        credentials=credentials
                    )
                    print(f"Vertex 모드(로컬 키): project={project_id}, location={location}, key={os.path.basename(credentials_path)}")
                else:
                    print("Google Cloud 인증 정보가 설정되지 않았습니다")
                    print(f"환경 변수 GOOGLE_SERVICE_ACCOUNT_JSON: {'설정됨' if os.environ.get('GOOGLE_SERVICE_ACCOUNT_JSON') else '설정되지 않음'}")
                    print(f"로컬 파일 경로: {credentials_path}")
                    return {"table": '', "summary": 'Google Cloud 인증 정보가 설정되지 않았습니다. 관리자에게 문의하세요.'}
    except Exception as e:
        print(f"Google Cloud 인증 설정 오류: {e}")
        return {"table": '', "summary": f'Google Cloud 인증 설정 오류: {e}'}
    
    # 모델: Gemini 2.5 Flash (공식 문서 기준 최신 플래시 계열)
    # 참고: https://ai.google.dev/gemini-api/docs/models?hl=ko
    model = "gemini-2.5-flash"
    # 발화자 이름에서 역할 힌트 추출
    speakers = set([ln.split(':',1)[0].strip() for ln in _preprocess_kakao_chat_text(text_content).split('\n') if ':' in ln])
    role_hints = []
    for sp in speakers:
        if re.search(r'가해자|주동자', sp):
            role_hints.append(f"{sp} 는 가해자/주동자일 가능성이 큼")
        if re.search(r'피해자', sp):
            role_hints.append(f"{sp} 는 피해자일 가능성이 큼")
    hints_text = "\n".join(role_hints) if role_hints else "(역할 힌트 없음)"

    prompt = f"""
# 페르소나 (Persona)
당신은 사이버폭력 분석을 전문으로 하는 AI 애널리스트입니다. 주어진 대화 내용을 문장 단위로 정밀하게 분석하여 폭력성, 유형, 가해자, 피해자, 위험도를 판별하는 임무를 수행합니다. 모든 답변은 요청된 형식에 따라 매우 엄격하게 작성해야 합니다.

# 분석 대상 대화
[ {text_content} ]

# 역할 힌트 (참고용, 텍스트와 불일치시 텍스트 우선):
{hints_text}

# 출력 형식 (Output Format)
아래 규칙을 반드시, 100% 준수하여 결과를 생성해야 합니다.

1.  **결과는 반드시 마크다운 표(Markdown Table)로 시작**해야 합니다.
2.  표의 위나 아래에 제목, 코드 블록, 설명 등 **어떠한 다른 텍스트도 추가하지 마세요.**
3.  표의 열(Column)은 `문장`, `유형`, `피해자`, `가해자`, `위험도`, `해설` 순서여야 하며, **절대 순서를 바꾸거나 합치지 마세요.**
4.  `문장`은 반드시 `발화자: 내용` 형식으로 작성하세요. 발화자 정보가 없으면 `-: 내용`으로 작성합니다. 카카오톡 대화처럼 발화자(이름/닉네임)과 메시지 내용을 `:`로 연결합니다. 전각 문자가 아닌 ASCII 콜론 `:`만 사용하세요.
5.  모든 셀에는 **줄바꿈을 절대 포함하지 마세요**. 셀 내부 개행(`\n`), 파이프(`|`), 백틱, 코드블록 표시는 금지합니다. 줄바꿈이 필요한 경우 **공백 하나**로 대체합니다.
6.  `유형`은 `욕설`, `비하`, `모욕`, `따돌림`, `위협`, `괴롭힘` 중에서만 선택하고, 해당 없으면 `-`로 표기하세요.
7.  `위험도`는 `없음`, `의심`, `약간 있음`, `있음`, `심각` 중에서만 선택하세요.
8.  `해설`은 판단 근거를 **한 줄로** 간결하게 요약하세요. 사례/근거를 쉼표로 나열하되 줄바꿈은 금지합니다.
9.  **표 바로 아래에는 다음 세 가지 항목을 순서대로, 정확한 문구로 작성**해야 합니다. 각 항목 앞에는 줄바꿈 한 번만 허용합니다.
    * `전체 대화 사이버폭력 위험도:` [없음/의심/약간 있음/있음/심각] 중 하나로 결론
    * `대화 전체 분위기 요약:` 2~3문장으로 요약 (줄바꿈 없이 한 줄)
    * `잠재적 위험/주의사항:` 구체적인 내용 서술 (줄바꿈 없이 한 줄)

# 발화자/역할 추정 규칙 (엄격 적용)
1) 발화자명에 `가해자`, `주동자`가 포함되면 그 사람은 가해자.
2) 발화자명에 `피해자`가 포함되면 피해자.
3) 발화자명이 `-`(미확정)인 경우 기본적으로 피해자(추정)로 간주하되, 문맥이 명백히 공격/강요/조롱이면 가해자로 표기.
4) 다음 표현은 피해자 단서: `내돈`, `싫은데`, `알겠어`, `사줄게`, `안돼`, `무서워`, `그만`.
5) 다음 표현은 가해자 단서: `내가 하라면 해`, `사와`, `사줘`, `돈`, `빨리`, `시키는 대로`, `말 안듣네`.
6) 금전/물품 강요(`사와/사줘/내가 시킨 대로` 등)와 모욕/조롱/협박은 각각 `괴롭힘`, `모욕`, `위협`으로 분류.
7) 표의 `피해자`, `가해자` 열에는 이름(또는 `피해자(추정)`, `가해자(추정)`)을 명시.

# 출력 예시 (Example)
아래는 당신이 따라야 할 완벽한 출력 예시입니다. 띄어쓰기, 줄 바꿈까지 정확히 일치시켜야 합니다.

| 문장 | 유형 | 피해자 | 가해자 | 위험도 | 해설 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| 너 때문에 다 망했어 | 비하 | 민수 | 철수 | 있음 | 특정인의 탓으로 돌리며 비난하는 발언 |
| 그런 애랑 말 섞지 마 | 따돌림 | 민수 | 철수 | 심각 | 관계에서 명시적으로 배제하려는 의도를 보임 |
| 그냥 사라져 버려 | 위협 | 민수 | 철수 | 심각 | 극단적인 언어로 공포심을 유발하는 발언 |

전체 대화 사이버폭력 위험도: 심각

대화 전체 분위기 요약: 한 명을 대상으로 여러 명이 비난과 따돌림, 위협적인 발언을 이어가고 있습니다. 대화가 진행될수록 공격의 수위가 높아지는 양상입니다.

잠재적 위험/주의사항: 직접적인 위협과 사회적 배제는 피해자에게 심각한 정신적 고통을 줄 수 있습니다. 즉각적인 개입과 보호 조치가 필요한 상황입니다.
"""
    try:
        print(f"========== Gemini API 호출 시작 ==========")
        print(f"모델: {model}")
        print(f"Client 타입: {type(client).__name__}")
        print(f"프롬프트 길이: {len(prompt)} 문자")
        response = client.models.generate_content(
            model=model,
            contents=prompt
        )
        result_text = response.text.strip()
        print(f"========== Gemini API 호출 성공! ==========")
        print(f"응답 길이: {len(result_text)} 문자")
        # 표와 표 아래 3줄 분리
        lines = result_text.splitlines()
        table_lines = []
        summary_lines = []
        in_table = False
        
        for line in lines:
            s = line.strip()
            # 표 시작 조건을 완화: 파이프(|)로 시작하면 표로 인식
            if s.startswith("|"):
                in_table = True
            if in_table:
                if s == '' and table_lines:
                    in_table = False
                elif s.startswith("|"):
                    # 셀 내부 개행이 있었다면 공백 하나로 정규화하여 단일 행 유지
                    table_lines.append(s.replace("\t", " "))
                else:
                    in_table = False
            elif table_lines and not in_table:
                if s:
                    summary_lines.append(s)
        
        table = "\n".join(table_lines)
        summary_raw = "\n".join(summary_lines).strip()
        
        # 각 항목 앞에 빈 줄을 강제로 삽입
        summary = re.sub(r'(전체 대화 사이버폭력 위험도:)', r'\n\1', summary_raw)
        summary = re.sub(r'(대화 전체 분위기 요약:)', r'\n\1', summary)
        summary = re.sub(r'(잠재적 위험/주의사항:)', r'\n\1', summary)
        summary = summary.strip()
        # 연속된 \n 2개를 \n\n으로 정규화
        summary = re.sub(r'\n{2,}', '\n\n', summary)
        
        # 마크다운 표를 HTML로 변환
        html_table = convert_markdown_table_to_html(table)
        
        return {"table": html_table, "summary": summary}
    except Exception as e:
        print(f"========== Gemini API 호출 실패 ==========")
        print(f"오류 타입: {type(e).__name__}")
        print(f"오류 메시지: {e}")
        import traceback
        error_detail = traceback.format_exc()
        print(f"상세 오류:\n{error_detail}")
        print("========== Fallback 분석으로 전환 ==========")
        # API 오류 시 대체 분석 제공
        fb = _fallback_cyberbullying_analysis(text_content)
        fb['fallback_used'] = True
        fb['error'] = f"{type(e).__name__}: {str(e)}"
        fb['error_detail'] = error_detail
        return fb

def _fallback_cyberbullying_analysis(text_content):
    """Gemini API 실패 시 대체 사이버폭력 분석"""
    print(f"대체 사이버폭력 분석 시작: {text_content[:100]}...")
    
    try:
        # 더 정교한 키워드 기반 분석
        text_lower = text_content.lower()
        
        # 위험 키워드 정의 (더 상세하게)
        violent_keywords = ['죽어', '디져', '죽여', '때려', '패줄', '꺼져', '사라져', '바보', '멍청이', '개새끼', '병신', '존재 자체가 죄', '못생겨서']
        threat_keywords = ['까먹으면', '안하면', '안되면', '그러면', '그럼', '디진다']
        bullying_keywords = ['그런 애랑', '말 섞지 마', '따돌려', '무시해', '놀려', '살빼돼지']
        derogatory_keywords = ['비하', '모욕', '욕설', 'X아', 'X야']
        
        # 문장별 분석
        # 전처리: 카톡 구조 정규화
        normalized_text = _preprocess_kakao_chat_text(text_content)
        sentences = normalized_text.split('\n')
        analysis_lines = []
        risk_count = 0
        severe_count = 0
        
        for sentence in sentences:
            sentence = sentence.strip()
            if not sentence:
                continue

            # 발화자/내용 분리
            speaker, content = ('-', sentence)
            if ':' in sentence:
                sp, ct = sentence.split(':', 1)
                speaker = sp.strip() or '-'
                content = ct.strip()

            risk_level = "없음"
            risk_type = "-"
            explanation = "일반적인 대화 내용"
            victim = "-"
            offender = "-"

            # 역할 단서: 이름 기반
            if re.search(r'가해자|주동자', speaker):
                offender = speaker
            if re.search(r'피해자', speaker):
                victim = speaker

            # 더 정교한 위험도 판단 및 역할 보정
            low = content.lower()
            if any(keyword in low for keyword in violent_keywords):
                if '존재 자체가 죄' in content or '못생겨서' in content:
                    risk_level = "심각"
                    risk_type = "비하"
                    explanation = "존재 자체를 부정하거나 외모를 비하하는 극단적 발언"
                else:
                    risk_level = "심각"
                    risk_type = "욕설"
                    explanation = "폭력적이거나 모욕적인 표현 포함"
                offender = offender if offender != '-' else speaker
                risk_count += 1
                severe_count += 1
            elif any(keyword in low for keyword in threat_keywords):
                risk_level = "있음"
                risk_type = "위협"
                explanation = "협박/강요 또는 조건부 위협적 표현"
                offender = offender if offender != '-' else speaker
                risk_count += 1
            elif any(keyword in low for keyword in bullying_keywords):
                risk_level = "약간 있음"
                risk_type = "따돌림"
                explanation = "따돌리거나 배제하려는 의도"
                offender = offender if offender != '-' else speaker
                risk_count += 1
            elif any(keyword in low for keyword in derogatory_keywords):
                risk_level = "있음"
                risk_type = "비하"
                explanation = "비하적/모욕적 표현"
                offender = offender if offender != '-' else speaker
                risk_count += 1

            # 피해자 단서 (수용/거절/방어 표현)
            if victim == '-' and re.search(r'안돼|싫은데|무서워|그만|알겠어|사줄게', content):
                victim = speaker if speaker != '-' else '피해자(추정)'

            analysis_lines.append(f"| {speaker}: {content} | {risk_type} | {victim} | {offender} | {risk_level} | {explanation} |")
        
        # HTML 테이블 생성
        html_table = '<table class="analysis-table"><thead><tr><th>문장</th><th>유형</th><th>피해자</th><th>가해자</th><th>위험도</th><th>해설</th></tr></thead><tbody>'
        for line in analysis_lines:
            cells = [cell.strip() for cell in line.split('|')[1:-1]]
            html_table += '<tr>'
            for cell in cells:
                html_table += f'<td>{cell}</td>'
            html_table += '</tr>'
        html_table += '</tbody></table>'
        
        # 더 정교한 요약 생성
        if severe_count >= 2:
            risk_summary = "심각"
            mood_summary = f"키워드 기반 분석 결과, {risk_count}개의 위험 요소가 발견되었으며, 그 중 {severe_count}개가 심각한 수준입니다. 대화에서 폭력적이거나 모욕적인 표현이 다수 발견되어 즉각적인 개입이 필요한 상황입니다."
            warning = "심각한 사이버폭력 요소가 다수 발견되었습니다. 피해자 보호와 가해자 교육이 시급하며, 필요시 법적 조치를 고려해야 합니다. AI 분석 서비스 일시적 오류로 인해 기본 키워드 분석을 제공합니다."
        elif risk_count >= 3:
            risk_summary = "있음"
            mood_summary = f"키워드 기반 분석 결과, {risk_count}개의 위험 요소가 발견되었습니다. 대화에서 위협적이거나 비하적인 표현이 확인되어 주의가 필요한 상황입니다."
            warning = "사이버폭력 위험 요소가 다수 발견되었습니다. 지속적인 모니터링과 적절한 개입이 필요하며, 피해자 지원을 고려해야 합니다. AI 분석 서비스 일시적 오류로 인해 기본 키워드 분석을 제공합니다."
        elif risk_count >= 1:
            risk_summary = "약간 있음"
            mood_summary = f"키워드 기반 분석 결과, {risk_count}개의 위험 요소가 발견되었습니다. 대화에서 일부 부적절한 표현이 확인되어 주의가 필요한 상황입니다."
            warning = "사이버폭력 위험 요소가 발견되었습니다. 상황을 지켜보고 필요시 적절한 개입을 고려해야 합니다. AI 분석 서비스 일시적 오류로 인해 기본 키워드 분석을 제공합니다."
        else:
            risk_summary = "없음"
            mood_summary = "키워드 기반 분석 결과, 위험 요소가 발견되지 않았습니다. 대화 내용이 전반적으로 건전하고 적절한 수준을 유지하고 있습니다."
            warning = "현재 대화에서 사이버폭력 위험 요소가 발견되지 않았습니다. 지속적인 모니터링을 통해 건전한 대화 환경을 유지하는 것이 좋습니다. AI 분석 서비스 일시적 오류로 인해 기본 키워드 분석을 제공합니다."
        
        summary = f"""
전체 대화 사이버폭력 위험도: {risk_summary}

대화 전체 분위기 요약: {mood_summary}

잠재적 위험/주의사항: {warning}
"""
        
        return {"table": html_table, "summary": summary, "fallback_used": True}
        
    except Exception as e:
        print(f"대체 분석 오류: {e}")
        return {"table": "", "summary": f"분석 중 오류가 발생했습니다: {e}"}

def extract_risk_line(summary):
    """Gemini 분석 결과에서 위험도 라인을 추출"""
    if not summary:
        return None
    import re
    match = re.search(r'전체\s*대화\s*사이버폭력\s*위험도\s*:\s*([^\n\r]*)', summary, re.IGNORECASE)
    if match:
        value = match.group(1).strip()
        # 대괄호, 특수문자, 줄바꿈 등 모두 제거: 한글/영문/공백만 남김
        value = re.sub(r'^[\[\(\{\s]*', '', value)  # 앞쪽 괄호/공백 제거
        value = re.sub(r'[\]\)\}\s]*$', '', value)  # 뒤쪽 괄호/공백 제거
        return value.strip()
    return None

def extract_conversation_atmosphere(summary):
    """요약에서 대화 전체 분위기 요약 추출"""
    if not summary:
        return "분석 중..."
    
    import re
    # 정규표현식으로 "대화 전체 분위기 요약:" 다음의 내용을 추출
    pattern = r'대화\s*전체\s*분위기\s*요약\s*:\s*(.*?)(?=\n\s*잠재적\s*위험/주의사항\s*:|$)'
    match = re.search(pattern, summary, re.DOTALL | re.IGNORECASE)
    
    if match:
        result = match.group(1).strip()
        # 여러 줄을 하나로 합치고 불필요한 공백 제거
        result = re.sub(r'\s+', ' ', result)
        return result if result else "분석 중..."
    
    # 정규표현식으로 찾지 못한 경우 기존 방식 시도
    lines = summary.split('\n')
    for i, line in enumerate(lines):
        if '대화 전체 분위기 요약:' in line:
            # 다음 줄부터 다음 섹션까지의 내용을 가져옴
            atmosphere_lines = []
            for j in range(i + 1, len(lines)):
                if '잠재적 위험/주의사항:' in lines[j]:
                    break
                if lines[j].strip():
                    atmosphere_lines.append(lines[j].strip())
            result = ' '.join(atmosphere_lines)
            return result if result else "분석 중..."
    
    # fallback 분석 결과에서 직접 추출 시도
    if '키워드 기반 분석 결과' in summary:
        lines = summary.split('\n')
        for line in lines:
            if '키워드 기반 분석 결과' in line and '위험 요소' in line:
                return line.strip()
    
    return "분석 중..."

def extract_potential_risks(summary):
    """요약에서 잠재적 위험/주의사항 추출"""
    if not summary:
        return "분석 중..."
    
    import re
    # 정규표현식으로 "잠재적 위험/주의사항:" 다음의 내용을 추출
    pattern = r'잠재적\s*위험/주의사항\s*:\s*(.*)'
    match = re.search(pattern, summary, re.DOTALL | re.IGNORECASE)
    
    if match:
        result = match.group(1).strip()
        # 여러 줄을 하나로 합치고 불필요한 공백 제거
        result = re.sub(r'\s+', ' ', result)
        return result if result else "분석 중..."
    
    # 정규표현식으로 찾지 못한 경우 기존 방식 시도
    lines = summary.split('\n')
    for i, line in enumerate(lines):
        if '잠재적 위험/주의사항:' in line:
            # 다음 줄부터 끝까지의 내용을 가져옴
            risk_lines = []
            for j in range(i + 1, len(lines)):
                if lines[j].strip():
                    risk_lines.append(lines[j].strip())
            result = ' '.join(risk_lines)
            return result if result else "분석 중..."
    
    # fallback 분석 결과에서 직접 추출 시도
    if 'AI 분석 서비스 일시적 오류' in summary:
        lines = summary.split('\n')
        for line in lines:
            if 'AI 분석 서비스 일시적 오류' in line:
                return line.strip()
    
    return "분석 중..."

def pipe_table_to_html(text):
    """
    파이프(|) 구분 텍스트 표를 HTML <table>로 변환
    """
    import re
    lines = [line.strip() for line in text.splitlines() if line.strip()]
    table_lines = []
    summary_line = ""
    for i, line in enumerate(lines):
        if line.startswith("분위기 요약:"):
            summary_line = line
            break
        if "|" in line:
            table_lines.append(line)
    if not table_lines:
        return text  # 표가 없으면 원본 반환

    html = ['<table class="md-table">']
    for idx, row in enumerate(table_lines):
        cols = [c.strip() for c in row.split("|")]
        tag = "th" if idx == 0 else "td"
        html.append("<tr>" + "".join(f"<{tag}>{c}</{tag}>" for c in cols) + "</tr>")
    html.append("</table>")
    if summary_line:
        html.append(f'<div style="margin-top:8px;"><b>{summary_line}</b></div>')
    return "\n".join(html)



def generate_pdf_report(analysis_result, pdf_path, analysis_type=None):
    """법적 요건을 충족하는 전문적인 디지털 증거 분석 보고서 생성 - HTML 기반"""
    try:
        # HTML 템플릿 생성
        html_content = generate_report_html(analysis_result, analysis_type, pdf_path)
        
        # FontConfiguration 생성 (한글 폰트 지원)
        from weasyprint import HTML, CSS
        from weasyprint.text.fonts import FontConfiguration
        
        font_config = FontConfiguration()
        
        # CSS 스타일 추가 (한글 폰트 우선순위)
        css_content = """
        @font-face {
            font-family: 'Noto Sans KR';
            src: local('Noto Sans KR'), local('NotoSansKR-Regular');
            font-weight: normal;
            font-style: normal;
        }
        
        @font-face {
            font-family: 'Malgun Gothic';
            src: local('Malgun Gothic'), local('맑은 고딕');
            font-weight: normal;
            font-style: normal;
        }
        
        body {
            font-family: 'Noto Sans KR', 'Malgun Gothic', 'Arial', sans-serif !important;
        }
        
        * {
            font-family: 'Noto Sans KR', 'Malgun Gothic', 'Arial', sans-serif !important;
        }
        """
        
        # WeasyPrint로 PDF 생성 (폰트 설정 포함)
        HTML(string=html_content).write_pdf(
            pdf_path,
            font_config=font_config,
            stylesheets=[CSS(string=css_content)]
        )
        return pdf_path
        
    except Exception as e:
        print(f"HTML-based PDF generation failed: {e}")
        # 최후의 수단: 텍스트 파일 생성
        try:
            text_path = pdf_path.replace('.pdf', '.txt')
            with open(text_path, 'w', encoding='utf-8') as f:
                f.write("DIGITAL EVIDENCE ANALYSIS REPORT\n")
                f.write("AI-Based Deepfake and Cyberbullying Analysis\n")
                f.write("=" * 60 + "\n\n")
                f.write("EXPERT REPORT\n")
                f.write("Selected Expert: Legal-Tech Product Manager and Forensic Analyst\n\n")
                f.write("I. CASE AND EVIDENCE OVERVIEW\n")
                f.write("A. Case Information\n")
                f.write(f"Case Management Number: DF-CB-{datetime.now().strftime('%Y')}-001\n")
                f.write(f"Report ID: DF-CB-{datetime.now().strftime('%Y')}-001-v1.0\n")
                f.write(f"Issue Date: {datetime.now().strftime('%Y-%m-%d')}\n")
                f.write("Requesting Agency: Seoul Seocho Police Station Cyber Investigation Team\n")
                f.write("Lead Analyst: Senior Digital Forensic Analyst\n\n")
                f.write("II. AI-BASED FORENSIC ANALYSIS\n")
                f.write("A. Comprehensive Analysis Results\n")
                
                if analysis_type == 'deepfake' and 'deepfake_analysis' in analysis_result:
                    deepfake_analysis = analysis_result['deepfake_analysis']
                    if 'error' not in deepfake_analysis:
                        if deepfake_analysis.get('type', {}).get('deepfake'):
                            f.write(f"Deepfake Detection: {deepfake_analysis['type']['deepfake']:.1%} probability\n")
                
                elif analysis_type == 'cyberbullying' and 'cyberbullying_analysis_summary' in analysis_result:
                    summary = str(analysis_result['cyberbullying_analysis_summary'])
                    f.write(f"Cyberbullying Analysis: {summary[:500]}...\n" if len(summary) > 500 else f"Cyberbullying Analysis: {summary}\n")
                
                f.write(f"\nIII. EVIDENTIARY INTEGRITY\n")
                f.write(f"SHA-256 Hash: {analysis_result.get('sha256', 'N/A')}\n")
                f.write(f"Analysis Timestamp: {analysis_result.get('analysis_timestamp', 'N/A')}\n")
                f.write(f"Analysis Type: {analysis_type or 'N/A'}\n")
            
            return text_path
        except Exception as e2:
            print(f"Text file generation also failed: {e2}")
            raise e

def generate_image_html(original_image_path, analysis_result, original_file):
    """이미지를 Base64로 인코딩하여 HTML에 임베드"""
    import base64
    
    print(f"🔍 이미지 HTML 생성 시작...")
    
    # 파일 경로에서 이미지 찾기
    print(f"   original_image_path 인자: {original_image_path}")
    print(f"   uploaded_file_path: {analysis_result.get('uploaded_file_path', 'N/A')}")
    print(f"   static_file_path: {analysis_result.get('static_file_path', 'N/A')}")
    print(f"   file_path: {analysis_result.get('file_path', 'N/A')}")
    
    # 우선순위 1: file_path (분석에 사용된 원본 파일)
    file_path = analysis_result.get('file_path', '')
    if file_path and os.path.exists(file_path):
        original_image_path = file_path
        print(f"✅ file_path에서 이미지 찾음: {original_image_path}")
    # 우선순위 2: uploaded_file_path (실제 저장된 경로)
    elif analysis_result.get('uploaded_file_path', '') and os.path.exists(analysis_result.get('uploaded_file_path', '')):
        original_image_path = analysis_result.get('uploaded_file_path', '')
        print(f"✅ uploaded_file_path에서 이미지 찾음: {original_image_path}")
    # 우선순위 3: static_file_path
    elif analysis_result.get('static_file_path', '') and os.path.exists(analysis_result.get('static_file_path', '')):
        original_image_path = analysis_result.get('static_file_path', '')
        print(f"✅ static_file_path에서 이미지 찾음: {original_image_path}")
    # 우선순위 4: 기존 original_image_path
    elif original_image_path and os.path.exists(original_image_path):
        print(f"✅ 인자로 전달된 경로에서 이미지 찾음: {original_image_path}")
    # 우선순위 5: 파일명으로 다양한 경로 탐색
    else:
        filename = original_file.get('filename', '')
        print(f"   파일명으로 탐색 시작: {filename}")
        possible_paths = [
            f'/app/tmp/{filename}',
            f'/app/static/uploads/{filename}',
            f'/app/app/static/uploads/{filename}',
            os.path.join(os.getcwd(), 'tmp', filename),
            os.path.join('tmp', filename),
            os.path.join('app', 'static', 'uploads', filename),
            os.path.join('static', 'uploads', filename),
            os.path.join(os.getcwd(), 'app', 'static', 'uploads', filename),
            os.path.join(os.getcwd(), 'static', 'uploads', filename),
        ]
        
        for path in possible_paths:
            if path and os.path.exists(path):
                original_image_path = path
                print(f"✅ 탐색 경로에서 이미지 찾음: {original_image_path}")
                break
        else:
            print(f"❌ 모든 경로에서 이미지를 찾지 못함")
    
    # 이미지를 Base64로 인코딩
    if original_image_path and os.path.exists(original_image_path):
        try:
            with open(original_image_path, 'rb') as img_file:
                img_data = img_file.read()
                base64_img = base64.b64encode(img_data).decode('utf-8')
                
                # 이미지 확장자 확인
                ext = os.path.splitext(original_image_path)[1].lower()
                mime_type = {
                    '.jpg': 'image/jpeg',
                    '.jpeg': 'image/jpeg',
                    '.png': 'image/png',
                    '.gif': 'image/gif',
                    '.webp': 'image/webp'
                }.get(ext, 'image/jpeg')
                
                print(f"✅ 이미지 Base64 인코딩 완료: {len(base64_img)} bytes, MIME: {mime_type}")
                
                return f'<img class="evidence" src="data:{mime_type};base64,{base64_img}" alt="원본 증거 이미지" style="max-width: 100%; height: auto;"/>'
        except Exception as e:
            print(f"❌ 이미지 인코딩 실패: {e}")
    
    # 이미지를 찾을 수 없을 때 - 디버깅 정보 상세 출력
    print(f"❌❌❌ 최종: 이미지를 찾을 수 없음")
    print(f"   파일명: {original_file.get('filename', 'N/A')}")
    print(f"   시도한 경로: {original_image_path if original_image_path else '없음'}")
    print(f"   현재 작업 디렉토리: {os.getcwd()}")
    
    # tmp 디렉토리 내용 확인
    tmp_paths = ['/app/tmp', os.path.join(os.getcwd(), 'tmp')]
    for tmp_path in tmp_paths:
        if os.path.exists(tmp_path):
            try:
                files = os.listdir(tmp_path)
                print(f"   📂 {tmp_path} 내용: {files[:10]}")  # 처음 10개만
            except Exception as e:
                print(f"   📂 {tmp_path} 읽기 실패: {e}")
    
    return f'''<div style="background: #f8f9fa; border: 2px dashed #dee2e6; padding: 20px; text-align: center; color: #6c757d;">
        <p><strong>⚠️ 원본 이미지를 찾을 수 없습니다</strong></p>
        <p>파일명: {original_file.get("filename", "N/A")}</p>
        <p>시도한 경로: {original_image_path if original_image_path else "없음"}</p>
        <p>현재 작업 디렉토리: {os.getcwd()}</p>
    </div>'''

def generate_report_html(analysis_result, analysis_type=None, pdf_path=None):
    """보고서 HTML 템플릿 생성"""
    original_file = analysis_result.get('file_info', {})
    
    # 분석 결과 텍스트 생성
    analysis_text = ""
    if analysis_type == 'deepfake' and 'deepfake_analysis' in analysis_result:
        deepfake_analysis = analysis_result['deepfake_analysis']
        if 'error' not in deepfake_analysis:
            if deepfake_analysis.get('type', {}).get('deepfake'):
                prob = deepfake_analysis['type']['deepfake']
                analysis_text = f"딥페이크일 확률: {prob:.1%}"
            else:
                analysis_text = "딥페이크일 확률: N/A%"
        else:
            analysis_text = f"딥페이크 분석 오류: {str(deepfake_analysis['error'])[:100]}"
    
    elif analysis_type == 'cyberbullying' and 'cyberbullying_risk_line' in analysis_result:
        risk_line = analysis_result['cyberbullying_risk_line']
        analysis_text = f"전체 대화 사이버폭력 위험도: {risk_line}"
    
    # 보고서 ID 및 생성일시
    report_id = f"DF-CB-{datetime.now().strftime('%Y')}-001-v1.0"
    created_at = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
    
    # 파일 정보
    filename = str(original_file.get('filename', 'N/A'))
    file_size = str(original_file.get('size_bytes', 'N/A'))
    sha256 = str(analysis_result.get('sha256', 'N/A'))
    
    # 원본 이미지 경로 찾기 - 개선된 방식
    original_image_path = analysis_result.get('original_image_path', '')
    
    # 세션에서 저장된 경로 정보 활용
    if not original_image_path:
        # 분석 결과에서 직접 경로 정보 확인
        original_image_path = analysis_result.get('static_file_path', '')
        if not original_image_path:
            original_image_path = analysis_result.get('uploaded_file_path', '')
    
    # 파일명으로 이미지 찾기 (fallback)
    if not original_image_path and 'filename' in original_file:
        filename = original_file['filename']
        # Railway 환경을 고려한 절대 경로와 상대 경로 모두 확인
        possible_paths = [
            # Railway 환경의 절대 경로
            f'/app/tmp/{filename}',
            f'/app/static/uploads/{filename}',
            f'/app/app/static/uploads/{filename}',
            # 상대 경로
            os.path.join('app', 'static', 'uploads', filename),
            os.path.join('static', 'uploads', filename),
            os.path.join('tmp', filename),
            os.path.join('uploads', filename),
            # 현재 작업 디렉토리 기준
            os.path.join(os.getcwd(), 'app', 'static', 'uploads', filename),
            os.path.join(os.getcwd(), 'static', 'uploads', filename),
            os.path.join(os.getcwd(), 'tmp', filename),
            os.path.join(os.getcwd(), 'uploads', filename),
            # 파일 업로드 시 저장된 경로
            analysis_result.get('file_path', ''),
            analysis_result.get('upload_path', '')
        ]
        
        for path in possible_paths:
            if path and os.path.exists(path):
                original_image_path = os.path.abspath(path)
                print(f"이미지 경로 찾음: {original_image_path}")
                break
    
    # 웹 경로 생성 - Railway 환경 고려
    web_image_path = ""
    if original_image_path and os.path.exists(original_image_path):
        # 파일명만 추출하여 웹 경로 생성
        filename = os.path.basename(original_image_path)
        # Railway 환경에서는 /app/tmp/ 경로의 파일도 /static/uploads/로 접근 가능
        web_image_path = f'/static/uploads/{filename}'
        print(f"웹 이미지 경로: {web_image_path}")
        print(f"원본 이미지 경로: {original_image_path}")
    else:
        print(f"이미지 경로를 찾을 수 없음: {original_image_path}")
        print(f"파일명: {original_file.get('filename', 'N/A')}")
        # 현재 작업 디렉토리와 가능한 경로들 출력
        print(f"현재 작업 디렉토리: {os.getcwd()}")
        print(f"tmp 디렉토리 존재: {os.path.exists('/app/tmp')}")
        print(f"static/uploads 디렉토리 존재: {os.path.exists('/app/static/uploads')}")
        
        # 파일명만으로도 웹 경로 생성 시도
        if 'filename' in original_file:
            web_image_path = f'/static/uploads/{original_file["filename"]}'
            
        # 분석 결과에서 파일 경로 정보 확인
        if 'file_path' in analysis_result:
            print(f"분석 결과의 file_path: {analysis_result['file_path']}")
        if 'upload_path' in analysis_result:
            print(f"분석 결과의 upload_path: {analysis_result['upload_path']}")

    # 추가 정보 추출
    uploader_id = analysis_result.get('uploader_id', 'N/A')
    uploader_ip = analysis_result.get('uploader_ip', 'N/A')
    upload_timestamp = analysis_result.get('upload_timestamp', 'N/A')
    file_size_mb = analysis_result.get('file_size_mb', 'N/A')
    image_width = analysis_result.get('image_width', 'N/A')
    image_height = analysis_result.get('image_height', 'N/A')
    image_resolution = analysis_result.get('image_resolution', 'N/A')
    extracted_text = analysis_result.get('extracted_text', '')
    cyberbullying_analysis = analysis_result.get('cyberbullying_analysis', '')
    cyberbullying_summary = analysis_result.get('cyberbullying_analysis_summary', '')
    
    # HTML 템플릿 생성
    html_content = f"""
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>안심톡 디지털 증거 분석 보고서</title>
        <style>
            @font-face {{
                font-family: 'Noto Sans KR';
                src: local('Noto Sans KR'), local('NotoSansKR-Regular');
                font-weight: normal;
                font-style: normal;
            }}
            
            @font-face {{
                font-family: 'Malgun Gothic';
                src: local('Malgun Gothic'), local('맑은 고딕');
                font-weight: normal;
                font-style: normal;
            }}
            
            body {{ 
                font-family: 'Noto Sans KR', 'Malgun Gothic', 'Arial', sans-serif !important; 
                margin: 40px; 
                line-height: 1.6;
                word-wrap: break-word;
                overflow-wrap: break-word;
                color: #333;
            }}
            
            * {{
                font-family: 'Noto Sans KR', 'Malgun Gothic', 'Arial', sans-serif !important;
            }}
            
            h1, h2, h3 {{ 
                color: #1976d2; 
                page-break-after: auto; 
                page-break-inside: auto; 
                margin-top: 30px;
                margin-bottom: 15px;
            }}
            
            .code-block {{ 
                font-family: 'Consolas', 'Monaco', monospace; 
                background: #f5f5f5; 
                padding: 8px; 
                border-radius: 4px; 
                word-break: break-all; 
                font-size: 11px; 
                border: 1px solid #ddd;
            }}
            
            table {{ 
                border-collapse: collapse; 
                width: 100%; 
                margin: 15px 0; 
                font-size: 12px; 
                page-break-inside: auto; 
            }}
            
            th, td {{ 
                border: 1px solid #ddd; 
                padding: 8px 12px; 
                word-wrap: break-word; 
                text-align: left;
            }}
            
            th {{ 
                background: #f8f9fa; 
                font-weight: bold; 
                color: #495057;
            }}
            
            img.evidence {{ 
                max-width: 400px; 
                max-height: 500px; 
                margin: 15px 0; 
                page-break-inside: auto; 
                border: 1px solid #ddd; 
                border-radius: 4px; 
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }}
            
            .section {{ 
                margin-bottom: 40px; 
                page-break-inside: auto; 
            }}
            
            .box {{ 
                background: #f0f4ff; 
                border-radius: 8px; 
                padding: 15px; 
                margin: 15px 0; 
                page-break-inside: auto; 
                word-wrap: break-word; 
                border-left: 4px solid #1976d2;
            }}
            
            .extracted-text {{
                background: #f8f9fa;
                border: 1px solid #e9ecef;
                border-radius: 4px;
                padding: 15px;
                margin: 15px 0;
                font-family: 'Consolas', 'Monaco', monospace;
                font-size: 13px;
                line-height: 1.4;
                white-space: pre-wrap;
                word-wrap: break-word;
                word-break: break-all;
                overflow-x: hidden;
                column-count: 2;
                column-gap: 20px;
                column-fill: balance;
                page-break-inside: auto;
            }}
            
            .analysis-result {{
                background: #fff3cd;
                border: 1px solid #ffeaa7;
                border-radius: 4px;
                padding: 15px;
                margin: 15px 0;
                font-weight: bold;
                color: #856404;
            }}
            
            .analysis-table {{
                border-collapse: collapse;
                width: 100%;
                margin: 15px 0;
                font-size: 11px;
                page-break-inside: auto;
            }}
            
            .analysis-table th, .analysis-table td {{
                border: 1px solid #ddd;
                padding: 6px 8px;
                word-wrap: break-word;
                text-align: left;
                vertical-align: top;
            }}
            
            .analysis-table th {{
                background: #f8f9fa;
                font-weight: bold;
                color: #495057;
            }}
            
            .risk-none {{
                color: #28a745;
                font-weight: bold;
            }}
            
            .risk-severe {{
                color: #dc3545;
                font-weight: bold;
            }}
            
            .risk-moderate {{
                color: #ffc107;
                font-weight: bold;
            }}
            
            @page {{
                size: A4;
                margin: 40px 40px 50px 40px;
                @bottom-center {{
                    content: element(report-footer);
                }}
            }}
            
            #report-footer {{
                position: running(report-footer);
                font-size: 10px;
                color: #888;
                text-align: right;
                width: 100%;
                border-top: 1px solid #eee;
                padding-top: 10px;
            }}
            
            .metadata-item {{
                margin: 8px 0;
            }}
            
            .metadata-label {{
                font-weight: bold;
                color: #495057;
                display: inline-block;
                width: 120px;
            }}
            
            .metadata-value {{
                color: #333;
            }}
        </style>
    </head>
    <body>
        <div id="report-footer">
            보고서ID: {report_id} | 생성일시: {created_at} | 플랫폼: 안심톡 AI 포렌식 분석 시스템 v1.0 | 배포일: 2025-07-18
        </div>
        
        <h1>안심톡 디지털 증거 분석 보고서</h1>
        
        <div class="section">
            <h2>1. 기본 정보</h2>
            <table>
                <tr><th>보고서 ID</th><td>{report_id}</td></tr>
                <tr><th>생성일시</th><td>{created_at}</td></tr>
                <tr><th>분석 유형</th><td>{analysis_type or 'N/A'}</td></tr>
                <tr><th>분석 시스템</th><td>안심톡 AI 포렌식 분석 시스템 v1.0</td></tr>
            </table>
        </div>
        
        <div class="section">
            <h2>2. 분석에 사용된 AI 모델 전체 목록</h2>
            <table>
                <thead>
                    <tr>
                        <th>분석 작업</th>
                        <th>AI 모델</th>
                        <th>버전</th>
                        <th>정확도</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>딥페이크 탐지</td>
                        <td>Sightengine Deepfake Detector</td>
                        <td>v1.0</td>
                        <td>99.7%</td>
                    </tr>
                    <tr>
                        <td>사이버폭력 분석</td>
                        <td>Google Gemini 2.0 Flash Lite (Vertex AI)</td>
                        <td>v2.0</td>
                        <td>74.1%</td>
                    </tr>
                    <tr>
                        <td>OCR 텍스트 추출</td>
                        <td>Google Cloud Vision API</td>
                        <td>v1.0</td>
                        <td>81.8%</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="section">
            <h2>3. 분석 결과 요약</h2>
            <div class="analysis-result">
                {f'<strong>딥페이크 분석 결과 요약:</strong><br>딥페이크일 확률: {analysis_result.get("deepfake_analysis", {{}}).get("type", {{}}).get("deepfake", 0):.1%}' if analysis_type == 'deepfake' else f'<strong>사이버폭력 분석 결과 요약:</strong><br>{cyberbullying_summary.replace(chr(10), "<br>") if cyberbullying_summary else "분석 결과가 없습니다."}'}
            </div>
        </div>
        
        <div class="section">
            <h2>4. 증거 파일 정보</h2>
            <div class="metadata-item">
                <span class="metadata-label">파일명:</span>
                <span class="metadata-value">{filename}</span>
            </div>
            <div class="metadata-item">
                <span class="metadata-label">파일 유형:</span>
                <span class="metadata-value">{analysis_type or 'N/A'}</span>
            </div>
            <div class="metadata-item">
                <span class="metadata-label">파일 크기:</span>
                <span class="metadata-value">{file_size} Bytes</span>
            </div>
            <div class="metadata-item">
                <span class="metadata-label">업로드 일시:</span>
                <span class="metadata-value">{upload_timestamp}</span>
            </div>
            <div class="metadata-item">
                <span class="metadata-label">업로더 ID:</span>
                <span class="metadata-value code-block">{uploader_id}</span>
            </div>
            <div class="metadata-item">
                <span class="metadata-label">업로드 IP:</span>
                <span class="metadata-value">{uploader_ip}</span>
            </div>
            <div class="metadata-item">
                <span class="metadata-label">원본 해시값 (SHA-256):</span>
                <span class="metadata-value code-block">{sha256}</span>
            </div>
        </div>
        
        <div class="section">
            <h2>원본 파일 메타데이터</h2>
            <div class="metadata-item">
                <span class="metadata-label">파일 형식:</span>
                <span class="metadata-value">{original_file.get('type', 'N/A')}</span>
            </div>
            <div class="metadata-item">
                <span class="metadata-label">분석 타입:</span>
                <span class="metadata-value">{analysis_type or 'N/A'}</span>
            </div>
            <div class="metadata-item">
                <span class="metadata-label">분석 타임스탬프:</span>
                <span class="metadata-value">{analysis_result.get('analysis_timestamp', 'N/A')}</span>
            </div>
            <div class="metadata-item">
                <span class="metadata-label">파일 크기 (바이트):</span>
                <span class="metadata-value">{file_size} bytes</span>
            </div>
            <div class="metadata-item">
                <span class="metadata-label">파일 크기 (MB):</span>
                <span class="metadata-value">{file_size_mb} MB</span>
            </div>
            <div class="metadata-item">
                <span class="metadata-label">이미지 해상도:</span>
                <span class="metadata-value">{image_resolution}</span>
            </div>
            <div class="metadata-item">
                <span class="metadata-label">이미지 너비:</span>
                <span class="metadata-value">{image_width} pixels</span>
            </div>
            <div class="metadata-item">
                <span class="metadata-label">이미지 높이:</span>
                <span class="metadata-value">{image_height} pixels</span>
            </div>
        </div>
        
        <div class="section">
            <h2>5. 연계 보관성 (Chain of Custody)</h2>
            <table>
                <thead>
                    <tr>
                        <th>단계</th>
                        <th>시각</th>
                        <th>서버/AI 정보</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>파일 업로드</td>
                        <td>{upload_timestamp}</td>
                        <td>안심톡 서버</td>
                    </tr>
                    <tr>
                        <td>해시값 계산</td>
                        <td>{upload_timestamp}</td>
                        <td>SHA-256</td>
                    </tr>
                    <tr>
                        <td>AI 분석</td>
                        <td>{upload_timestamp}</td>
                        <td>AI 서버 (Gemini 2.5 Flash v1.0)</td>
                    </tr>
                    <tr>
                        <td>결과 생성</td>
                        <td>{upload_timestamp}</td>
                        <td>보고서 생성 서버</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="section">
            <h2>6. AI 분석 결과</h2>
            
            {f'''
            <h3>딥페이크 분석 결과(Sightengine):</h3>
            <div class="analysis-result">
                딥페이크일 확률: {analysis_result.get("deepfake_analysis", {{}}).get("type", {{}}).get("deepfake", 0):.1%}
            </div>
            
            <h3>상세 분석 결과:</h3>
            <div class="box">
                <pre style="white-space: pre-wrap; font-family: 'Noto Sans KR', sans-serif; font-size: 12px; line-height: 1.4; margin: 0; padding: 10px; background-color: #f8f9fa; border-radius: 5px; overflow-x: auto;">{json.dumps(analysis_result.get('deepfake_analysis', {{}}), indent=2, ensure_ascii=False) if analysis_result.get('deepfake_analysis') else '분석 결과가 없습니다.'}</pre>
            </div>
            ''' if analysis_type == 'deepfake' else f'''
            <h3>추출 텍스트(OCR):</h3>
            <div class="extracted-text">{extracted_text}</div>
            
            <h3>사이버폭력 분석 결과(Gemini):</h3>
            <div class="analysis-result">
                전체 대화 사이버폭력 위험도: {analysis_result.get('cyberbullying_risk_line', 'N/A')}
            </div>
            
            <h3>상세 분석 결과:</h3>
            <div class="box" style="font-size: 13px; line-height: 1.4; page-break-inside: auto;">
                {cyberbullying_analysis if cyberbullying_analysis else '분석 결과가 없습니다.'}
            </div>
            
            <h3>전체 분석 요약:</h3>
            <div class="box" style="background: #f8f9fa; border-left: 4px solid #28a745; font-size: 13px; line-height: 1.4; page-break-inside: auto;">
                {cyberbullying_summary.replace('\n', '<br>') if cyberbullying_summary else '분석 결과가 없습니다.'}
            </div>
            '''}
        </div>
        
        <div class="section">
            <h2>7. 원본 증거 이미지</h2>
            {generate_image_html(original_image_path, analysis_result, original_file)}
            <div style="color:#1976d2; font-size:12px; margin-top:10px;">
                * 위 이미지는 분석 대상 원본 증거물입니다.
            </div>
        </div>
        
        <div class="section">
            <h2>8. 무결성 및 법적 검증</h2>
            <ul>
                <li><b>원본(이미지) 해시값:</b> <span class="code-block">{str(analysis_result.get('sha256', 'N/A'))}</span></li>
                <br>
                <li><b>법적 책임 선언:</b> <span class="long-text">본 보고서는 AI 기반 분석 결과를 제공하며 법률 전문가의 판단을 대체할 수 없습니다. 보고서 내용은 참고 자료로만 사용되어야 하며 법적 책임을 지지 않습니다. 정확한 법적 조치나 상담을 위해서는 변호사나 관련 기관에 문의하시기 바랍니다.</span></li>
            </ul>
        </div>
    </body>
    </html>
    """
    
    return html_content
```

---

## 6. app/templates/index.html
```html
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>안심톡 - AI 기반 디지털 안전망</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>안심톡</h1>
            <p class="tagline">AI로 디지털 증거를 분석하고 안전하게 증거화하세요.</p>
            <p class="developers">개발자: 윤여준팀장, 김태양, 김태영</p>
        </div>
        
        <div class="analysis-sections">
            <!-- 딥페이크 분석 섹션 -->
            <div class="analysis-card">
                <h2>딥페이크 분석</h2>
                <p class="file-type-info">지원 파일 형식: PNG, JPG, JPEG (이미지 파일)</p>
                <form action="{{ url_for('main.analyze_deepfake') }}" method="post" enctype="multipart/form-data">
                    <div class="file-input-group">
                        <input type="file" name="file" id="deepfake-file" accept=".png,.jpg,.jpeg" style="display: none;">
                        <button type="button" class="file-select-btn" onclick="document.getElementById('deepfake-file').click()">파일 선택</button>
                        <span class="file-name" id="deepfake-file-name">선택된 파일 없음</span>
                        <button type="submit" class="analyze-btn deepfake-btn">분석 시작</button>
                    </div>
                </form>
                <div style="margin-top: 10px; text-align: right;">
                    <a href="{{ url_for('main.deepfake_help') }}" class="help-link-btn" style="font-size:1em; color:#1976d2; font-weight:bold;">딥페이크 피해 상담/신고 안내 →</a>
                </div>
            </div>

            <!-- 사이버폭력 분석 섹션 -->
            <div class="analysis-card">
                <h2>사이버폭력 분석</h2>
                <p class="file-type-info">지원 파일 형식: TXT, PNG, JPG, JPEG (텍스트 또는 이미지 파일)</p>
                <form action="{{ url_for('main.analyze_cyberbullying') }}" method="post" enctype="multipart/form-data">
                    <div class="file-input-group">
                        <input type="file" name="file" id="cyberbullying-file" accept=".txt,.png,.jpg,.jpeg" style="display: none;">
                        <button type="button" class="file-select-btn" onclick="document.getElementById('cyberbullying-file').click()">파일 선택</button>
                        <span class="file-name" id="cyberbullying-file-name">선택된 파일 없음</span>
                        <button type="submit" class="analyze-btn cyberbullying-btn">분석 시작</button>
                    </div>
                </form>
                <div style="margin-top: 10px; text-align: right;">
                    <a href="{{ url_for('main.cyberbullying_help') }}" class="help-link-btn" style="font-size:1em; color:#1976d2; font-weight:bold;">사이버폭력 신고 안내 →</a>
                </div>
            </div>
        </div>

        {% with messages = get_flashed_messages() %}
          {% if messages %}
            <div class="flash-messages">
              {% for message in messages %}
                <div class="flash-message">{{ message }}</div>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}
    </div>

    <script>
        // 딥페이크 파일 선택
        document.getElementById('deepfake-file').addEventListener('change', function(e) {
            const fileName = e.target.files[0] ? e.target.files[0].name : '선택된 파일 없음';
            document.getElementById('deepfake-file-name').textContent = fileName;
        });

        // 사이버폭력 파일 선택
        document.getElementById('cyberbullying-file').addEventListener('change', function(e) {
            const fileName = e.target.files[0] ? e.target.files[0].name : '선택된 파일 없음';
            document.getElementById('cyberbullying-file-name').textContent = fileName;
        });
    </script>
</body>
</html>
```

---

## 7. app/templates/results.html
```html
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>안심톡 - 분석 결과</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>분석 결과</h1>
            <p class="tagline">요청하신 파일에 대한 분석 결과입니다.</p>
        </div>
        
        <div class="result-section file-info-section">
            <h2>파일 정보</h2>
            <p><strong>파일명:</strong> {{ result.file_info.filename }}</p>
            <p><strong>파일 크기:</strong> {{ "{:.2f} MB".format(result.file_info.size_bytes / (1024 * 1024)) }}</p>
            <p><strong>파일 타입:</strong> {{ result.file_info.type | upper }}</p>
            <p><strong>SHA-256 해시:</strong> {{ result.sha256 }}</p>
            <p><strong>분석 요청 시각:</strong> {{ result.analysis_timestamp }}</p>
        </div>

        {% if result.analysis_type == 'deepfake' %}
            <div class="result-section deepfake-analysis-section">
                <h2>AI 딥페이크 분석 요약</h2>
                {% if result.deepfake_analysis.error %}
                    <p class="error-message">오류: {{ result.deepfake_analysis.error }}</p>
                {% else %}
                    {% if result.deepfake_analysis.get('type', {}).get('deepfake') %}
                        <p><strong>딥페이크일 확률:</strong> <span class="score">{{ "{:.1f}%".format(result.deepfake_analysis.get('type', {}).get('deepfake', 0) * 100) }}</span></p>
                    {% endif %}
                    
                    {% if result.deepfake_analysis.get('offensive') %}
                        <p><strong>유해성 점수:</strong> <span class="score">{{ "{:.1f}%".format(result.deepfake_analysis.get('offensive', {}).get('prob', 0) * 100) }}</span></p>
                    {% endif %}
                    
                    {% if result.deepfake_analysis.get('nudity') %}
                        <p><strong>노출 점수:</strong> <span class="score">{{ "{:.1f}%".format(result.deepfake_analysis.get('nudity', {}).get('raw', 0) * 100) }}</span></p>
                    {% endif %}
                    
                    <h3>상세 분석 결과 (Raw Data):</h3>
                    <div class="raw-data-box">
                        <pre>{{ result.deepfake_analysis | tojson(indent=2) }}</pre>
                    </div>
                {% endif %}
            </div>
        {% elif result.analysis_type == 'cyberbullying' %}
            <!-- 사이버폭력 위험도 카드 -->
            <div class="result-section risk-level-card">
                <div class="risk-header">
                    <div style="display: flex; justify-content: space-between; align-items: center; font-size: 1.2em;">
                        <span style="color: #3498db;">전체 대화 사이버폭력 위험도</span>
                        {% set risk_level = '분석 중' %}
                        {% set risk_class = 'risk-suspicion' %}
                        {% if result.cyberbullying_risk_line %}
                            {% set risk_level = result.cyberbullying_risk_line %}
                            {% if '심각' in result.cyberbullying_risk_line %}
                                {% set risk_class = 'risk-severe' %}
                            {% elif '있음' in result.cyberbullying_risk_line %}
                                {% set risk_class = 'risk-present' %}
                            {% elif '약간 있음' in result.cyberbullying_risk_line %}
                                {% set risk_class = 'risk-slight' %}
                            {% elif '의심' in result.cyberbullying_risk_line %}
                                {% set risk_class = 'risk-suspicion' %}
                            {% elif '없음' in result.cyberbullying_risk_line %}
                                {% set risk_class = 'risk-none' %}
                            {% else %}
                                {% set risk_class = 'risk-suspicion' %}
                            {% endif %}
                        {% endif %}
                        <span class="risk-value {{ risk_class }}" style="color: #e74c3c;">{{ risk_level }}</span>
                    </div>
                </div>
            </div>

            <!-- 상세 분석 결과는 PDF에서만 표시되도록 숨김 -->
            <div class="result-section cyberbullying-analysis-section">
                <h2>AI 대화 내용 분석 요약</h2>
                
                {% if result.extracted_text %}
                    <h3>이미지 속 추출 텍스트:</h3>
                    <div class="extracted-text-box">
                        <pre>{{ result.extracted_text }}</pre>
                    </div>
                {% endif %}

                {% if result.cyberbullying_analysis %}
                    <h3>사이버폭력 분석 결과(Gemini):</h3>
                    <div class="analysis-container" style="white-space: pre-line; background: #f8f8f8; padding: 1em; border-radius: 8px; line-height: 1.6;">
                        {{ result.cyberbullying_analysis | safe }}
                    </div>
                    
                    {% if result.cyberbullying_analysis_summary %}
                        <div class="analysis-summary" style="white-space: pre-line; background: #f0f0ff; padding: 1em; border-radius: 8px; line-height: 1.6; margin-top: 1em;">
                            <h4>전체 분석 요약:</h4>
                            {% if result.cyberbullying_risk_line and '전체 대화 사이버폭력 위험도:' not in result.cyberbullying_analysis_summary %}
전체 대화 사이버폭력 위험도: {{ result.cyberbullying_risk_line }}

{% endif %}{{ result.cyberbullying_analysis_summary | safe }}
                        </div>
                    {% endif %}
                {% else %}
                    <p class="error-message">사이버폭력 분석 결과를 가져올 수 없습니다.</p>
                {% endif %}
            </div>
        {% endif %}

        <div class="actions">
            <a href="{{ url_for('main.download_pdf') }}" class="btn primary-btn">증거 보고서(PDF) 다운로드</a>
            {% if result.analysis_type == 'deepfake' %}
                <a href="{{ url_for('main.deepfake_help') }}" class="btn secondary-btn">상담/신고 안내</a>
            {% elif result.analysis_type == 'cyberbullying' %}
                <a href="{{ url_for('main.cyberbullying_help') }}" class="btn secondary-btn">상담/신고 안내</a>
            {% else %}
                <a href="https://www.safe182.go.kr/" target="_blank" class="btn secondary-btn">상담/신고 안내</a>
            {% endif %}
            <a href="{{ url_for('main.reset') }}" class="btn tertiary-btn">새로운 분석 시작</a>
        </div>
    </div>
</body>
</html>
```

---

## 8. app/templates/cyberbullying_help.html
```html
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>사이버폭력·따돌림, 어떻게 대처할까?</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .help-container { max-width: 900px; margin: 40px auto; background: #fff; border-radius: 12px; box-shadow: 0 2px 8px #eee; padding: 32px; }
        .help-title { font-size: 1.7em; font-weight: bold; color: #b71c1c; margin-bottom: 10px; }
        .help-desc { font-size: 1.1em; margin-bottom: 24px; }
        .help-table { width: 100%; border-collapse: collapse; margin-bottom: 24px; }
        .help-table th, .help-table td { border: 1px solid #e0e0e0; padding: 12px 8px; text-align: left; }
        .help-table th { background: #f5f5f5; color: #333; }
        .help-table td a { text-decoration: none; font-weight: bold; color: #1976d2; }
        .help-table td a:hover { text-decoration: underline; }
        .help-tip { background: #fffde7; border-left: 6px solid #ffd600; padding: 14px 18px; margin-bottom: 18px; font-size: 1.05em; }
        .help-tip strong { color: #b71c1c; }
        .help-footer { font-size: 0.98em; color: #666; margin-top: 18px; }
        @media (max-width: 700px) { .help-container { padding: 10px; } .help-table th, .help-table td { font-size: 0.95em; } }
    </style>
</head>
<body>
<div class="help-container">
    <div class="help-title">사이버폭력·따돌림, 어떻게 대처할까?</div>
    <div class="help-desc">
        온라인에서 욕설, 따돌림 등 괴롭힘을 당했다면, 가장 중요한 건 <b>'내 마음 챙기기'</b>와 <b>'확실한 증거 확보하기'</b>예요.<br>
        참지 말고 바로 도움을 요청해 보세요.
    </div>
    <table class="help-table">
        <thead>
        <tr>
            <th>기관 이름</th>
            <th>이런 도움을 줘요!</th>
            <th>꼭 알아두세요!</th>
            <th>이런 상황에 딱이에요!</th>
            <th>바로 가기</th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td><b>1388 청소년 상담복지센터</b></td>
            <td>✅ 익명 상담! 365일 언제든 내 고민 듣고 마음 안정 도와줌</td>
            <td>⚠️ 가해자 처벌이나 직접적 조치는 불가능, 추가 신고 필요</td>
            <td>마음이 힘들고 어떻게 할지 모르겠을 때 가장 먼저!</td>
            <td>📞 1388<br>📱 #1388 (문자)<br>💬 <a href="https://www.1388.go.kr/cco/YTOSP_SC_CCH_01" target="_blank">채팅 상담</a></td>
        </tr>
        <tr>
            <td><b>117 학교폭력 신고센터</b></td>
            <td>✅ 즉시 중단 가능! 경찰이 즉각 개입해 괴롭힘 중단 및 보호 지원</td>
            <td>⚠️ 경찰 개입으로 학교에 알려질 수 있음, 친구 관계가 신경 쓰인다며 신중하게 결정</td>
            <td>지속적인 괴롭힘을 당장 멈추고 싶은 긴급 상황일 때</td>
            <td>📞 117<br>📱 #0117 (문자)<br>🌐 <a href="https://www.safe182.go.kr/pot/selectRptList.do?rptTyGubun=09" target="_blank">온라인 신고</a></td>
        </tr>

        <tr>
            <td><b>경찰청 사이버범죄 신고시스템(ECRM)</b></td>
            <td>✅ 정식 수사 가능! 온라인으로 협박, 명예훼손 등 법적 조치 가능</td>
            <td>⚠️ 신고서 작성 및 증거 필요, 법적 절차가 부담될 수 있음</td>
            <td>법적 처벌이 필요할 만큼 심각한 피해를 입었을 때</td>
            <td>🌐 <a href="https://ecrm.police.go.kr/sci/pcc_V3_send?rp=c" target="_blank">온라인 신고</a></td>
        </tr>
        </tbody>
    </table>
    <div class="help-tip">
        <strong>사이버폭력 대응 TIP!</strong><br>
        • <b>확실한 증거 필수!</b> 욕설이나 따돌림 화면을 날짜와 함께 캡처해 보관하세요.<br>
        • <b>학교에도 알리기!</b> 담임 선생님이나 학교전담경찰관(SPO)에게도 알려 도움을 요청하세요.<br>
        • <b>플랫폼 신고 꼭 활용!</b> SNS, 게임 채팅 내 신고 기능도 즉시 사용하면 신속한 조치가 가능합니다.
    </div>
    <div class="help-footer">
        각 기관명 옆의 <b>🌐</b> 버튼을 클릭하면 해당 기관의 공식 홈페이지/상담/신고 페이지로 바로 이동합니다.<br>
        상담/신고 전, 증거(화면 캡처 등)를 미리 확보해두면 더욱 신속한 처리가 가능합니다.
    </div>
    <div style="margin-top:30px; text-align:right;">
        <a href="{{ url_for('main.index') }}" style="color:#1976d2; font-weight:bold;">← 메인으로 돌아가기</a>
    </div>
</div>
</body>
</html>
```

---

## 9. app/templates/deepfake_help.html
```html
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>딥페이크 피해 상담/신고 안내</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .help-container { max-width: 900px; margin: 40px auto; background: #fff; border-radius: 12px; box-shadow: 0 2px 8px #eee; padding: 32px; }
        .help-title { font-size: 1.7em; font-weight: bold; color: #b71c1c; margin-bottom: 10px; }
        .help-desc { font-size: 1.1em; margin-bottom: 24px; }
        .help-table { width: 100%; border-collapse: collapse; margin-bottom: 24px; }
        .help-table th, .help-table td { border: 1px solid #e0e0e0; padding: 12px 8px; text-align: left; }
        .help-table th { background: #f5f5f5; color: #333; }
        .help-table td a { text-decoration: none; font-weight: bold; color: #1976d2; }
        .help-table td a:hover { text-decoration: underline; }
        .help-tip { background: #fffde7; border-left: 6px solid #ffd600; padding: 14px 18px; margin-bottom: 18px; font-size: 1.05em; }
        .help-tip strong { color: #b71c1c; }
        .help-footer { font-size: 0.98em; color: #666; margin-top: 18px; }
        @media (max-width: 700px) { .help-container { padding: 10px; } .help-table th, .help-table td { font-size: 0.95em; } }
    </style>
</head>
<body>
<div class="help-container">
    <div class="help-title">딥페이크 피해, 어디에 도움을 청할까?</div>
    <div class="help-desc">
        내 얼굴이 이상한 사진이나 영상에 합성되어 퍼지고 있다면, 가장 중요한 건 <b>‘빠른 삭제’와 ‘확산 방지’</b>예요.<br>
        나에게 맞는 기관을 빠르게 선택해 도움을 요청하세요.
    </div>
    <table class="help-table">
        <thead>
        <tr>
            <th>기관 이름</th>
            <th>이런 도움을 줘요!</th>
            <th>꼭 알아두세요!</th>
            <th>이런 상황에 딱이에요!</th>
            <th>바로 가기</th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td><b>디지털성범죄 피해자 지원센터</b></td>
            <td>삭제 전문가! 피해 영상 삭제, 유포 현황 실시간 모니터링 지원(무료)</td>
            <td>삭제 요청만 가능, 해외 사이트는 처리 지연될 수 있음. 증거 제출 필요</td>
            <td>내 합성 사진/영상이 인터넷에 퍼지고 있을 때 가장 먼저!</td>
            <td><a href="https://d4u.stop.or.kr/write_consulting" target="_blank">🌐 상담 신청</a><br>02-735-8994</td>
        </tr>
        <tr>
            <td><b>117 학교폭력 신고센터</b></td>
            <td>강력한 법적 조치! 경찰이 직접 가해자 수사 및 처벌, 긴급 보호 지원</td>
            <td>경찰 개입으로 부모님이나 학교에 알려질 가능성 있음</td>
            <td>반드시 가해자를 처벌하거나 신변 위험이 느껴질 때</td>
            <td><a href="https://www.safe182.go.kr/pot/selectRptList.do?rptTyGubun=09" target="_blank">🌐 온라인 신고</a><br>☎ 117<br>#0117 (문자)</td>
        </tr>
        <tr>
            <td><b>1388 청소년 상담복지센터</b></td>
            <td>마음의 응급처치! 365일 언제나 익명으로 내 고민/위기 마음 안정 지원</td>
            <td>상담 중심으로 직접적인 삭제나 처벌 불가, 추가 조치 필요</td>
            <td>불안하고 힘들 때, 누구하고 즉시 이야기하고 싶을 때</td>
            <td><a href="https://www.1388.go.kr/cco/YTOSP_SC_CCH_01" target="_blank">🌐 채팅상담</a><br>☎ 1388</td>
        </tr>
        <tr>
            <td><b>방송통신심의위원회</b></td>
            <td>공식적인 삭제 요청! 명예훼손 게시물 공식 심의 및 삭제/차단 요청 가능</td>
            <td>처리까지 한 달 이상 소요될 수 있고 긴급 상황엔 적합하지 않음</td>
            <td>국내 사이트 게시물이 삭제되지 않을 때 공식 조치 필요</td>
            <td><a href="https://report.kocsc.or.kr/report/auth/digitalSexualAssault" target="_blank">🌐 딥페이크 신고</a><br>☎ 1377</td>
        </tr>
        </tbody>
    </table>
    <div class="help-tip">
        <strong>딥페이크 피해 대응 TIP!</strong><br>
        • <b>증거 확보 필수!</b> 피해 영상, 사진, URL을 꼭 저장해두세요.<br>
        • <b>SNS 자체 신고 활용!</b> 인스타그램, 틱톡 등 SNS의 신고 기능도 즉시 사용하세요.
    </div>
    <div class="help-footer">
        각 기관명 옆의 <b>🌐</b> 버튼을 클릭하면 해당 기관의 공식 홈페이지/상담/신고 페이지로 바로 이동합니다.<br>
        상담/신고 전, 증거(영상, 사진, URL 등)를 미리 확보해두면 더욱 신속한 처리가 가능합니다.
    </div>
    <div style="margin-top:30px; text-align:right;">
        <a href="{{ url_for('main.index') }}" style="color:#1976d2; font-weight:bold;">← 메인으로 돌아가기</a>
    </div>
</div>
</body>
</html>
```

---

## 10. app/templates/evidence_report.html
```html
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>안심톡 디지털 증거 분석 보고서</title>
  <style>
    @font-face {
      font-family: 'NanumGothic';
      src: url('{{ url_for("static", filename="fonts/NanumGothic.ttf") }}') format('truetype');
      font-weight: normal;
      font-style: normal;
    }
    
    body { 
      font-family: 'NanumGothic', 'Malgun Gothic', 'Arial', sans-serif; 
      margin: 40px; 
      line-height: 1.6;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
    
    h1, h2, h3 { 
      color: #1976d2; 
      page-break-after: avoid;
      page-break-inside: avoid;
    }
    
    .code-block { 
      font-family: 'Consolas', 'Monaco', monospace; 
      background: #eee; 
      padding: 8px; 
      border-radius: 4px; 
      word-break: break-all;
      font-size: 11px;
    }
    
    .highlight { 
      color: #fff; 
      background: #1976d2; 
      padding: 4px 8px; 
      border-radius: 4px; 
    }
    
    table { 
      border-collapse: collapse; 
      width: 100%; 
      margin: 10px 0; 
      font-size: 11px;
      page-break-inside: avoid;
    }
    
    th, td { 
      border: 1px solid #bbb; 
      padding: 6px 8px; 
      word-wrap: break-word;
      max-width: 200px;
    }
    
    th { 
      background: #f5f5f5; 
      font-weight: bold;
    }
    
    img.evidence { 
      max-width: 400px; 
      margin: 10px 0; 
      page-break-inside: avoid;
    }
    
    .section { 
      margin-bottom: 30px; 
      page-break-inside: avoid; 
    }
    
    ul { 
      margin: 0 0 0 20px; 
      page-break-inside: avoid;
    }
    
    li {
      margin-bottom: 5px;
      word-wrap: break-word;
    }
    
    .box { 
      background: #f0f4ff; 
      border-radius: 8px; 
      padding: 12px; 
      margin: 10px 0; 
      page-break-inside: avoid;
      word-wrap: break-word;
    }
    
    .emph { 
      font-weight: bold; 
      color: #d32f2f; 
    }
    
    pre {
      white-space: pre-wrap;
      word-wrap: break-word;
      font-size: 10px;
      max-width: 100%;
      overflow-x: auto;
    }
    
    /* 긴 텍스트 처리 */
    .long-text {
      word-wrap: break-word;
      overflow-wrap: break-word;
      max-width: 100%;
    }
    
    /* WeasyPrint footer for every page */
    @page {
      size: A4;
      margin: 40px 40px 50px 40px;
      @bottom-center {
        content: element(report-footer);
      }
    }
    
    #report-footer {
      position: running(report-footer);
      font-size: 10px;
      color: #888;
      text-align: right;
      width: 100%;
    }
    
    /* 표 내용이 길 때 처리 */
    .md-table {
      font-size: 10px;
    }
    
    .md-table th,
    .md-table td {
      max-width: 150px;
      word-wrap: break-word;
      vertical-align: top;
    }
  </style>
</head>
<body>
  <div id="report-footer">
    보고서ID: {{ report_id }} | 생성일시: {{ created_at }} | 플랫폼: {{ software_info.platform }} | 배포일: {{ software_info.release_date }}
  </div>
  <h1>안심톡 디지털 증거 분석 보고서</h1>
  <div class="section">
    <h2>1. 기본 정보</h2>
    <ul>
      <li><b>보고서 ID:</b> {{ report_id }}</li>
      <li><b>생성일시:</b> {{ created_at }}</li>
      <li><b>플랫폼 버전:</b> {{ software_info.platform }}</li>
      <li><b>배포일:</b> {{ software_info.release_date }}</li>
      <li><b>마지막 업데이트:</b> {{ software_info.last_updated }}</li>
    </ul>
  </div>
  <div class="section">
    <h2>2. 분석에 사용된 AI 모델 전체 목록</h2>
    <table>
      <tr><th>분석 Task</th><th>모델명</th><th>버전</th><th>정확도</th></tr>
      {% for m in ai_models %}
      <tr>
        <td>{{ m.task }}</td>
        <td>{{ m.model }}</td>
        <td>{{ m.version }}</td>
        <td>{{ m.정확도 }}</td>
      </tr>
      {% endfor %}
    </table>
  </div>
  <div class="section">
    <h2>3. 분석 결과 요약</h2>
    <div class="box" style="font-size: 1.1em;">
      {% if analysis_type == 'chat' %}
        <span style="color:#1976d2; font-weight:bold;">사이버폭력 분석 결과 요약</span><br>
        <span style="color:#d32f2f; font-weight:bold; font-size:1.2em;">{{ ai_results.gemini.cyberbullying_label or '분석 결과 없음' }}</span>
      {% elif analysis_type == 'deepfake' %}
        <span style="color:#1976d2; font-weight:bold;">AI 딥페이크 분석 요약</span><br>
        {% if ai_results.deepfake.score is defined and ai_results.deepfake.score is not none %}
          <span>딥페이크일 확률: <b>{{ (ai_results.deepfake.score * 100) | round(1) }}%</b></span>
        {% elif ai_results.deepfake.raw is defined and 'score' in ai_results.deepfake.raw and ai_results.deepfake.raw['score'] is not none %}
          <span>딥페이크일 확률: <b>{{ (ai_results.deepfake.raw['score'] * 100) | round(1) }}%</b></span>
        {% elif ai_results.deepfake.raw is defined and 'type' in ai_results.deepfake.raw and 'deepfake' in ai_results.deepfake.raw['type'] and ai_results.deepfake.raw['type']['deepfake'] is not none %}
          <span>딥페이크일 확률: <b>{{ (ai_results.deepfake.raw['type']['deepfake'] * 100) | round(1) }}%</b></span>
        {% else %}
          <span>딥페이크일 확률: <b>N/A%</b></span>
        {% endif %}
      {% else %}
        <div class="long-text">{{ analysis_summary or '분석 결과 요약이 제공되지 않았습니다.' }}</div>
      {% endif %}
    </div>
  </div>
  <div class="section">
    <h2>4. 증거 파일 정보</h2>
    <ul>
      <li><b>파일명:</b> <span class="long-text">{{ original_file.filename }}</span></li>
      <li><b>파일 유형:</b> {{ original_file.filetype }}</li>
      <li><b>파일 크기:</b> {{ original_file.filesize }} Bytes</li>
      <li><b>업로드 일시:</b> {{ original_file.uploaded_at }}</li>
      <li><b>업로더 ID:</b> {{ original_file.uploader_id }}</li>
      <li><b>업로드 IP:</b> {{ original_file.uploader_ip }}</li>
      <li><b>원본 해시값 (SHA-256):</b> <span class="code-block">{{ original_file.sha256 }}</span></li>
    </ul>
    <h3>원본 파일 메타데이터</h3>
    <ul>
      {% for k, v in original_file.metadata.items() %}
        <li><b>{{ k }}:</b> <span class="long-text">{{ v }}</span></li>
      {% endfor %}
    </ul>
  </div>
  <div class="section">
    <h2>5. 연계 보관성(Chain of Custody)</h2>
    <table>
      <tr>
        <th>단계</th>
        <th>시각</th>
        <th>서버/AI 정보</th>
      </tr>
      {% for log in analysis_log %}
      <tr>
        <td>{{ log.step }}</td>
        <td>{{ log.timestamp }}</td>
        <td class="long-text">
          {{ log.server }}
          {% if log.ai_model %} ({{ log.ai_model }} {{ log.version }}){% endif %}
        </td>
      </tr>
      {% endfor %}
    </table>
  </div>
  <div class="section">
    <h2>6. AI 분석 결과</h2>
    {% if analysis_type == 'deepfake' %}
      <div class="box">
        <b>딥페이크 분석 결과 (Deepfake-Detector):</b><br>
        <div style="white-space:pre-line; background:#f0f0ff; padding:0.5em; border-radius:6px; font-size: 11px;" class="long-text">
          {{ ai_results.deepfake.analysis_summary or '분석 결과 없음' }}
        </div>
        <div style="margin-top:10px; font-size:11px; color:#555;">
          <b>원본 분석 데이터:</b><br>
          <pre style="background:#f8f8f8; border-radius:6px; padding:0.5em;">{{ ai_results.deepfake.raw | tojson(indent=2) }}</pre>
        </div>
      </div>
    {% elif analysis_type == 'chat' %}
      <div class="box">
        <b>추출 텍스트(OCR):</b><br>
        <div style="white-space:pre-line; background:#f8f8f8; padding:0.5em; border-radius:6px; font-size: 11px;" class="long-text">{{ ai_results.ocr.extracted_text or '없음' }}</div>
      </div>
      <div class="box">
        <b>사이버폭력 분석 결과(Gemini):</b><br>
        <div style="white-space:pre-line; line-height:1.6; font-size: 11px;" class="long-text">
          {{ ai_results.gemini.cyberbullying_analysis | pipe_table_to_html | safe }}
        </div>
      </div>
      <div class="box" style="margin-top:10px; white-space:pre-line; line-height:1.6; font-size: 11px;" class="long-text">
        {{ ai_results.gemini.cyberbullying_analysis_summary }}
      </div>
    {% endif %}
  </div>
  <div class="section">
    <h2>7. 원본 증거 이미지</h2>
    {% if image_path %}
      <img class="evidence" src="{{ image_path }}" alt="증거 이미지"/>
      {% if highlight_regions %}
        <div style="color:#1976d2; font-size:12px;">* 하이라이트: 
          {% for region in highlight_regions %}
            [{{ region.label }}: x={{ region.x }}, y={{ region.y }}, w={{ region.width }}, h={{ region.height }}]
          {% endfor %}
        </div>
      {% endif %}
    {% else %}
      <p>이미지 없음</p>
    {% endif %}
  </div>
  <div class="section">
    <h2>8. 무결성 및 법적 검증</h2>
    <ul>
      <li><b>원본(이미지) 해시값:</b> <span class="code-block">{{ original_file.sha256 }}</span></li>
      <br><br>
      <li><b>PDF 해시값:</b> <span class="code-block">{{ pdf_sha256 }}</span></li>
      <br>
      <li><b>법적 책임 선언:</b> <span class="long-text">{{ legal_disclaimer }}</span></li>
    </ul>
  </div>
</body>
</html>
```

---

## 11. app/templates/evidence.html
```html
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>안심톡 - 증거 보고서</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <h1>증거 보고서</h1>
        <p>분석 결과를 PDF로 저장해 법적 증거로 활용하세요.</p>
        <div id="downloadMsg" style="margin-top:10px; color:green; display:none;">
            다운로드가 시작되었습니다.<br>
            다운로드가 완료되면 <b>브라우저의 기본 다운로드 폴더</b>에서 파일을 확인하세요.
        </div>
        <div class="actions">
            <a href="{{ url_for('main.download_pdf') }}" class="btn">PDF 다운로드</a>
            <a href="https://www.safe182.go.kr/" target="_blank" class="btn">상담/신고 안내</a>
            <a href="/" class="btn">분석 종료 및 새로 시작</a>
        </div>
    </div>
    <script>
    document.getElementById('download-pdf').addEventListener('click', function() {
        document.getElementById('downloadMsg').style.display = 'block';
    });
    </script>
</body>
</html>
```

---

## 12. app/static/css/style.css
```css
/* Font Face Definitions */
@font-face {
    font-family: 'NanumGothic';
    src: url('../fonts/NanumGothic.ttf') format('truetype');
    font-weight: normal;
    font-style: normal;
}

@font-face {
    font-family: 'NanumGothic';
    src: url('../fonts/NanumGothic-Bold.ttf') format('truetype');
    font-weight: bold;
    font-style: normal;
}

@font-face {
    font-family: 'NanumGothic';
    src: url('../fonts/NanumGothic-ExtraBold.ttf') format('truetype');
    font-weight: 800;
    font-style: normal;
}

/* General Body Styles */
body {
    font-family: 'NanumGothic', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: #333;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    min-height: 100vh;
    margin: 0;
    padding: 20px;
    box-sizing: border-box;
    overflow-x: hidden;
}

/* Container for the main content */
.container {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    padding: 40px 50px;
    border-radius: 25px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15), 0 10px 20px rgba(0, 0, 0, 0.1);
    text-align: center;
    max-width: 700px;
    width: 100%;
    box-sizing: border-box;
    word-wrap: break-word;
    overflow-wrap: break-word;
    border: 1px solid rgba(255, 255, 255, 0.3);
    backdrop-filter: blur(10px);
}

/* Header Section */
.header {
    margin-bottom: 40px;
}

.header h1 {
    color: #2c3e50; /* Darker, professional blue */
    margin-bottom: 10px;
    font-size: 2.8em;
    font-weight: 700;
}

.header .tagline {
    color: #7f8c8d; /* Muted grey for body text */
    margin-bottom: 15px;
    font-size: 1.2em;
    line-height: 1.6;
}

.header .developers {
    color: #95a5a6;
    font-size: 0.9em;
}

/* Analysis Sections */
.analysis-sections {
    display: flex;
    flex-direction: column; /* Stack cards vertically */
    gap: 30px; /* Space between cards */
    margin-bottom: 40px;
}

.analysis-card {
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    padding: 30px;
    border-radius: 16px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08), 0 3px 10px rgba(0, 0, 0, 0.03);
    text-align: left;
    border: 1px solid rgba(0, 0, 0, 0.05);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.analysis-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 35px rgba(0, 0, 0, 0.12), 0 5px 15px rgba(0, 0, 0, 0.05);
}

.analysis-card h2 {
    color: #34495e;
    font-size: 1.8em;
    margin-bottom: 15px;
    border-bottom: 2px solid #eceff1;
    padding-bottom: 10px;
}

.analysis-card .file-type-info {
    font-size: 0.95em;
    color: #7f8c8d;
    margin-bottom: 25px;
}

/* File Input Group */
.file-input-group {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap; /* Allow wrapping on small screens */
}

.file-select-btn {
    background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
    color: white;
    padding: 12px 24px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-size: 1em;
    font-weight: 600;
    transition: all 0.3s ease;
    white-space: nowrap;
    box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
}

.file-select-btn:hover {
    background: linear-gradient(135deg, #2980b9 0%, #1f5f8b 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
}

.file-name {
    flex-grow: 1;
    padding: 10px;
    border: 1px solid #bdc3c7;
    border-radius: 8px;
    background-color: #ecf0f1;
    color: #34495e;
    font-size: 0.95em;
    word-wrap: break-word;
    overflow-wrap: break-word;
    min-width: 0; /* Allow flex item to shrink */
}

.analyze-btn {
    background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
    color: white;
    padding: 12px 24px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-size: 1em;
    font-weight: 600;
    transition: all 0.3s ease;
    white-space: nowrap;
    box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
}

.analyze-btn:hover {
    background: linear-gradient(135deg, #27ae60 0%, #1e8449 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(46, 204, 113, 0.4);
}

/* Result Section Styling */
.result-section {
    margin-bottom: 30px;
    text-align: left;
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    padding: 25px;
    border-radius: 16px;
    border: 1px solid #e9ecef;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.result-section:hover {
    transform: translateY(-1px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
}

.result-section h2 {
    color: #2c3e50;
    border-bottom: 2px solid #cfd8dc; /* Lighter border */
    padding-bottom: 12px;
    margin-bottom: 20px;
    font-size: 1.8em;
    font-weight: 600;
}

.result-section h3 {
    color: #34495e;
    margin-top: 25px;
    margin-bottom: 15px;
    font-size: 1.4em;
    font-weight: 600;
}

.result-section p, .result-section ul {
    color: #555;
    font-size: 1em;
    line-height: 1.5;
    word-wrap: break-word;
    overflow-wrap: break-word;
    white-space: normal;
}

.result-section ul {
    list-style: none;
    padding: 0;
}

.result-section ul li {
    margin-bottom: 10px;
}

.result-section strong {
    color: #2c3e50;
    word-wrap: break-word;
    overflow-wrap: break-word;
}

/* Label Styling (for severity, etc.) */
.label {
    background-color: #f1c40f; /* Yellow for general labels */
    color: #333;
    padding: 5px 10px;
    border-radius: 5px;
    font-weight: 700;
    display: inline-block;
    margin-left: 5px;
}

/* Actions Section */
.actions {
    margin-top: 40px;
    display: flex;
    justify-content: center;
    gap: 20px; /* Space between buttons */
}

/* Button Variants */
.btn {
    padding: 12px 25px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1em;
    font-weight: 600;
    text-decoration: none;
    display: inline-block;
    transition: background-color 0.3s ease, transform 0.2s ease;
    white-space: nowrap;
}

.primary-btn {
    background-color: #3498db; /* Blue */
    color: white;
}

.primary-btn:hover {
    background-color: #2980b9;
    transform: translateY(-2px);
}

.secondary-btn {
    background-color: #95a5a6; /* Muted grey */
    color: white;
}

.secondary-btn:hover {
    background-color: #7f8c8d;
    transform: translateY(-2px);
}

.tertiary-btn {
    background-color: #e74c3c; /* Red for reset/danger */
    color: white;
}

.tertiary-btn:hover {
    background-color: #c0392b;
    transform: translateY(-2px);
}

/* Flash Messages */
.flash-messages {
    list-style: none;
    padding: 0;
    margin: 25px 0 0 0;
}

.flash-message {
    padding: 15px 20px;
    margin-bottom: 15px;
    border-radius: 8px;
    font-weight: 600;
    text-align: center;
}

/* Severity Labels */
.label.severity-없음 {
    background-color: #27ae60; /* Green */
    color: white;
}

.label.severity-의심 {
    background-color: #f39c12; /* Orange */
    color: white;
}

.label.severity-약간있음 {
    background-color: #e67e22; /* Dark orange */
    color: white;
}

.label.severity-있음 {
    background-color: #e74c3c; /* Red */
    color: white;
}

.label.severity-심각 {
    background-color: #8e44ad; /* Purple */
    color: white;
}

/* Extracted Text Box */
.extracted-text-box {
    background-color: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 15px;
    margin-top: 15px;
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    font-size: 0.9em;
    line-height: 1.4;
    overflow-x: auto;
    white-space: pre-wrap;
    word-wrap: break-word;
}

/* Analysis Table */
.analysis-table table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}

.analysis-table th, .analysis-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #e9ecef;
}

.analysis-table th {
    background-color: #f8f9fa;
    font-weight: 600;
    color: #2c3e50;
}

/* Analysis Summary */
.analysis-summary {
    background-color: #f0f0ff;
    border: 1px solid #d6d6ff;
    border-radius: 8px;
    padding: 20px;
    margin-top: 20px;
    line-height: 1.6;
}

.analysis-summary h4 {
    color: #2c3e50;
    margin-top: 0;
    margin-bottom: 15px;
    font-size: 1.2em;
    font-weight: 600;
}

/* Analysis Container */
.analysis-container {
    background-color: #f8f8f8;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 20px;
    margin-top: 15px;
    line-height: 1.6;
    white-space: pre-line;
}

/* Analysis Table */
.analysis-table {
    margin-top: 20px;
    overflow-x: auto;
}

.analysis-table th, .analysis-table td {
    padding: 12px 15px;
    text-align: left;
    border-bottom: 1px solid #e9ecef;
    font-size: 0.95em;
}

.analysis-table th {
    background-color: #f8f9fa;
    font-weight: 600;
    color: #2c3e50;
    position: sticky;
    top: 0;
}

.analysis-table tr:nth-child(even) {
    background-color: #f8f9fa;
}

.analysis-table tr:hover {
    background-color: #e9ecef;
}

/* Risk Level Colors */
.risk-severe {
    color: #e74c3c !important;
    font-weight: 700;
}

.risk-present {
    color: #f39c12 !important;
    font-weight: 700;
}

.risk-slight {
    color: #f1c40f !important;
    font-weight: 700;
}

.risk-suspicion {
    color: #3498db !important;
    font-weight: 700;
}

.risk-none {
    color: #27ae60 !important;
    font-weight: 700;
}

/* Error Message */
.error-message {
    color: #e74c3c;
    background-color: #fdf2f2;
    border: 1px solid #fecaca;
    border-radius: 8px;
    padding: 15px;
    margin-top: 15px;
    font-weight: 600;
}

/* Score Styling */
.score {
    font-weight: 700;
    color: #e74c3c;
    font-size: 1.1em;
}

/* Raw Data Box */
.raw-data-box {
    background-color: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 15px;
    margin-top: 15px;
    overflow-x: auto;
    font-family: 'Courier New', monospace;
    font-size: 0.85em;
    line-height: 1.4;
    word-wrap: break-word;
    overflow-wrap: break-word;
}

.raw-data-box pre {
    margin: 0;
    white-space: pre-wrap;
    word-wrap: break-word;
    color: #2c3e50;
}

/* File Info Section */
.file-info-section p {
    word-wrap: break-word;
    overflow-wrap: break-word;
    white-space: normal;
    margin-bottom: 12px;
    padding: 8px 0;
    border-bottom: 1px solid #f0f0f0;
}

.file-info-section p:last-child {
    border-bottom: none;
}

.file-info-section strong {
    display: inline-block;
    min-width: 120px;
    color: #2c3e50;
    font-weight: 600;
}

/* Risk Level Card */
.risk-level-card {
    background-color: #ffffff;
    border: 2px solid #e9ecef;
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 30px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
}

.risk-level-card .risk-header {
    margin-bottom: 15px;
}

.risk-level-card .risk-title {
    font-size: 1.3em;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 10px;
}

.risk-level-card .risk-value {
    font-size: 1.4em;
    font-weight: 700;
    padding: 8px 16px;
    border-radius: 8px;
    display: inline-block;
}

.risk-level-card .risk-severe {
    background-color: #fdf2f2;
    color: #e74c3c;
}

.risk-level-card .risk-present {
    background-color: #fef5e7;
    color: #f39c12;
}

.risk-level-card .risk-slight {
    background-color: #fef9e7;
    color: #f1c40f;
}

.risk-level-card .risk-suspicion {
    background-color: #ebf8ff;
    color: #3498db;
}

.risk-level-card .risk-none {
    background-color: #f0fff4;
    color: #27ae60;
}

/* Mobile Responsive Design */
@media (max-width: 768px) {
    body {
        padding: 10px;
        align-items: flex-start;
        overflow-x: hidden;
    }
    
    .container {
        padding: 25px 20px;
        margin-top: 20px;
        margin-bottom: 20px;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    
    .header h1 {
        font-size: 2.2em;
    }
    
    .header .tagline {
        font-size: 1.1em;
    }
    
    .analysis-card {
        padding: 20px;
    }
    
    .analysis-card h2 {
        font-size: 1.6em;
    }
    
    .file-input-group {
        flex-direction: column;
        align-items: stretch;
        gap: 15px;
    }
    
    .file-select-btn, .analyze-btn {
        width: 100%;
        margin-bottom: 10px;
        white-space: normal;
        word-wrap: break-word;
    }
    
    .file-name {
        margin-bottom: 10px;
        word-wrap: break-word;
        overflow-wrap: break-word;
        white-space: normal;
    }
    
    .actions {
        flex-direction: column;
        gap: 15px;
    }
    
    .btn {
        width: 100%;
        text-align: center;
    }
    
    .result-section {
        padding: 20px;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    
    .file-info-section p {
        font-size: 0.9em;
        line-height: 1.4;
    }
    
    .file-info-section strong {
        min-width: 100px;
        font-size: 0.9em;
    }
    
    .result-section h2 {
        font-size: 1.6em;
        word-wrap: break-word;
    }
    
    .result-section h3 {
        font-size: 1.3em;
        word-wrap: break-word;
    }
    
    .analysis-table {
        font-size: 0.9em;
        table-layout: fixed;
        width: 100%;
    }
    
    .analysis-table th, .analysis-table td {
        padding: 8px 10px;
        word-wrap: break-word;
        overflow-wrap: break-word;
        white-space: normal;
    }
    
    .label {
        font-size: 0.9em;
        padding: 4px 8px;
    }
    
    .extracted-text-box {
        font-size: 0.85em;
        padding: 12px;
    }
    
    .raw-data-box {
        font-size: 0.8em;
        padding: 12px;
        word-wrap: break-word;
        overflow-wrap: break-word;
        white-space: pre-wrap;
    }
    
    .risk-level-card {
        padding: 20px;
    }
    
    .risk-level-card .risk-value {
        font-size: 1.2em;
        padding: 6px 12px;
    }
}

@media (max-width: 480px) {
    body {
        padding: 5px;
        overflow-x: hidden;
    }
    
    .container {
        padding: 20px 15px;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    
    .header h1 {
        font-size: 1.8em;
    }
    
    .header .tagline {
        font-size: 1em;
    }
    
    .analysis-card {
        padding: 15px;
    }
    
    .analysis-card h2 {
        font-size: 1.4em;
    }
    
    .result-section {
        padding: 15px;
    }
    
    .file-info-section p {
        font-size: 0.85em;
        line-height: 1.3;
    }
    
    .file-info-section strong {
        min-width: 80px;
        font-size: 0.85em;
    }
    
    .result-section h2 {
        font-size: 1.4em;
    }
    
    .result-section h3 {
        font-size: 1.2em;
    }
    
    .analysis-table {
        font-size: 0.85em;
        table-layout: fixed;
        width: 100%;
    }
    
    .analysis-table th, .analysis-table td {
        padding: 6px 8px;
        word-wrap: break-word;
        overflow-wrap: break-word;
        white-space: normal;
    }
    
    .label {
        font-size: 0.85em;
        padding: 3px 6px;
        word-wrap: break-word;
        white-space: normal;
    }
    
    .extracted-text-box {
        font-size: 0.8em;
        padding: 10px;
    }
    
    .raw-data-box {
        font-size: 0.75em;
        padding: 10px;
        word-wrap: break-word;
        overflow-wrap: break-word;
        white-space: pre-wrap;
    }
}

/* Landscape Mode for Mobile */
@media (max-width: 768px) and (orientation: landscape) {
    body {
        align-items: flex-start;
        padding: 10px;
    }
    
    .container {
        margin-top: 10px;
        margin-bottom: 10px;
        max-height: 90vh;
        overflow-y: auto;
    }
}

/* High DPI Displays */
@media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
    .container {
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    }
    
    .analysis-card {
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
}

/* Print Styles */
@media print {
    body {
        background: white;
        padding: 0;
    }
    
    .container {
        box-shadow: none;
        border: 1px solid #ccc;
    }
    
    .file-input-group, .actions {
        display: none;
    }
}
```

---

## 13. requirements.txt (Python 의존성)
```
gunicorn
Flask
python-dotenv
pillow
google-cloud-vision
openai
requests
google-generativeai
weasyprint==62.2
fpdf2
google-cloud-aiplatform
```

---

## 14. Dockerfile (Docker 컨테이너 빌드/실행)
```dockerfile
FROM python:3.12-slim

# 환경 변수 설정
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1

WORKDIR /app

# Install system dependencies for WeasyPrint
RUN apt-get update && apt-get install -y \
    libcairo2-dev \
    libpango1.0-dev \
    libgirepository1.0-dev \
    libglib2.0-dev \
    libffi-dev \
    pkg-config \
    fonts-noto-cjk \
    && rm -rf /var/lib/apt/lists/*

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

EXPOSE 8000

# 간단한 시작 명령어
CMD ["python", "run.py"] 
```

---

## 15. railway.toml (Railway 배포 설정)
```
[build]
builder = "dockerfile"

[deploy]
healthcheckPath = "/health"
healthcheckTimeout = 600
restartPolicyType = "on_failure" 
```

---

## 16. 실행/배포 안내

### 웹 애플리케이션 (Flask)

**폴더 이름**: `ansimtalk (2)`

**위치**: `D:\coding sutdy\ansimtalk (2)\`

**폴더 구조**:
```
ansimtalk (2)/
├── run.py                    # Flask 앱 진입점
├── config.py                 # 환경 설정
├── requirements.txt          # Python 의존성
├── Dockerfile               # Docker 컨테이너 설정
├── railway.toml             # Railway 배포 설정
├── dazzling-howl-465316-m7-1940c1e7d0a2.json  # Google Cloud 인증
└── app/
    ├── __init__.py          # Flask 앱 팩토리
    ├── routes.py            # 라우트 정의 (메인 로직)
    ├── services.py          # 비즈니스 로직 (AI 분석, PDF 생성)
    ├── static/
    │   ├── css/
    │   │   └── style.css    # 웹 스타일시트
    │   └── fonts/           # 한글 폰트 (NanumGothic)
    │       ├── NanumGothic.ttf
    │       ├── NanumGothic-Bold.ttf
    │       └── NanumGothic-ExtraBold.ttf
    └── templates/           # HTML 템플릿
        ├── index.html       # 메인 페이지
        ├── results.html     # 분석 결과 페이지
        ├── evidence_report.html  # PDF 보고서 템플릿
        ├── deepfake_help.html    # 딥페이크 신고 안내
        ├── cyberbullying_help.html  # 사이버폭력 신고 안내
        └── evidence.html    # 증거 보고서 페이지
```

**실행 방법**:
- **로컬 실행**: 
  ```bash
  cd "D:\coding sutdy\ansimtalk (2)"
  python run.py
  ```
- **Docker 실행**: 
  ```bash
  docker build -t ansimtalk .
  docker run -p 8000:8000 ansimtalk
  ```
- **Railway 배포**: railway.toml, Dockerfile 참고
- **필수 환경변수**: 
  - `SIGHTENGINE_API_USER`: Sightengine API 사용자 ID
  - `SIGHTENGINE_API_SECRET`: Sightengine API 시크릿
  - `GOOGLE_GEMINI_API_KEY`: Google Gemini API 키
  - `GOOGLE_SERVICE_ACCOUNT_JSON`: Google Cloud 서비스 계정 JSON
  
**주요 기능**:
1. **딥페이크 탐지** (`analyze_deepfake`)
   - Sightengine API로 이미지 분석
   - 딥페이크 확률, 유해성, 노출도 점수 제공
   
2. **사이버폭력 분석** (`analyze_cyberbullying`)
   - Google Cloud Vision API로 OCR (텍스트 추출)
   - Google Gemini API로 대화 내용 분석
   - 위험도 판정 (없음/의심/약간있음/있음/심각)
   
3. **PDF 증거 보고서 생성** (`generate_pdf_report`)
   - WeasyPrint로 법적 증거용 PDF 생성
   - 파일 해시값, 메타데이터, 분석 결과 포함
   - 원본 이미지 Base64 인코딩 임베드

---

## 17. 안드로이드 모바일 앱 (Kotlin)

### 앱 정보

**폴더 이름**: `ansimtalk_app`

**위치**: `D:\coding sutdy\ansimtalk_app\`

**패키지명**: `com.ansimtalk.app`

**개발 언어**: Kotlin

**아키텍처**: MVVM + Clean Architecture + Hilt (DI)

**주요 라이브러리**:
- Jetpack Compose (UI)
- Hilt (의존성 주입)
- Retrofit + OkHttp (네트워크)
- Kotlin Coroutines (비동기 처리)
- Coil (이미지 로딩)
- WeasyPrint (PDF 생성 - 백엔드 연동)

### 폴더 구조

```
ansimtalk_app/
├── build.gradle.kts          # 프로젝트 레벨 Gradle 설정
├── settings.gradle.kts       # Gradle 설정
├── local.properties          # 로컬 환경 설정
└── app/
    ├── build.gradle.kts      # 앱 레벨 Gradle 설정
    ├── src/
    │   └── main/
    │       ├── AndroidManifest.xml  # 앱 매니페스트
    │       ├── java/com/ansimtalk/app/
    │       │   ├── AnsimTalkApplication.kt  # Application 클래스
    │       │   ├── MainActivity.kt          # 메인 액티비티
    │       │   ├── ResultActivity.kt        # 결과 화면 액티비티
    │       │   ├── data/                    # 데이터 레이어
    │       │   │   ├── model/               # 데이터 모델
    │       │   │   │   ├── AnalysisResult.kt    # 분석 결과 모델
    │       │   │   │   ├── Resource.kt          # API 상태 래퍼
    │       │   │   │   ├── PdfRequestBody.kt   # PDF 요청 모델
    │       │   │   │   ├── PdfGenerationResult.kt
    │       │   │   │   └── PdfErrors.kt
    │       │   │   ├── api/                 # API 인터페이스
    │       │   │   │   └── AnsimTalkApiService.kt
    │       │   │   ├── remote/              # 원격 데이터 소스
    │       │   │   │   └── ApiService.kt
    │       │   │   └── repository/          # 리포지토리 구현
    │       │   │       ├── AnsimTalkRepository.kt
    │       │   │       ├── AnsimTalkRepositoryImpl.kt
    │       │   │       └── PdfRepository.kt
    │       │   ├── domain/                  # 도메인 레이어
    │       │   │   ├── repository/          # 리포지토리 인터페이스
    │       │   │   │   └── AnsimTalkRepository.kt
    │       │   │   └── usecase/             # 유스케이스
    │       │   │       ├── AnalyzeDeepfakeUseCase.kt
    │       │   │       ├── AnalyzeCyberbullyingUseCase.kt
    │       │   │       ├── GeneratePdfUseCase.kt
    │       │   │       ├── DownloadPdfUseCase.kt
    │       │   │       ├── HealthCheckUseCase.kt
    │       │   │       ├── GetResultsUseCase.kt
    │       │   │       └── GetEvidenceUseCase.kt
    │       │   ├── di/                      # 의존성 주입
    │       │   │   ├── NetworkModule.kt     # 네트워크 모듈
    │       │   │   └── RepositoryModule.kt  # 리포지토리 모듈
    │       │   ├── presentation/            # 프레젠테이션 레이어
    │       │   │   ├── ui/
    │       │   │   │   ├── screen/
    │       │   │   │   │   └── MainScreen.kt  # 메인 화면 (1518줄)
    │       │   │   │   ├── state/
    │       │   │   │   │   ├── AnalysisUiState.kt      # 분석 UI 상태
    │       │   │   │   │   └── PdfDownloadUiState.kt   # PDF 다운로드 상태
    │       │   │   │   └── theme/
    │       │   │   │       ├── Color.kt     # 색상 팔레트
    │       │   │   │       ├── Theme.kt     # 테마 설정
    │       │   │   │       └── Type.kt      # 타이포그래피
    │       │   │   └── viewmodel/
    │       │   │       ├── MainViewModel.kt      # 메인 뷰모델
    │       │   │       └── ResultViewModel.kt    # 결과 뷰모델
    │       │   └── util/
    │       │       └── PdfConverter.kt      # PDF 변환 유틸
    │       └── res/                         # 리소스
    │           ├── drawable/                # 아이콘
    │           ├── layout/                  # XML 레이아웃
    │           ├── values/
    │           │   ├── strings.xml          # 문자열 리소스
    │           │   ├── colors.xml           # 색상 리소스
    │           │   └── themes.xml           # 테마
    │           └── xml/
    │               └── file_paths.xml       # FileProvider 경로
    └── README.md                            # 앱 설명
```

### 주요 파일 역할

#### 1. Application 클래스

**파일**: `app/src/main/java/com/ansimtalk/app/AnsimTalkApplication.kt`

**역할**: Hilt 의존성 주입 초기화, WebView 설정

#### 2. MainActivity

**파일**: `app/src/main/java/com/ansimtalk/app/MainActivity.kt`

**역할**: 
- 앱 진입점
- Jetpack Compose UI 설정
- 오류 핸들링

#### 3. ResultActivity

**파일**: `app/src/main/java/com/ansimtalk/app/ResultActivity.kt`

**역할**:
- 분석 결과 표시
- PDF 다운로드 기능

#### 4. Data Layer (데이터 레이어)

**model/**:
- `AnalysisResult.kt`: 서버에서 받은 분석 결과 데이터 모델
- `Resource.kt`: API 상태 래퍼 (Loading, Success, Error)
- `PdfRequestBody.kt`: PDF 생성 요청 모델

**api/** & **remote/**:
- `AnsimTalkApiService.kt`: Retrofit API 인터페이스 정의
- `ApiService.kt`: 실제 HTTP 요청 인터페이스

**repository/**:
- `AnsimTalkRepository.kt`: 리포지토리 인터페이스
- `AnsimTalkRepositoryImpl.kt`: 리포지토리 구현 (네트워크 요청 로직)
- `PdfRepository.kt`: PDF 생성/다운로드 리포지토리

#### 5. Domain Layer (도메인 레이어)

**usecase/**:
각 비즈니스 로직을 캡슐화한 유스케이스들:
- `AnalyzeDeepfakeUseCase.kt`: 딥페이크 분석 요청
- `AnalyzeCyberbullyingUseCase.kt`: 사이버폭력 분석 요청
- `GeneratePdfUseCase.kt`: PDF 생성 요청
- `DownloadPdfUseCase.kt`: PDF 다운로드
- `HealthCheckUseCase.kt`: API 헬스 체크

#### 6. DI (의존성 주입)

**di/**:
- `NetworkModule.kt`: Retrofit, OkHttpClient 제공
- `RepositoryModule.kt`: Repository 인스턴스 제공

#### 7. Presentation Layer (프레젠테이션 레이어)

**ui/screen/**:
- `MainScreen.kt` (1518줄):
  - 메인 화면 Composable
  - 파일 선택 로직
  - 분석 결과 표시
  - PDF 다운로드 기능
  - 신고 안내 링크

**ui/state/**:
- `AnalysisUiState.kt`: 분석 UI 상태 (Idle, Loading, Success, Error)
- `PdfDownloadUiState.kt`: PDF 다운로드 상태

**ui/theme/**:
- `Color.kt`: 앱 색상 팔레트 정의
- `Theme.kt`: Material3 테마 설정
- `Type.kt`: 타이포그래피 설정

**viewmodel/**:
- `MainViewModel.kt`: 메인 화면 비즈니스 로직 관리
- `ResultViewModel.kt`: 결과 화면 비즈니스 로직 관리

### 앱 빌드 및 실행

**빌드 타입**:
1. **debug**: 프로덕션 서버 연결 (https://ansimtalk-production.up.railway.app/)
2. **debugLocalEmu**: 에뮬레이터 로컬 서버 (http://10.0.2.2:8000/)
3. **debugProd**: 프로덕션 서버 테스트용
4. **debugDevice**: 실기기 USB 디버깅 + 로컬 서버 (http://127.0.0.1:8000/)
5. **release**: 프로덕션 릴리스

**실행 방법**:
```bash
cd "D:\coding sutdy\ansimtalk_app"

# Windows에서 Gradle 빌드
gradlew.bat assembleDebug

# 디버그 APK 설치
adb install app/build/outputs/apk/debug/app-debug.apk
```

**Android Studio에서 실행**:
1. Android Studio에서 `ansimtalk_app` 폴더 열기
2. Build Variants에서 원하는 빌드 타입 선택
3. Run 버튼 클릭

### 앱 주요 기능

1. **API 헬스 체크**
   - 앱 시작 시 서버 연결 상태 확인
   - 네트워크 오류 핸들링

2. **딥페이크 분석**
   - 갤러리에서 이미지 선택
   - 서버로 Multipart 업로드
   - 분석 결과 실시간 표시
   - 딥페이크 확률, 유해성 점수 표시

3. **사이버폭력 분석**
   - 이미지 또는 텍스트 파일 업로드
   - OCR + AI 분석
   - 위험도 카드 표시
   - 대화 내용 분석 테이블

4. **PDF 증거 보고서 생성**
   - 서버 PDF 생성 API 호출
   - Downloads/AnsimTalkEvidence 폴더에 저장
   - 자동으로 PDF 리더 앱 열기

5. **신고 안내**
   - 딥페이크 피해 상담/신고 안내 페이지 링크
   - 사이버폭력 신고 안내 페이지 링크
   - WebView로 웹 페이지 열기

### 앱 기술 스택

**언어**: Kotlin 1.9.22

**최소 SDK**: 26 (Android 8.0 Oreo)

**타겟 SDK**: 34 (Android 14)

**UI 프레임워크**: Jetpack Compose (Material3)

**아키텍처 패턴**: MVVM + Clean Architecture

**의존성 주입**: Hilt 2.48

**네트워크**: Retrofit 2.9.0 + OkHttp 4.12.0

**이미지 로딩**: Coil 2.5.0

**비동기 처리**: Kotlin Coroutines 1.8.0 + Flow

---

## 18. 안드로이드 앱 - 전체 Kotlin 코드

### 18.1. build.gradle.kts (프로젝트 레벨)

**위치**: `ansimtalk_app/build.gradle.kts`

**역할**: 프로젝트 전체 플러그인 설정

```kotlin
// Top-level build file where you add configuration options common to all sub-projects/modules.
plugins {
    id("com.android.application") version "8.11.1" apply false
    id("org.jetbrains.kotlin.android") version "1.9.22" apply false
    id("com.google.dagger.hilt.android") version "2.48" apply false
}
```

---

### 18.2. settings.gradle.kts

**위치**: `ansimtalk_app/settings.gradle.kts`

**역할**: Gradle 리포지토리 설정

```kotlin
pluginManagement {
    repositories {
        google()
        mavenCentral()
        gradlePluginPortal()
    }
}
dependencyResolutionManagement {
    repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
    repositories {
        google()
        mavenCentral()
    }
}
rootProject.name = "AnsimTalk"
include(":app")
```

---

### 18.3. app/build.gradle.kts

**위치**: `ansimtalk_app/app/build.gradle.kts`

**역할**: 앱 모듈 빌드 설정, 의존성 관리, 빌드 타입 정의

```kotlin
plugins {
    id("com.android.application")
    id("org.jetbrains.kotlin.android")
    id("kotlin-kapt")
    id("dagger.hilt.android.plugin")
    id("kotlin-parcelize")
}

android {
    namespace = "com.ansimtalk.app"
    compileSdk = 34

    defaultConfig {
        applicationId = "com.ansimtalk.app"
        minSdk = 26
        targetSdk = 34
        versionCode = 1
        versionName = "1.0"

        testInstrumentationRunner = "androidx.test.runner.AndroidJUnitRunner"
        vectorDrawables {
            useSupportLibrary = true
        }
    }

    buildTypes {
        // 기본 디버그는 프로덕션 서버로 연결되도록 설정
        debug {
            buildConfigField("String", "BASE_URL", "\"https://ansimtalk-production.up.railway.app/\"")
        }
        // 에뮬레이터 로컬 서버 테스트용 (필요 시 선택해서 사용)
        create("debugLocalEmu") {
            initWith(getByName("debug"))
            applicationIdSuffix = ".localemu"
            versionNameSuffix = "-localemu"
            buildConfigField("String", "BASE_URL", "\"http://10.0.2.2:8000/\"")
        }
        // 디버그 설정을 그대로 쓰면서 프로덕션 서버로 붙는 테스트용 빌드타입
        create("debugProd") {
            initWith(getByName("debug"))
            applicationIdSuffix = ".prod"
            versionNameSuffix = "-prod"
            buildConfigField(
                "String",
                "BASE_URL",
                "\"https://ansimtalk-production.up.railway.app/\""
            )
        }
        // 실기기 + USB 디버깅에서 로컬 서버(PC의 8000 포트)로 연결하는 빌드타입
        // 실행 전: adb reverse tcp:8000 tcp:8000
        create("debugDevice") {
            initWith(getByName("debug"))
            applicationIdSuffix = ".device"
            versionNameSuffix = "-device"
            buildConfigField(
                "String",
                "BASE_URL",
                "\"http://127.0.0.1:8000/\""
            )
        }
        release {
            isMinifyEnabled = false
            proguardFiles(
                getDefaultProguardFile("proguard-android-optimize.txt"),
                "proguard-rules.pro"
            )
            // 실제 서비스 서버 주소로 설정
            buildConfigField("String", "BASE_URL", "\"https://ansimtalk-production.up.railway.app/\"")
        }
    }
    
    compileOptions {
        sourceCompatibility = JavaVersion.VERSION_11
        targetCompatibility = JavaVersion.VERSION_11
    }
    
    kotlinOptions {
        jvmTarget = "11"
    }
    
    buildFeatures {
        buildConfig = true
        compose = true
        viewBinding = true
    }
    
    composeOptions {
        kotlinCompilerExtensionVersion = "1.5.8"
    }
    
    packaging {
        resources {
            excludes += "/META-INF/{AL2.0,LGPL2.1}"
        }
    }
}

dependencies {
    // Core Android
    implementation("androidx.core:core-ktx:1.12.0")
    implementation("androidx.lifecycle:lifecycle-runtime-ktx:2.7.0")
    implementation("androidx.activity:activity-compose:1.8.2")
    implementation("androidx.appcompat:appcompat:1.6.1")
    implementation("com.google.android.material:material:1.11.0")
    
    // Compose
    implementation(platform("androidx.compose:compose-bom:2024.02.00"))
    implementation("androidx.compose.ui:ui")
    implementation("androidx.compose.ui:ui-graphics")
    implementation("androidx.compose.ui:ui-tooling-preview")
    implementation("androidx.compose.material3:material3")
    implementation("androidx.compose.material:material-icons-extended")
    
    // Navigation
    implementation("androidx.navigation:navigation-compose:2.7.6")
    
    // ViewModel & LiveData
    implementation("androidx.lifecycle:lifecycle-viewmodel-ktx:2.7.0")
    implementation("androidx.lifecycle:lifecycle-viewmodel-compose:2.7.0")
    implementation("androidx.lifecycle:lifecycle-runtime-compose:2.7.0")
    
    // Hilt
    implementation("com.google.dagger:hilt-android:2.48")
    kapt("com.google.dagger:hilt-compiler:2.48")
    implementation("androidx.hilt:hilt-navigation-compose:1.1.0")
    
    // Retrofit & Network
    implementation("com.squareup.retrofit2:retrofit:2.9.0")
    implementation("com.squareup.retrofit2:converter-gson:2.9.0")
    implementation("com.squareup.okhttp3:logging-interceptor:4.12.0")
    implementation("com.google.code.gson:gson:2.10.1")
    
    // Coroutines
    implementation("org.jetbrains.kotlinx:kotlinx-coroutines-core:1.8.0")
    implementation("org.jetbrains.kotlinx:kotlinx-coroutines-android:1.8.0")
    
    // Image Loading
    implementation("io.coil-kt:coil-compose:2.5.0")
    
    // File Handling
    implementation("androidx.documentfile:documentfile:1.0.1")
    
    // Testing
    testImplementation("junit:junit:4.13.2")
    androidTestImplementation("androidx.test.ext:junit:1.1.5")
    androidTestImplementation("androidx.test.espresso:espresso-core:3.5.1")
    androidTestImplementation(platform("androidx.compose:compose-bom:2024.02.00"))
    androidTestImplementation("androidx.compose.ui:ui-test-junit4")
    debugImplementation("androidx.compose.ui:ui-tooling")
    debugImplementation("androidx.compose.ui:ui-test-manifest")
}

kapt {
    correctErrorTypes = true
}
```

---

### 18.4. AndroidManifest.xml

**위치**: `ansimtalk_app/app/src/main/AndroidManifest.xml`

**역할**: 앱 권한, 액티비티, 프로바이더 선언

```xml
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:tools="http://schemas.android.com/tools">

    <uses-permission android:name="android.permission.INTERNET" />
    <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
    <uses-permission android:name="android.permission.POST_NOTIFICATIONS" />

    <application
        android:name=".AnsimTalkApplication"
        android:allowBackup="true"
        android:dataExtractionRules="@xml/data_extraction_rules"
        android:fullBackupContent="@xml/backup_rules"
        android:icon="@mipmap/ic_launcher"
        android:label="@string/app_name"
        android:roundIcon="@mipmap/ic_launcher_round"
        android:supportsRtl="true"
        android:theme="@style/Theme.AnsimTalk"
        android:usesCleartextTraffic="true"
        tools:targetApi="31">

        <activity
            android:name=".MainActivity"
            android:exported="true"
            android:theme="@style/Theme.AnsimTalk">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>

        <activity
            android:name=".ResultActivity"
            android:exported="false"
            android:theme="@style/Theme.AnsimTalk" />

        <provider
            android:name="androidx.core.content.FileProvider"
            android:authorities="${applicationId}.fileprovider"
            android:exported="false"
            android:grantUriPermissions="true">
            <meta-data
                android:name="android.support.FILE_PROVIDER_PATHS"
                android:resource="@xml/file_paths" />
        </provider>

    </application>

</manifest>
```

---

### 18.5. AnsimTalkApplication.kt

**위치**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/AnsimTalkApplication.kt`

**역할**: 
- Hilt 의존성 주입 초기화 (@HiltAndroidApp)
- WebView 전역 설정 (PDF 생성 안정성)

```kotlin
package com.ansimtalk.app

import android.app.Application
import android.os.Build
import android.webkit.WebView
import dagger.hilt.android.HiltAndroidApp

@HiltAndroidApp
class AnsimTalkApplication : Application() {
    override fun onCreate() {
        super.onCreate()
        // PDF 생성 안정성을 위해 앱 시작 시점에 전체 문서 그리기 활성화
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.LOLLIPOP) {
            try {
                WebView.enableSlowWholeDocumentDraw()
            } catch (_: Throwable) {
                // 일부 환경에서 WebView 초기화 이슈가 있을 수 있으므로 무시
            }
        }
    }
}
```

---

### 18.6. MainActivity.kt

**위치**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/MainActivity.kt`

**역할**: 
- 앱 메인 진입점
- Compose UI 설정
- 오류 핸들링 및 Fallback UI

```kotlin
package com.ansimtalk.app

import android.os.Bundle
import android.util.Log
import androidx.activity.compose.setContent
import androidx.appcompat.app.AppCompatActivity
import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.padding
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Surface
import androidx.compose.material3.Text
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import com.ansimtalk.app.presentation.ui.screen.MainScreen
import com.ansimtalk.app.presentation.ui.theme.AnsimTalkTheme
import dagger.hilt.android.AndroidEntryPoint

@AndroidEntryPoint
class MainActivity : AppCompatActivity() {
    
    companion object {
        private const val TAG = "MainActivity"
    }
    
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        
        try {
            Log.d(TAG, "MainActivity onCreate 시작")
            
            // 기본 UI 설정
            setupBasicUI()
            
            Log.d(TAG, "MainActivity onCreate 완료")
            
        } catch (e: Exception) {
            Log.e(TAG, "MainActivity onCreate 오류", e)
            // 오류 발생 시 기본 오류 UI 표시
            showErrorUI("앱 초기화 오류: \${e.message}")
        }
    }
    
    private fun setupBasicUI() {
        try {
            setContent {
                AnsimTalkTheme {
                    Surface(
                        modifier = Modifier.fillMaxSize(),
                        color = MaterialTheme.colorScheme.background
                    ) {
                        MainScreen()
                    }
                }
            }
        } catch (e: Exception) {
            Log.e(TAG, "Compose UI 설정 오류", e)
            // Compose 오류 시 기본 View 기반 오류 UI 표시
            showErrorUI("UI 설정 오류: \${e.message}")
        }
    }
    
    private fun showErrorUI(errorMessage: String) {
        try {
            setContentView(android.widget.LinearLayout(this).apply {
                orientation = android.widget.LinearLayout.VERTICAL
                gravity = android.view.Gravity.CENTER
                setPadding(32, 32, 32, 32)
                
                addView(android.widget.TextView(this@MainActivity).apply {
                    text = "안심톡"
                    textSize = 24f
                    gravity = android.view.Gravity.CENTER
                    setTextColor(android.graphics.Color.BLACK)
                    setPadding(0, 0, 0, 16)
                })
                
                addView(android.widget.TextView(this@MainActivity).apply {
                    text = "앱 실행 중 오류가 발생했습니다"
                    textSize = 16f
                    gravity = android.view.Gravity.CENTER
                    setTextColor(android.graphics.Color.RED)
                    setPadding(0, 0, 0, 16)
                })
                
                addView(android.widget.TextView(this@MainActivity).apply {
                    text = errorMessage
                    textSize = 14f
                    gravity = android.view.Gravity.CENTER
                    setTextColor(android.graphics.Color.DKGRAY)
                    setPadding(0, 0, 0, 32)
                })
                
                addView(android.widget.Button(this@MainActivity).apply {
                    text = "다시 시도"
                    setOnClickListener {
                        try {
                            setupBasicUI()
                        } catch (e: Exception) {
                            Log.e(TAG, "재시도 실패", e)
                        }
                    }
                })
            })
        } catch (e: Exception) {
            Log.e(TAG, "오류 UI 표시 실패", e)
            // 최후의 수단: 기본 텍스트만 표시
            setContentView(android.widget.TextView(this).apply {
                text = "앱 오류\n$errorMessage"
                textSize = 16f
                gravity = android.view.Gravity.CENTER
                setTextColor(android.graphics.Color.RED)
                setPadding(32, 32, 32, 32)
            })
        }
    }
}
```

---

### 18.7. ResultActivity.kt

**위치**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/ResultActivity.kt`

**역할**:
- 분석 결과 표시 화면
- PDF 다운로드 버튼
- MediaStore를 통한 파일 저장

```kotlin
package com.ansimtalk.app

import android.content.ContentValues
import android.content.Context
import android.os.Bundle
import android.os.Environment
import android.provider.MediaStore
import android.widget.Toast
import androidx.activity.ComponentActivity
import androidx.activity.compose.setContent
import androidx.activity.viewModels
import androidx.compose.foundation.layout.*
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.unit.dp
import androidx.core.content.IntentCompat
import com.ansimtalk.app.data.model.AnalysisResult
import com.ansimtalk.app.data.model.Resource
import com.ansimtalk.app.presentation.viewmodel.ResultViewModel
import com.google.gson.GsonBuilder
import dagger.hilt.android.AndroidEntryPoint
import kotlinx.coroutines.flow.collectLatest
import okhttp3.ResponseBody
import java.io.IOException

@AndroidEntryPoint
class ResultActivity : ComponentActivity() {

    private val viewModel: ResultViewModel by viewModels()

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)

        val result = IntentCompat.getParcelableExtra(intent, "result", AnalysisResult::class.java)

        if (result == null) {
            Toast.makeText(this, "분석 결과를 찾을 수 없습니다.", Toast.LENGTH_SHORT).show()
            finish()
            return
        }

        setContent {
            ResultScreen(viewModel = viewModel, analysisResult = result)
        }
    }
}

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun ResultScreen(viewModel: ResultViewModel, analysisResult: AnalysisResult) {
    val context = LocalContext.current
    var isLoading by remember { mutableStateOf(false) }

    LaunchedEffect(Unit) {
        viewModel.downloadState.collectLatest {
            when (it) {
                is Resource.Loading -> {
                    isLoading = true
                }
                is Resource.Success -> {
                    isLoading = false
                    it.data.let {
                        val fileName = "AnsimTalk_Report_\${System.currentTimeMillis()}.pdf"
                        savePdfToDownloads(context, it, fileName)
                    }
                }
                is Resource.Error -> {
                    isLoading = false
                    Toast.makeText(context, "다운로드 실패: \${it.message}", Toast.LENGTH_LONG).show()
                }
            }
        }
    }

    MaterialTheme {
        Scaffold(
            topBar = {
                TopAppBar(
                    title = { Text("분석 결과", color = androidx.compose.ui.graphics.Color.White) },
                    colors = TopAppBarDefaults.topAppBarColors(
                        containerColor = com.ansimtalk.app.presentation.ui.theme.Primary800,
                        titleContentColor = androidx.compose.ui.graphics.Color.White
                    )
                )
            }
        ) {
            Column(
                modifier = Modifier
                    .fillMaxSize()
                    .padding(it)
                    .padding(16.dp),
                horizontalAlignment = Alignment.CenterHorizontally,
                verticalArrangement = Arrangement.SpaceBetween
            ) {
                AnalysisResultDetails(analysisResult)

                if (isLoading) {
                    CircularProgressIndicator()
                } else {
                    Button(
                        onClick = { viewModel.downloadPdf(analysisResult) },
                        modifier = Modifier.fillMaxWidth()
                    ) {
                        Text("PDF 보고서 다운로드")
                    }
                }
            }
        }
    }
}

@Composable
fun AnalysisResultDetails(result: AnalysisResult) {
    val gson = GsonBuilder().setPrettyPrinting().create()
    val resultJson = gson.toJson(result)
    Card(modifier = Modifier.fillMaxWidth()) {
        Column(modifier = Modifier.padding(16.dp)) {
            Text(text = resultJson, style = MaterialTheme.typography.bodySmall)
        }
    }
}

private fun savePdfToDownloads(context: Context, body: ResponseBody, fileName: String) {
    val contentValues = ContentValues().apply {
        put(MediaStore.MediaColumns.DISPLAY_NAME, fileName)
        put(MediaStore.MediaColumns.MIME_TYPE, "application/pdf")
        put(MediaStore.MediaColumns.RELATIVE_PATH, Environment.DIRECTORY_DOWNLOADS)
    }

    val resolver = context.contentResolver
    val uri = resolver.insert(MediaStore.Downloads.EXTERNAL_CONTENT_URI, contentValues)

    if (uri != null) {
        try {
            resolver.openOutputStream(uri).use { outputStream ->
                if (outputStream == null) {
                    throw IOException("Failed to get output stream.")
                }
                body.byteStream().use { inputStream ->
                    inputStream.copyTo(outputStream)
                }
            }
            Toast.makeText(context, "다운로드 완료: Downloads 폴더를 확인하세요.", Toast.LENGTH_LONG).show()
        } catch (e: IOException) {
            e.printStackTrace()
            Toast.makeText(context, "파일 저장 실패: \${e.message}", Toast.LENGTH_LONG).show()
        }
    } else {
        Toast.makeText(context, "파일 저장 실패: URI를 생성할 수 없습니다.", Toast.LENGTH_LONG).show()
    }
}
```

---

### 18.8. Data Models (데이터 모델)

#### AnalysisResult.kt

**위치**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/data/model/AnalysisResult.kt`

**역할**: 서버 API 응답 데이터 모델, Parcelable로 액티비티 간 전달 가능

```kotlin
package com.ansimtalk.app.data.model

import android.os.Parcelable
import com.google.gson.annotations.SerializedName
import kotlinx.parcelize.Parcelize

@Parcelize
data class AnalysisResult(
    @SerializedName("file_info")
    val fileInfo: FileInfo,
    @SerializedName("analysis_timestamp")
    val analysisTimestamp: String,
    @SerializedName("sha256")
    val sha256: String,
    @SerializedName("analysis_type")
    val analysisType: String,
    @SerializedName("deepfake_analysis")
    val deepfakeAnalysis: DeepfakeAnalysis?,
    @SerializedName("extracted_text")
    val extractedText: String?,
    @SerializedName("cyberbullying_analysis")
    val cyberbullyingAnalysis: String?,
    @SerializedName("cyberbullying_analysis_summary")
    val cyberbullyingAnalysisSummary: String?,
    @SerializedName("cyberbullying_risk_line")
    val cyberbullyingRiskLine: String?,
    @SerializedName("original_image_path")
    val originalImagePath: String?,
    @SerializedName("error")
    val error: String?,
    // MainScreen.kt에서 사용하는 필드 추가
    val result: String?,
    val confidence: Double?
) : Parcelable

@Parcelize
data class FileInfo(
    @SerializedName("filename")
    val filename: String,
    @SerializedName("type")
    val type: String,
    @SerializedName("size_bytes")
    val sizeBytes: Long
) : Parcelable

@Parcelize
data class DeepfakeAnalysis(
    @SerializedName("status")
    val status: String,
    @SerializedName("request")
    val request: Request?,
    @SerializedName("type")
    val type: Type?,
    @SerializedName("offensive")
    val offensive: Offensive?,
    @SerializedName("nudity")
    val nudity: Nudity?,
    @SerializedName("wad")
    val wad: Wad?,
    @SerializedName("error")
    val error: String?
) : Parcelable

@Parcelize
data class Request(
    @SerializedName("id")
    val id: String,
    @SerializedName("timestamp")
    val timestamp: Double,
    @SerializedName("operations")
    val operations: Int
) : Parcelable

@Parcelize
data class Type(
    @SerializedName("ai_generated")
    val aiGenerated: Double,
    @SerializedName("deepfake")
    val deepfake: Double
) : Parcelable

@Parcelize
data class Offensive(
    @SerializedName("prob")
    val prob: Double
) : Parcelable

@Parcelize
data class Nudity(
    @SerializedName("sexual_activity")
    val sexualActivity: Double,
    @SerializedName("sexual_display")
    val sexualDisplay: Double,
    @SerializedName("erotica")
    val erotica: Double,
    @SerializedName("suggestive")
    val suggestive: Double,
    @SerializedName("none")
    val none: Double,
    @SerializedName("raw")
    val raw: Double
) : Parcelable

@Parcelize
data class Wad(
    @SerializedName("prob")
    val prob: Double
) : Parcelable
```

---

### 18.9. Resource.kt

**위치**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/data/model/Resource.kt`

**역할**: API 응답 상태를 감싸는 래퍼 클래스 (Loading/Success/Error)

```kotlin
package com.ansimtalk.app.data.model

sealed class Resource<out T> {
    object Loading : Resource<Nothing>()
    data class Success<T>(val data: T) : Resource<T>()
    data class Error(val message: String) : Resource<Nothing>()
}
```

---

### 18.10. PdfRequestBody.kt

**위치**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/data/model/PdfRequestBody.kt`

**역할**: PDF 생성 API 요청 바디

```kotlin
package com.ansimtalk.app.data.model

import com.google.gson.annotations.SerializedName

data class PdfRequestBody(
    @SerializedName("analysis_type")
    val analysisType: String,
    @SerializedName("analysis_result")
    val analysisResult: AnalysisResult,
    @SerializedName("original_image_path")
    val originalImagePath: String? = null
)
```

---

### 18.11. PdfGenerationResult.kt

**위치**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/data/model/PdfGenerationResult.kt`

**역할**: PDF 생성 결과 상태

```kotlin
package com.ansimtalk.app.data.model

import okhttp3.ResponseBody
import java.io.File

sealed class PdfGenerationResult {
    data class Success(val data: Any) : PdfGenerationResult() // ResponseBody or File
    data class Failure(val error: Exception) : PdfGenerationResult()
}
```

---

### 18.12. PdfErrors.kt

**위치**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/data/model/PdfErrors.kt`

**역할**: PDF 다운로드 오류 분류 및 상세 메시지 제공

```kotlin
package com.ansimtalk.app.data.model

/** 상세 원인을 담는 예외. UI/로그에서 분기 처리 가능 */
class PdfDownloadException(
    val kind: Kind,
    val httpCode: Int? = null,
    val serverMessage: String? = null,
    val serverBody: String? = null,
    cause: Throwable? = null
) : Exception(buildMessage(kind, httpCode, serverMessage, serverBody), cause) {
    enum class Kind { Network, Http4xx, Http5xx, EmptyBody, Unexpected }

    companion object {
        private fun buildMessage(kind: Kind, code: Int?, msg: String?, body: String?): String {
            return when (kind) {
                Kind.Network -> "서버 연결 실패(네트워크/타임아웃)."
                Kind.Http4xx -> "요청 오류(\${code ?: "4xx"}): \${msg ?: "클라이언트 요청 검증 실패"}\${body?.let { " | $it" } ?: ""}"
                Kind.Http5xx -> "서버 오류(\${code ?: "5xx"}): \${msg ?: "서버 내부 오류"}\${body?.let { " | $it" } ?: ""}"
                Kind.EmptyBody -> "서버 응답이 비어 있습니다(2xx인데 body null)."
                Kind.Unexpected -> "예상치 못한 오류: \${msg ?: "원인 불명"}"
            }
        }
    }
}
```

---

### 18.13. API Services

#### AnsimTalkApiService.kt

**위치**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/data/api/AnsimTalkApiService.kt`

**역할**: Retrofit API 인터페이스 정의

```kotlin
package com.ansimtalk.app.data.api

import com.ansimtalk.app.data.model.AnalysisResult
import okhttp3.MultipartBody
import okhttp3.ResponseBody
import retrofit2.Response
import retrofit2.http.*

interface AnsimTalkApiService {
    @Multipart
    @POST("analyze_deepfake")
    suspend fun analyzeDeepfake(@Part file: MultipartBody.Part): Response<AnalysisResult>

    @Multipart
    @POST("analyze_cyberbullying")
    suspend fun analyzeCyberbullying(@Part file: MultipartBody.Part): Response<AnalysisResult>

    @GET("download_pdf")
    suspend fun downloadPdf(): Response<ResponseBody>

    @GET("health")
    suspend fun healthCheck(): Response<Map<String, Any>>

    @GET("results")
    suspend fun getResults(): Response<List<AnalysisResult>>

    @GET("evidence")
    suspend fun getEvidence(): Response<Map<String, Any>>
}
```

---

#### ApiService.kt

**위치**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/data/remote/ApiService.kt`

**역할**: 실제 HTTP 요청 인터페이스

```kotlin
package com.ansimtalk.app.data.remote

import com.ansimtalk.app.data.model.PdfRequestBody
import okhttp3.MultipartBody
import okhttp3.ResponseBody
import retrofit2.http.GET
import retrofit2.http.Multipart
import retrofit2.http.POST
import retrofit2.http.Part
import retrofit2.Response
import retrofit2.http.Body
import retrofit2.http.Headers

interface ApiService {
    @GET("/api/health")
    suspend fun healthCheck(): Map<String, Any>

    @Multipart
    @Headers("Accept: application/json")
    @POST("/api/analyze_deepfake")
    suspend fun analyzeDeepfake(@Part file: MultipartBody.Part): Response<ResponseBody>

    @Multipart
    @Headers("Accept: application/json")
    @POST("/api/analyze_cyberbullying")
    suspend fun analyzeCyberbullying(@Part file: MultipartBody.Part): Response<ResponseBody>

    @POST("/api/download_pdf")
    suspend fun downloadPdf(@Body body: PdfRequestBody): Response<ResponseBody>
}
```

---

### 18.14. Repositories

#### AnsimTalkRepository.kt (Domain Interface)

**위치**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/domain/repository/AnsimTalkRepository.kt`

**역할**: 리포지토리 인터페이스 (Clean Architecture)

```kotlin
package com.ansimtalk.app.domain.repository

import com.ansimtalk.app.data.model.AnalysisResult
import com.ansimtalk.app.data.model.PdfRequestBody
import com.ansimtalk.app.data.model.Resource
import kotlinx.coroutines.flow.Flow
import okhttp3.MultipartBody
import okhttp3.ResponseBody

interface AnsimTalkRepository {
    fun healthCheck(): Flow<Resource<Map<String, Any>>>
    fun analyzeDeepfake(file: MultipartBody.Part): Flow<Resource<AnalysisResult>>
    fun analyzeCyberbullying(file: MultipartBody.Part): Flow<Resource<AnalysisResult>>
    fun downloadPdf(body: PdfRequestBody): Flow<Resource<ResponseBody>>
    fun getResults(): Flow<Resource<List<AnalysisResult>>>
    fun getEvidence(): Flow<Resource<Map<String, Any>>>
}
```

---

#### AnsimTalkRepositoryImpl.kt

**위치**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/data/repository/AnsimTalkRepositoryImpl.kt`

**역할**: 리포지토리 구현 (API 호출, JSON 파싱, 오류 핸들링)

```kotlin
package com.ansimtalk.app.data.repository

import com.ansimtalk.app.data.model.AnalysisResult
import com.ansimtalk.app.data.model.PdfRequestBody
import com.ansimtalk.app.data.model.Resource
import com.ansimtalk.app.data.remote.ApiService
import com.ansimtalk.app.domain.repository.AnsimTalkRepository
import kotlinx.coroutines.flow.Flow
import kotlinx.coroutines.flow.flow
import okhttp3.MultipartBody
import okhttp3.ResponseBody
import javax.inject.Inject

class AnsimTalkRepositoryImpl @Inject constructor(
    private val apiService: ApiService
) : AnsimTalkRepository {
    override fun healthCheck(): Flow<Resource<Map<String, Any>>> = flow {
        emit(Resource.Loading)
        try {
            val response = apiService.healthCheck()
            emit(Resource.Success(response))
        } catch (e: Exception) {
            val message = e.message ?: "Unknown Error"
            emit(Resource.Error(message))
        }
    }

    override fun analyzeDeepfake(file: MultipartBody.Part): Flow<Resource<AnalysisResult>> = flow {
        emit(Resource.Loading)
        try {
            val response = apiService.analyzeDeepfake(file)
            if (response.isSuccessful) {
                val body = response.body()?.string() ?: "{}"
                val trimmed = body.trim()
                if (!trimmed.startsWith("{")) {
                    val snippet = trimmed.take(300)
                    emit(Resource.Error("서버가 JSON 대신 문자열을 반환: $snippet"))
                    return@flow
                }
                val gson = com.google.gson.Gson()
                val parsed = gson.fromJson(trimmed, com.ansimtalk.app.data.model.AnalysisResult::class.java)
                val errorText = parsed.error
                val deepfakeStatus = parsed.deepfakeAnalysis?.status ?: ""
                if (errorText != null && errorText.isNotBlank()) {
                    emit(Resource.Error(errorText))
                } else if (deepfakeStatus.equals("error", ignoreCase = true)) {
                    val fallback = parsed.copy(
                        deepfakeAnalysis = com.ansimtalk.app.data.model.DeepfakeAnalysis(
                            status = "fallback",
                            request = com.ansimtalk.app.data.model.Request("n/a", 0.0, 0),
                            type = com.ansimtalk.app.data.model.Type(0.0, 0.0),
                            offensive = com.ansimtalk.app.data.model.Offensive(0.0),
                            nudity = com.ansimtalk.app.data.model.Nudity(0.0,0.0,0.0,0.0,0.0,0.0),
                            wad = com.ansimtalk.app.data.model.Wad(0.0),
                            error = null
                        ),
                        error = null
                    )
                    emit(Resource.Success(fallback))
                } else {
                    emit(Resource.Success(parsed))
                }
            } else {
                val raw = response.errorBody()?.string() ?: "HTTP \${response.code()}"
                val gson = com.google.gson.Gson()
                val isModelErrorJson = raw.contains("\"status\"") && raw.contains("\"code\"") && raw.contains("\"message\"")
                if (isModelErrorJson) {
                    val now = java.time.LocalDateTime.now().toString()
                    val fallback = com.ansimtalk.app.data.model.AnalysisResult(
                        fileInfo = com.ansimtalk.app.data.model.FileInfo(filename = "N/A", type = "deepfake", sizeBytes = 0L),
                        analysisTimestamp = now,
                        sha256 = "N/A",
                        analysisType = "deepfake",
                        deepfakeAnalysis = com.ansimtalk.app.data.model.DeepfakeAnalysis(
                            status = "fallback",
                            request = com.ansimtalk.app.data.model.Request("n/a", 0.0, 0),
                            type = com.ansimtalk.app.data.model.Type(0.0, 0.0),
                            offensive = com.ansimtalk.app.data.model.Offensive(0.0),
                            nudity = com.ansimtalk.app.data.model.Nudity(0.0,0.0,0.0,0.0,0.0,0.0),
                            wad = com.ansimtalk.app.data.model.Wad(0.0),
                            error = null
                        ),
                        extractedText = null,
                        cyberbullyingAnalysis = null,
                        cyberbullyingAnalysisSummary = null,
                        cyberbullyingRiskLine = null,
                        error = null,
                        result = null,
                        confidence = null,
                        originalImagePath = null
                    )
                    emit(Resource.Success(fallback))
                } else {
                    val message = try {
                        val mapType = object : com.google.gson.reflect.TypeToken<Map<String, Any>>() {}.type
                        val map: Map<String, Any> = gson.fromJson(raw, mapType)
                        map["error"]?.toString() ?: raw
                    } catch (_: Exception) {
                        raw
                    }
                    emit(Resource.Error(message))
                }
            }
        } catch (e: Exception) {
            val message = e.message ?: "Unknown Error"
            emit(Resource.Error(message))
        }
    }

    override fun analyzeCyberbullying(file: MultipartBody.Part): Flow<Resource<AnalysisResult>> = flow {
        emit(Resource.Loading)
        try {
            val response = apiService.analyzeCyberbullying(file)
            if (response.isSuccessful) {
                val body = response.body()?.string() ?: "{}"
                val trimmed = body.trim()
                if (!trimmed.startsWith("{")) {
                    val snippet = trimmed.take(300)
                    emit(Resource.Error("서버가 JSON 대신 문자열을 반환: $snippet"))
                    return@flow
                }
                val gson = com.google.gson.Gson()
                val parsed = gson.fromJson(trimmed, com.ansimtalk.app.data.model.AnalysisResult::class.java)
                val errorText = parsed.error
                if (errorText != null && errorText.isNotBlank()) {
                    emit(Resource.Error(errorText))
                } else {
                    emit(Resource.Success(parsed))
                }
            } else {
                val raw = response.errorBody()?.string() ?: "HTTP \${response.code()}"
                val gson = com.google.gson.Gson()
                val message = try {
                    val mapType = object : com.google.gson.reflect.TypeToken<Map<String, Any>>() {}.type
                    val map: Map<String, Any> = gson.fromJson(raw, mapType)
                    map["error"]?.toString() ?: raw
                } catch (_: Exception) {
                    raw
                }
                emit(Resource.Error(message))
            }
        } catch (e: Exception) {
            val message = e.message ?: "Unknown Error"
            emit(Resource.Error(message))
        }
    }

    override fun downloadPdf(body: PdfRequestBody): Flow<Resource<ResponseBody>> = flow {
        emit(Resource.Loading)
        try {
            val response = apiService.downloadPdf(body)
            if (response.isSuccessful) {
                response.body()?.let {
                    emit(Resource.Success(it))
                } ?: emit(Resource.Error("PDF 데이터가 비어있습니다."))
            } else {
                val errorBody = response.errorBody()?.string() ?: "알 수 없는 오류"
                emit(Resource.Error("PDF 다운로드 실패: $errorBody"))
            }
        } catch (e: Exception) {
            emit(Resource.Error("네트워크 오류: \${e.message}"))
        }
    }

    override fun getResults(): Flow<Resource<List<AnalysisResult>>> = flow {
        emit(Resource.Loading)
        try {
            // 임시로 빈 리스트 반환 (실제로는 API에서 결과를 가져와야 함)
            emit(Resource.Success(emptyList()))
        } catch (e: Exception) {
            emit(Resource.Error(e.message ?: "Unknown Error"))
        }
    }

    override fun getEvidence(): Flow<Resource<Map<String, Any>>> = flow {
        emit(Resource.Loading)
        try {
            // 임시로 빈 맵 반환 (실제로는 API에서 증거를 가져와야 함)
            emit(Resource.Success(emptyMap()))
        } catch (e: Exception) {
            emit(Resource.Error(e.message ?: "Unknown Error"))
        }
    }
}
```

---

#### PdfRepository.kt

**위치**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/data/repository/PdfRepository.kt`

**역할**: 
- 서버 PDF 생성 API 호출
- WebView 기반 로컬 PDF 생성 (Fallback)
- MediaStore를 통한 파일 저장

```kotlin
package com.ansimtalk.app.data.repository

import android.content.ContentValues
import android.content.Context
import android.os.Environment
import android.webkit.WebView
import android.view.View
import android.view.View.MeasureSpec
import android.graphics.pdf.PdfDocument
import android.graphics.Bitmap
import android.graphics.Canvas
import android.graphics.Paint
import android.os.Handler
import android.os.Looper
import com.ansimtalk.app.data.model.PdfGenerationResult
import com.ansimtalk.app.data.model.PdfDownloadException
import com.ansimtalk.app.data.model.PdfRequestBody
import com.ansimtalk.app.data.remote.ApiService
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.suspendCancellableCoroutine
import kotlinx.coroutines.withContext
import okhttp3.ResponseBody
import java.io.File
import kotlin.coroutines.resume

class PdfRepository(
    private val context: Context,
    private val apiService: ApiService
) {
    suspend fun generatePdfReport(body: PdfRequestBody): PdfGenerationResult {
        return try {
            val response = withContext(Dispatchers.IO) { apiService.downloadPdf(body) }
            if (response.isSuccessful) {
                val rb: ResponseBody? = response.body()
                if (rb != null) PdfGenerationResult.Success(rb)
                else PdfGenerationResult.Failure(PdfDownloadException(PdfDownloadException.Kind.EmptyBody))
            } else {
                val code = response.code()
                val errText = try { response.errorBody()?.string() } catch (_: Exception) { null }
                android.util.Log.e("PdfRepository", "download_pdf failed: code=$code body=$errText")
                val kind = if (code in 400..499) PdfDownloadException.Kind.Http4xx else PdfDownloadException.Kind.Http5xx
                PdfGenerationResult.Failure(PdfDownloadException(kind, httpCode = code, serverMessage = response.message(), serverBody = errText))
            }
        } catch (e: java.net.SocketTimeoutException) {
            PdfGenerationResult.Failure(PdfDownloadException(PdfDownloadException.Kind.Network, serverMessage = e.message, cause = e))
        } catch (e: java.io.IOException) {
            PdfGenerationResult.Failure(PdfDownloadException(PdfDownloadException.Kind.Network, serverMessage = e.message, cause = e))
        } catch (e: Exception) {
            PdfGenerationResult.Failure(PdfDownloadException(PdfDownloadException.Kind.Unexpected, serverMessage = e.message, cause = e))
        }
    }

    // 서버 PDF만 사용하므로 HTML/로컬 폴백 경로 제거

    private fun enforceA4Width(html: String): String {
        // 1) viewport를 고정 폭으로 교체
        val viewportRegex = Regex("<meta[^>]*name=\\\"viewport\\\"[^>]*>", RegexOption.IGNORE_CASE)
        var out = viewportRegex.replace(html) {
            """<meta name=\"viewport\" content=\"width=595, initial-scale=1, maximum-scale=1, user-scalable=no\" />"""
        }
        if (!out.contains("name=\"viewport\"", ignoreCase = true)) {
            out = out.replace("</head>", """<meta name=\"viewport\" content=\"width=595, initial-scale=1\" /></head>""", ignoreCase = true)
        }
        // 2) html/body 폭을 595px로 고정하는 스타일 주입
        val style = """
            <style>
              html, body { width:595px !important; margin:0; padding:0; }
              body { margin:40px; -webkit-text-size-adjust:100%; }
            </style>
        """.trimIndent()
        return if (out.contains("</head>", ignoreCase = true))
            out.replace(Regex("</head>", RegexOption.IGNORE_CASE), style + "\n</head>")
        else "<head>$style</head>$out"
    }

    private fun buildHtmlFromBody(body: PdfRequestBody): String {
        // 경량 HTML 템플릿 (값 실제 치환, 모바일/웹뷰 렌더 안정 CSS 포함)
        val result = body.analysisResult
        val createdAt = java.time.LocalDateTime.now().toString().replace('T',' ')
        val reportId = "DF-CB-\${java.time.LocalDate.now()}-001-v1.0"
        val deepfakeProb = result.deepfakeAnalysis?.type?.deepfake ?: 0.0
        val cbRisk = result.cyberbullyingRiskLine ?: "N/A"
        val summary = if (body.analysisType == "deepfake")
            "딥페이크 확률: \${String.format("%.1f%%", deepfakeProb * 100)}"
        else
            "사이버폭력 위험도: $cbRisk"
        val fileName = result.fileInfo.filename
        val fileSize = "\${result.fileInfo.sizeBytes} bytes"
        val sha256 = result.sha256
        val extracted = result.extractedText ?: ""
        val cbHtml = result.cyberbullyingAnalysis ?: ""
        val cbSummary = result.cyberbullyingAnalysisSummary ?: ""

        return """
            <!DOCTYPE html>
            <html lang="ko">
            <head>
              <meta charset="UTF-8" />
              <meta name="viewport" content="width=device-width, initial-scale=1" />
              <style>
                html, body { margin:0; padding:0; width:595px; }
                body{
                  font-family: 'Noto Sans KR', 'Malgun Gothic', Arial, sans-serif;
                  margin:40px; line-height:1.6; color:#333;
                  word-break: keep-all; white-space: normal; letter-spacing: normal;
                }
                h1,h2{ color:#1976d2; margin: 0 0 12px 0; }
                table{ border-collapse:collapse; width:100%; font-size:12px; margin:12px 0 }
                th,td{ border:1px solid #ddd; padding:8px 12px; text-align:left }
                .box{ background:#f0f4ff; border-left:4px solid #1976d2; border-radius:8px; padding:12px; margin:12px 0 }
                .container{ max-width:100%; }
              </style>
            </head>
            <body>
              <div class="container">
                <h1>안심톡 디지털 증거 분석 보고서</h1>
                <h2>1. 기본 정보</h2>
                <table>
                  <tr><th>보고서 ID</th><td>$reportId</td></tr>
                  <tr><th>생성일시</th><td>$createdAt</td></tr>
                  <tr><th>분석 유형</th><td>\${body.analysisType}</td></tr>
                </table>

                <h2>2. 분석 결과 요약</h2>
                <div class="box">$summary</div>

                <h2>3. 증거 파일 정보</h2>
                <table>
                  <tr><th>파일명</th><td>$fileName</td></tr>
                  <tr><th>파일 크기</th><td>$fileSize</td></tr>
                  <tr><th>SHA-256</th><td style="font-family:monospace;">$sha256</td></tr>
                </table>

                <h2>4. 원본 텍스트(OCR)</h2>
                <div class="box" style="font-family:monospace; white-space:pre-wrap;">$extracted</div>

                <h2>5. AI 분석 상세</h2>
                <div class="box">\${cbHtml}</div>
                <h2>6. 분석 요약</h2>
                <div class="box">\${cbSummary.replace("\n", "<br>")}</div>
              </div>
            </body>
            </html>
        """.trimIndent()
    }

    private suspend fun generatePdfLocally(html: String): PdfGenerationResult = withContext(Dispatchers.Main) {
        suspendCancellableCoroutine { cont ->
            val pageWidthPt = 595 // A4 72dpi 기준 폭 (pt)
            val pageHeightPt = 842
            val scale = 1 // 서버 템플릿(A4 폭 595px) 기준 축소 왜곡 방지 위해 1배 스케일로 렌더
            val webView = WebView(context)
            webView.settings.javaScriptEnabled = false
            webView.setLayerType(View.LAYER_TYPE_SOFTWARE, null)
            webView.settings.textZoom = 100
            webView.settings.useWideViewPort = false
            webView.settings.loadWithOverviewMode = false
            webView.webViewClient = object : android.webkit.WebViewClient() {
                override fun onPageFinished(view: WebView?, url: String?) {
                    try {
                        // A4 폭 기반 레이아웃 폭
                        val contentWidthPx = pageWidthPt * scale

                        val handler = Handler(Looper.getMainLooper())
                        var tries = 0
                        var lastHeight = 0

                        fun proceed() {
                            try {
                                val contentHeightPx = (webView.contentHeight * scale).coerceAtLeast(pageHeightPt * scale)
                                val pageHeightPx = pageHeightPt * scale
                                webView.layout(0, 0, contentWidthPx, contentHeightPx)

                                val pdf = PdfDocument()
                                var currentY = 0
                                var pageNumber = 1
                                while (currentY < contentHeightPx && pageNumber <= 100) {
                                    val visible = kotlin.math.min(pageHeightPx, contentHeightPx - currentY)
                                    val bitmap = Bitmap.createBitmap(contentWidthPx, visible, Bitmap.Config.ARGB_8888)
                                    val canvas = Canvas(bitmap)
                                    canvas.drawColor(android.graphics.Color.WHITE)
                                    canvas.save()
                                    canvas.translate(0f, -currentY.toFloat())
                                    webView.draw(canvas)
                                    canvas.restore()

                                    val pageInfo = PdfDocument.PageInfo.Builder(pageWidthPt, pageHeightPt, pageNumber).create()
                                    val page = pdf.startPage(pageInfo)
                                    val paint = Paint(Paint.FILTER_BITMAP_FLAG)
                                    page.canvas.save()
                                    val scaleX = pageWidthPt.toFloat() / contentWidthPx.toFloat()
                                    val scaleY = pageHeightPt.toFloat() / pageHeightPx.toFloat()
                                    page.canvas.scale(scaleX, scaleY)
                                    page.canvas.drawBitmap(bitmap, 0f, 0f, paint)
                                    page.canvas.restore()
                                    pdf.finishPage(page)
                                    bitmap.recycle()

                                    currentY += visible
                                    pageNumber += 1
                                }

                                val outFile = File(context.cacheDir, "evidence_\${System.currentTimeMillis()}.pdf")
                                outFile.outputStream().use { pdf.writeTo(it) }
                                pdf.close()
                                webView.destroy()
                                cont.resume(PdfGenerationResult.Success(outFile))
                            } catch (e: Exception) {
                                cont.resume(PdfGenerationResult.Failure(e))
                            }
                        }

                        fun waitStable() {
                            webView.measure(
                                MeasureSpec.makeMeasureSpec(contentWidthPx, MeasureSpec.EXACTLY),
                                MeasureSpec.makeMeasureSpec(0, MeasureSpec.UNSPECIFIED)
                            )
                            val h = webView.contentHeight
                            if ((h > 0 && kotlin.math.abs(h - lastHeight) < 2) || tries >= 40) {
                                proceed()
                            } else {
                                lastHeight = h
                                tries += 1
                                handler.postDelayed({ waitStable() }, 50)
                            }
                        }

                        waitStable()
                    } catch (e: Exception) {
                        cont.resume(PdfGenerationResult.Failure(e))
                    }
                }

                override fun onReceivedError(view: WebView?, request: android.webkit.WebResourceRequest?, error: android.webkit.WebResourceError?) {
                    cont.resume(PdfGenerationResult.Failure(Exception("WebView error")))
                }
            }
            webView.loadDataWithBaseURL("about:blank", html, "text/html", "UTF-8", null)
        }
    }

    fun saveToDownloads(bytes: ByteArray, displayName: String): Boolean {
        val values = ContentValues().apply {
            put(android.provider.MediaStore.MediaColumns.DISPLAY_NAME, displayName)
            put(android.provider.MediaStore.MediaColumns.MIME_TYPE, "application/pdf")
            put(android.provider.MediaStore.MediaColumns.RELATIVE_PATH, Environment.DIRECTORY_DOWNLOADS)
        }
        val resolver = context.contentResolver
        val uri = resolver.insert(android.provider.MediaStore.Downloads.EXTERNAL_CONTENT_URI, values)
        if (uri != null) {
            resolver.openOutputStream(uri).use { out ->
                if (out != null) {
                    out.write(bytes)
                    out.flush()
                    return true
                }
            }
        }
        return false
    }
}
```

---

### 18.15. Use Cases

#### AnalyzeDeepfakeUseCase.kt

**위치**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/domain/usecase/AnalyzeDeepfakeUseCase.kt`

```kotlin
package com.ansimtalk.app.domain.usecase

import com.ansimtalk.app.data.model.AnalysisResult
import com.ansimtalk.app.data.model.Resource
import com.ansimtalk.app.domain.repository.AnsimTalkRepository
import kotlinx.coroutines.flow.Flow
import okhttp3.MultipartBody
import javax.inject.Inject

class AnalyzeDeepfakeUseCase @Inject constructor(
    private val repository: AnsimTalkRepository
) {
    operator fun invoke(file: MultipartBody.Part): Flow<Resource<AnalysisResult>> {
        return repository.analyzeDeepfake(file)
    }
}
```

---

#### AnalyzeCyberbullyingUseCase.kt

**위치**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/domain/usecase/AnalyzeCyberbullyingUseCase.kt`

```kotlin
package com.ansimtalk.app.domain.usecase

import com.ansimtalk.app.data.model.AnalysisResult
import com.ansimtalk.app.data.model.Resource
import com.ansimtalk.app.domain.repository.AnsimTalkRepository
import kotlinx.coroutines.flow.Flow
import okhttp3.MultipartBody
import javax.inject.Inject

class AnalyzeCyberbullyingUseCase @Inject constructor(
    private val repository: AnsimTalkRepository
) {
    operator fun invoke(file: MultipartBody.Part): Flow<Resource<AnalysisResult>> {
        return repository.analyzeCyberbullying(file)
    }
}
```

---

#### GeneratePdfUseCase.kt

**위치**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/domain/usecase/GeneratePdfUseCase.kt`

```kotlin
package com.ansimtalk.app.domain.usecase

import com.ansimtalk.app.data.model.PdfGenerationResult
import com.ansimtalk.app.data.model.PdfRequestBody
import com.ansimtalk.app.data.repository.PdfRepository
import javax.inject.Inject

class GeneratePdfUseCase @Inject constructor(
    private val repository: PdfRepository
) {
    suspend operator fun invoke(body: PdfRequestBody): PdfGenerationResult {
        return repository.generatePdfReport(body)
    }
}
```

---

#### DownloadPdfUseCase.kt

**위치**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/domain/usecase/DownloadPdfUseCase.kt`

```kotlin
package com.ansimtalk.app.domain.usecase

import com.ansimtalk.app.data.model.PdfRequestBody
import com.ansimtalk.app.data.model.Resource
import com.ansimtalk.app.domain.repository.AnsimTalkRepository
import kotlinx.coroutines.flow.Flow
import okhttp3.ResponseBody
import javax.inject.Inject

class DownloadPdfUseCase @Inject constructor(
    private val repository: AnsimTalkRepository
) {
    operator fun invoke(body: PdfRequestBody): Flow<Resource<ResponseBody>> {
        return repository.downloadPdf(body)
    }
}
```

---

#### HealthCheckUseCase.kt

**위치**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/domain/usecase/HealthCheckUseCase.kt`

```kotlin
package com.ansimtalk.app.domain.usecase

import com.ansimtalk.app.data.model.Resource
import com.ansimtalk.app.domain.repository.AnsimTalkRepository
import kotlinx.coroutines.flow.Flow
import javax.inject.Inject

class HealthCheckUseCase @Inject constructor(
    private val repository: AnsimTalkRepository
) {
    operator fun invoke(): Flow<Resource<Map<String, Any>>> {
        return repository.healthCheck()
    }
}
```

---

#### GetResultsUseCase.kt

**위치**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/domain/usecase/GetResultsUseCase.kt`

```kotlin
package com.ansimtalk.app.domain.usecase

import com.ansimtalk.app.data.model.AnalysisResult
import com.ansimtalk.app.data.model.Resource
import com.ansimtalk.app.domain.repository.AnsimTalkRepository
import kotlinx.coroutines.flow.Flow
import javax.inject.Inject

class GetResultsUseCase @Inject constructor(
    private val repository: AnsimTalkRepository
) {
    operator fun invoke(): Flow<Resource<List<AnalysisResult>>> {
        return repository.getResults()
    }
}
```

---

#### GetEvidenceUseCase.kt

**위치**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/domain/usecase/GetEvidenceUseCase.kt`

```kotlin
package com.ansimtalk.app.domain.usecase

import com.ansimtalk.app.data.model.Resource
import com.ansimtalk.app.domain.repository.AnsimTalkRepository
import kotlinx.coroutines.flow.Flow
import javax.inject.Inject

class GetEvidenceUseCase @Inject constructor(
    private val repository: AnsimTalkRepository
) {
    operator fun invoke(): Flow<Resource<Map<String, Any>>> {
        return repository.getEvidence()
    }
}
```

---

### 18.16. DI Modules

#### NetworkModule.kt

**위치**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/di/NetworkModule.kt`

**역할**: Retrofit, OkHttpClient 설정 및 제공

```kotlin
package com.ansimtalk.app.di

import com.ansimtalk.app.data.remote.ApiService
import com.ansimtalk.app.BuildConfig
import dagger.Module
import dagger.Provides
import dagger.hilt.InstallIn
import dagger.hilt.components.SingletonComponent
import okhttp3.OkHttpClient
import okhttp3.logging.HttpLoggingInterceptor
import retrofit2.Retrofit
import retrofit2.converter.gson.GsonConverterFactory
import javax.inject.Singleton
import com.google.gson.GsonBuilder

@Module
@InstallIn(SingletonComponent::class)
object NetworkModule {

    @Provides
    @Singleton
    fun provideLoggingInterceptor(): HttpLoggingInterceptor {
        return HttpLoggingInterceptor().setLevel(HttpLoggingInterceptor.Level.BODY)
    }

    @Provides
    @Singleton
    fun provideOkHttpClient(loggingInterceptor: HttpLoggingInterceptor): OkHttpClient {
        return OkHttpClient.Builder()
            .addInterceptor(loggingInterceptor)
            .addInterceptor { chain ->
                val original = chain.request()
                val request = original.newBuilder()
                    .header("Accept", "application/json")
                    .build()
                chain.proceed(request)
            }
            .retryOnConnectionFailure(true)
            .connectTimeout(15, java.util.concurrent.TimeUnit.SECONDS)
            .readTimeout(60, java.util.concurrent.TimeUnit.SECONDS)
            .writeTimeout(60, java.util.concurrent.TimeUnit.SECONDS)
            .callTimeout(75, java.util.concurrent.TimeUnit.SECONDS)
            .build()
    }

    @Provides
    @Singleton
    fun provideRetrofit(okHttpClient: OkHttpClient): Retrofit {
        val gson = GsonBuilder()
            .setLenient()
            .create()
        return Retrofit.Builder()
            .baseUrl(BuildConfig.BASE_URL)
            .client(okHttpClient)
            .addConverterFactory(GsonConverterFactory.create(gson))
            .build()
    }

    @Provides
    @Singleton
    fun provideApiService(retrofit: Retrofit): ApiService {
        return retrofit.create(ApiService::class.java)
    }
}
```

---

#### RepositoryModule.kt

**위치**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/di/RepositoryModule.kt`

**역할**: Repository 바인딩 및 제공

```kotlin
package com.ansimtalk.app.di

import android.content.Context
import com.ansimtalk.app.data.remote.ApiService
import com.ansimtalk.app.data.repository.AnsimTalkRepositoryImpl
import com.ansimtalk.app.data.repository.PdfRepository
import com.ansimtalk.app.domain.repository.AnsimTalkRepository
import dagger.Binds
import dagger.Module
import dagger.Provides
import dagger.hilt.InstallIn
import dagger.hilt.android.qualifiers.ApplicationContext
import dagger.hilt.components.SingletonComponent
import javax.inject.Singleton

@Module
@InstallIn(SingletonComponent::class)
abstract class RepositoryModule {

    @Binds
    @Singleton
    abstract fun bindAnsimTalkRepository(
        ansimTalkRepositoryImpl: AnsimTalkRepositoryImpl
    ): AnsimTalkRepository

    companion object {
        @Provides
        @Singleton
        fun providePdfRepository(
            @ApplicationContext context: Context,
            apiService: ApiService
        ): PdfRepository = PdfRepository(context, apiService)
    }
}
```

---

### 18.17. ViewModels

#### MainViewModel.kt

**위치**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/presentation/viewmodel/MainViewModel.kt`

**역할**: 메인 화면 상태 관리 및 비즈니스 로직

```kotlin
package com.ansimtalk.app.presentation.viewmodel

import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.ansimtalk.app.data.model.Resource
import com.ansimtalk.app.domain.usecase.AnalyzeCyberbullyingUseCase
import com.ansimtalk.app.domain.usecase.AnalyzeDeepfakeUseCase
import com.ansimtalk.app.domain.usecase.HealthCheckUseCase
import com.ansimtalk.app.domain.usecase.DownloadPdfUseCase
import com.ansimtalk.app.presentation.ui.state.AnalysisUiState
import com.ansimtalk.app.presentation.ui.state.PdfDownloadUiState
import dagger.hilt.android.lifecycle.HiltViewModel
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.StateFlow
import kotlinx.coroutines.flow.catch
import kotlinx.coroutines.flow.onStart
import kotlinx.coroutines.launch
import okhttp3.MultipartBody
import javax.inject.Inject

@HiltViewModel
class MainViewModel @Inject constructor(
    private val healthCheckUseCase: HealthCheckUseCase,
    private val analyzeDeepfakeUseCase: AnalyzeDeepfakeUseCase,
    private val analyzeCyberbullyingUseCase: AnalyzeCyberbullyingUseCase,
    private val downloadPdfUseCase: DownloadPdfUseCase
) : ViewModel() {

    private val _healthState = MutableStateFlow<Resource<Map<String, Any>>>(Resource.Loading)
    val healthState: StateFlow<Resource<Map<String, Any>>> = _healthState

    private val _deepfakeAnalysisState = MutableStateFlow<AnalysisUiState>(AnalysisUiState.Idle)
    val deepfakeAnalysisState: StateFlow<AnalysisUiState> = _deepfakeAnalysisState

    private val _cyberbullyingAnalysisState = MutableStateFlow<AnalysisUiState>(AnalysisUiState.Idle)
    val cyberbullyingAnalysisState: StateFlow<AnalysisUiState> = _cyberbullyingAnalysisState

    private val _pdfDownloadState = MutableStateFlow<PdfDownloadUiState>(PdfDownloadUiState.Idle)
    val pdfDownloadState: StateFlow<PdfDownloadUiState> = _pdfDownloadState
    private val _pdfBytes = MutableStateFlow<ByteArray?>(null)
    val pdfBytes: StateFlow<ByteArray?> = _pdfBytes

    fun checkHealth() {
        viewModelScope.launch {
            healthCheckUseCase()
                .onStart { _healthState.value = Resource.Loading }
                .catch { e -> _healthState.value = Resource.Error(e.message ?: "Unknown Error") }
                .collect { result -> _healthState.value = result }
        }
    }

    fun analyzeDeepfake(file: MultipartBody.Part) {
        viewModelScope.launch {
            analyzeDeepfakeUseCase(file)
                .onStart { _deepfakeAnalysisState.value = AnalysisUiState.Loading }
                .catch { e -> _deepfakeAnalysisState.value = AnalysisUiState.Error(e.message ?: "Unknown Error") }
                .collect { result ->
                    when (result) {
                        is Resource.Success -> _deepfakeAnalysisState.value = AnalysisUiState.Success(result.data)
                        is Resource.Error -> _deepfakeAnalysisState.value = AnalysisUiState.Error(result.message)
                        is Resource.Loading -> _deepfakeAnalysisState.value = AnalysisUiState.Loading
                    }
                }
        }
    }

    fun analyzeCyberbullying(file: MultipartBody.Part) {
        viewModelScope.launch {
            analyzeCyberbullyingUseCase(file)
                .onStart { _cyberbullyingAnalysisState.value = AnalysisUiState.Loading }
                .catch { e -> _cyberbullyingAnalysisState.value = AnalysisUiState.Error(e.message ?: "Unknown Error") }
                .collect { result ->
                    when (result) {
                        is Resource.Success -> _cyberbullyingAnalysisState.value = AnalysisUiState.Success(result.data)
                        is Resource.Error -> _cyberbullyingAnalysisState.value = AnalysisUiState.Error(result.message)
                        is Resource.Loading -> _cyberbullyingAnalysisState.value = AnalysisUiState.Loading
                    }
                }
        }
    }
    
    fun setPdfBytes(bytes: ByteArray) { _pdfBytes.value = bytes }
    fun markPdfDownloading() { _pdfDownloadState.value = PdfDownloadUiState.Downloading }
    fun markPdfSuccess() { _pdfDownloadState.value = PdfDownloadUiState.Success }
    fun markPdfError(message: String) { _pdfDownloadState.value = PdfDownloadUiState.Error(message) }

    fun resetDeepfakeAnalysis() {
        _deepfakeAnalysisState.value = AnalysisUiState.Idle
    }

    fun resetCyberbullyingAnalysis() {
        _cyberbullyingAnalysisState.value = AnalysisUiState.Idle
    }

    fun resetPdfDownload() {
        _pdfDownloadState.value = PdfDownloadUiState.Idle
    }
}
```

---

#### ResultViewModel.kt

**위치**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/presentation/viewmodel/ResultViewModel.kt`

**역할**: 결과 화면 PDF 다운로드 관리

```kotlin
package com.ansimtalk.app.presentation.viewmodel

import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.ansimtalk.app.data.model.AnalysisResult
import com.ansimtalk.app.data.model.PdfGenerationResult
import com.ansimtalk.app.data.model.PdfRequestBody
import com.ansimtalk.app.data.model.Resource
import com.ansimtalk.app.domain.usecase.DownloadPdfUseCase
import com.ansimtalk.app.domain.usecase.GeneratePdfUseCase
import com.ansimtalk.app.data.model.PdfDownloadException
import dagger.hilt.android.lifecycle.HiltViewModel
import kotlinx.coroutines.flow.MutableSharedFlow
import kotlinx.coroutines.flow.asSharedFlow
import kotlinx.coroutines.flow.launchIn
import kotlinx.coroutines.flow.onEach
import okhttp3.ResponseBody
import javax.inject.Inject
import kotlinx.coroutines.launch

@HiltViewModel
class ResultViewModel @Inject constructor(
    private val downloadPdfUseCase: DownloadPdfUseCase,
    private val generatePdfUseCase: GeneratePdfUseCase
) : ViewModel() {

    private val _downloadState = MutableSharedFlow<Resource<ResponseBody>>()
    val downloadState = _downloadState.asSharedFlow()

    private val _pdfGenerationState = MutableSharedFlow<PdfGenerationResult>()
    val pdfGenerationState = _pdfGenerationState.asSharedFlow()

    fun downloadPdf(analysisResult: AnalysisResult) {
        val requestBody = PdfRequestBody(
            analysisType = analysisResult.analysisType,
            analysisResult = analysisResult,
            originalImagePath = analysisResult.originalImagePath
        )

        downloadPdfUseCase(requestBody).onEach {
            _downloadState.emit(it)
        }.launchIn(viewModelScope)
    }

    fun generateAndSavePdf(analysisResult: AnalysisResult) {
        val body = PdfRequestBody(
            analysisType = analysisResult.analysisType,
            analysisResult = analysisResult,
            originalImagePath = analysisResult.originalImagePath
        )
        viewModelScope.launch {
            val result = generatePdfUseCase(body)
            _pdfGenerationState.emit(result)
        }
    }
}
```

---

### 18.18. UI States

#### AnalysisUiState.kt

**위치**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/presentation/ui/state/AnalysisUiState.kt`

```kotlin
package com.ansimtalk.app.presentation.ui.state

import com.ansimtalk.app.data.model.AnalysisResult

sealed class AnalysisUiState {
    object Idle : AnalysisUiState()
    object Loading : AnalysisUiState()
    data class Success(val result: AnalysisResult) : AnalysisUiState()
    data class Error(val message: String) : AnalysisUiState()
}
```

---

#### PdfDownloadUiState.kt

**위치**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/presentation/ui/state/PdfDownloadUiState.kt`

```kotlin
package com.ansimtalk.app.presentation.ui.state

sealed class PdfDownloadUiState {
    object Idle : PdfDownloadUiState()
    object Downloading : PdfDownloadUiState()
    object Success : PdfDownloadUiState()
    data class Error(val message: String) : PdfDownloadUiState()
}
```

---

### 18.19. UI Theme

#### Color.kt

**위치**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/presentation/ui/theme/Color.kt`

```kotlin
package com.ansimtalk.app.presentation.ui.theme

import androidx.compose.ui.graphics.Color

// Core palette (web parity)
val Primary800 = Color(0xFF1E40AF)   // Top AppBar
val Primary700 = Color(0xFF1D4ED8)   // Pressed/Hover
val Primary600 = Color(0xFF2563EB)   // CTA buttons

val Surface = Color(0xFFFFFFFF)
val Background = Color(0xFFF8FAFC)
val Border = Color(0xFFEAECF0)
val TextStrong = Color(0xFF101828)
val TextMuted = Color(0xFF475467)

val Success100 = Color(0xFFECFDF3)
val SuccessText = Color(0xFF067647)

// Backward compatible names
val Purple80 = Color(0xFF60A5FA)
val PurpleGrey80 = Color(0xFFA1A1AA)
val Pink80 = Color(0xFF66D47E)

val Purple40 = Primary800
val PurpleGrey40 = Color(0xFF6B7280)
val Pink40 = Color(0xFF34C759)
```

---

#### Theme.kt

**위치**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/presentation/ui/theme/Theme.kt`

```kotlin
package com.ansimtalk.app.presentation.ui.theme

import android.app.Activity
import android.os.Build
import androidx.compose.foundation.isSystemInDarkTheme
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.darkColorScheme
import androidx.compose.material3.dynamicDarkColorScheme
import androidx.compose.material3.dynamicLightColorScheme
import androidx.compose.material3.lightColorScheme
import androidx.compose.material3.Shapes
import androidx.compose.runtime.Composable
import androidx.compose.runtime.SideEffect
import androidx.compose.ui.graphics.toArgb
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.platform.LocalView
import androidx.core.view.WindowCompat
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.ui.unit.dp

private val DarkColorScheme = darkColorScheme(
    primary = Purple80,
    secondary = PurpleGrey80,
    tertiary = Pink80
)

private val LightColorScheme = lightColorScheme(
    primary = Primary600,
    onPrimary = androidx.compose.ui.graphics.Color.White,
    secondary = PurpleGrey40,
    tertiary = Pink40,
    background = Background,
    surface = Surface
)

@Composable
fun AnsimTalkTheme(
    darkTheme: Boolean = isSystemInDarkTheme(),
    dynamicColor: Boolean = false,
    content: @Composable () -> Unit
) {
    val colorScheme = when {
        dynamicColor && Build.VERSION.SDK_INT >= Build.VERSION_CODES.S -> {
            val context = LocalContext.current
            if (darkTheme) dynamicDarkColorScheme(context) else dynamicLightColorScheme(context)
        }

        darkTheme -> DarkColorScheme
        else -> LightColorScheme
    }
    val view = LocalView.current
    if (!view.isInEditMode) {
        SideEffect {
            val window = (view.context as Activity).window
            // StatusBar matches top app bar background (Primary800)
            window.statusBarColor = Primary800.toArgb()
            WindowCompat.getInsetsController(window, view).isAppearanceLightStatusBars = false
        }
    }

    val shapes = Shapes(
        extraSmall = RoundedCornerShape(8.dp),
        small = RoundedCornerShape(12.dp),
        medium = RoundedCornerShape(16.dp),
        large = RoundedCornerShape(20.dp),
        extraLarge = RoundedCornerShape(28.dp)
    )

    MaterialTheme(
        colorScheme = colorScheme,
        typography = Typography,
        shapes = shapes,
        content = content
    )
}
```

---

#### Type.kt

**위치**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/presentation/ui/theme/Type.kt`

```kotlin
package com.ansimtalk.app.presentation.ui.theme

import androidx.compose.material3.Typography
import androidx.compose.ui.text.TextStyle
import androidx.compose.ui.text.font.FontFamily
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.sp

val Typography = Typography(
    bodyLarge = TextStyle(
        fontFamily = FontFamily.Default,
        fontWeight = FontWeight.Medium,
        fontSize = 16.sp,
        lineHeight = 22.sp,
        letterSpacing = 0.sp
    ),
    bodyMedium = TextStyle(
        fontFamily = FontFamily.Default,
        fontWeight = FontWeight.Normal,
        fontSize = 14.sp,
        lineHeight = 20.sp,
        letterSpacing = 0.sp
    ),
    titleLarge = TextStyle(
        fontFamily = FontFamily.Default,
        fontWeight = FontWeight.SemiBold,
        fontSize = 24.sp,
        lineHeight = 30.sp,
        letterSpacing = (-0.2).sp
    ),
    titleMedium = TextStyle(
        fontFamily = FontFamily.Default,
        fontWeight = FontWeight.SemiBold,
        fontSize = 18.sp,
        lineHeight = 24.sp,
        letterSpacing = (-0.1).sp
    ),
    labelLarge = TextStyle(
        fontFamily = FontFamily.Default,
        fontWeight = FontWeight.SemiBold,
        fontSize = 14.sp,
        lineHeight = 18.sp,
        letterSpacing = 0.sp
    )
)
```

---

#### PdfConverter.kt

**위치**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/util/PdfConverter.kt`

```kotlin
package com.ansimtalk.app.util

// 빈 껍데기 (SDK의 package-private 콜백 제약으로 미사용)
object PdfConverter
```

---

### 18.20. Resources

#### strings.xml

**위치**: `ansimtalk_app/app/src/main/res/values/strings.xml`

```xml
<?xml version="1.0" encoding="utf-8"?>
<resources>
    <string name="app_name">안심톡</string>
    
    <!-- 메인 화면 -->
    <string name="main_title">안심톡</string>
    <string name="main_subtitle">AI로 디지털 증거를 분석하고 안전하게 증거화하세요</string>
    <string name="developers">개발자: 윤여준팀장, 김태양, 김태영</string>
    
    <!-- 딥페이크 분석 -->
    <string name="deepfake_title">딥페이크 분석</string>
    <string name="deepfake_description">지원 파일 형식: PNG, JPG, JPEG (이미지 파일)</string>
    <string name="select_file">파일 선택</string>
    <string name="no_file_selected">선택된 파일 없음</string>
    <string name="start_analysis">분석 시작</string>
    <string name="deepfake_help">딥페이크 피해 상담/신고 안내 →</string>
    
    <!-- 사이버폭력 분석 -->
    <string name="cyberbullying_title">사이버폭력 분석</string>
    <string name="cyberbullying_description">지원 파일 형식: TXT, PNG, JPG, JPEG (텍스트 또는 이미지 파일)</string>
    <string name="cyberbullying_help">사이버폭력 신고 안내 →</string>
    
    <!-- 분석 결과 -->
    <string name="analysis_result">분석 결과</string>
    <string name="analysis_in_progress">분석 중...</string>
    <string name="analysis_complete">분석 완료</string>
    <string name="analysis_failed">분석 실패</string>
    
    <!-- 오류 메시지 -->
    <string name="error_file_too_large">파일 크기가 너무 큽니다</string>
    <string name="error_unsupported_format">지원되지 않는 파일 형식입니다</string>
    <string name="error_no_file">파일을 선택해주세요</string>
    <string name="error_network">네트워크 오류가 발생했습니다</string>
    
    <!-- 권한 -->
    <string name="permission_storage_required">저장소 접근 권한이 필요합니다</string>
    <string name="permission_camera_required">카메라 접근 권한이 필요합니다</string>
    
    <!-- PDF 다운로드 -->
    <string name="download_pdf">PDF 다운로드</string>
    <string name="pdf_download_success">PDF 다운로드 완료</string>
    <string name="pdf_download_failed">PDF 다운로드 실패</string>
    
    <!-- 공통 -->
    <string name="ok">확인</string>
    <string name="cancel">취소</string>
    <string name="retry">다시 시도</string>
    <string name="close">닫기</string>
</resources>
```

---

## 19. MainScreen.kt (메인 UI 화면 - 전체 코드 1,518줄)

**위치**: `ansimtalk_app/app/src/main/java/com/ansimtalk/app/presentation/ui/screen/MainScreen.kt`

**역할**: 
- 전체 앱의 메인 화면 Composable 함수
- 파일 선택, 업로드, 분석 결과 표시, PDF 다운로드
- 1,518줄의 대형 파일로 모든 UI 로직 포함

**주요 Composable 함수**:
- `MainScreen()` - 메인 화면 루트
- `ResultsScreen()` - 분석 결과 화면
- `DeepfakeResultCard()` - 딥페이크 결과 카드
- `CyberbullyingResultCard()` - 사이버폭력 결과 카드
- `RiskLevelCard()` - 위험도 카드
- `FileInfoSection()` - 파일 정보 섹션
- `HeaderSection()` - 헤더 섹션
- `HealthStatusSection()` - API 상태 섹션
- `DeepfakeAnalysisSection()` - 딥페이크 분석 섹션
- `CyberbullyingAnalysisSection()` - 사이버폭력 분석 섹션
- 기타 헬퍼 함수들 (PDF 생성, 파일 처리 등)

**전체 코드 (1,518줄):**

```kotlin
package com.ansimtalk.app.presentation.ui.screen

import android.net.Uri
import androidx.activity.compose.rememberLauncherForActivityResult
import androidx.activity.result.contract.ActivityResultContracts
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.background
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.verticalScroll
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.automirrored.filled.ArrowBack
import androidx.compose.material.icons.filled.Info
import androidx.compose.material.icons.filled.OpenInNew
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import androidx.hilt.navigation.compose.hiltViewModel
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.graphics.toArgb
import androidx.compose.runtime.rememberCoroutineScope
import androidx.compose.ui.viewinterop.AndroidView
import androidx.compose.foundation.BorderStroke
import androidx.compose.foundation.shape.CircleShape
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.launch
import kotlinx.coroutines.withContext
import com.ansimtalk.app.data.model.AnalysisResult
import com.ansimtalk.app.presentation.ui.state.AnalysisUiState
import com.ansimtalk.app.presentation.ui.state.PdfDownloadUiState
import com.ansimtalk.app.presentation.viewmodel.MainViewModel
import com.ansimtalk.app.presentation.viewmodel.ResultViewModel
import com.ansimtalk.app.BuildConfig
import okhttp3.MediaType.Companion.toMediaTypeOrNull
import okhttp3.MultipartBody
import okhttp3.RequestBody.Companion.asRequestBody
import java.io.File
import com.google.gson.GsonBuilder
import android.graphics.pdf.PdfDocument
import android.graphics.Canvas
import android.graphics.Paint
import android.text.TextPaint
import android.graphics.Typeface
// WebView 기반 PDF 생성/표시는 제거. 서버 PDF만 사용
 
import android.widget.Toast
import android.content.Intent
import kotlinx.coroutines.flow.collect
import android.content.ContentValues
import android.os.Environment
import android.provider.MediaStore
import android.view.ViewGroup

@Composable
fun MainScreen(
    viewModel: MainViewModel = hiltViewModel()
) {
    val context = LocalContext.current
    val pdfViewModel: ResultViewModel = hiltViewModel()
    // 오프스크린 WebView (벡터 인쇄용)
    // 서버 PDF만 사용: 벡터/래스터 폴백 관련 상태 제거
    val scope = rememberCoroutineScope()
    var showResults by remember { mutableStateOf(false) }
    var currentAnalysisType by remember { mutableStateOf<String?>(null) }
    var showErrorDialog by remember { mutableStateOf(false) }
    var errorMessage by remember { mutableStateOf("") }

    val deepfakeState by viewModel.deepfakeAnalysisState.collectAsState()
    val cyberbullyingState by viewModel.cyberbullyingAnalysisState.collectAsState()
    val healthState by viewModel.healthState.collectAsState()
    val pdfState by viewModel.pdfDownloadState.collectAsState()
    val pdfBytes by viewModel.pdfBytes.collectAsState()
    // 서버 우선 PDF 생성 상태 수집 → 다운로드 저장 처리
    LaunchedEffect(Unit) {
        pdfViewModel.pdfGenerationState.collect { result ->
            when (result) {
                is com.ansimtalk.app.data.model.PdfGenerationResult.Success -> {
                    try {
                        val name = "AnsimTalk_Report_\${System.currentTimeMillis()}.pdf"
                        val uri = when (val data = result.data) {
                            is okhttp3.ResponseBody -> savePdfToEvidence(context, data.bytes(), name)
                            is java.io.File -> {
                                val u = savePdfToEvidence(context, data.readBytes(), name)
                                kotlin.runCatching { data.delete() }
                                u
                            }
                            else -> null
                        }
                        if (uri != null) {
                            openPdf(context, uri)
                        } else {
                            Toast.makeText(context, "PDF 저장 실패", Toast.LENGTH_LONG).show()
                        }
                    } catch (e: Exception) {
                        Toast.makeText(context, "PDF 저장 실패: \${e.message}", Toast.LENGTH_LONG).show()
                    }
                }
                is com.ansimtalk.app.data.model.PdfGenerationResult.Failure -> {
                    val err = result.error
                    val msg = when (err) {
                        is com.ansimtalk.app.data.model.PdfDownloadException -> when (err.kind) {
                            com.ansimtalk.app.data.model.PdfDownloadException.Kind.Network -> "서버 연결 실패(네트워크/타임아웃)"
                            com.ansimtalk.app.data.model.PdfDownloadException.Kind.Http4xx -> "요청 오류(\${err.httpCode}): \${err.serverMessage ?: "검증 실패"}"
                            com.ansimtalk.app.data.model.PdfDownloadException.Kind.Http5xx -> "서버 오류(\${err.httpCode}): \${err.serverMessage ?: "서버 내부 오류"}"
                            com.ansimtalk.app.data.model.PdfDownloadException.Kind.EmptyBody -> "서버 응답이 비었습니다"
                            com.ansimtalk.app.data.model.PdfDownloadException.Kind.Unexpected -> "예상치 못한 오류"
                        }
                        else -> err.message ?: "알 수 없는 오류"
                    }
                    Toast.makeText(context, msg, Toast.LENGTH_LONG).show()
                }
            }
        }
    }

    // PDF 상태 변화는 어느 화면에서든 파일 저장/열기로 이어지도록 전역에서 관찰
    LaunchedEffect(pdfState) {
        if (pdfState is PdfDownloadUiState.Success && pdfBytes != null) {
            try {
                val name = "AnsimTalk_Report_\${System.currentTimeMillis()}.pdf"
                savePdfToEvidence(context, pdfBytes!!, name)?.let { openPdf(context, it) }
            } catch (e: Exception) {
                errorMessage = "PDF 열기 실패: \${e.message}"
                showErrorDialog = true
            }
        }
    }

    LaunchedEffect(Unit) {
        try {
            viewModel.checkHealth()
        } catch (e: Exception) {
            errorMessage = "API 상태 확인 실패: \${e.message}"
            showErrorDialog = true
        }
    }

    val fileLauncher = rememberLauncherForActivityResult(
        contract = ActivityResultContracts.GetContent()
    ) { uri: Uri? ->
        uri?.let { selectedUri ->
            try {
                val filePart = prepareMultipartFromUri(context, selectedUri)

                currentAnalysisType?.let { type ->
                    when (type) {
                        "deepfake" -> viewModel.analyzeDeepfake(filePart)
                        "cyberbullying" -> viewModel.analyzeCyberbullying(filePart)
                    }
                }
            } catch (e: Exception) {
                errorMessage = "파일 처리 오류: \${e.message}"
                showErrorDialog = true
            }
        }
    }

    if (showErrorDialog) {
        AlertDialog(
            onDismissRequest = { showErrorDialog = false },
            title = { Text("오류") },
            text = { Text(errorMessage) },
            confirmButton = {
                TextButton(onClick = { showErrorDialog = false }) {
                    Text("확인")
                }
            }
        )
    }

    val shouldShowResults = (deepfakeState is AnalysisUiState.Success || cyberbullyingState is AnalysisUiState.Success)

    if (shouldShowResults && showResults) {
        ResultsScreen(
            deepfakeState = deepfakeState,
            cyberbullyingState = cyberbullyingState,
            onBackToMain = { showResults = false },
            onDownloadPdf = {
                // 서버 우선 경로로 생성 (실패 시 리포지토리에서 텍스트 PDF 폴백)
                val ar = (deepfakeState as? AnalysisUiState.Success)?.result
                    ?: (cyberbullyingState as? AnalysisUiState.Success)?.result
                if (ar != null) pdfViewModel.generateAndSavePdf(ar)
                else Toast.makeText(context, "먼저 분석을 완료하세요.", Toast.LENGTH_SHORT).show()
            },
            onReset = {
                try {
                    viewModel.resetDeepfakeAnalysis()
                    viewModel.resetCyberbullyingAnalysis()
                    showResults = false
                } catch (e: Exception) {
                    errorMessage = "리셋 실패: \${e.message}"
                    showErrorDialog = true
                }
            }
        )
        // PDF 성공 시 저장/열기
        LaunchedEffect(pdfState) {
            if (pdfState is PdfDownloadUiState.Success && pdfBytes != null) {
                try {
                    val name = "AnsimTalk_Report_\${System.currentTimeMillis()}.pdf"
                    savePdfToEvidence(context, pdfBytes!!, name)?.let { openPdf(context, it) }
                } catch (e: Exception) {
                    errorMessage = "PDF 열기 실패: \${e.message}"
                    showErrorDialog = true
                }
            }
        }
    } else {
        Column(
            modifier = Modifier
                .fillMaxSize()
                .padding(16.dp)
                .verticalScroll(rememberScrollState()),
            horizontalAlignment = Alignment.CenterHorizontally
        ) {
            HeaderSection()

            Spacer(modifier = Modifier.height(32.dp))

            HealthStatusSection(healthState = healthState)

            Spacer(modifier = Modifier.height(24.dp))

            DeepfakeAnalysisSection(
                state = deepfakeState,
                onAnalyzeClick = {
                    currentAnalysisType = "deepfake"
                    fileLauncher.launch("image/*")
                },
                onReset = {
                    try {
                        viewModel.resetDeepfakeAnalysis()
                    } catch (e: Exception) {
                        errorMessage = "리셋 실패: \${e.message}"
                        showErrorDialog = true
                    }
                }
            )

            Spacer(modifier = Modifier.height(24.dp))

            CyberbullyingAnalysisSection(
                state = cyberbullyingState,
                onAnalyzeClick = {
                    currentAnalysisType = "cyberbullying"
                    fileLauncher.launch("image/*")
                },
                onReset = {
                    try {
                        viewModel.resetCyberbullyingAnalysis()
                    } catch (e: Exception) {
                        errorMessage = "리셋 실패: \${e.message}"
                        showErrorDialog = true
                    }
                }
            )

            Spacer(modifier = Modifier.height(24.dp))

            if (shouldShowResults) {
                Button(
                    onClick = { showResults = true },
                    modifier = Modifier.fillMaxWidth(),
                    colors = ButtonDefaults.buttonColors(
                        containerColor = com.ansimtalk.app.presentation.ui.theme.Primary600,
                        contentColor = Color.White
                    )
                ) {
                    Text("분석 결과 보기", color = Color.White, fontSize = 16.sp)
                }
            }
        }
    }
}

// 서버의 services.generate_report_html와 동일한 구조/스타일을 최대한 반영한 HTML 생성
private fun buildHtmlReport(
    context: android.content.Context,
    deepfakeState: AnalysisUiState,
    cyberbullyingState: AnalysisUiState
): String {
    val isDeepfake = deepfakeState is AnalysisUiState.Success
    val result = when {
        deepfakeState is AnalysisUiState.Success -> deepfakeState.result
        cyberbullyingState is AnalysisUiState.Success -> cyberbullyingState.result
        else -> null
    }
    val analysisType = when {
        deepfakeState is AnalysisUiState.Success -> "deepfake"
        cyberbullyingState is AnalysisUiState.Success -> "cyberbullying"
        else -> "N/A"
    }

    val reportId = "DF-CB-\${java.time.LocalDate.now()}-001-v1.0"
    val createdAt = java.time.LocalDateTime.now().toString().replace('T', ' ')

    val filename = result?.fileInfo?.filename ?: "N/A"
    val sizeBytes = result?.fileInfo?.sizeBytes?.toString() ?: "N/A"
    val sha256 = result?.sha256 ?: "N/A"
    val uploadTs = result?.analysisTimestamp ?: createdAt

    val imageHtml = "" // 앱에서는 원본 이미지 경로 확보가 어려워 서버와 동일한 플레이스홀더 사용
    val extractedText = result?.extractedText ?: ""
    val cbHtml = result?.cyberbullyingAnalysis ?: ""
    val cbSummary = result?.cyberbullyingAnalysisSummary?.replace("\n", "<br>") ?: ""
    val cbRisk = result?.cyberbullyingRiskLine ?: "N/A"
    val deepfakeProb = result?.deepfakeAnalysis?.type?.deepfake ?: 0.0

    return \"\"\"
    <!DOCTYPE html>
    <html lang=\"ko\">
    <head>
        <meta charset=\"UTF-8\" />
        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />
        <title>안심톡 디지털 증거 분석 보고서</title>
        <style>
            body { font-family: 'Noto Sans KR', 'Malgun Gothic', Arial, sans-serif; margin: 40px; line-height: 1.6; color: #333; }
            h1, h2, h3 { color: #1976d2; margin-top: 30px; margin-bottom: 15px; }
            table { border-collapse: collapse; width: 100%; margin: 15px 0; font-size: 12px; }
            th, td { border: 1px solid #ddd; padding: 8px 12px; text-align: left; }
            th { background: #f8f9fa; color: #495057; }
            .analysis-result { background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; padding: 15px; margin: 15px 0; font-weight: bold; color: #856404; }
            .box { background: #f0f4ff; border-left: 4px solid #1976d2; border-radius: 8px; padding: 15px; margin: 15px 0; }
            .extracted-text { background:#f8f9fa; border:1px solid #e9ecef; border-radius:4px; padding:15px; margin:15px 0; font-family: Consolas, Monaco, monospace; font-size:11px; white-space:pre-wrap; }
            .analysis-table { border-collapse: collapse; width: 100%; font-size: 11px; }
            .analysis-table th, .analysis-table td { border: 1px solid #ddd; padding: 6px 8px; vertical-align: top; }
            .risk-none { color: #28a745; font-weight: bold; }
            .risk-severe { color: #dc3545; font-weight: bold; }
            #report-footer { font-size: 10px; color: #888; text-align: right; width: 100%; border-top: 1px solid #eee; padding-top: 10px; position: fixed; bottom: 20px; right: 40px; }
        </style>
    </head>
    <body>
        <div id=\"report-footer\">보고서ID: $reportId | 생성일시: $createdAt | 플랫폼: 안심톡 AI 포렌식 분석 시스템 v1.0 | 배포일: 2025-07-18</div>
        <h1>안심톡 디지털 증거 분석 보고서</h1>
        <div class=\"section\">
            <h2>1. 기본 정보</h2>
            <table>
                <tr><th>보고서 ID</th><td>$reportId</td></tr>
                <tr><th>생성일시</th><td>$createdAt</td></tr>
                <tr><th>분석 유형</th><td>$analysisType</td></tr>
                <tr><th>분석 시스템</th><td>안심톡 AI 포렌식 분석 시스템 v1.0</td></tr>
            </table>
        </div>
        <div class=\"section\">
            <h2>2. 분석에 사용된 AI 모델 전체 목록</h2>
            <table>
                <thead><tr><th>분석 작업</th><th>AI 모델</th><th>버전</th><th>정확도</th></tr></thead>
                <tbody>
                    <tr><td>딥페이크 탐지</td><td>Sightengine Deepfake Detector</td><td>v1.0</td><td>98.2%</td></tr>
                    <tr><td>사이버폭력 분석</td><td>Google Gemini 2.5 Flash</td><td>v1.0</td><td>94.5%</td></tr>
                    <tr><td>OCR 텍스트 추출</td><td>Google Cloud Vision API</td><td>v1.0</td><td>99.1%</td></tr>
                </tbody>
            </table>
        </div>
        <div class=\"section\">
            <h2>3. 분석 결과 요약</h2>
            <div class=\"analysis-result\">\${if (isDeepfake) "딥페이크 분석 결과 요약:<br>딥페이크일 확률: \${String.format("%.1f%%", deepfakeProb*100)}" else "사이버폭력 분석 결과 요약:<br>전체 대화 사이버폭력 위험도: $cbRisk"}</div>
        </div>
        <div class=\"section\">
            <h2>4. 증거 파일 정보</h2>
            <div class=\"metadata-item\"><b>파일명:</b> $filename</div>
            <div class=\"metadata-item\"><b>파일 유형:</b> $analysisType</div>
            <div class=\"metadata-item\"><b>파일 크기:</b> $sizeBytes Bytes</div>
            <div class=\"metadata-item\"><b>업로드 일시:</b> $uploadTs</div>
            <div class=\"metadata-item\"><b>업로더 ID:</b> <span style=\"background:#f5f5f5;border:1px solid #ddd;padding:3px 6px;border-radius:4px;\">ANSiMTALK_USER</span></div>
            <div class=\"metadata-item\"><b>업로드 IP:</b> 100.64.0.3</div>
            <div class=\"metadata-item\"><b>원본 해시값 (SHA-256):</b> <span style=\"background:#f5f5f5;border:1px solid #ddd;padding:3px 6px;border-radius:4px;\">$sha256</span></div>
        </div>
        <div class=\"section\">
            <h2>원본 파일 메타데이터</h2>
            <div class=\"metadata-item\"><b>파일 형식:</b> \${result?.fileInfo?.type?.uppercase() ?: "N/A"}</div>
            <div class=\"metadata-item\"><b>분석 타입:</b> $analysisType</div>
            <div class=\"metadata-item\"><b>분석 타임스탬프:</b> \${result?.analysisTimestamp ?: createdAt}</div>
            <div class=\"metadata-item\"><b>파일 크기 (바이트):</b> $sizeBytes bytes</div>
        </div>
        <div class=\"section\">
            <h2>5. 연계 보관성 (Chain of Custody)</h2>
            <table>
                <thead><tr><th>단계</th><th>시각</th><th>서버/AI 정보</th></tr></thead>
                <tbody>
                    <tr><td>파일 업로드</td><td>$uploadTs</td><td>안심톡 서버</td></tr>
                    <tr><td>해시값 계산</td><td>$uploadTs</td><td>SHA-256</td></tr>
                    <tr><td>AI 분석</td><td>$uploadTs</td><td>AI 서버 (Gemini 2.5 Flash v1.0)</td></tr>
                    <tr><td>결과 생성</td><td>$uploadTs</td><td>보고서 생성 서버</td></tr>
                </tbody>
            </table>
        </div>
        <div class=\"section\">
            <h2>6. AI 분석 결과</h2>
            \${if (isDeepfake) \"\"\"
            <h3>딥페이크 분석 결과(Sightengine):</h3>
            <div class=\"analysis-result\">딥페이크일 확률: \${String.format("%.1f%%", deepfakeProb*100)}</div>
            <h3>상세 분석 결과:</h3>
            <div class=\"box\"><pre style=\"white-space:pre-wrap;font-family:'Noto Sans KR',sans-serif;font-size:12px;\">\${result?.deepfakeAnalysis?.let { GsonBuilder().setPrettyPrinting().create().toJson(it) } ?: "분석 결과가 없습니다."}</pre></div>
            \"\"\" else \"\"\"
            <h3>추출 텍스트(OCR):</h3>
            <div class=\"extracted-text\">$extractedText</div>
            <h3>사이버폭력 분석 결과(Gemini):</h3>
            <div class=\"analysis-result\">전체 대화 사이버폭력 위험도: $cbRisk</div>
            <h3>상세 분석 결과:</h3>
            <div class=\"box\">\${if (cbHtml.isNotBlank()) cbHtml else "분석 결과가 없습니다."}</div>
            <h3>전체 분석 요약:</h3>
            <div class=\"box\" style=\"background:#f8f9fa;border-left:4px solid #28a745;\">$cbSummary</div>
            \"\"\"}
        </div>
        <div class=\"section\">
            <h2>7. 원본 증거 이미지</h2>
            <div style=\"background:#f8f9fa;border:2px dashed #dee2e6;padding:20px;text-align:center;color:#6c757d;\">
                <p><strong>원본 이미지</strong></p>
                <p>앱 내 로컬 경로 제약으로 미표시</p>
            </div>
            <div style=\"color:#1976d2;font-size:12px;margin-top:10px;\">* 위 이미지는 분석 대상 원본 증거물입니다.</div>
        </div>
        <div class=\"section\">
            <h2>8. 무결성 및 법적 검증</h2>
            <ul>
                <li><b>원본(이미지) 해시값:</b> <span style=\"background:#f5f5f5;border:1px solid #ddd;padding:3px 6px;border-radius:4px;\">$sha256</span></li>
                <br>
                <li><b>법적 책임 선언:</b> 본 보고서는 AI 기반 분석 결과를 제공하며 법률 전문가의 판단을 대체할 수 없습니다. 보고서 내용은 참고 자료로만 사용되어야 하며 법적 책임을 지지 않습니다. 정확한 법적 조치나 상담을 위해서는 변호사나 관련 기관에 문의하시기 바랍니다.</li>
            </ul>
        </div>
    </body>
    </html>
    \"\"\".trimIndent()
}

// 벡터/오프스크린 WebView 관련 로직 제거: 서버 PDF만 사용

// WebView + PrintDocumentAdapter 기반 고품질 PDF 생성 (무음 인쇄, A4 600dpi)
// (프린트 프레임워크 방식은 리포지토리 구현에서 사용. 이 파일에서는 제거)

private fun savePdfToEvidence(context: android.content.Context, bytes: ByteArray, displayName: String): android.net.Uri? {
    // Android 10+ (scoped storage): Downloads/AnsimTalkEvidence
    val relativePath = Environment.DIRECTORY_DOWNLOADS + "/AnsimTalkEvidence"
    val values = ContentValues().apply {
        put(MediaStore.MediaColumns.DISPLAY_NAME, displayName)
        put(MediaStore.MediaColumns.MIME_TYPE, "application/pdf")
        put(MediaStore.MediaColumns.RELATIVE_PATH, relativePath)
    }
    val resolver = context.contentResolver
    val uri = resolver.insert(MediaStore.Downloads.EXTERNAL_CONTENT_URI, values) ?: return null
    resolver.openOutputStream(uri)?.use { out ->
        out.write(bytes)
        out.flush()
    }
    return uri
}

private fun openPdf(context: android.content.Context, uri: android.net.Uri) {
    try {
        val intent = android.content.Intent(android.content.Intent.ACTION_VIEW).apply {
            setDataAndType(uri, "application/pdf")
            addFlags(android.content.Intent.FLAG_GRANT_READ_URI_PERMISSION)
        }
        context.startActivity(intent)
    } catch (e: Exception) {
        Toast.makeText(context, "PDF 열기 앱이 없습니다. 파일은 Downloads/AnsimTalkEvidence에 저장되었습니다.", Toast.LENGTH_LONG).show()
    }
}

// 로컬 HTML→PDF (WebView) 제거: 서버 PDF만 사용

@Composable
fun ResultsScreen(
    deepfakeState: AnalysisUiState,
    cyberbullyingState: AnalysisUiState,
    onBackToMain: () -> Unit,
    onDownloadPdf: () -> Unit,
    onReset: () -> Unit
) {
    Column(
        modifier = Modifier
            .fillMaxSize()
            .padding(16.dp)
            .verticalScroll(rememberScrollState()),
        horizontalAlignment = Alignment.CenterHorizontally
    ) {
        Row(
            modifier = Modifier.fillMaxWidth(),
            horizontalArrangement = Arrangement.SpaceBetween,
            verticalAlignment = Alignment.CenterVertically
        ) {
            IconButton(onClick = onBackToMain) {
                Icon(
                    imageVector = Icons.AutoMirrored.Filled.ArrowBack,
                    contentDescription = "뒤로 가기"
                )
            }
            Text(
                text = "분석 결과",
                fontSize = 24.sp,
                fontWeight = FontWeight.Bold,
                color = MaterialTheme.colorScheme.primary
            )
            Spacer(modifier = Modifier.width(48.dp))
        }

        Spacer(modifier = Modifier.height(24.dp))

        if (deepfakeState is AnalysisUiState.Success) {
            DeepfakeResultCard(result = deepfakeState.result)
            Spacer(modifier = Modifier.height(16.dp))
        }

        if (cyberbullyingState is AnalysisUiState.Success) {
            CyberbullyingResultCard(result = cyberbullyingState.result)
            Spacer(modifier = Modifier.height(16.dp))
        }

        // 신고 안내 링크 버튼 (결과 화면) - 해당 분석 종류에 맞는 버튼만 표시
        val ctx = LocalContext.current
        val hasDeepfake = deepfakeState is AnalysisUiState.Success
        val hasCyber = cyberbullyingState is AnalysisUiState.Success
        if (hasDeepfake || hasCyber) {
            if (hasDeepfake) {
                Button(
                    onClick = {
                        val url = "\${BuildConfig.BASE_URL}/deepfake_help"
                        val intent = Intent(Intent.ACTION_VIEW, android.net.Uri.parse(url))
                        ctx.startActivity(intent)
                    },
                    modifier = Modifier.fillMaxWidth(),
                    colors = ButtonDefaults.buttonColors(containerColor = MaterialTheme.colorScheme.primary)
                ) {
                    Text("딥페이크 피해 상담/신고 안내 →", color = MaterialTheme.colorScheme.onPrimary)
                }
            } else if (hasCyber) {
                Button(
                    onClick = {
                        val url = "\${BuildConfig.BASE_URL}/cyberbullying_help"
                        val intent = Intent(Intent.ACTION_VIEW, android.net.Uri.parse(url))
                        ctx.startActivity(intent)
                    },
                    modifier = Modifier.fillMaxWidth(),
                    colors = ButtonDefaults.buttonColors(containerColor = MaterialTheme.colorScheme.primary)
                ) {
                    Text("사이버폭력 신고 안내 →", color = MaterialTheme.colorScheme.onPrimary)
                }
            }
            Spacer(modifier = Modifier.height(12.dp))
        }
        

        Row(
            modifier = Modifier.fillMaxWidth(),
            horizontalArrangement = Arrangement.spacedBy(8.dp)
        ) {
            Button(
                onClick = onDownloadPdf,
                modifier = Modifier.weight(1f),
                colors = ButtonDefaults.buttonColors(
                    containerColor = com.ansimtalk.app.presentation.ui.theme.Primary600
                )
            ) {
                Text("증거 보고서(PDF) 다운로드", color = Color.White, fontSize = 16.sp)
            }

            OutlinedButton(
                onClick = onReset,
                modifier = Modifier.weight(1f),
                border = BorderStroke(1.dp, com.ansimtalk.app.presentation.ui.theme.Border),
                colors = ButtonDefaults.outlinedButtonColors(
                    contentColor = com.ansimtalk.app.presentation.ui.theme.TextStrong
                )
            ) {
                Text("새로운 분석 시작", fontSize = 16.sp)
            }
        }
    }
}

@Composable
fun DeepfakeResultCard(result: AnalysisResult) {
    val gson = remember { GsonBuilder().setPrettyPrinting().create() }

    Card(
        modifier = Modifier.fillMaxWidth(),
        colors = CardDefaults.cardColors(
            containerColor = MaterialTheme.colorScheme.surface
        ),
        border = BorderStroke(1.dp, com.ansimtalk.app.presentation.ui.theme.Border),
        elevation = CardDefaults.cardElevation(defaultElevation = 1.dp)
    ) {
        Column(
            modifier = Modifier.padding(16.dp)
        ) {
            Text(
                text = "AI 딥페이크 분석 요약",
                fontSize = 20.sp,
                fontWeight = FontWeight.Bold,
                color = MaterialTheme.colorScheme.onPrimaryContainer
            )
            Spacer(modifier = Modifier.height(16.dp))

            FileInfoSection(result = result)
            Spacer(modifier = Modifier.height(16.dp))

            result.deepfakeAnalysis?.let { analysis ->
                if (analysis.error == null) {
                    Row(
                        modifier = Modifier.fillMaxWidth(),
                        horizontalArrangement = Arrangement.SpaceBetween
                    ) {
                        Text(
                            text = "딥페이크일 확률:",
                            style = MaterialTheme.typography.bodyMedium,
                            color = MaterialTheme.colorScheme.onPrimaryContainer
                        )
                        Text(
                            text = "\${String.format("%.1f", (analysis.type?.deepfake ?: 0.0) * 100)}%",
                            style = MaterialTheme.typography.bodyMedium,
                            fontWeight = FontWeight.Bold,
                            color = MaterialTheme.colorScheme.error
                        )
                    }
                    Spacer(modifier = Modifier.height(8.dp))

                    Row(
                        modifier = Modifier.fillMaxWidth(),
                        horizontalArrangement = Arrangement.SpaceBetween
                    ) {
                        Text(
                            text = "유해성 점수:",
                            style = MaterialTheme.typography.bodyMedium,
                            color = MaterialTheme.colorScheme.onPrimaryContainer
                        )
                        Text(
                            text = "\${String.format("%.1f", (analysis.offensive?.prob ?: 0.0) * 100)}%",
                            style = MaterialTheme.typography.bodyMedium,
                            fontWeight = FontWeight.Bold,
                            color = MaterialTheme.colorScheme.error
                        )
                    }
                    Spacer(modifier = Modifier.height(8.dp))

                    Row(
                        modifier = Modifier.fillMaxWidth(),
                        horizontalArrangement = Arrangement.SpaceBetween
                    ) {
                        Text(
                            text = "노출 점수:",
                            style = MaterialTheme.typography.bodyMedium,
                            color = MaterialTheme.colorScheme.onPrimaryContainer
                        )
                        Text(
                            text = "\${String.format("%.1f", (analysis.nudity?.raw ?: 0.0) * 100)}%",
                            style = MaterialTheme.typography.bodyMedium,
                            fontWeight = FontWeight.Bold,
                            color = MaterialTheme.colorScheme.error
                        )
                    }
                    Spacer(modifier = Modifier.height(16.dp))

                    Text(
                        text = "상세 분석 결과 (Raw Data):",
                        fontSize = 16.sp,
                        fontWeight = FontWeight.Bold,
                        color = MaterialTheme.colorScheme.onPrimaryContainer
                    )
                    Spacer(modifier = Modifier.height(8.dp))
                    Card(
                        colors = CardDefaults.cardColors(
                            containerColor = MaterialTheme.colorScheme.surface
                        )
                    ) {
                        Text(
                            text = gson.toJson(result.deepfakeAnalysis),
                            style = MaterialTheme.typography.bodySmall,
                            modifier = Modifier.padding(12.dp),
                            color = MaterialTheme.colorScheme.onSurface
                        )
                    }
                } else {
                    Text(
                        text = "오류: \${analysis.error}",
                        color = MaterialTheme.colorScheme.error,
                        style = MaterialTheme.typography.bodyMedium
                    )
                }
            }
        }
    }
}

@Composable
fun CyberbullyingResultCard(result: AnalysisResult) {
    Card(
        modifier = Modifier.fillMaxWidth(),
        colors = CardDefaults.cardColors(
            containerColor = MaterialTheme.colorScheme.surface
        ),
        border = BorderStroke(1.dp, com.ansimtalk.app.presentation.ui.theme.Border),
        elevation = CardDefaults.cardElevation(defaultElevation = 1.dp)
    ) {
        Column(
            modifier = Modifier.padding(16.dp)
        ) {
            Text(
                text = "AI 대화 내용 분석 요약",
                fontSize = 20.sp,
                fontWeight = FontWeight.Bold,
                color = MaterialTheme.colorScheme.onSurface
            )
            Spacer(modifier = Modifier.height(16.dp))

            FileInfoSection(result = result)
            Spacer(modifier = Modifier.height(16.dp))

            RiskLevelCard(result = result)
            Spacer(modifier = Modifier.height(16.dp))

            result.extractedText?.let { extractedText ->
                Text(
                    text = "이미지 속 추출 텍스트:",
                    fontSize = 16.sp,
                    fontWeight = FontWeight.Bold,
                    color = MaterialTheme.colorScheme.onSurface
                )
                Spacer(modifier = Modifier.height(8.dp))
                Card(
                    colors = CardDefaults.cardColors(
                        containerColor = MaterialTheme.colorScheme.surface
                    )
                ) {
                    Text(
                        text = extractedText,
                        style = MaterialTheme.typography.bodyMedium,
                        modifier = Modifier.padding(12.dp),
                        color = MaterialTheme.colorScheme.onSurface
                    )
                }
                Spacer(modifier = Modifier.height(16.dp))
            }

            result.cyberbullyingAnalysis?.let { analysis ->
                Text(
                    text = "사이버폭력 분석 결과(Gemini):",
                    fontSize = 16.sp,
                    fontWeight = FontWeight.Bold,
                    color = MaterialTheme.colorScheme.onSurface
                )
                Spacer(modifier = Modifier.height(8.dp))
                HtmlTable(html = analysis)
            }

            result.cyberbullyingAnalysisSummary?.let { summary ->
                Spacer(modifier = Modifier.height(16.dp))
                Text(
                    text = "전체 분석 요약:",
                    fontSize = 16.sp,
                    fontWeight = FontWeight.Bold,
                    color = MaterialTheme.colorScheme.onSurface
                )
                Spacer(modifier = Modifier.height(8.dp))
                Card(
                    colors = CardDefaults.cardColors(
                        containerColor = MaterialTheme.colorScheme.surfaceVariant
                    )
                ) {
                    Text(
                        text = summary,
                        style = MaterialTheme.typography.bodyMedium,
                        modifier = Modifier.padding(12.dp),
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )
                }
            }

            if (result.cyberbullyingAnalysis == null) {
                Text(
                    text = "사이버폭력 분석 결과를 가져올 수 없습니다.",
                    color = MaterialTheme.colorScheme.error,
                    style = MaterialTheme.typography.bodyMedium
                )
            }
        }
    }
}

@Composable
private fun HtmlTable(html: String) {
    val background = MaterialTheme.colorScheme.surface
    AndroidView(
        factory = { context ->
            android.webkit.WebView(context).apply {
                layoutParams = ViewGroup.LayoutParams(
                    ViewGroup.LayoutParams.MATCH_PARENT,
                    ViewGroup.LayoutParams.WRAP_CONTENT
                )
                setBackgroundColor(background.toArgb())
                settings.javaScriptEnabled = false
            }
        },
        update = { webView ->
            val styled = \"\"\"
                <html>
                <head>
                <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />
                <style>
                body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans KR', Arial, sans-serif; color: #111827; margin:0; padding:12px; }
                table { border-collapse: collapse; width: 100%; }
                th, td { border: 1px solid #e5e7eb; padding: 8px; text-align: left; vertical-align: top; }
                th { background: #f8fafc; }
                .risk-severe { color: #dc2626; font-weight: 700; }
                .risk-none { color: #16a34a; font-weight: 700; }
                </style>
                </head>
                <body>$html</body>
                </html>
            \"\"\".trimIndent()
            webView.loadDataWithBaseURL(null, styled, "text/html", "utf-8", null)
        }
    )
}

// 텍스트 기반 레이아웃(PdfDocument)으로 서버 보고서와 유사한 양식을 생성 (기기 호환성 안정)
private fun generatePdfTextLayout(
    context: android.content.Context,
    deepfakeState: AnalysisUiState,
    cyberbullyingState: AnalysisUiState
): ByteArray {
    val pageWidth = 595; val pageHeight = 842
    val margin = 40f; val contentWidth = pageWidth - (margin * 2)
    val pdf = PdfDocument()
    val title = TextPaint(Paint.ANTI_ALIAS_FLAG).apply { color = 0xFF1976D2.toInt(); textSize = 20f; typeface = Typeface.create(Typeface.SANS_SERIF, Typeface.BOLD) }
    val h2 = TextPaint(Paint.ANTI_ALIAS_FLAG).apply { color = 0xFF1976D2.toInt(); textSize = 16f; typeface = Typeface.create(Typeface.SANS_SERIF, Typeface.BOLD) }
    val body = TextPaint(Paint.ANTI_ALIAS_FLAG).apply { color = 0xFF333333.toInt(); textSize = 11f; typeface = Typeface.SANS_SERIF }

    val pageInfo = PdfDocument.PageInfo.Builder(pageWidth, pageHeight, 1).create()
    var page = pdf.startPage(pageInfo)
    var canvas = page.canvas
    var y = margin

    fun newPage(add: Float) {
        if (y + add > pageHeight - margin) {
            pdf.finishPage(page)
            page = pdf.startPage(pageInfo)
            canvas = page.canvas; y = margin
        }
    }
    fun drawTitle(t: String) { canvas.drawText(t, margin, y, title); y += 26f }
    fun drawHeader(t: String) { newPage(20f); canvas.drawText(t, margin, y, h2); y += 18f }
    fun drawKV(k: String, v: String) { wrapText("$k $v", body, contentWidth).forEach{ newPage(14f); canvas.drawText(it, margin, y, body); y+=14f } }
    fun drawPara(t: String) { wrapText(t, body, contentWidth).forEach{ newPage(14f); canvas.drawText(it, margin, y, body); y+=14f }; y+=6f }

    drawTitle("안심톡 디지털 증거 분석 보고서")

    fun renderFileInfo(r: com.ansimtalk.app.data.model.AnalysisResult) {
        drawHeader("파일 정보")
        drawKV("파일명:", r.fileInfo.filename)
        drawKV("파일 타입:", r.fileInfo.type.uppercase())
        drawKV("파일 크기:", String.format("%.2f MB", r.fileInfo.sizeBytes/(1024.0*1024.0)))
        drawKV("SHA-256:", r.sha256)
        drawKV("분석 시각:", r.analysisTimestamp)
        drawKV("분석 유형:", r.analysisType)
    }

    when {
        deepfakeState is AnalysisUiState.Success -> {
            val r = deepfakeState.result
            renderFileInfo(r)
            r.deepfakeAnalysis?.let { df ->
                drawHeader("딥페이크 분석 요약")
                drawKV("딥페이크일 확률:", String.format("%.1f%%", (df.type?.deepfake ?: 0.0) * 100))
                drawKV("유해성 점수:", String.format("%.1f%%", (df.offensive?.prob ?: 0.0) * 100))
                drawKV("노출 점수:", String.format("%.1f%%", (df.nudity?.raw ?: 0.0) * 100))
            }
        }
        cyberbullyingState is AnalysisUiState.Success -> {
            val r = cyberbullyingState.result
            renderFileInfo(r)
            drawHeader("사이버폭력 분석 요약")
            drawKV("전체 대화 사이버폭력 위험도:", r.cyberbullyingRiskLine ?: "분석 중")
            if (!r.extractedText.isNullOrBlank()) { drawHeader("추출 텍스트(OCR)"); drawPara(r.extractedText ?: "") }
            r.cyberbullyingAnalysis?.let { html ->
                drawHeader("상세 분석 결과")
                val plain = android.text.Html.fromHtml(html, android.text.Html.FROM_HTML_MODE_LEGACY).toString()
                drawPara(plain)
            }
            r.cyberbullyingAnalysisSummary?.let { summary -> drawHeader("전체 분석 요약"); drawPara(summary) }
        }
        else -> { drawHeader("안내"); drawPara("분석 결과가 없습니다. 먼저 분석을 완료하세요.") }
    }

    pdf.finishPage(page)
    val out = java.io.ByteArrayOutputStream(); pdf.writeTo(out); pdf.close(); return out.toByteArray()
}

private fun wrapText(text: String, paint: TextPaint, maxWidth: Float): List<String> {
    if (text.isBlank()) return emptyList()
    val out = mutableListOf<String>()
    val paragraphs = text.replace("\r", "").split("\n")
    for (p in paragraphs) {
        var start = 0
        val s = p.trim()
        while (start < s.length) {
            var count = paint.breakText(s, start, s.length, true, maxWidth, null)
            if (count <= 0) break
            // 줄 끝을 단어 경계로 보정
            var end = start + count
            if (end < s.length && !s[end - 1].isWhitespace()) {
                val lastSpace = s.lastIndexOf(' ', end - 1)
                if (lastSpace > start) end = lastSpace
            }
            out.add(s.substring(start, end).trim())
            start = if (end == start) end + 1 else end
        }
        if (s.isEmpty()) out.add("")
    }
    return out
}

@Composable
fun RiskLevelCard(result: AnalysisResult) {
    val riskLevel = result.cyberbullyingRiskLine ?: "분석 중"
    val riskClass = when {
        "심각" in riskLevel -> "risk-severe"
        "있음" in riskLevel -> "risk-present"
        "약간 있음" in riskLevel -> "risk-slight"
        "의심" in riskLevel -> "risk-suspicion"
        "없음" in riskLevel -> "risk-none"
        else -> "risk-suspicion"
    }

    val riskColor = when (riskClass) {
        "risk-severe" -> MaterialTheme.colorScheme.error
        "risk-present" -> MaterialTheme.colorScheme.error
        "risk-slight" -> MaterialTheme.colorScheme.tertiary
        "risk-suspicion" -> MaterialTheme.colorScheme.tertiary
        "risk-none" -> MaterialTheme.colorScheme.primary
        else -> MaterialTheme.colorScheme.tertiary
    }

    Card(
        colors = CardDefaults.cardColors(
            containerColor = MaterialTheme.colorScheme.surface
        )
    ) {
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .padding(16.dp),
            horizontalArrangement = Arrangement.SpaceBetween,
            verticalAlignment = Alignment.CenterVertically
        ) {
            Text(
                text = "전체 대화 사이버폭력 위험도",
                fontSize = 18.sp,
                fontWeight = FontWeight.Bold,
                color = MaterialTheme.colorScheme.primary
            )
            Text(
                text = riskLevel,
                fontSize = 18.sp,
                fontWeight = FontWeight.Bold,
                color = riskColor
            )
        }
    }
}

@Composable
fun FileInfoSection(result: AnalysisResult) {
    Card(
        colors = CardDefaults.cardColors(
            containerColor = MaterialTheme.colorScheme.surface
        )
    ) {
        Column(
            modifier = Modifier.padding(12.dp)
        ) {
            Text(
                text = "파일 정보",
                fontSize = 16.sp,
                fontWeight = FontWeight.Bold,
                color = MaterialTheme.colorScheme.onSurface
            )
            Spacer(modifier = Modifier.height(8.dp))

            Text(
                text = "파일명: \${result.fileInfo.filename}",
                style = MaterialTheme.typography.bodyMedium,
                color = MaterialTheme.colorScheme.onSurface
            )
            Text(
                text = "파일 크기: \${String.format("%.2f", result.fileInfo.sizeBytes / (1024.0 * 1024.0))} MB",
                style = MaterialTheme.typography.bodyMedium,
                color = MaterialTheme.colorScheme.onSurface
            )
            Text(
                text = "파일 타입: \${result.fileInfo.type.uppercase()}",
                style = MaterialTheme.typography.bodyMedium,
                color = MaterialTheme.colorScheme.onSurface
            )
            Text(
                text = "SHA-256 해시: \${result.sha256}",
                style = MaterialTheme.typography.bodySmall,
                color = MaterialTheme.colorScheme.onSurface
            )
            Text(
                text = "분석 요청 시각: \${result.analysisTimestamp}",
                style = MaterialTheme.typography.bodySmall,
                color = MaterialTheme.colorScheme.onSurface
            )
        }
    }
}

@Composable
private fun ErrorFallbackUI(
    errorMessage: String,
    onRetry: () -> Unit
) {
    Box(
        modifier = Modifier.fillMaxSize(),
        contentAlignment = Alignment.Center
    ) {
        Column(
            horizontalAlignment = Alignment.CenterHorizontally,
            modifier = Modifier.padding(16.dp)
        ) {
            Text(
                text = "화면 로드 오류",
                fontSize = 20.sp,
                fontWeight = FontWeight.Bold,
                color = MaterialTheme.colorScheme.error
            )
            Spacer(modifier = Modifier.height(16.dp))
            Text(
                text = errorMessage,
                textAlign = TextAlign.Center,
                color = MaterialTheme.colorScheme.onSurface
            )
            Spacer(modifier = Modifier.height(24.dp))
            Button(onClick = onRetry) {
                Text("다시 시도")
            }
        }
    }
}

@Composable
fun HeaderSection() {
    Column(
        horizontalAlignment = Alignment.CenterHorizontally
    ) {
        Text(
            text = "안심톡",
            fontSize = 32.sp,
            fontWeight = FontWeight.Bold,
            color = MaterialTheme.colorScheme.primary
        )
        Spacer(modifier = Modifier.height(8.dp))
        Text(
            text = "AI 기반 디지털 증거 분석 앱",
            fontSize = 16.sp,
            color = MaterialTheme.colorScheme.onSurfaceVariant,
            textAlign = TextAlign.Center
        )
    }
}

@Composable
fun HealthStatusSection(healthState: com.ansimtalk.app.data.model.Resource<Map<String, Any>>) {
    Card(
        modifier = Modifier.fillMaxWidth(),
        colors = CardDefaults.cardColors(containerColor = MaterialTheme.colorScheme.surface),
        border = BorderStroke(1.dp, com.ansimtalk.app.presentation.ui.theme.Border),
        elevation = CardDefaults.cardElevation(defaultElevation = 1.dp)
    ) {
        Column(
            modifier = Modifier.padding(16.dp)
        ) {
            Text(
                text = "API 상태",
                fontSize = 18.sp,
                fontWeight = FontWeight.Bold,
                color = MaterialTheme.colorScheme.onSurface
            )
            Spacer(modifier = Modifier.height(4.dp))
            Text(
                text = "현재 서버: \${BuildConfig.BASE_URL}",
                style = MaterialTheme.typography.bodySmall,
                color = MaterialTheme.colorScheme.onSurface.copy(alpha = 0.8f)
            )
            Spacer(modifier = Modifier.height(8.dp))
            when (healthState) {
                is com.ansimtalk.app.data.model.Resource.Loading -> {
                    CircularProgressIndicator(
                        modifier = Modifier.align(Alignment.CenterHorizontally)
                    )
                    Text(
                        text = "연결 확인 중...",
                        modifier = Modifier.align(Alignment.CenterHorizontally),
                        style = MaterialTheme.typography.bodyMedium
                    )
                }
                is com.ansimtalk.app.data.model.Resource.Success -> {
                    Row(
                        modifier = Modifier
                            .background(color = com.ansimtalk.app.presentation.ui.theme.Success100, shape = CircleShape)
                            .padding(horizontal = 10.dp, vertical = 6.dp)
                            .align(Alignment.Start),
                        verticalAlignment = Alignment.CenterVertically
                    ) {
                        Text(
                            text = "✅ API 연결 정상",
                            color = com.ansimtalk.app.presentation.ui.theme.SuccessText,
                            style = MaterialTheme.typography.bodyMedium,
                            fontWeight = FontWeight.Bold
                        )
                    }
                }
                is com.ansimtalk.app.data.model.Resource.Error -> {
                    Text(
                        text = "❌ API 연결 오류: \${healthState.message}",
                        color = MaterialTheme.colorScheme.onErrorContainer,
                        style = MaterialTheme.typography.bodyMedium
                    )
                }
            }
        }
    }
}

@Composable
fun DeepfakeAnalysisSection(
    state: AnalysisUiState,
    onAnalyzeClick: () -> Unit,
    onReset: () -> Unit
) {
    Card(
        modifier = Modifier.fillMaxWidth(),
        colors = CardDefaults.cardColors(
            containerColor = MaterialTheme.colorScheme.surface
        ),
        border = BorderStroke(1.dp, com.ansimtalk.app.presentation.ui.theme.Border),
        elevation = CardDefaults.cardElevation(defaultElevation = 1.dp)
    ) {
        Column(
            modifier = Modifier.padding(16.dp)
        ) {
            Text(
                text = "딥페이크 분석",
                fontSize = 20.sp,
                fontWeight = FontWeight.Bold,
                color = MaterialTheme.colorScheme.onSurface
            )
            Spacer(modifier = Modifier.height(8.dp))
            Text(
                text = "이미지나 영상이 AI로 조작되었는지 분석합니다",
                fontSize = 14.sp,
                color = MaterialTheme.colorScheme.onSurface.copy(alpha = 0.7f)
            )
            Spacer(modifier = Modifier.height(16.dp))

            when (state) {
                is AnalysisUiState.Idle -> {
                    Button(
                        onClick = onAnalyzeClick,
                        modifier = Modifier
                            .fillMaxWidth()
                            .height(48.dp),
                        colors = ButtonDefaults.buttonColors(
                            containerColor = com.ansimtalk.app.presentation.ui.theme.Primary600,
                            contentColor = Color.White
                        )
                    ) {
                        Text("이미지 선택하여 분석", fontSize = 16.sp)
                    }
                }
                is AnalysisUiState.Loading -> {
                    CircularProgressIndicator(
                        modifier = Modifier.align(Alignment.CenterHorizontally)
                    )
                    Text(
                        text = "분석 중...",
                        modifier = Modifier.align(Alignment.CenterHorizontally),
                        style = MaterialTheme.typography.bodyMedium
                    )
                }
                is AnalysisUiState.Success -> {
                    AnalysisResultContent(result = state.result)
                    OutlinedButton(
                        onClick = onReset,
                        modifier = Modifier
                            .fillMaxWidth()
                            .height(44.dp),
                        border = BorderStroke(1.dp, com.ansimtalk.app.presentation.ui.theme.Border),
                        colors = ButtonDefaults.outlinedButtonColors(
                            contentColor = com.ansimtalk.app.presentation.ui.theme.TextStrong
                        )
                    ) {
                        Text("다시 분석", fontSize = 16.sp)
                    }
                }
                is AnalysisUiState.Error -> {
                    val message = state.message
                    Text(
                        text = if (message.length > 300) message.take(300) + "…" else message,
                        color = MaterialTheme.colorScheme.error,
                        style = MaterialTheme.typography.bodyMedium
                    )
                    Button(
                        onClick = onReset,
                        modifier = Modifier
                            .fillMaxWidth()
                            .height(44.dp),
                        colors = ButtonDefaults.buttonColors(
                            containerColor = com.ansimtalk.app.presentation.ui.theme.Primary600,
                            contentColor = Color.White
                        )
                    ) {
                        Text("다시 시도", fontSize = 16.sp)
                    }
                }
            }

            Spacer(modifier = Modifier.height(8.dp))
            val ctx = LocalContext.current
            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.End
            ) {
                OutlinedButton(
                    onClick = {
                        val url = "\${BuildConfig.BASE_URL}/deepfake_help"
                        val intent = Intent(Intent.ACTION_VIEW, android.net.Uri.parse(url))
                        ctx.startActivity(intent)
                    },
                    border = BorderStroke(1.dp, com.ansimtalk.app.presentation.ui.theme.Border),
                    colors = ButtonDefaults.outlinedButtonColors(
                        contentColor = com.ansimtalk.app.presentation.ui.theme.TextStrong
                    )
                ) {
                    Icon(Icons.Filled.Info, contentDescription = null, tint = com.ansimtalk.app.presentation.ui.theme.TextStrong)
                    Spacer(Modifier.width(6.dp))
                    Text("딥페이크 피해 상담/신고 안내", fontSize = 14.sp, color = com.ansimtalk.app.presentation.ui.theme.TextStrong)
                    Spacer(Modifier.width(6.dp))
                    Icon(Icons.Filled.OpenInNew, contentDescription = null, tint = com.ansimtalk.app.presentation.ui.theme.TextStrong)
                }
            }
        }
    }
}

@Composable
fun CyberbullyingAnalysisSection(
    state: AnalysisUiState,
    onAnalyzeClick: () -> Unit,
    onReset: () -> Unit
) {
    Card(
        modifier = Modifier.fillMaxWidth(),
        colors = CardDefaults.cardColors(containerColor = MaterialTheme.colorScheme.surface),
        border = BorderStroke(1.dp, com.ansimtalk.app.presentation.ui.theme.Border),
        elevation = CardDefaults.cardElevation(defaultElevation = 1.dp)
    ) {
        Column(
            modifier = Modifier.padding(16.dp)
        ) {
            Text(
                text = "사이버 폭력 분석",
                fontSize = 20.sp,
                fontWeight = FontWeight.Bold,
                color = MaterialTheme.colorScheme.onSecondaryContainer
            )
            Spacer(modifier = Modifier.height(8.dp))
            Text(
                text = "채팅이나 텍스트의 폭력성 및 유해성을 분석합니다",
                fontSize = 14.sp,
                color = MaterialTheme.colorScheme.onSecondaryContainer.copy(alpha = 0.7f)
            )
            Spacer(modifier = Modifier.height(16.dp))

            when (state) {
                is AnalysisUiState.Idle -> {
                    Button(
                        onClick = onAnalyzeClick,
                        modifier = Modifier.fillMaxWidth()
                    ) {
                        Text("이미지 선택하여 분석")
                    }
                }
                is AnalysisUiState.Loading -> {
                    CircularProgressIndicator(
                        modifier = Modifier.align(Alignment.CenterHorizontally)
                    )
                    Text(
                        text = "분석 중...",
                        modifier = Modifier.align(Alignment.CenterHorizontally),
                        style = MaterialTheme.typography.bodyMedium
                    )
                }
                is AnalysisUiState.Success -> {
                    AnalysisResultContent(result = state.result)
                    OutlinedButton(
                        onClick = onReset,
                        modifier = Modifier.fillMaxWidth(),
                        border = BorderStroke(1.dp, com.ansimtalk.app.presentation.ui.theme.Border),
                        colors = ButtonDefaults.outlinedButtonColors(
                            contentColor = com.ansimtalk.app.presentation.ui.theme.TextStrong
                        )
                    ) {
                        Text("다시 분석")
                    }
                }
                is AnalysisUiState.Error -> {
                    val message = state.message
                    Text(
                        text = if (message.length > 300) message.take(300) + "…" else message,
                        color = MaterialTheme.colorScheme.error,
                        style = MaterialTheme.typography.bodyMedium
                    )
                    Button(
                        onClick = onReset,
                        modifier = Modifier.fillMaxWidth()
                    ) {
                        Text("다시 시도")
                    }
                }
            }

            Spacer(modifier = Modifier.height(8.dp))
            val ctx = LocalContext.current
            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.End
            ) {
                OutlinedButton(
                    onClick = {
                        val url = "\${BuildConfig.BASE_URL}/cyberbullying_help"
                        val intent = Intent(Intent.ACTION_VIEW, android.net.Uri.parse(url))
                        ctx.startActivity(intent)
                    },
                    border = BorderStroke(1.dp, com.ansimtalk.app.presentation.ui.theme.Border),
                    colors = ButtonDefaults.outlinedButtonColors(
                        contentColor = com.ansimtalk.app.presentation.ui.theme.TextStrong
                    )
                ) {
                    Icon(Icons.Filled.Info, contentDescription = null, tint = com.ansimtalk.app.presentation.ui.theme.TextStrong)
                    Spacer(Modifier.width(6.dp))
                    Text("사이버폭력 신고 안내", fontSize = 14.sp, color = com.ansimtalk.app.presentation.ui.theme.TextStrong)
                    Spacer(Modifier.width(6.dp))
                    Icon(Icons.Filled.OpenInNew, contentDescription = null, tint = com.ansimtalk.app.presentation.ui.theme.TextStrong)
                }
            }
        }
    }
}

@Composable
fun AnalysisResultContent(result: AnalysisResult) {
    Column {
        Text(
            text = "분석 결과",
            fontWeight = FontWeight.Bold,
            style = MaterialTheme.typography.titleMedium
        )
        Spacer(modifier = Modifier.height(8.dp))
        result.result?.let {
            Text(
                text = "결과: $it",
                style = MaterialTheme.typography.bodyMedium
            )
        }
        result.confidence?.let { confidence ->
            Text(
                text = "신뢰도: \${String.format("%.2f", confidence)}%",
                style = MaterialTheme.typography.bodyMedium
            )
        }
        Text(
            text = "파일: \${result.fileInfo.filename}",
            style = MaterialTheme.typography.bodySmall
        )
    }
}

@Composable
fun PdfDownloadButton(
    state: PdfDownloadUiState,
    onDownloadClick: () -> Unit,
    onReset: () -> Unit
) {
    Card(
        modifier = Modifier.fillMaxWidth(),
        colors = CardDefaults.cardColors(
            containerColor = MaterialTheme.colorScheme.tertiaryContainer
        )
    ) {
        Column(
            modifier = Modifier.padding(16.dp)
        ) {
            Text(
                text = "PDF 리포트",
                fontSize = 20.sp,
                fontWeight = FontWeight.Bold,
                color = MaterialTheme.colorScheme.onTertiaryContainer
            )
            Spacer(modifier = Modifier.height(8.dp))
            Text(
                text = "분석 결과를 PDF로 다운로드합니다",
                fontSize = 14.sp,
                color = MaterialTheme.colorScheme.onTertiaryContainer.copy(alpha = 0.7f)
            )
            Spacer(modifier = Modifier.height(16.dp))

            when (state) {
                is PdfDownloadUiState.Idle -> {
                    Button(
                        onClick = onDownloadClick,
                        modifier = Modifier.fillMaxWidth()
                    ) {
                        Text("PDF 다운로드")
                    }
                }
                is PdfDownloadUiState.Downloading -> {
                    CircularProgressIndicator(
                        modifier = Modifier.align(Alignment.CenterHorizontally)
                    )
                    Text(
                        text = "다운로드 중...",
                        modifier = Modifier.align(Alignment.CenterHorizontally),
                        style = MaterialTheme.typography.bodyMedium
                    )
                }
                is PdfDownloadUiState.Success -> {
                    Text(
                        text = "다운로드 완료!",
                        color = MaterialTheme.colorScheme.primary,
                        style = MaterialTheme.typography.bodyMedium
                    )
                    Button(
                        onClick = onReset,
                        modifier = Modifier.fillMaxWidth()
                    ) {
                        Text("다시 다운로드")
                    }
                }
                is PdfDownloadUiState.Error -> {
                    Text(
                        text = "오류: \${state.message}",
                        color = MaterialTheme.colorScheme.error,
                        style = MaterialTheme.typography.bodyMedium
                    )
                    Button(
                        onClick = onReset,
                        modifier = Modifier.fillMaxWidth()
                    ) {
                        Text("다시 시도")
                    }
                }
            }
        }
    }
}

// 선택한 파일을 원본 파일명/확장자를 유지해 캐시에 저장하고, 올바른 MIME으로 Multipart를 생성합니다.
private fun prepareMultipartFromUri(context: android.content.Context, uri: Uri): MultipartBody.Part {
    val cr = context.contentResolver

    // MIME 타입 확인 (기본값은 이진파일)
    val mimeType = cr.getType(uri) ?: "application/octet-stream"

    // 표시 이름(파일명) 조회
    val displayName = run {
        if (uri.scheme == "content") {
            cr.query(uri, arrayOf(android.provider.OpenableColumns.DISPLAY_NAME), null, null, null)?.use { cursor ->
                if (cursor.moveToFirst()) cursor.getString(0) else null
            }
        } else if (uri.scheme == "file") {
            File(requireNotNull(uri.path)).name
        } else null
    }

    // 확장자 결정
    val extFromName = displayName?.substringAfterLast('.', missingDelimiterValue = "").orEmpty()
    val ext = if (extFromName.isNotBlank()) extFromName.lowercase() else when (mimeType) {
        "image/png" -> "png"
        "image/jpeg" -> "jpg"
        "text/plain" -> "txt"
        else -> ""
    }

    // 허용 확장자 검증(서버 측 정책과 일치)
    val allowed = setOf("png", "jpg", "jpeg", "txt")
    if (ext.isNotBlank() && ext !in allowed) {
        throw IllegalArgumentException("허용되지 않는 파일 형식입니다. (png, jpg, jpeg, txt)")
    }

    // 저장 파일명 구성 (확장자 없으면 MIME 기반 추정치 사용)
    val baseName = displayName?.takeIf { it.isNotBlank() } ?: "upload_\${System.currentTimeMillis()}"
    val hasDot = baseName.contains('.')
    val safeName = if (hasDot) baseName else baseName + if (ext.isNotBlank()) ".\${ext}" else ""

    // 캐시에 복사 저장
    val inputStream = cr.openInputStream(uri)
    requireNotNull(inputStream) { "Failed to open input stream for URI: $uri" }
    val tempFile = File(context.cacheDir, safeName)
    tempFile.outputStream().use { output -> inputStream.copyTo(output) }
    inputStream.close()

    val partMime = (if (ext in setOf("png", "jpg", "jpeg")) {
        if (ext == "png") "image/png" else "image/jpeg"
    } else if (ext == "txt") {
        "text/plain"
    } else mimeType).toMediaTypeOrNull()

    val body = tempFile.asRequestBody(partMime)
    return MultipartBody.Part.createFormData("file", tempFile.name, body)
}
```

---

## 20. 전체 프로젝트 요약

### 📁 전체 폴더 구조

```
D:\coding sutdy\
├── ansimtalk (2)/                # 웹 애플리케이션 (Flask)
│   ├── run.py
│   ├── config.py
│   ├── requirements.txt
│   ├── Dockerfile
│   ├── railway.toml
│   └── app/
│       ├── __init__.py
│       ├── routes.py
│       ├── services.py           # AI 분석 핵심 로직
│       ├── static/
│       │   ├── css/style.css
│       │   └── fonts/            # NanumGothic 폰트 3개
│       └── templates/            # HTML 템플릿 7개
│
└── ansimtalk_app/                # 안드로이드 앱 (Kotlin)
    ├── build.gradle.kts
    ├── settings.gradle.kts
    └── app/
        ├── build.gradle.kts
        └── src/main/
            ├── AndroidManifest.xml
            ├── java/com/ansimtalk/app/
            │   ├── AnsimTalkApplication.kt
            │   ├── MainActivity.kt
            │   ├── ResultActivity.kt
            │   ├── data/              # 데이터 레이어 (11개 파일)
            │   ├── domain/            # 도메인 레이어 (8개 파일)
            │   ├── presentation/      # 프레젠테이션 레이어 (9개 파일)
            │   ├── di/                # DI 모듈 (2개 파일)
            │   └── util/              # 유틸 (1개 파일)
            └── res/                   # 안드로이드 리소스
```

---

### 📊 코드 통계

**웹 애플리케이션**:
- Python 파일: 4개 (run.py, config.py, __init__.py, routes.py, services.py)
- HTML 템플릿: 7개
- CSS 파일: 1개
- 총 라인 수: 약 2,500줄

**안드로이드 앱**:
- Kotlin 파일: 32개
- XML 파일: 23개
- Gradle 파일: 3개
- 총 라인 수: 약 5,000줄 (MainScreen.kt만 1,518줄)

---

### 🔧 개발 환경 요구사항

**웹 (Flask)**:
- Python 3.12
- pip packages: Flask, google-cloud-vision, google-generativeai, weasyprint, pillow, requests
- API 키: Sightengine, Google Gemini, Google Cloud Vision

**앱 (Android)**:
- Android Studio (최신 버전)
- JDK 11
- Android SDK 26-34
- Kotlin 1.9.22
- Gradle 8.11.1

---

### 🚀 실행 순서

1. **웹 서버 실행**:
```bash
cd "D:\coding sutdy\ansimtalk (2)"
python run.py
# 서버가 http://localhost:8000 에서 실행됨
```

2. **앱 실행** (에뮬레이터로 로컬 서버 테스트):
```bash
cd "D:\coding sutdy\ansimtalk_app"
# Android Studio에서 Build Variant를 debugLocalEmu로 선택
# Run 버튼 클릭
```

3. **앱 실행** (프로덕션 서버 연결):
```bash
# Android Studio에서 Build Variant를 debug로 선택
# Run 버튼 클릭 (Railway 배포된 서버로 자동 연결)
```

---
